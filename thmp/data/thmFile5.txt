\begin{lemma} \label{lemma-snake} \begin{reference} \cite[III, Lemma 3.3]{Cartan-Eilenberg} \end{reference} Suppose given a commutative diagram $$ \xymatrix{ & X \ar[r] \ar[d]^\alpha & Y \ar[r] \ar[d]^\beta & Z \ar[r] \ar[d]^\gamma & 0 \\ 0 \ar[r] & U \ar[r] & V \ar[r] & W } $$ of abelian groups with exact rows, then there is a canonical exact sequence $$ \Ker(\alpha) \to \Ker(\beta) \to \Ker(\gamma) \to \Coker(\alpha) \to \Coker(\beta) \to \Coker(\gamma) $$ Moreover, if $X \to Y$ is injective, then the first map is injective, and if $V \to W$ is surjective, then the last map is surjective.

\begin{definition} \label{definition-module-finite-type} Let $R$ be a ring. Let $M$ be an $R$-module. \begin{enumerate} \item We say $M$ is a {\it finite $R$-module}, or a {\it finitely generated $R$-module} if there exist $n \in \mathbf{N}$ and $x_1, \ldots, x_n \in M$ such that every element of $M$ is a $R$-linear combination of the $x_i$. Equivalently, this means there exists a surjection $R^{\oplus n} \to M$ for some $n \in \mathbf{N}$. \item We say $M$ is a {\it finitely presented $R$-module} or an {\it $R$-module of finite presentation} if there exist integers $n, m \in \mathbf{N}$ and an exact sequence $$ R^{\oplus m} \longrightarrow R^{\oplus n} \longrightarrow M \longrightarrow 0 $$ \end{enumerate}

\begin{lemma} \label{lemma-lift-map} Let $R$ be a ring. Let $\alpha : R^{\oplus n} \to M$ and $\beta : N \to M$ be module maps. If $\Im(\alpha) \subset \Im(\beta)$, then there exists an $R$-module map $\gamma : R^{\oplus n} \to N$ such that $\alpha = \beta \circ \gamma$.

\begin{lemma} \label{lemma-extension} Let $R$ be a ring. Let $$ 0 \to M_1 \to M_2 \to M_3 \to 0 $$ be a short exact sequence of $R$-modules. \begin{enumerate} \item If $M_1$ and $M_3$ are finite $R$-modules, then $M_2$ is a finite $R$-module. \item If $M_1$ and $M_3$ are finitely presented $R$-modules, then $M_2$ is a finitely presented $R$-module. \item If $M_2$ is a finite $R$-module, then $M_3$ is a finite $R$-module. \item If $M_2$ is a finitely presented $R$-module and $M_1$ is a finite $R$-module, then $M_3$ is a finitely presented $R$-module. \item If $M_3$ is a finitely presented $R$-module and $M_2$ is a finite $R$-module, then $M_1$ is a finite $R$-module. \end{enumerate}

\begin{lemma} \label{lemma-trivial-filter-finite-module} \begin{slogan} Finite modules have filtrations such that successive quotients are cyclic modules. \end{slogan} Let $R$ be a ring, and let $M$ be a finite $R$-module. There exists a filtration by $R$-submodules $$ 0 = M_0 \subset M_1 \subset \ldots \subset M_n = M $$ such that each quotient $M_i/M_{i-1}$ is isomorphic to $R/I_i$ for some ideal $I_i$ of $R$.

\begin{lemma} \label{lemma-finite-over-subring} Let $R \to S$ be a ring map. Let $M$ be an $S$-module. If $M$ is finite as an $R$-module, then $M$ is finite as an $S$-module.

\begin{definition} \label{definition-finite-type} Let $R \to S$ be a ring map. \begin{enumerate} \item We say $R \to S$ is of {\it finite type}, or that {\it $S$ is a finite type $R$-algebra} if there exists an $n \in \mathbf{N}$ and an surjection of $R$-algebras $R[x_1, \ldots, x_n] \to S$. \item We say $R \to S$ is of {\it finite presentation} if there exist integers $n, m \in \mathbf{N}$ and polynomials $f_1, \ldots, f_m \in R[x_1, \ldots, x_n]$ and an isomorphism of $R$-algebras $R[x_1, \ldots, x_n]/(f_1, \ldots, f_m) \cong S$. \end{enumerate}

\begin{lemma} \label{lemma-compose-finite-type} The notions finite type and finite presentation have the following permanence properties. \begin{enumerate} \item A composition of ring maps of finite type is of finite type. \item A composition of ring maps of finite presentation is of finite presentation. \item Given $R \to S' \to S$ with $R \to S$ of finite type, then $S' \to S$ is of finite type. \item Given $R \to S' \to S$, with $R \to S$ of finite presentation, and $R \to S'$ of finite type, then $S' \to S$ is of finite presentation. \end{enumerate}

\begin{lemma} \label{lemma-finite-presentation-independent} Let $R \to S$ be a ring map of finite presentation. For any surjection $\alpha : R[x_1, \ldots, x_n] \to S$ the kernel of $\alpha$ is a finitely generated ideal in $R[x_1, \ldots, x_n]$.

\begin{lemma} \label{lemma-finitely-presented-over-subring} Let $R \to S$ be a ring map. Let $M$ be an $S$-module. Assume $R \to S$ is of finite type and $M$ is finitely presented as an $R$-module. Then $M$ is finitely presented as an $S$-module.

\begin{definition} \label{definition-finite-ring-map} Let $\varphi : R \to S$ be a ring map. We say $\varphi : R \to S$ is {\it finite} if $S$ is finite as an $R$-module.

\begin{lemma} \label{lemma-finite-module-over-finite-extension} Let $R \to S$ be a finite ring map. Let $M$ be an $S$-module. Then $M$ is finite as an $R$-module if and only if $M$ is finite as an $S$-module.

\begin{lemma} \label{lemma-finite-transitive} Suppose that $R \to S$ and $S \to T$ are finite ring maps. Then $R \to T$ is finite.

\begin{definition} \label{definition-directed-system} Let $(I, \leq)$ be a preordered set. A {\it system $(M_i, \mu_{ij})$ of $R$-modules over $I$} consists of a family of $R$-modules $\{M_i\}_{i\in I}$ indexed by $I$ and a family of $R$-module maps $\{\mu_{ij} : M_i \to M_j\}_{i \leq j}$ such that for all $i \leq j \leq k$ $$ \mu_{ii} = \text{id}_{M_i}\quad \mu_{ik} = \mu_{jk}\circ \mu_{ij} $$ We say $(M_i, \mu_{ij})$ is a {\it directed system} if $I$ is a directed set.

\begin{lemma} \label{lemma-colimit} Let $(M_i, \mu_{ij})$ be a system of $R$-modules over the preordered set $I$. The colimit of the system $(M_i, \mu_{ij})$ is the quotient $R$-module $(\bigoplus_{i\in I} M_i) /Q$ where $Q$ is the $R$-submodule generated by all elements $$ \iota_i(x_i) - \iota_j(\mu_{ij}(x_i)) $$ where $\iota_i : M_i \to \bigoplus_{i\in I} M_i$ is the natural inclusion. We denote the colimit $M = \colim_i M_i$. We denote $\pi : \bigoplus_{i\in I} M_i \to M$ the projection map and $\phi_i = \pi \circ \iota_i : M_i \to M$.

\begin{lemma} \label{lemma-directed-colimit} Let $(M_i, \mu_{ij})$ be a system of $R$-modules over the preordered set $I$. Assume that $I$ is directed. The colimit of the system $(M_i, \mu_{ij})$ is canonically isomorphic to the module $M$ defined as follows: \begin{enumerate} \item as a set let $$ M = \left(\coprod\nolimits_{i \in I} M_i\right)/\sim $$ where for $m \in M_i$ and $m' \in M_{i'}$ we have $$ m \sim m' \Leftrightarrow \mu_{ij}(m) = \mu_{i'j}(m')\text{ for some }j \geq i, i' $$ \item as an abelian group for $m \in M_i$ and $m' \in M_{i'}$ we define the sum of the classes of $m$ and $m'$ in $M$ to be the class of $\mu_{ij}(m) + \mu_{i'j}(m')$ where $j \in I$ is any index with $i \leq j$ and $i' \leq j$, and \item as an $R$-module define for $m \in M_i$ and $x \in R$ the product of $x$ and the class of $m$ in $M$ to be the class of $xm$ in $M$. \end{enumerate} The canonical maps $\phi_i : M_i \to M$ are induced by the canonical maps $M_i \to \coprod_{i \in I} M_i$.

\begin{lemma} \label{lemma-zero-directed-limit} Let $(M_i, \mu_{ij})$ be a directed system. Let $M = \colim M_i$ with $\mu_i : M_i \to M$. Then, $\mu_i(x_i) = 0$ for $x_i \in M_i$ if and only if there exists $j \geq i$ such that $\mu_{ij}(x_i) = 0$.

\begin{definition} \label{definition-homomorphism-directed-systems} Let $(M_i, \mu_{ij})$, $(N_i, \nu_{ij})$ be systems of $R$-modules over the same preordered set $I$. A {\it homomorphism of systems} $\Phi$ from $(M_i, \mu_{ij})$ to $(N_i, \nu_{ij})$ is by definition a family of $R$-module homomorphisms $\phi_i : M_i \to N_i$ such that $\phi_j \circ \mu_{ij} = \nu_{ij} \circ \phi_i$ for all $i \leq j$.

\begin{lemma} \label{lemma-homomorphism-limit} Let $(M_i, \mu_{ij})$, $(N_i, \nu_{ij})$ be systems of $R$-modules over the same preordered set. A morphism of systems $\Phi = (\phi_i)$ from $(M_i, \mu_{ij})$ to $(N_i, \nu_{ij})$ induces a unique homomorphism $$ \colim \phi_i : \colim M_i \longrightarrow \colim N_i $$ such that $$ \xymatrix{ M_i \ar[r] \ar[d]_{\phi_i} & \colim M_i \ar[d]^{\colim \phi_i} \\ N_i \ar[r] & \colim N_i } $$ commutes for all $i \in I$.

\begin{lemma} \label{lemma-directed-colimit-exact} \begin{slogan} Filtered colimits are exact. Directed colimits are exact. \end{slogan} Let $I$ be a directed set. Let $(L_i, \lambda_{ij})$, $(M_i, \mu_{ij})$, and $(N_i, \nu_{ij})$ be systems of $R$-modules over $I$. Let $\varphi_i : L_i \to M_i$ and $\psi_i : M_i \to N_i$ be morphisms of systems over $I$. Assume that for all $i \in I$ the sequence of $R$-modules $$ \xymatrix{ L_i \ar[r]^{\varphi_i} & M_i \ar[r]^{\psi_i} & N_i } $$ is a complex with homology $H_i$. Then the $R$-modules $H_i$ form a system over $I$, the sequence of $R$-modules $$ \xymatrix{ \colim_i L_i \ar[r]^\varphi & \colim_i M_i \ar[r]^\psi & \colim_i N_i } $$ is a complex as well, and denoting $H$ its homology we have $$ H = \colim_i H_i. $$

\begin{lemma} \label{lemma-almost-directed-colimit-exact} Let $\mathcal{I}$ be an index category satisfying the assumptions of Categories, Lemma \ref{categories-lemma-split-into-directed}. Then taking colimits of diagrams of abelian groups over $\mathcal{I}$ is exact (i.e., the analogue of Lemma \ref{lemma-directed-colimit-exact} holds in this situation).

\begin{definition} \label{definition-relation} Let $R$ be a ring. Let $M$ be an $R$-module. Let $n \geq 0$ and $x_i \in M$ for $i = 1, \ldots, n$. A {\it relation} between $x_1, \ldots, x_n$ in $M$ is a sequence of elements $f_1, \ldots, f_n \in R$ such that $\sum_{i = 1, \ldots, n} f_i x_i = 0$.

\begin{lemma} \label{lemma-module-colimit-fp} Let $R$ be a ring and let $M$ be an $R$-module. Then $M$ is the colimit of a directed system $(M_i, \mu_{ij})$ of $R$-modules with all $M_i$ finitely presented $R$-modules.

\begin{definition} \label{definition-multiplicative-subset} Let $R$ be a ring, $S$ a subset of $R$. We say $S$ is a {\it multiplicative subset of $R$} is $1\in S$ and $S$ is closed under multiplication, i.e., $s, s' \in S \Rightarrow ss' \in S$.

\begin{definition} \label{definition-localization} This ring is called the {\it localization of $A$ with respect to $S$}.

\begin{lemma} \label{lemma-localization-zero} The localization $S^{-1}A$ is the zero ring if and only if $0\in S$.

\begin{lemma} \label{lemma-localization-and-modules} Let $R$ be a ring. Let $S \subset R$ be a multiplicative subset. The category of $S^{-1}R$-modules is equivalent to the category of $R$-modules $N$ with the property that every $s \in S$ acts as an automorphism on $N$.

\begin{definition} \label{definition-localization-module} The $S^{-1}A$-module $S^{-1}M$ is called the {\it localization} of $M$ at $S$.

\begin{lemma} \label{lemma-universal-property-localization-module} Let $R$ be a ring. Let $S \subset R$ a multiplicative subset. Let $M$, $N$ be $R$-modules. Assume all the elements of $S$ act as automorphisms on $N$. Then the canonical map $$ \Hom_R(S^{-1}M, N) \longrightarrow \Hom_R(M, N) $$ induced by the localization map, is an isomorphism.

\begin{lemma} \label{lemma-localization-colimit} Let $R$ be a ring. Let $S \subset R$ be a multiplicative subset. Let $M$ be an $R$-module. Then $$ S^{-1}M = \colim_{f \in S} M_f $$ where the preorder on $S$ is given by $f \geq f' \Leftrightarrow f = f'f''$ for some $f'' \in R$ in which case the map $M_{f'} \to M_f$ is given by $m/(f')^e \mapsto m(f'')^e/f^e$.

\begin{lemma} \label{lemma-localize-quotient-modules} Localization respects quotients, i.e. if $N$ is a submodule of $M$, then $S^{-1}(M/N)\simeq (S^{-1}M)/(S^{-1}N)$.

\begin{lemma} \label{lemma-submodule-localization} Any submodule $N'$ of $S^{-1}M$ is of the form $S^{-1}N$ for some $N\subset M$. Indeed one can take $N$ to be the inverse image of $N'$ in $M$.

\begin{lemma} \label{lemma-ideal-in-localization} \begin{slogan} Ideals in the localization of a ring are localizations of ideals. \end{slogan} Each ideal $I'$ of $S^{-1}A$ takes the form $S^{-1}I$, where one can take $I$ to be the inverse image of $I'$ in $A$.

\begin{lemma} \label{lemma-hom-exact} Exactness and $\Hom_R$. Let $R$ be a ring. \begin{enumerate} \item Let $M_1 \to M_2 \to M_3 \to 0$ be a complex of $R$-modules. Then $M_1 \to M_2 \to M_3 \to 0$ is exact if and only if $0 \to \Hom_R(M_3, N) \to \Hom_R(M_2, N) \to \Hom_R(M_1, N)$ is exact for all $R$-modules $N$. \item  Let $0 \to M_1 \to M_2 \to M_3$ be a complex of $R$-modules. Then $0 \to M_1 \to M_2 \to M_3$ is exact if and only if $0 \to \Hom_R(N, M_1) \to \Hom_R(N, M_2) \to \Hom_R(N, M_3)$ is exact for all $R$-modules $N$. \end{enumerate}

\begin{lemma} \label{lemma-hom-from-finitely-presented} Let $R$ be a ring. Let $M$ be a finitely presented $R$-module. Let $N$ be an $R$-module. \begin{enumerate} \item For $f \in R$ we have $\Hom_R(M, N)_f = \Hom_{R_f}(M_f, N_f) = \Hom_R(M_f, N_f)$, \item for a multiplicative subset $S$ of $R$ we have $$ S^{-1}\Hom_R(M, N) = \Hom_{S^{-1}R}(S^{-1}M, S^{-1}N) = \Hom_R(S^{-1}M, S^{-1}N). $$ \end{enumerate}

\begin{definition} \label{definition-bilinear} Let $R$ be a ring, $M, N, P$ be three $R$-modules. A mapping $f : M \times N \to P$ (where $M \times N$ is viewed only as Cartesian product of two $R$-modules) is said to be {\it $R$-bilinear} if for each $x \in M$ the mapping $y\mapsto f(x, y)$ of $N$ into $P$ is $R$-linear, and for each $y\in N$ the mapping $x\mapsto f(x, y)$ is also $R$-linear.

\begin{lemma} \label{lemma-tensor-product} Let $M, N$ be $R$-modules. Then there exists a pair $(T, g)$ where $T$ is an $R$-module, and $g : M \times N \to T$ an $R$-bilinear mapping, with the following universal property: For any $R$-module $P$ and any $R$-bilinear mapping $f : M \times N \to P$, there exists a unique $R$-linear mapping $\tilde{f} : T \to P$ such that $f = \tilde{f} \circ g$. In other words, the following diagram commutes: $$ \xymatrix{ M \times N \ar[rr]^f \ar[dr]_g & & P\\ & T \ar[ur]_{f'} } $$ Moreover, if $(T, g)$ and $(T', g')$ are two pairs with this property, then there exists a unique isomorphism $j : T \to T'$ such that $j\circ g = g'$.

\begin{lemma} \label{lemma-flip-tensor-product} Let $M, N, P$ be $R$-modules, then the bilinear maps \begin{align*} (x, y) & \mapsto y \otimes x\\ (x + y, z) & \mapsto x \otimes z + y \otimes z\\ (r, x) & \mapsto rx \end{align*} induce unique isomorphisms \begin{align*} M \otimes_R N & \to N \otimes_R M, \\ (M\oplus N)\otimes_R P & \to (M \otimes_R P)\oplus(N \otimes_R P),  \\ R \otimes_R M & \to M \end{align*}

\begin{lemma} \label{lemma-multilinear} Let $M_1, \ldots, M_r$ be $R$-modules. Then there exists a pair $(T, g)$ consisting of an $R$-module T and an $R$-multilinear mapping $g : M_1\times \ldots \times M_r \to T$ with the universal property: For any $R$-multilinear mapping $f : M_1\times \ldots \times M_r \to P$ there exists a unique $R$-module homomorphism $f' : T \to P$ such that $f'\circ g = f$. Such a module $T$ is unique up to unique isomorphism. We denote it $M_1\otimes_R \ldots \otimes_R M_r$ and we denote the universal multilinear map $(m_1, \ldots, m_r) \mapsto m_1 \otimes \ldots \otimes m_r$.

\begin{lemma} \label{lemma-transitive} The homomorphisms $$ (M \otimes_R N)\otimes_R P \to M \otimes_R N \otimes_R P \to M \otimes_R (N \otimes_R P) $$ such that $f((x \otimes y)\otimes z) = x \otimes y \otimes z$ and $g(x \otimes y \otimes z) = x \otimes (y \otimes z)$, $x\in M, y\in N, z\in P$ are well-defined and are isomorphisms.

\begin{definition} \label{definition-bimodule} An abelian group $N$ is called an {\it $(A, B)$-bimodule} if it is both an $A$-module and a $B$-module, and the actions $A \to End(M)$ and $B \to End(M)$ are compatible in the sense that $(ax)b = a(xb)$ for all $a\in A, b\in B, x\in N$. Usually we denote it as $_AN_B$.

\begin{lemma} \label{lemma-tensor-with-bimodule} For $A$-module $M$, $B$-module $P$ and $(A, B)$-bimodule $N$, the modules $(M \otimes_A N)\otimes_B P$ and $M \otimes_A(N \otimes_B P)$ can both be given $(A, B)$-bimodule structure, and moreover $$ (M \otimes_A N)\otimes_B P \cong M \otimes_A(N \otimes_B P). $$

\begin{lemma} \label{lemma-hom-from-tensor-product} For any three $R$-modules $M, N, P$, $$ \Hom_R(M \otimes_R N, P) \cong \Hom_R(M, \Hom_R(N, P)) $$



\begin{lemma} \label{lemma-tensor-product-exact} Let \begin{align*} M_1\xrightarrow{f} M_2\xrightarrow{g} M_3 \to 0 \end{align*} be an exact sequence of $R$-modules and homomorphisms, and let $N$ be any $R$-module. Then the sequence \begin{equation} \label{equation-2ndex} M_1\otimes N\xrightarrow{f \otimes 1} M_2\otimes N \xrightarrow{g \otimes 1} M_3\otimes N \to 0 \end{equation} is exact. In other words, the functor $- \otimes_R N$ is {\it right exact}, in the sense that tensoring each term in the original right exact sequence preserves the exactness.

\begin{lemma} \label{lemma-tensor-finiteness} Let $R$ be a ring. Let $M$ and $N$ be $R$-modules. \begin{enumerate} \item If $N$ and $M$ are finite, then so is $M \otimes_R N$. \item If $N$ and $M$ are finitely presented, then so is $M \otimes_R N$. \end{enumerate}

\begin{lemma} \label{lemma-tensor-localization} Let $M$ be an $R$-module. Then the $S^{-1}R$-modules $S^{-1}M$ and $S^{-1}R \otimes_R M$ are canonically isomorphic, and the canonical isomorphism $f : S^{-1}R \otimes_R M \to S^{-1}M$ is given by $$ f((a/s) \otimes m) = am/s, \forall a \in R, m \in M, s \in S $$

\begin{lemma} \label{lemma-tensor-product-localization} Let $M, N$ be $R$-modules, then there is a canonical $S^{-1}R$-module isomorphism $f : S^{-1}M \otimes_{S^{-1}R}S^{-1}N \to S^{-1}(M \otimes_R N)$, given by $$ f((m/s)\otimes(n/t)) = (m \otimes n)/st $$

\begin{lemma} \label{lemma-free-tensor-algebra} Let $R$ be a ring. Let $M$ be an $R$-module. If $M$ is a free $R$-module, so is each symmetric and exterior power.

\begin{lemma} \label{lemma-presentation-sym-exterior} Let $R$ be a ring. Let $M_2 \to M_1 \to M \to 0$ be an exact sequence of $R$-modules. There are exact sequences $$ M_2 \otimes_R \text{Sym}^{n - 1}(M_1) \to \text{Sym}^n(M_1) \to \text{Sym}^n(M) \to 0 $$ and similarly $$ M_2 \otimes_R \wedge^{n - 1}(M_1) \to \wedge^n(M_1) \to \wedge^n(M) \to 0 $$

\begin{lemma} \label{lemma-present-sym-wedge} Let $R$ be a ring. Let $M$ be an $R$-module. Let $x_i$, $i \in I$ be a given system of generators of $M$ as an $R$-module. Let $n \geq 2$. There exists a canonical exact sequence $$ \bigoplus_{1 \leq j_1 < j_2 \leq n} \bigoplus_{i_1, i_2 \in I} \text{T}^{n - 2}(M) \oplus \bigoplus_{1 \leq j_1 < j_2 \leq n} \bigoplus_{i \in I} \text{T}^{n - 2}(M) \to \text{T}^n(M) \to \wedge^n(M) \to 0 $$ where the pure tensor $m_1 \otimes \ldots \otimes m_{n - 2}$ in the first summand maps to \begin{align*} \underbrace{ m_1 \otimes \ldots \otimes x_{i_1} \otimes \ldots \otimes x_{i_2} \otimes \ldots \otimes m_{n - 2} }_{\text{with } x_{i_1} \text{ and } x_{i_2} \text{ occupying slots } j_1 \text{ and } j_2 \text{ in the tensor}} \\ + \underbrace{ m_1 \otimes \ldots \otimes x_{i_2} \otimes \ldots \otimes x_{i_1} \otimes \ldots \otimes m_{n - 2} }_{\text{with } x_{i_2} \text{ and } x_{i_1} \text{ occupying slots } j_1 \text{ and } j_2 \text{ in the tensor}} \end{align*} and $m_1 \otimes \ldots \otimes m_{n - 2}$ in the second summand maps to $$ \underbrace{ m_1 \otimes \ldots \otimes x_i \otimes \ldots \otimes x_i \otimes \ldots \otimes m_{n - 2} }_{\text{with } x_{i} \text{ and } x_{i} \text{ occupying slots } j_1 \text{ and } j_2 \text{ in the tensor}} $$ There is also a canonical exact sequence $$ \bigoplus_{1 \leq j_1 < j_2 \leq n} \bigoplus_{i_1, i_2 \in I} \text{T}^{n - 2}(M) \to \text{T}^n(M) \to \text{Sym}^n(M) \to 0 $$ where the pure tensor $m_1 \otimes \ldots \otimes m_{n - 2}$ maps to \begin{align*} \underbrace{ m_1 \otimes \ldots \otimes x_{i_1} \otimes \ldots \otimes x_{i_2} \otimes \ldots \otimes m_{n - 2} }_{\text{with } x_{i_1} \text{ and } x_{i_2} \text{ occupying slots } j_1 \text{ and } j_2 \text{ in the tensor}} \\ - \underbrace{ m_1 \otimes \ldots \otimes x_{i_2} \otimes \ldots \otimes x_{i_1} \otimes \ldots \otimes m_{n - 2} }_{\text{with } x_{i_2} \text{ and } x_{i_1} \text{ occupying slots } j_1 \text{ and } j_2 \text{ in the tensor}} \end{align*}

\begin{lemma} \label{lemma-colimit-tensor-algebra} \begin{slogan} Taking tensor algebras commutes with filtered colimits. \end{slogan} Let $R$ be a ring. Let $M_i$ be a directed system of $R$-modules. Then $\colim_i \text{T}(M) = \text{T}(\colim_i M_i)$ and similarly for the symmetric and exterior algebras.

\begin{lemma} \label{lemma-tensor-algebra-localization} Let $R$ be a ring and let $S \subset R$ be a multiplicative subset. Then $S^{-1}T_R(M) = T_{S^{-1}R}(S^{-1}M)$ for any $R$-module $M$. Similar for symmetric and exterior algebras.

\begin{definition} \label{definition-base-change} Let $\varphi : R \to S$ be a ring map. Let $M$ be an $S$-module. Let $R \to R'$ be any ring map. The {\it base change} of $\varphi$ by $R \to R'$ is the ring map $R' \to S \otimes_R R'$. In this situation we often write $S' = S \otimes_R R'$. The {\it base change} of the $S$-module $M$ is the $S'$-module $M \otimes_R R'$.

\begin{lemma} \label{lemma-base-change-finiteness} Let $R \to S$ be a ring map. Let $M$ be an $S$-module. Let $R \to R'$ be a ring map and let $S' = S \otimes_R R'$ and $M' = M \otimes_R R'$ be the base changes. \begin{enumerate} \item If $M$ is a finite $S$-module, then the base change $M'$ is a finite $S'$-module. \item If $M$ is an $S$-module finite presentation, then the base change $M'$ is an $S'$-module of finite presentation. \item If $R \to S$ is of finite type, then the base change $R' \to S'$ is of finite type. \item If $R \to S$ is of finite presentation, then the base change $R' \to S'$ is of finite presentation. \end{enumerate}

\begin{lemma} \label{lemma-adjoint-tensor-restrict} Let $R \to S$ be a ring map. The functors $\text{Mod}_S \to \text{Mod}_R$, $N \mapsto N_R$ (restriction) and $\text{Mod}_R \to \text{Mod}_S$, $M \mapsto M \otimes_R S$ (base change) are adjoint functors. In a formula $$ \Hom_R(M, N_R) = \Hom_S(M \otimes_R S, N) $$

\begin{lemma} \label{lemma-adjoint-hom-restrict} Let $R \to S$ be a ring map. The functors $\text{Mod}_S \to \text{Mod}_R$, $N \mapsto N_R$ (restriction) and $\text{Mod}_R \to \text{Mod}_S$, $M \mapsto \Hom_R(S, M)$ are adjoint functors. In a formula $$ \Hom_R(N_R, M) = \Hom_S(N, \Hom_R(S, M)) $$

\begin{lemma} \label{lemma-hom-from-tensor-product-variant} Let $R \to S$ be a ring map. Given $S$-modules $M, N$ and an $R$-module $P$ we have $$ \Hom_R(M \otimes_S N, P) = \Hom_S(M, \Hom_R(N, P)) $$

\begin{lemma} \label{lemma-product-ideals-in-prime} Let $R$ be a ring, $I$ and $J$ two ideals and $\mathfrak p$ a prime ideal containing the product $IJ$. Then $\mathfrak{p}$ contains $I$ or $J$.





\begin{lemma} \label{lemma-matrix-left-inverse} Let $R$ be a ring. Let $n \geq m$. Let $A$ be an $n \times m$ matrix with coefficients in $R$. Let $J \subset R$ be the ideal generated by the $m \times m$ minors of $A$. \begin{enumerate} \item For any $f \in J$ there exists a $m \times n$ matrix $B$ such that $BA = f 1_{m \times m}$. \item If $f \in R$ and $BA = f 1_{m \times m}$ for some $m \times m$ matrix $B$, then $f^m \in J$. \end{enumerate}

\begin{lemma} \label{lemma-matrix-right-inverse} Let $R$ be a ring. Let $n \geq m$. Let $A = (a_{ij})$ be an $n \times m$ matrix with coefficients in $R$, written in block form as $$ A = \left( \begin{matrix} A_1 \\ A_2 \end{matrix} \right) $$ where $A_1$ has size $m \times m$. Let $B$ be the adjugate (transpose of cofactor) matrix to $A_1$. Then $$ AB =  \left( \begin{matrix} f 1_{m \times m} \\ C \end{matrix} \right) $$ where $f = \det(A_1)$ and $c_{ij}$ is (up to sign) the determinant of the $m \times m$ minor of $A$ corresponding to the rows $1, \ldots, \hat j, \ldots, m, i$.

\begin{lemma} \label{lemma-charpoly} Let $R$ be a ring. Let $A = (a_{ij})$ be an $n \times n$ matrix with coefficients in $R$. Let $P(x) \in R[x]$ be the characteristic polynomial of $A$ (defined as $\det(x\text{id}_{n \times n} - A)$). Then $P(A) = 0$ in $\text{Mat}(n \times n, R)$.

\begin{lemma} \label{lemma-charpoly-module} Let $R$ be a ring. Let $M$ be a finite $R$-module. Let $\varphi : M \to M$ be an endomorphism. Then there exists a monic polynomial $P \in R[T]$ such that $P(\varphi) = 0$ as an endomorphism of $M$.

\begin{lemma} \label{lemma-charpoly-module-ideal} Let $R$ be a ring. Let $I \subset R$ be an ideal. Let $M$ be a finite $R$-module. Let $\varphi : M \to M$ be an endomorphism such that $\varphi(M) \subset IM$. Then there exists a monic polynomial $P = t^n + a_1 t^{n - 1} + \ldots + a_n \in R[T]$ such that $a_j \in I^j$ and $P(\varphi) = 0$ as an endomorphism of $M$.

\begin{lemma} \label{lemma-fun} Let $R$ be a ring. Let $M$ be a finite $R$-module. Let $\varphi : M \to M$ be a surjective $R$-module map. Then $\varphi$ is an isomorphism.

\begin{definition} \label{definition-spectrum-ring} Let $R$ be a ring. \begin{enumerate} \item The {\it spectrum} of $R$ is the set of prime ideals of $R$. It is usually denoted $\Spec(R)$. \item Given a subset $T \subset R$ we let $V(T) \subset \Spec(R)$ be the set of primes containing $T$, i.e., $V(T) = \{ \mathfrak p \in \Spec(R) \mid \forall f\in T, f\in \mathfrak p\}$. \item Given an element $f \in R$ we let $D(f) \subset \Spec(R)$ be the set of primes not containing $f$. \end{enumerate}

\begin{lemma} \label{lemma-Zariski-topology} Let $R$ be a ring. \begin{enumerate} \item The spectrum of a ring $R$ is empty if and only if $R$ is the zero ring. \item Every nonzero ring has a maximal ideal. \item Every nonzero ring has a minimal prime ideal. \item Given an ideal $I \subset R$ and a prime ideal $I \subset \mathfrak p$ there exists a prime $I \subset \mathfrak q \subset \mathfrak p$ such that $\mathfrak q$ is minimal over $I$. \item If $T \subset R$, and if $(T)$ is the ideal generated by $T$ in $R$, then $V((T)) = V(T)$. \item If $I$ is an ideal and $\sqrt{I}$ is its radical, see basic notion (\ref{item-radical-ideal}), then $V(I) = V(\sqrt{I})$. \item Given an ideal $I$ of $R$ we have $\sqrt{I} = \bigcap_{I \subset \mathfrak p} \mathfrak p$. \item If $I$ is an ideal then $V(I) = \emptyset$ if and only if $I$ is the unit ideal. \item If $I$, $J$ are ideals of $R$ then $V(I) \cup V(J) = V(I \cap J)$. \item If $(I_a)_{a\in A}$ is a set of ideals of $R$ then $\cap_{a\in A} V(I_a) = V(\cup_{a\in A} I_a)$. \item If $f \in R$, then $D(f) \amalg V(f) = \Spec(R)$. \item If $f \in R$ then $D(f) = \emptyset$ if and only if $f$ is nilpotent. \item If $f = u f'$ for some unit $u \in R$, then $D(f) = D(f')$. \item If $I \subset R$ is an ideal, and $\mathfrak p$ is a prime of $R$ with $\mathfrak p \not\in V(I)$, then there exists an $f \in R$ such that $\mathfrak p \in D(f)$, and $D(f) \cap V(I) = \emptyset$. \item If $f, g \in R$, then $D(fg) = D(f) \cap D(g)$. \item If $f_i \in R$ for $i \in I$, then $\bigcup_{i\in I} D(f_i)$ is the complement of $V(\{f_i \}_{i\in I})$ in $\Spec(R)$. \item If $f \in R$ and $D(f) = \Spec(R)$, then $f$ is a unit. \end{enumerate}

\begin{definition} \label{definition-Zariski-topology} Let $R$ be a ring. The topology on $\Spec(R)$ whose closed sets are the sets $V(T)$ is called the {\it Zariski} topology. The open subsets $D(f)$ are called the {\it standard opens} of $\Spec(R)$.

\begin{lemma} \label{lemma-spec-functorial} Suppose that $\varphi : R \to R'$ is a ring homomorphism. The induced map $$ \Spec(\varphi) : \Spec(R') \longrightarrow \Spec(R), \quad \mathfrak p' \longmapsto \varphi^{-1}(\mathfrak p') $$ is continuous for the Zariski topologies. In fact, for any element $f \in R$ we have $\Spec(\varphi)^{-1}(D(f)) = D(\varphi(f))$.

\begin{lemma} \label{lemma-spec-localization} Let $R$ be a ring. Let $S \subset R$ be a multiplicative subset. The map $R \to S^{-1}R$ induces via the functoriality of $\Spec$ a homeomorphism $$ \Spec(S^{-1}R) \longrightarrow \{\mathfrak p \in \Spec(R) \mid S \cap \mathfrak p = \emptyset \} $$ where the topology on the right hand side is that induced from the Zariski topology on $\Spec(R)$. The inverse map is given by $\mathfrak p \mapsto S^{-1}\mathfrak p$.

\begin{lemma} \label{lemma-standard-open} Let $R$ be a ring. Let $f \in R$. The map $R \to R_f$ induces via the functoriality of $\Spec$ a homeomorphism $$ \Spec(R_f) \longrightarrow D(f) \subset \Spec(R). $$ The inverse is given by $\mathfrak p \mapsto \mathfrak p \cdot R_f$.

\begin{lemma} \label{lemma-spec-closed} Let $R$ be a ring. Let $I \subset R$ be an ideal. The map $R \to R/I$ induces via the functoriality of $\Spec$ a homeomorphism $$ \Spec(R/I) \longrightarrow V(I) \subset \Spec(R). $$ The inverse is given by $\mathfrak p \mapsto \mathfrak p / I$.

\begin{lemma} \label{lemma-in-image} Let $\varphi : R \to S$ be a ring map. Let $\mathfrak p$ be a prime of $R$. The following are equivalent \begin{enumerate} \item $\mathfrak p$ is in the image of $\Spec(S) \to \Spec(R)$, \item $S \otimes_R \kappa(\mathfrak p) \not = 0$, \item $S_{\mathfrak p}/\mathfrak p S_{\mathfrak p} \not = 0$, \item $(S/\mathfrak pS)_{\mathfrak p} \not = 0$, and \item $\mathfrak p = \varphi^{-1}(\mathfrak pS)$. \end{enumerate}

\begin{lemma} \label{lemma-quasi-compact} Let $R$ be a ring. The space $\Spec(R)$ is quasi-compact.

\begin{lemma} \label{lemma-topology-spec} Let $R$ be a ring. The topology on $X = \Spec(R)$ has the following properties: \begin{enumerate} \item $X$ is quasi-compact, \item $X$ has a basis for the topology consisting of quasi-compact opens, and \item the intersection of any two quasi-compact opens is quasi-compact. \end{enumerate}

\begin{definition} \label{definition-local-ring} A {\it local ring} is a ring with exactly one maximal ideal. The maximal ideal is often denoted $\mathfrak m_R$ in this case. We often say ``let $(R, \mathfrak m, \kappa)$ be a local ring'' to indicate that $R$ is local, $\mathfrak m$ is its unique maximal ideal and $\kappa = R/\mathfrak m$ is its residue field. A {\it local homomorphism of local rings} is a ring map $\varphi : R \to S$ such that $R$ and $S$ are local rings and such that $\varphi(\mathfrak m_R) \subset \mathfrak m_S$. If it is given that $R$ and $S$ are local rings, then the phrase ``{\it local ring map $\varphi : R \to S$}'' means that $\varphi$ is a local homomorphism of local rings.

\begin{lemma} \label{lemma-characterize-local-ring} Let $R$ be a ring. The following are equivalent: \begin{enumerate} \item $R$ is a local ring, \item $\Spec(R)$ has exactly one closed point, \item $R$ has a maximal ideal $\mathfrak m$ and every element of $R \setminus \mathfrak m$ is a unit, and \item $R$ is not the zero ring and for every $x \in R$ either $x$ or $1 - x$ is invertible or both. \end{enumerate}

\begin{lemma} \label{lemma-characterize-local-ring-map} Let $\varphi : R \to S$ be a ring map. Assume $R$ and $S$ are local rings. The following are equivalent: \begin{enumerate} \item $\varphi$ is a local ring map, \item $\varphi(\mathfrak m_R) \subset \mathfrak m_S$, and \item $\varphi^{-1}(\mathfrak m_S) = \mathfrak m_R$. \item For any $x \in R$, if $\varphi(x)$ is invertible in $S$, then $x$ is invertible in $R$. \end{enumerate}

\begin{lemma} \label{lemma-contained-in-radical} Let $R$ be a ring and let $I \subset R$ be an ideal. The following are equivalent \begin{enumerate} \item $I \subset \text{rad}(R)$, and \item every element of $1 + I$ is a unit in $R$. \end{enumerate} In this case every element of $R$ which maps to a unit of $R/I$ is a unit.

\begin{lemma} \label{lemma-surjective-on-spec-units} Let $\varphi : R \to S$ be a ring map such that the induced map $\Spec(S) \to \Spec(R)$ is surjective. Then an element $x \in R$ is a unit if and only if $\varphi(x) \in S$ is a unit.



\begin{lemma} \label{lemma-idempotent-spec} Let $R$ be a ring. Let $e \in R$ be an idempotent. In this case $$ \Spec(R) = D(e) \amalg D(1-e). $$

\begin{lemma} \label{lemma-spec-product} Let $R_1$ and $R_2$ be rings. Let $R = R_1 \times R_2$. The maps $R \to R_1$, $(x, y) \mapsto x$ and $R \to R_2$, $(x, y) \mapsto y$ induce continuous maps $\Spec(R_1) \to \Spec(R)$ and $\Spec(R_2) \to \Spec(R)$. The induced map $$ \Spec(R_1) \amalg \Spec(R_2) \longrightarrow \Spec(R) $$ is a homeomorphism. In other words, the spectrum of $R = R_1\times R_2$ is the disjoint union of the spectrum of $R_1$ and the spectrum of $R_2$.

\begin{lemma} \label{lemma-disjoint-decomposition} Let $R$ be a ring. For each $U \subset \Spec(R)$ which is open and closed there exists a unique idempotent $e \in R$ such that $U = D(e)$. This induces a 1-1 correspondence between open and closed subsets $U \subset \Spec(R)$ and idempotents $e \in R$.

\begin{lemma} \label{lemma-characterize-spec-connected} Let $R$ be a nonzero ring. Then $\Spec(R)$ is connected if and only if $R$ has no nontrivial idempotents.

\begin{lemma} \label{lemma-ideal-is-squared-union-connected} Let $R$ be a ring. Let $I$ be a finitely generated ideal. Assume that $I = I^2$. Then $V(I)$ is open and closed in $\Spec(R)$, and $R/I \cong R_e$ for some idempotent $e \in R$.

\begin{lemma} \label{lemma-closed-union-connected-components} Let $R$ be a ring. Let $T \subset \Spec(R)$ be a subset of the spectrum. The following are equivalent \begin{enumerate} \item $T$ is closed and is a union of connected components of $\Spec(R)$, \item $T$ is an intersection of open and closed subsets of $\Spec(R)$, and \item $T = V(I)$ where $I \subset R$ is an ideal generated by idempotents. \end{enumerate} Moreover, the ideal in (3) if it exists is unique.

\begin{lemma} \label{lemma-connected-component} Let $R$ be a ring. A connected component of $\Spec(R)$ is of the form $V(I)$, where $I$ is an ideal generated by idempotents such that every idempotent of $R$ either maps to $0$ or $1$ in $R/I$.

\begin{lemma} \label{lemma-standard-covering} Let $R$ be a ring, and let $f_1, f_2, \ldots f_n\in R$ generate the unit ideal in $R$. Then the following sequence is exact: $$ 0 \longrightarrow R \longrightarrow \bigoplus\nolimits_i R_{f_i} \longrightarrow \bigoplus\nolimits_{i, j}R_{f_if_j} $$ where the maps $\alpha : R \longrightarrow \bigoplus_i R_{f_i}$ and $\beta : \bigoplus_i R_{f_i} \longrightarrow \bigoplus_{i, j} R_{f_if_j}$ are defined as $$ \alpha(x) = \left(\frac{x}{1}, \ldots, \frac{x}{1}\right) \text{ and } \beta\left(\frac{x_1}{f_1^{r_1}}, \ldots, \frac{x_n}{f_n^{r_n}}\right) = \left(\frac{x_i}{f_i^{r_i}}-\frac{x_j}{f_j^{r_j}}~\text{in}~R_{f_if_j}\right). $$

\begin{lemma} \label{lemma-cover-module} Let $R$ be a ring. Let $f_1, \ldots, f_n$ be elements of $R$ generating the unit ideal. Let $M$ be an $R$-module. The sequence $$ 0 \to M \xrightarrow{\alpha} \bigoplus\nolimits_{i = 1}^n M_{f_i} \xrightarrow{\beta} \bigoplus\nolimits_{i, j = 1}^n M_{f_i f_j} $$ is exact, where $\alpha(m) = (m/1, \ldots, m/1)$ and $\beta(m_1/f_1^{e_1}, \ldots, m_n/f_n^{e_n}) = (m_i/f_i^{e_i} - m_j/f_j^{e_j})_{(i, j)}$.

\begin{lemma} \label{lemma-disjoint-implies-product} Let $R$ be a ring. If $\Spec(R) = U \amalg V$ with both $U$ and $V$ open then $R \cong R_1 \times R_2$ with $U \cong \Spec(R_1)$ and $V \cong \Spec(R_2)$ via the maps in Lemma \ref{lemma-spec-product}. Moreover, both $R_1$ and $R_2$ are localizations as well as quotients of the ring $R$.

\begin{lemma} \label{lemma-when-injective-covering} Let $R$ be a ring. Let $f_1, \ldots, f_n \in R$. Let $M$ be an $R$-module. Then $M \to \bigoplus M_{f_i}$ is injective if and only if $$ M \longrightarrow \bigoplus\nolimits_{i = 1, \ldots, n} M, \quad m \longmapsto (f_1m, \ldots, f_nm) $$ is injective.

\begin{lemma} \label{lemma-characterize-zero-local} Let $R$ be a ring. \begin{enumerate} \item For an element $x$ of an $R$-module $M$ the following are equivalent \begin{enumerate} \item $x = 0$, \item $x$ maps to zero in $M_\mathfrak p$ for all $\mathfrak p \in \Spec(R)$, \item $x$ maps to zero in $M_{\mathfrak m}$ for all maximal ideals $\mathfrak m$ of $R$. \end{enumerate} In other words, the map $M \to \prod_{\mathfrak m} M_{\mathfrak m}$ is injective. \item Given an $R$-module $M$ the following are equivalent \begin{enumerate} \item $M$ is zero, \item $M_{\mathfrak p}$ is zero for all $\mathfrak p \in \Spec(R)$, \item $M_{\mathfrak m}$ is zero for all maximal ideals $\mathfrak m$ of $R$. \end{enumerate} \item Given a complex $M_1 \to M_2 \to M_3$ of $R$-modules the following are equivalent \begin{enumerate} \item $M_1 \to M_2 \to M_3$ is exact, \item for every prime $\mathfrak p$ of $R$ the localization $M_{1, \mathfrak p} \to M_{2, \mathfrak p} \to M_{3, \mathfrak p}$ is exact, \item for every maximal ideal $\mathfrak m$ of $R$ the localization $M_{1, \mathfrak m} \to M_{2, \mathfrak m} \to M_{3, \mathfrak m}$ is exact. \end{enumerate} \item Given a map $f : M \to M'$ of $R$-modules the following are equivalent \begin{enumerate} \item $f$ is injective, \item $f_{\mathfrak p} : M_\mathfrak p \to M'_\mathfrak p$ is injective for all primes $\mathfrak p$ of $R$, \item $f_{\mathfrak m} : M_\mathfrak m \to M'_\mathfrak m$ is injective for all maximal ideals $\mathfrak m$ of $R$. \end{enumerate} \item Given a map $f : M \to M'$ of $R$-modules the following are equivalent \begin{enumerate} \item $f$ is surjective, \item $f_{\mathfrak p} : M_\mathfrak p \to M'_\mathfrak p$ is surjective for all primes $\mathfrak p$ of $R$, \item $f_{\mathfrak m} : M_\mathfrak m \to M'_\mathfrak m$ is surjective for all maximal ideals $\mathfrak m$ of $R$. \end{enumerate} \item Given a map $f : M \to M'$ of $R$-modules the following are equivalent \begin{enumerate} \item $f$ is bijective, \item $f_{\mathfrak p} : M_\mathfrak p \to M'_\mathfrak p$ is bijective for all primes $\mathfrak p$ of $R$, \item $f_{\mathfrak m} : M_\mathfrak m \to M'_\mathfrak m$ is bijective for all maximal ideals $\mathfrak m$ of $R$. \end{enumerate} \end{enumerate}

\begin{lemma} \label{lemma-cover} \begin{slogan} Zariski-local properties of modules and algebras \end{slogan} Let $R$ be a ring. Let $M$ be an $R$-module. Let $S$ be an $R$-algebra. Suppose that $f_1, \ldots, f_n$ is a finite list of elements of $R$ such that $\bigcup D(f_i) = \Spec(R)$ in other words $(f_1, \ldots, f_n) = R$. \begin{enumerate} \item If each $M_{f_i} = 0$ then $M = 0$. \item If each $M_{f_i}$ is a finite $R_{f_i}$-module, then $M$ is a finite $R$-module. \item If each $M_{f_i}$ is a finitely presented $R_{f_i}$-module, then $M$ is a finitely presented $R$-module. \item Let $M \to N$ be a map of $R$-modules. If $M_{f_i} \to N_{f_i}$ is an isomorphism for each $i$ then $M \to N$ is an isomorphism. \item Let $0 \to M'' \to M \to M' \to 0$ be a complex of $R$-module. If $0 \to M''_{f_i} \to M_{f_i} \to M'_{f_i} \to 0$ is exact for each $i$, then $0 \to M'' \to M \to M' \to 0$ is exact. \item If each $R_{f_i}$ is Noetherian, then $R$ is Noetherian. \item If each $S_{f_i}$ is a finite type $R$-algebra, so is $S$. \item If each $S_{f_i}$ is of finite presentation over $R$, so is $S$. \end{enumerate}

\begin{lemma} \label{lemma-cover-upstairs} Let $R \to S$ be a ring map. Suppose that $g_1, \ldots, g_m$ is a finite list of elements of $S$ such that $\bigcup D(g_j) = \Spec(S)$ in other words $(g_1, \ldots, g_m) = S$. \begin{enumerate} \item If each $S_{g_i}$ is of finite type over $R$, then $S$ is of finite type over $R$. \item If each $S_{g_i}$ is of finite presentation over $R$, then $S$ is of finite presentation over $R$. \end{enumerate}

\begin{lemma} \label{lemma-glue-modules} Let $R$ be a ring. Let $f_1, \ldots, f_n \in R$ be elements which generate the unit ideal in $R$. Suppose we are given the following data: \begin{enumerate} \item For each $i$ an $R_{f_i}$-module $M_i$. \item For each pair $i, j$ an $R_{f_if_j}$-module isomorphism $\psi_{ij} : (M_i)_{f_j} \to (M_j)_{f_i}$. \end{enumerate} which satisfy the ``cocycle condition'' that all the diagrams $$ \xymatrix{ (M_i)_{f_jf_k} \ar[rd]_{\psi_{ij}} \ar[rr]^{\psi_{ik}} & & (M_k)_{f_if_j} \\ & (M_j)_{f_if_k} \ar[ru]_{\psi_{jk}} } $$ commute (for all triples $i, j, k$). Given this data define $$ M = \Ker\left( \bigoplus\nolimits_{1 \leq i \leq n} M_i \longrightarrow \bigoplus\nolimits_{1 \leq i, j \leq n} (M_i)_{f_i} \right) $$ where $(m_1, \ldots, m_n)$ maps to the element whose $(i, j)$th entry is $m_i/1 - \psi_{ji}(m_j/1)$. Then the natural map $M \to M_i$ identifies $M_i$ with $M_{f_i}$. Moreover $\psi_{ij}(m/1) = m/1$ for all $m \in M$ (with obvious notation).

\begin{lemma} \label{lemma-minimal-prime-reduced-ring} Let $\mathfrak p$ be a minimal prime of a ring $R$. Every element of the maximal ideal of $R_{\mathfrak p}$ is nilpotent. If $R$ is reduced then $R_{\mathfrak p}$ is a field.

\begin{lemma} \label{lemma-reduced-ring-sub-product-fields} Let $R$ be a reduced ring. Then \begin{enumerate} \item $R$ is a subring of a product of fields, \item $R \to \prod_{\mathfrak p\text{ minimal}} R_{\mathfrak p}$ is an embedding into a product of fields, \item $\bigcup_{\mathfrak p\text{ minimal}} \mathfrak p$ is the set of zerodivisors of $R$. \end{enumerate}

\begin{lemma} \label{lemma-total-ring-fractions} Let $R$ be a ring. Let $S \subset R$ be a multiplicative subset consisting of nonzerodivisors. Then $Q(R) \cong Q(S^{-1}R)$. In particular $Q(R) \cong Q(Q(R))$.

\begin{lemma} \label{lemma-total-ring-fractions-no-embedded-points} Let $R$ be a ring. Assume that $R$ has finitely many minimal primes $\mathfrak q_1, \ldots, \mathfrak q_t$, and that $\mathfrak q_1 \cup \ldots \cup \mathfrak q_t$ is the set of zerodivisors of $R$. Then the total ring of fractions $Q(R)$ is equal to $R_{\mathfrak q_1} \times \ldots \times R_{\mathfrak q_t}$.

\begin{lemma} \label{lemma-irreducible} Let $R$ be a ring. \begin{enumerate} \item For a prime $\mathfrak p \subset R$ the closure of $\{\mathfrak p\}$ in the Zariski topology is $V(\mathfrak p)$. In a formula $\overline{\{\mathfrak p\}} = V(\mathfrak p)$. \item The irreducible closed subsets of $\Spec(R)$ are exactly the subsets $V(\mathfrak p)$, with $\mathfrak p \subset R$ a prime. \item The irreducible components (see Topology, Definition \ref{topology-definition-irreducible-components}) of $\Spec(R)$ are  exactly the subsets $V(\mathfrak p)$, with $\mathfrak p \subset R$ a minimal prime. \end{enumerate}

\begin{lemma} \label{lemma-spec-spectral} The spectrum of a ring is a spectral space, see Topology, Definition \ref{topology-definition-spectral-space}.

\begin{lemma} \label{lemma-irreducible-components-containing-x} Let $R$ be a ring. Let $\mathfrak p \subset R$ be a prime. \begin{enumerate} \item the set of irreducible closed subsets of $\Spec(R)$ passing through $\mathfrak p$ is in one-to-one correspondence with primes $\mathfrak q \subset R_{\mathfrak p}$. \item The set of irreducible components of $\Spec(R)$ passing through $\mathfrak p$ is in one-to-one correspondence with minimal primes $\mathfrak q \subset R_{\mathfrak p}$. \end{enumerate}

\begin{lemma} \label{lemma-standard-open-containing-maximal-point} Let $R$ be a ring. Let $\mathfrak p$ be a minimal prime of $R$. Let $W \subset \Spec(R)$ be a quasi-compact open not containing the point $\mathfrak p$. Then there exists an $f \in R$, $f \not \in \mathfrak p$ such that $D(f) \cap W = \emptyset$.

\begin{lemma} \label{lemma-ring-with-only-minimal-primes} Let $R$ be a ring. Let $X = \Spec(R)$ as a topological space. The following are equivalent \begin{enumerate} \item $X$ is profinite, \item $X$ is Hausdorff, \item $X$ is totally disconnected. \item every quasi-compact open of $X$ is closed, \item there are no nontrivial inclusions between its prime ideals, \item every prime ideal is a maximal ideal, \item every prime ideal is minimal, \item every standard open $D(f) \subset X$ is closed, and \item add more here. \end{enumerate}

\begin{lemma} \label{lemma-colon} Let $R$ be a ring. For a principal ideal $J \subset R$, and for any ideal $I \subset J$ we have $I = J (I : J)$.

\begin{definition} \label{definition-oka-family} Let $R$ be a ring. Let $\mathcal{F}$ be a set of ideals of $R$. We say $\mathcal{F}$ is an {\it Oka family} if $R \in \mathcal{F}$ and whenever $I \subset R$ is an ideal and $(I : a), (I, a) \in \mathcal{F}$ for some $a \in R$, then $I \in \mathcal{F}$.

\begin{lemma} \label{lemma-simple} Let $R$ be a ring. Let $S$ be a multiplicative subset of $R$. An ideal $I \subset R$ which is maximal with respect to the property that $I \cap S = \emptyset$ is prime.

\begin{lemma} \label{lemma-cohen} Let $R$ be a ring. \begin{enumerate} \item An ideal $I \subset R$ maximal with respect to not being finitely generated is prime. \item If every prime ideal of $R$ is finitely generated, then every ideal of $R$ is finitely generated\footnote{Later we will say that $R$ is Noetherian.}. \end{enumerate}

\begin{lemma} \label{lemma-primes-principal} Let $R$ be a ring. \begin{enumerate} \item An ideal $I \subset R$ maximal with respect to not being principal is prime. \item If every prime ideal of $R$ is principal, then every ideal of $R$ is principal. \end{enumerate}

\begin{lemma} \label{lemma-characterize-domain} Let $R$ be a ring. \begin{enumerate} \item An ideal maximal among the ideals which do not contain a nonzerodivisor is prime. \item If every nonzero prime ideal in $R$ contains a nonzerodivisor, then $R$ is a domain. \end{enumerate}

\begin{lemma} \label{lemma-qc-open} Let $U \subset \Spec(R)$ be open. The following are equivalent: \begin{enumerate} \item $U$ is retrocompact in $\Spec(R)$, \item $U$ is quasi-compact, \item $U$ is a finite union of standard opens, and \item there exists a finitely generated ideal $I \subset R$ such that $X \setminus V(I) = U$. \end{enumerate}

\begin{lemma} \label{lemma-affine-map-quasi-compact} Let $\varphi : R \to S$ be a ring map. The induced continuous map $f : \Spec(S) \to \Spec(R)$ is quasi-compact. For any constructible set $E \subset \Spec(R)$ the inverse image $f^{-1}(E)$ is constructible in $\Spec(S)$.

\begin{lemma} \label{lemma-constructible-is-image} Let $R$ be a ring and let $T \subset \Spec(R)$ be constructible. Then there exists a ring map $R \to S$ of finite presentation such that $T$ is the image of $\Spec(S)$ in $\Spec(R)$.

\begin{lemma} \label{lemma-open-fp} Let $R$ be a ring. Let $f$ be an element of $R$. Let $S = R_f$. Then the image of a constructible subset of $\Spec(S)$ is constructible in $\Spec(R)$.

\begin{lemma} \label{lemma-closed-fp} Let $R$ be a ring. Let $I$ be a finitely generated ideal of $R$. Let $S = R/I$. Then the image of a constructible of $\Spec(S)$ is constructible in $\Spec(R)$.

\begin{lemma} \label{lemma-affineline-open} Let $R$ be a ring. The map $\Spec(R[x]) \to \Spec(R)$ is open, and the image of any standard open is a quasi-compact open.

\begin{lemma} \label{lemma-characteristic-polynomial-prime} Let $R \to A$ be a ring homomorphism. Assume $A \cong R^{\oplus n}$ as an $R$-module. Let $f \in A$. The multiplication map $m_f: A \to A$ is $R$-linear and hence has a characteristic polynomial $P(T) = T^n + r_{n-1}T^{n-1} + \ldots + r_0 \in R[T]$. For any prime $\mathfrak{p} \in \Spec(R)$, $f$ acts nilpotently on $A \otimes_R \kappa(\mathfrak{p})$ if and only if $\mathfrak p \in V(r_0, \ldots, r_{n-1})$.

\begin{lemma} \label{lemma-affineline-special} Let $R$ be a ring. Let $f, g \in R[x]$ be polynomials. Assume the leading coefficient of $g$ is a unit of $R$. There exists elements $r_i\in R$, $i = 1\ldots, n$ such that the image of $D(f) \cap V(g)$ in $\Spec(R)$ is $\bigcup_{i = 1, \ldots, n} D(r_i)$.

\begin{lemma} \label{lemma-generic-finite-presentation} Let $R \subset S$ be an inclusion of domains. Assume that $R \to S$ is of finite type. There exists a nonzero $f \in R$, and a nonzero $g \in S$ such that $R_f \to S_{fg}$ is of finite presentation.

\begin{lemma} \label{lemma-characterize-image-finite-type} Let $R \to S$ be a finite type ring map. Denote $X = \Spec(R)$ and $Y = \Spec(S)$. Write $f : Y \to X$ the induced map of spectra. Let $E \subset Y = \Spec(S)$ be a constructible set. If a point $\xi \in X$ is in $f(E)$, then $\overline{\{\xi\}} \cap f(E)$ contains an open dense subset of $\overline{\{\xi\}}$.

\begin{lemma} \label{lemma-surjective-spec-radical-ideal} Let $\varphi : R \to S$ be a ring map. The following are equivalent: \begin{enumerate} \item The map $\Spec(S) \to \Spec(R)$ is surjective. \item For any ideal $I \subset R$ the inverse image of $\sqrt{IS}$ in $R$ is equal to $\sqrt{I}$. \item For any radical ideal $I \subset R$ the inverse image of $IS$ in $R$ is equal to $I$. \item For every prime $\mathfrak p$ of $R$ the inverse image of $\mathfrak p S$ in $R$ is $\mathfrak p$. \end{enumerate} In this case the same is true after any base change: Given a ring map $R \to R'$ the ring map $R' \to R' \otimes_R S$ has the equivalent properties (1), (2), (3) also.

\begin{lemma} \label{lemma-domain-image-dense-set-points-generic-point} Let $R$ be a domain. Let $\varphi : R \to S$ be a ring map. The following are equivalent: \begin{enumerate} \item The ring map $R \to S$ is injective. \item The image $\Spec(S) \to \Spec(R)$ contains a dense set of points. \item There exists a prime ideal $\mathfrak q \subset S$ whose inverse image in $R$ is $(0)$. \end{enumerate}

\begin{lemma} \label{lemma-injective-minimal-primes-in-image} Let $R \subset S$ be an injective ring map. Then $\Spec(S) \to \Spec(R)$ hits all the minimal primes of $\Spec(R)$.

\begin{lemma} \label{lemma-image-dense-generic-points} Let $R \to S$ be a ring map. The following are equivalent: \begin{enumerate} \item The kernel of $R \to S$ consists of nilpotent elements. \item The minimal primes of $R$ are in the image of $\Spec(S) \to \Spec(R)$. \item The image of $\Spec(S) \to \Spec(R)$ is dense in $\Spec(R)$. \end{enumerate}

\begin{lemma} \label{lemma-minimal-prime-image-minimal-prime} Let $R \to S$ be a ring map. If a minimal prime $\mathfrak p \subset R$ is in the image of $\Spec(S) \to \Spec(R)$, then it is the image of a minimal prime.

\begin{lemma} \label{lemma-Noetherian-permanence} \begin{slogan} Noetherian property is stable by passage to finite type extension and localization. \end{slogan} Any finitely generated ring over a Noetherian ring is Noetherian. Any localization of a Noetherian ring is Noetherian.

\begin{lemma} \label{lemma-Noetherian-power-series} If $R$ is a Noetherian ring, then so is the formal power series ring $R[[x_1, \ldots, x_n]]$.

\begin{lemma} \label{lemma-obvious-Noetherian} Any finite type algebra over a field is Noetherian. Any finite type algebra over $\mathbf{Z}$ is Noetherian.

\begin{lemma} \label{lemma-Noetherian-finite-type-is-finite-presentation} Let $R$ be a Noetherian ring. \begin{enumerate} \item Any finite $R$-module is of finite presentation. \item Any finite type $R$-algebra is of finite presentation over $R$. \end{enumerate}

\begin{lemma} \label{lemma-Noetherian-topology} If $R$ is a Noetherian ring then $\Spec(R)$ is a Noetherian topological space, see Topology, Definition \ref{topology-definition-noetherian}.

\begin{lemma} \label{lemma-Noetherian-irreducible-components} \begin{slogan} A noetherian affine scheme has finitely many generic points. \end{slogan} If $R$ is a Noetherian ring then $\Spec(R)$ has finitely many irreducible components. In other words $R$ has finitely many minimal primes.

\begin{lemma} \label{lemma-Noetherian-field-extension} Let $k$ be a field and let $R$ be a Noetherian $k$-algebra. If $k \subset K$ is a finitely generated field extension then $K \otimes_k R$ is Noetherian.

\begin{lemma} \label{lemma-subring-of-local-ring} Let $R$ be a ring and $\mathfrak p \subset R$ be a prime. There exists an $f \in R$, $f \not \in \mathfrak p$ such that $R_f \to R_\mathfrak p$ is injective in each of the following cases \begin{enumerate} \item $R$ is a domain, \item $R$ is Noetherian, or \item $R$ is reduced and has finitely many minimal primes. \end{enumerate}

\begin{lemma} \label{lemma-surjective-endo-noetherian-ring-is-iso} Any surjective endomorphism of a Noetherian ring is an isomorphism.

\begin{definition} \label{definition-locally-nilpotent-ideal} Let $R$ be a ring. Let $I \subset R$ be an ideal. We say $I$ is {\it locally nilpotent} if for every $x \in I$ there exists an $n \in \mathbf{N}$ such that $x^n = 0$. We say $I$ is {\it nilpotent} if there exists an $n \in \mathbf{N}$ such that $I^n = 0$.

\begin{lemma} \label{lemma-locally-nilpotent} Let $R \to R'$ be a ring map and let $I \subset R$ be a locally nilpotent ideal. Then $IR'$ is a locally nilpotent ideal of $R'$.

\begin{lemma} \label{lemma-locally-nilpotent-unit} Let $R$ be a ring and let $I \subset R$ be a locally nilpotent ideal. An element $x$ of $R$ is a unit if and only if the image of $x$ in $R/I$ is a unit.

\begin{lemma} \label{lemma-Noetherian-power} \begin{slogan} An ideal in a Noetherian ring is nilpotent if each element of the ideal is nilpotent. \end{slogan} Let $R$ be a Noetherian ring. Let $I, J$ be ideals of $R$. Suppose $J \subset \sqrt{I}$. Then $J^n \subset I$ for some $n$. In particular, in a Noetherian ring the notions of ``locally nilpotent ideal'' and ``nilpotent ideal'' coincide.

\begin{lemma} \label{lemma-lift-idempotents} Let $R$ be a ring. Let $I \subset R$ be a locally nilpotent ideal. Then $R \to R/I$ induces a bijection on idempotents.

\begin{lemma} \label{lemma-lift-idempotents-noncommutative} Let $A$ be a possibly noncommutative algebra. Let $e \in A$ be an element such that $x = e^2 - e$ is nilpotent. Then there exists an idempotent of the form $e' = e + x(\sum a_{i, j}e^ix^j) \in A$ with $a_{i, j} \in \mathbf{Z}$.

\begin{lemma} \label{lemma-lift-nth-roots} Let $R$ be a ring. Let $I \subset R$ be a locally nilpotent ideal. Let $n \geq 1$ be an integer which is invertible in $R/I$. Then \begin{enumerate} \item the $n$th power map $1 + I \to 1 + I$, $1 + x \mapsto (1 + x)^n$ is a bijection, \item a unit of $R$ is a $n$th power if and only if its image in $R/I$ is an $n$th power. \end{enumerate}

\begin{lemma} \label{lemma-invert-closed-quotient} Let $R$ be a ring. Let $S \subset R$ be a multiplicative subset. Assume the image of the map $\Spec(S^{-1}R) \to \Spec(R)$ is closed. Then $S^{-1}R \cong R/I$ for some ideal $I \subset R$.

\begin{lemma} \label{lemma-invert-closed-split} Let $R$ be a ring. Let $S \subset R$ be a multiplicative subset. Assume the image of the map $\Spec(S^{-1}R) \to \Spec(R)$ is closed. If $R$ is Noetherian, or $\Spec(R)$ is a Noetherian topological space, or $S$ is finitely generated as a monoid, then $R \cong S^{-1}R \times R'$ for some ring $R'$.

\begin{lemma} \label{lemma-field-finite-type-over-domain} Let $R$ be a ring. Let $K$ be a field. If $R \subset K$ and $K$ is of finite type over $R$, then there exists a $f \in R$ such that $R_f$ is a field, and $R_f \subset K$ is a finite field extension.

\begin{definition} \label{definition-ring-jacobson} Let $R$ be a ring. We say that $R$ is a {\it Jacobson ring} if every radical ideal $I$ is the intersection of the maximal ideals containing it.

\begin{lemma} \label{lemma-finite-type-field-Jacobson} Any algebra of finite type over a field is Jacobson.

\begin{lemma} \label{lemma-jacobson-prime} Let $R$ be a ring. If every prime ideal of $R$ is the intersection of the maximal ideals containing it, then $R$ is Jacobson.

\begin{lemma} \label{lemma-jacobson} A ring $R$ is Jacobson if and only if $\Spec(R)$ is Jacobson, see Topology, Definition \ref{topology-definition-space-jacobson}.

\begin{lemma} \label{lemma-characterize-jacobson} Let $R$ be a ring. If $R$ is not Jacobson there exist a prime $\mathfrak p \subset R$, an element $f \in R$ such that the following hold \begin{enumerate} \item $\mathfrak p$ is not a maximal ideal, \item $f \not \in \mathfrak p$, \item $V(\mathfrak p) \cap D(f) = \{\mathfrak p\}$, and \item $(R/\mathfrak p)_f$ is a field. \end{enumerate} On the other hand, if $R$ is Jacobson, then for any pair $(\mathfrak p, f)$ such that (1) and (2) hold the set $V(\mathfrak p) \cap D(f)$ is infinite.

\begin{lemma} \label{lemma-pid-jacobson} The ring $\mathbf{Z}$ is a Jacobson ring. More generally, let $R$ be a ring such that \begin{enumerate} \item $R$ is a domain, \item $R$ is Noetherian, \item any nonzero prime ideal is a maximal ideal, and \item $R$ has infinitely many maximal ideals. \end{enumerate} Then $R$ is a Jacobson ring.

\begin{lemma} \label{lemma-finite-residue-extension-closed} Let $R \to S$ be a ring map. Let $\mathfrak m \subset R$ be a maximal ideal. Let $\mathfrak q \subset S$ be a prime ideal lying over $\mathfrak m$ such that $\kappa(\mathfrak m) \subset \kappa(\mathfrak q)$ is an algebraic field extension. Then $\mathfrak q$ is a maximal ideal of $S$.

\begin{lemma} \label{lemma-dimension} Suppose that $k$ is a field and suppose that $V$ is a nonzero vector space over $k$. Assume the dimension of $V$ (which is a cardinal number) is smaller than the cardinality of $k$. Then for any linear operator $T : V \to V$ there exists some monic polynomial $P(t) \in k[t]$ such that $P(T)$ is not invertible.

\begin{lemma} \label{lemma-base-change-Jacobson} Let $k$ be a field. Let $S$ be a $k$-algebra. For any field extension $k \subset K$ whose cardinality is larger than the cardinality of $S$ we have \begin{enumerate} \item for every maximal ideal $\mathfrak m$ of $S_K$ the field $\kappa(\mathfrak m)$ is algebraic over $K$, and \item $S_K$ is a Jacobson ring. \end{enumerate}

\begin{lemma} \label{lemma-Jacobson-invert-element} Let $R$ be a Jacobson ring. Let $f \in R$. The ring $R_f$ is Jacobson and maximal ideals of $R_f$ correspond to maximal ideals of $R$ not containing $f$.

\begin{lemma} \label{lemma-Jacobson-mod-ideal} Let $R$ be a Jacobson ring. Let $I \subset R$ be an ideal. The ring $R/I$ is Jacobson and maximal ideals of $R/I$ correspond to maximal ideals of $R$ containing $I$.

\begin{lemma} \label{lemma-corollary-jacobson} Any finite type algebra over $\mathbf{Z}$ is Jacobson.

\begin{lemma} \label{lemma-image-finite-type-map-Jacobson-rings} Let $R \to S$ be a finite type ring map of Jacobson rings. Denote $X = \Spec(R)$ and $Y = \Spec(S)$. Write $f : Y \to X$ the induced map of spectra. Let $E \subset Y = \Spec(S)$ be a constructible set. Denote with a subscript ${}_0$ the set of closed points of a topological space. \begin{enumerate} \item We have $f(E)_0 = f(E_0) = X_0 \cap f(E)$. \item A point $\xi \in X$ is in $f(E)$ if and only if $\overline{\{\xi\}} \cap f(E_0)$ is dense in $\overline{\{\xi\}}$. \end{enumerate}

\begin{lemma} \label{lemma-conclude-jacobson-Noetherian} With notation as above. Assume that $R$ is a Noetherian Jacobson ring. Further assume $R \to S$ is of finite type. There is a commutative diagram $$ \xymatrix{ \text{Constr}(Y) \ar[r]^{E \mapsto E_0} \ar[d]^{E \mapsto f(E)} & \text{Constr}(Y_0) \ar[d]^{E \mapsto f(E)} \\ \text{Constr}(X) \ar[r]^{E \mapsto E_0} & \text{Constr}(X_0) } $$ where the horizontal arrows are the bijections from Topology, Lemma \ref{topology-lemma-jacobson-equivalent-constructible}.

\begin{definition} \label{definition-integral-ring-map} Let $\varphi : R \to S$ be a ring map. \begin{enumerate} \item An element $s \in S$ is {\it integral over $R$} if there exists a monic polynomial $P(x) \in R[x]$ such that $P^\varphi(s) = 0$, where $P^\varphi(x) \in S[x]$ is the image of $P$ under $\varphi : R[x] \to S[x]$. \item  The ring map $\varphi$ is {\it integral} if every $s \in S$ is integral over $R$. \end{enumerate}

\begin{lemma} \label{lemma-characterize-integral-element} Let $\varphi : R \to S$ be a ring map. Let $y \in S$. If there exists a finite $R$-submodule $M$ of $S$ such that $1 \in M$ and $yM \subset M$, then $y$ is integral over $R$.

\begin{lemma} \label{lemma-finite-is-integral} A finite ring extension is integral.

\begin{lemma} \label{lemma-characterize-integral} Let $\varphi : R \to S$ be a ring map. Let $s_1, \ldots, s_n$ be a finite set of elements of $S$. In this case $s_i$ is integral over $R$ for all $i = 1, \ldots, n$ if and only if there exists an $R$-subalgebra $S' \subset S$ finite over $R$ containing all of the $s_i$.

\begin{lemma} \label{lemma-characterize-finite-in-terms-of-integral} Let $R \to S$ be a ring map. The following are equivalent \begin{enumerate} \item $R \to S$ is finite, \item $R \to S$ is integral and of finite type, and \item there exist $x_1, \ldots, x_n \in S$ which generate $S$ as an algebra over $R$ such that each $x_i$ is integral over $R$. \end{enumerate}

\begin{lemma} \label{lemma-integral-transitive} Suppose that $R \to S$ and $S \to T$ are integral ring maps. Then $R \to T$ is integral.

\begin{lemma} \label{lemma-integral-closure-is-ring} Let $R \to S$ be a ring homomorphism. The set $$ S' = \{s \in S \mid s\text{ is integral over }R\} $$ is an $R$-subalgebra of $S$.

\begin{definition} \label{definition-integral-closure} Let $R \to S$ be a ring map. The ring $S' \subset S$ of elements integral over $R$, see Lemma \ref{lemma-integral-closure-is-ring}, is called the {\it integral closure} of $R$ in $S$. If $R \subset S$ we say that $R$ is {\it integrally closed} in $S$ if $R = S'$.

\begin{lemma} \label{lemma-integral-closure-localize} Integral closure commutes with localization: If $A \to B$ is a ring map, and $S \subset A$ is a multiplicative subset, then the integral closure of $S^{-1}A$ in $S^{-1}B$ is $S^{-1}B'$, where $B' \subset B$ is the integral closure of $A$ in $B$.

\begin{lemma} \label{lemma-integral-closure-stalks} \begin{slogan} An element of an algebra over a ring is integral over the ring if and only if it is locally integral at every prime ideal of the ring. \end{slogan} Let $\varphi : R \to S$ be a ring map. Let $x \in S$. The following are equivalent: \begin{enumerate} \item $x$ is integral over $R$, and \item for every prime ideal $\mathfrak p \subset R$ the element $x \in S_{\mathfrak p}$ is integral over $R_{\mathfrak p}$. \end{enumerate}

\begin{lemma} \label{lemma-base-change-integral} \begin{slogan} Integrality and finitneness are preserved under base change. \end{slogan} Let $R \to S$ and $R \to R'$ be ring maps. Set $S' = R' \otimes_R S$. \begin{enumerate} \item If $R \to S$ is integral so is $R' \to S'$. \item If $R \to S$ is finite so is $R' \to S'$. \end{enumerate}

\begin{lemma} \label{lemma-integral-local} Let $R \to S$ be a ring map. Let $f_1, \ldots, f_n \in R$ generate the unit ideal. \begin{enumerate} \item If each $R_{f_i} \to S_{f_i}$ is integral, so is $R \to S$. \item If each $R_{f_i} \to S_{f_i}$ is finite, so is $R \to S$. \end{enumerate}

\begin{lemma} \label{lemma-integral-permanence} Let $A \to B \to C$ be ring maps. \begin{enumerate} \item If $A \to C$ is integral so is $B \to C$. \item If $A \to C$ is finite so is $B \to C$. \end{enumerate}

\begin{lemma} \label{lemma-integral-closure-transitive} Let $A \to B \to C$ be ring maps. Let $B'$ be the integral closure of $A$ in $B$, let $C'$ be the integral closure of $B'$ in $C$. Then $C'$ is the integral closure of $A$ in $C$.

\begin{lemma} \label{lemma-integral-overring-surjective} Suppose that $R \to S$ is an integral ring extension with $R \subset S$. Then $\varphi : \Spec(S) \to \Spec(R)$ is surjective.

\begin{lemma} \label{lemma-integral-under-field} Let $R$ be a ring. Let $K$ be a field. If $R \subset K$ and $K$ is integral over $R$, then $R$ is a field and $K$ is an algebraic extension. If $R \subset K$ and $K$ is finite over $R$, then $R$ is a field and $K$ is a finite algebraic extension.

\begin{lemma} \label{lemma-integral-over-field} Let $k$ be a field. Let $S$ be a $k$-algebra over $k$. \begin{enumerate} \item If $S$ is a domain and finite dimensional over $k$, then $S$ is a field. \item If $S$ is integral over $k$ and a domain, then $S$ is a field. \item If $S$ is integral over $k$ then every prime of $S$ is a maximal ideal (see Lemma \ref{lemma-ring-with-only-minimal-primes} for more consequences). \end{enumerate}

\begin{lemma} \label{lemma-integral-no-inclusion} Suppose $R \to S$ is integral. Let $\mathfrak q, \mathfrak q' \in \Spec(S)$ be distinct primes having the same image in $\Spec(R)$. Then neither $\mathfrak q \subset \mathfrak q'$ nor $\mathfrak q' \subset \mathfrak q$.

\begin{lemma} \label{lemma-finite-finite-fibres} Suppose $R \to S$ is finite. Then the fibres of $\Spec(S) \to \Spec(R)$ are finite.

\begin{lemma} \label{lemma-integral-going-up} Let $R \to S$ be a ring map such that $S$ is integral over $R$. Let $\mathfrak p \subset \mathfrak p' \subset R$ be primes. Let $\mathfrak q$ be a prime of $S$ mapping to $\mathfrak p$. Then there exists a prime $\mathfrak q'$ with $\mathfrak q \subset \mathfrak q'$ mapping to $\mathfrak p'$.

\begin{lemma} \label{lemma-finite-finitely-presented-extension} Let $R \to S$ be a finite and finitely presented ring map. Let $M$ be an $S$-module. Then $M$ is finitely presented as an $R$-module if and only if $M$ is finitely presented as an $S$-module.

\begin{lemma} \label{lemma-silly-normal} Let $R$ be a ring. Let $x, y \in R$ be nonzerodivisors. Let $R[x/y] \subset R_{xy}$ be the $R$-subalgebra generated by $x/y$, and similarly for the subalgebras $R[y/x]$ and $R[x/y, y/x]$. If $R$ is integrally closed in $R_x$ or $R_y$, then the sequence $$ 0 \to R \xrightarrow{(-1, 1)} R[x/y] \oplus R[y/x] \xrightarrow{(1, 1)} R[x/y, y/x] \to 0 $$ is a short exact sequence of $R$-modules.

\begin{definition} \label{definition-domain-normal} A domain $R$ is called {\it normal} if it is integrally closed in its field of fractions.

\begin{lemma} \label{lemma-integral-closure-in-normal} Let $R \to S$ be a ring map. If $S$ is a normal domain, then the integral closure of $R$ in $S$ is a normal domain.

\begin{definition} \label{definition-almost-integral} Let $R$ be a domain. \begin{enumerate} \item An element $g$ of the fraction field of $R$ is called {\it almost integral over $R$} if there exists an element $r \in R$, $r\not = 0$ such that $rg^n \in R$ for all $n \geq 0$. \item The domain $R$ is called {\it completely normal} if every almost integral element of the fraction field of $R$ is contained in $R$. \end{enumerate}

\begin{lemma} \label{lemma-almost-integral} Let $R$ be a domain with fraction field $K$. If $u, v \in K$ are almost integral over $R$, then so are $u + v$ and $uv$. Any element $g \in K$ which is integral over $R$ is almost integral over $R$. If $R$ is Noetherian then the converse holds as well.

\begin{lemma} \label{lemma-localize-normal-domain} Any localization of a normal domain is normal.

\begin{lemma} \label{lemma-PID-normal} A principal ideal domain is normal.

\begin{lemma} \label{lemma-prepare-polynomial-ring-normal} Let $R$ be a domain with fraction field $K$. Suppose $f = \sum \alpha_i x^i$ is an element of $K[x]$. \begin{enumerate} \item If $f$ is integral over $R[x]$ then all $\alpha_i$ are integral over $R$, and \item If $f$ is almost integral over $R[x]$ then all $\alpha_i$ are almost integral over $R$. \end{enumerate}

\begin{lemma} \label{lemma-polynomial-domain-normal} Let $R$ be a normal domain. Then $R[x]$ is a normal domain.

\begin{lemma} \label{lemma-power-series-over-Noetherian-normal-domain} Let $R$ be a Noetherian normal domain. Then $R[[x]]$ is a Noetherian normal domain.

\begin{lemma} \label{lemma-normality-is-local} Let $R$ be a domain. The following are equivalent: \begin{enumerate} \item The domain $R$ is a normal domain, \item for every prime $\mathfrak p \subset R$ the local ring $R_{\mathfrak p}$ is a normal domain, and \item for every maximal ideal $\mathfrak m$ the ring $R_{\mathfrak m}$ is a normal domain. \end{enumerate}

\begin{definition} \label{definition-ring-normal} A ring $R$ is called {\it normal} if for every prime $\mathfrak p \subset R$ the localization $R_{\mathfrak p}$ is a normal domain (see Definition \ref{definition-domain-normal}).

\begin{lemma} \label{lemma-normal-ring-integrally-closed} A normal ring is integrally closed in its total ring of fractions.

\begin{lemma} \label{lemma-localization-normal-ring} A localization of a normal ring is a normal ring.

\begin{lemma} \label{lemma-polynomial-ring-normal} Let $R$ be a normal ring. Then $R[x]$ is a normal ring.

\begin{lemma} \label{lemma-characterize-reduced-ring-normal} Let $R$ be a ring. Assume $R$ is reduced and has finitely many minimal primes. Then the following are equivalent: \begin{enumerate} \item $R$ is a normal ring, \item $R$ is integrally closed in its total ring of fractions, and \item $R$ is a finite product of normal domains. \end{enumerate}

\begin{lemma} \label{lemma-colimit-normal-ring} Let $(R_i, \varphi_{ii'})$ be a directed system (Categories, Definition \ref{definition-directed-system}) of rings. If each $R_i$ is a normal ring so is $R = \colim_i R_i$.

\begin{definition} \label{definition-integral-over-ideal} Let $\varphi : R \to S$ be a ring map. Let $I \subset R$ be an ideal. We say an element $g \in S$ is {\it integral over $I$} if there exists a monic polynomial $P = x^d + \sum_{j < d} a_j x^j$ with coefficients $a_j \in I^{d-j}$ such that $P^\varphi(g) = 0$ in $S$.

\begin{lemma} \label{lemma-characterize-integral-ideal} Let $\varphi : R \to S$ be a ring map. Let $I \subset R$ be an ideal. Let $A = \sum I^nt^n \subset R[t]$ be the subring of the polynomial ring generated by $R \oplus It \subset R[t]$. An element $s \in S$ is integral over $I$ if and only if the element $st \in S[t]$ is integral over $A$.

\begin{lemma} \label{lemma-integral-over-ideal-is-submodule} Let $\varphi : R \to S$ be a ring map. Let $I \subset R$ be an ideal. The set of elements of $S$ which are integral over $I$ form a $R$-submodule of $S$. Furthermore, if $s \in S$ is integral over $R$, and $s'$ is integral over $I$, then $ss'$ is integral over $I$.

\begin{lemma} \label{lemma-integral-integral-over-ideal} Suppose $\varphi : R \to S$ is integral. Suppose $I \subset R$ is an ideal. Then every element of $IS$ is integral over $I$.

\begin{lemma} \label{lemma-polynomials-divide} Let $K$ be a field. Let $n, m \in \mathbf{N}$ and $a_0, \ldots, a_{n - 1}, b_0, \ldots, b_{m - 1} \in K$. If the polynomial $x^n + a_{n - 1}x^{n - 1} + \ldots + a_0$ divides the polynomial $x^m + b_{m - 1} x^{m - 1} + \ldots + b_0$ in $K[x]$ then \begin{enumerate} \item $a_0, \ldots, a_{n - 1}$ are integral over any subring $R_0$ of $K$ containing the elements $b_0, \ldots, b_{m - 1}$, and \item each $a_i$ lies in $\sqrt{(b_0, \ldots, b_m)R}$ for any subring $R \subset K$ containing the elements $a_0, \ldots, a_{n - 1}, b_0, \ldots, b_{m - 1}$. \end{enumerate}

\begin{lemma} \label{lemma-minimal-polynomial-normal-domain} Let $R \subset S$ be an inclusion of domains. Assume $R$ is normal. Let $g \in S$ be integral over $R$. Then the minimal polynomial of $g$ has coefficients in $R$.

\begin{definition} \label{definition-flat} Let $R$ be a ring. \begin{enumerate} \item An $R$-module $M$ is called {\it flat} if whenever $N_1 \to N_2 \to N_3$ is an exact sequence of $R$-modules the sequence $M \otimes_R N_1 \to M \otimes_R N_2 \to M \otimes_R N_3$ is exact as well. \item An $R$-module $M$ is called {\it faithfully flat} if the complex of $R$-modules $N_1 \to N_2 \to N_3$ is exact if and only if the sequence $M \otimes_R N_1 \to M \otimes_R N_2 \to M \otimes_R N_3$ is exact. \item A ring map $R \to S$ is called {\it flat} if $S$ is flat as an $R$-module. \item A ring map $R \to S$ is called {\it faithfully flat} if $S$ is faithfully flat as an $R$-module. \end{enumerate}

\begin{lemma} \label{lemma-flat-intersect-ideals} Let $R$ be a ring. Let $I, J \subset R$ be ideals. Let $M$ be a flat $R$-module. Then $IM \cap JM = (I \cap J)M$.

\begin{lemma} \label{lemma-colimit-flat} Let $R$ be a ring. Let $\{M_i, \varphi_{ii'}\}$ be a directed system of flat $R$-modules. Then $\colim_i M_i$ is a flat $R$-module.

\begin{lemma} \label{lemma-composition-flat} A composition of (faithfully) flat ring maps is (faithfully) flat. If $R \to R'$ is (faithfully) flat, and $M'$ is a (faithfully) flat $R'$-module, then $M'$ is a (faithfully) flat $R$-module.

\begin{lemma} \label{lemma-flat} Let $M$ be an $R$-module. The following are equivalent: \begin{enumerate} \item \label{item-flat} $M$ is flat over $R$. \item \label{item-injective} for every injection of $R$-modules $N \subset N'$ the map $N \otimes_R M \to N'\otimes_R M$ is injective. \item \label{item-f-ideal} for every ideal $I \subset R$ the map $I \otimes_R M \to R \otimes_R M = M$ is injective. \item \label{item-ffg-ideal} for every finitely generated ideal $I \subset R$ the map $I \otimes_R M \to R \otimes_R M = M$ is injective. \end{enumerate}

\begin{lemma} \label{lemma-colimit-rings-flat} Let $\{R_i, \varphi_{ii'}\}$ be a system of rings over the directed set $I$. Let $R = \colim_i R_i$. Let $M$ be an $R$-module such that $M$ is flat as an $R_i$-module for all $i$. Then $M$ is flat as an $R$-module.

\begin{lemma} \label{lemma-flat-base-change} Suppose that $M$ is flat over $R$, and that $R \to R'$ is a ring map. Then $M \otimes_R R'$ is flat over $R'$.

\begin{lemma} \label{lemma-flatness-descends} Let $R \to R'$ be a faithfully flat ring map. Let $M$ be a module over $R$, and set $M' = R' \otimes_R M$. Then $M$ is flat over $R$ if and only if $M'$ is flat over $R'$.

\begin{lemma} \label{lemma-flatness-descends-more-general} Let $R$ be a ring. Let $S \to S'$ be a faithfully flat map of $R$-algebras. Let $M$ be a module over $S$, and set $M' = S' \otimes_S M$. Then $M$ is flat over $R$ if and only if $M'$ is flat over $R$.

\begin{lemma} \label{lemma-flat-permanence} Let $R \to S$ be a ring map. Let $M$ be an $S$-module. If $M$ is flat as an $R$-module and faithfully flat as an $S$-module, then $R \to S$ is flat.



\begin{lemma} \label{lemma-flat-tor-zero} Suppose that $R$ is a ring, $0 \to M'' \to M' \to M \to 0$ a short exact sequence, and $N$ an $R$-module. If $M$ is flat then $N \otimes_R M'' \to N \otimes_R M'$ is injective, i.e., the sequence $$ 0 \to N \otimes_R M'' \to N \otimes_R M' \to N \otimes_R M \to 0 $$ is a short exact sequence.

\begin{lemma} \label{lemma-flat-ses} Suppose that $0 \to M' \to M \to M'' \to 0$ is a short exact sequence of $R$-modules. If $M'$ and $M''$ are flat so is $M$. If $M$ and $M''$ are flat so is $M'$.

\begin{lemma} \label{lemma-easy-ff} Let $R$ be a ring. Let $M$ be an $R$-module. The following are equivalent \begin{enumerate} \item $M$ is faithfully flat, and \item $M$ is flat and for all $R$-module homomorphisms $\alpha : N \to N'$ we have $\alpha = 0$ if and only if $\alpha \otimes \text{id}_M = 0$. \end{enumerate}

\begin{lemma} \label{lemma-ff} \begin{slogan} A flat module is faithfully flat if and only if it has nonzero fibers. \end{slogan} Let $M$ be a flat $R$-module. The following are equivalent: \begin{enumerate} \item $M$ is faithfully flat, \item for all $\mathfrak p \in \Spec(R)$ the tensor product $M \otimes_R \kappa(\mathfrak p)$ is nonzero, and \item for all maximal ideals $\mathfrak m$ of $R$ the tensor product $M \otimes_R \kappa(\mathfrak m) = M/{\mathfrak m}M$ is nonzero. \end{enumerate}

\begin{lemma} \label{lemma-ff-rings} Let $R \to S$ be a flat ring map. The following are equivalent: \begin{enumerate} \item $R \to S$ is faithfully flat, \item the induced map on $\Spec$ is surjective, and \item any closed point $x \in \Spec(R)$ is in the image of the map $\Spec(S) \to \Spec(R)$. \end{enumerate}

\begin{lemma} \label{lemma-local-flat-ff} A flat local ring homomorphism of local rings is faithfully flat.

\begin{lemma} \label{lemma-flat-going-down} Let $R \to S$ be flat. Let $\mathfrak p \subset \mathfrak p'$ be primes of $R$. Let $\mathfrak q' \subset S$ be a prime of $S$ mapping to $\mathfrak p'$. Then there exists a prime $\mathfrak q \subset \mathfrak q'$ mapping to $\mathfrak p$.

\begin{lemma} \label{lemma-flat-localization} Let $R$ be a ring. Let $S \subset R$ be a multiplicative subset. \begin{enumerate} \item The localization $S^{-1}R$ is a flat $R$-algebra. \item If $M$ is a $S^{-1}R$-module, then $M$ is a flat $R$-module if and only if $M$ is a flat $S^{-1}R$-module. \item Suppose $M$ is an $R$-module. Then $M$ is a flat $R$-module if and only if $M_{\mathfrak p}$ is a flat $R_{\mathfrak p}$-module for all primes $\mathfrak p$ of $R$. \item Suppose $M$ is an $R$-module. Then $M$ is a flat $R$-module if and only if $M_{\mathfrak m}$ is a flat $R_{\mathfrak m}$-module for all maximal ideals $\mathfrak m$ of $R$. \item Suppose $R \to A$ is a ring map, $M$ is an $A$-module, and $g_1, \ldots, g_m \in A$ are elements generating the unit ideal of $A$. Then $M$ is flat over $R$ if and only if each localization $M_{g_i}$ is flat over $R$. \item Suppose $R \to A$ is a ring map, and $M$ is an $A$-module. Then $M$ is a flat $R$-module if and only if the localization $M_{\mathfrak q}$ is a flat $R_{\mathfrak p}$-module (with $\mathfrak p$ the prime of $R$ lying under $\mathfrak q$) for all primes $\mathfrak q$ of $A$. \item Suppose $R \to A$ is a ring map, and $M$ is an $A$-module. Then $M$ is a flat $R$-module if and only if the localization $M_{\mathfrak m}$ is a flat $R_{\mathfrak p}$-module (with $\mathfrak p = R \cap \mathfrak m$) for all maximal ideals $\mathfrak m$ of $A$. \end{enumerate}

\begin{lemma} \label{lemma-colimit-faithfully-flat} Let $R$ be a ring. Let $\{S_i, \varphi_{ii'}\}$ be a directed system of faithfully flat $R$-algebras. Then $S = \colim_i S_i$ is a faithfully flat $R$-algebra.

\begin{definition} \label{definition-support-module} Let $R$ be a ring and let $M$ be an $R$-module. The {\it support of $M$} is the set $$ \text{Supp}(M) = \{ \mathfrak p \in \Spec(R) \mid M_{\mathfrak p} \not = 0 \} $$

\begin{lemma} \label{lemma-support-zero} \begin{slogan} A module over a ring has empty support if and only if it is the trivial module. \end{slogan} Let $R$ be a ring. Let $M$ be an $R$-module. Then $$ M = (0) \Leftrightarrow \text{Supp}(M) = \emptyset. $$

\begin{definition} \label{definition-annihilator} Let $R$ be a ring. Let $M$ be an $R$-module. \begin{enumerate} \item Given an element $m \in M$ the {\it annihilator of $m$} is the ideal $$ \text{Ann}_R(m) = \text{Ann}(m) = \{f \in R \mid fm = 0\}. $$ \item The {\it annihilator of $M$} is the ideal $$ \text{Ann}_R(M) = \text{Ann}(M) = \{f \in R \mid fm = 0\ \forall m \in M\}. $$ \end{enumerate}

\begin{lemma} \label{lemma-annihilator-flat-base-change} Let $R \to S$ be a flat ring map. Let $M$ be an $R$-module and $m \in M$. Then $\text{Ann}_R(m) S = \text{Ann}_S(m \otimes 1)$. If $M$ is a finite $R$-module, then $\text{Ann}_R(M) S = \text{Ann}_S(M \otimes_R S)$.

\begin{lemma} \label{lemma-support-closed} Let $R$ be a ring and let $M$ be an $R$-module. If $M$ is finite, then $\text{Supp}(M)$ is closed. More precisely, if $I = \text{Ann}(M)$ is the annihilator of $M$, then $V(I) = \text{Supp}(M)$.

\begin{lemma} \label{lemma-support-base-change} Let $R \to R'$ be a ring map and let $M$ be a finite $R$-module. Then $\text{Supp}(M \otimes_R R')$ is the inverse image of $\text{Supp}(M)$.

\begin{lemma} \label{lemma-support-element} Let $R$ be a ring, let $M$ be an $R$-module, and let $m \in M$. Then $\mathfrak p \in V(\text{Ann}(m))$ if and only if $m$ does not map to zero in $M_\mathfrak p$.

\begin{lemma} \label{lemma-support-finite-presentation-constructible} Let $R$ be a ring and let $M$ be an $R$-module. If $M$ is a finitely presented $R$-module, then $\text{Supp}(M)$ is a closed subset of $\Spec(R)$ whose complement is quasi-compact.

\begin{lemma} \label{lemma-support-quotient} Let $R$ be a ring and let $M$ be an $R$-module. \begin{enumerate} \item If $M$ is finite then the support of $M/IM$ is $\text{Supp}(M) \cap V(I)$. \item If $N \subset M$, then $\text{Supp}(N) \subset \text{Supp}(M)$. \item If $Q$ is a quotient module of $M$ then $\text{Supp}(Q) \subset \text{Supp}(M)$. \item If $0 \to N \to M \to Q \to 0$ is a short exact sequence then $\text{Supp}(M) = \text{Supp}(Q) \cup \text{Supp}(N)$. \end{enumerate}

\begin{definition} \label{definition-going-up-down} Let $\varphi : R \to S$ be a ring map. \begin{enumerate} \item We say a $\varphi : R \to S$ satisfies {\it going up} if given primes $\mathfrak p \subset \mathfrak p'$ in $R$ and a prime $\mathfrak q$ in $S$ lying over $\mathfrak p$ there exists a prime $\mathfrak q'$ of $S$ such that (a) $\mathfrak q \subset \mathfrak q'$, and (b) $\mathfrak q'$ lies over $\mathfrak p'$. \item We say a $\varphi : R \to S$ satisfies {\it going down} if given primes $\mathfrak p \subset \mathfrak p'$ in $R$ and a prime $\mathfrak q'$ in $S$ lying over $\mathfrak p'$ there exists a prime $\mathfrak q$ of $S$ such that (a) $\mathfrak q \subset \mathfrak q'$, and (b) $\mathfrak q$ lies over $\mathfrak p$. \end{enumerate}

\begin{lemma} \label{lemma-open-going-down} Let $R \to S$ be a ring map. If the induced map $\varphi : \Spec(S) \to \Spec(R)$ is open, then $R \to S$ satisfies going down.

\begin{lemma} \label{lemma-going-up-down-specialization} Let $R \to S$ be a ring map. \begin{enumerate} \item $R \to S$ satisfies going down if and only if generalizations lift along the map $\Spec(S) \to \Spec(R)$, see Topology, Definition \ref{topology-definition-lift-specializations}. \item $R \to S$ satisfies going up if and only if specializations lift along the map $\Spec(S) \to \Spec(R)$, see Topology, Definition \ref{topology-definition-lift-specializations}. \end{enumerate}

\begin{lemma} \label{lemma-going-up-down-composition} Suppose $R \to S$ and $S \to T$ are ring maps satisfying going down. Then so does $R \to T$. Similarly for going up.

\begin{lemma} \label{lemma-image-stable-specialization-closed} Let $R \to S$ be a ring map. Let $T \subset \Spec(R)$ be the image of $\Spec(S)$. If $T$ is stable under specialization, then $T$ is closed.

\begin{lemma} \label{lemma-going-up-closed} Let $R \to S$ be a ring map. The following are equivalent: \begin{enumerate} \item Going up holds for $R \to S$, and \item the map $\Spec(S) \to \Spec(R)$ is closed. \end{enumerate}

\begin{lemma} \label{lemma-constructible-stable-specialization-closed} Let $R$ be a ring. Let $E \subset \Spec(R)$ be a constructible subset. \begin{enumerate} \item If $E$ is stable under specialization, then $E$ is closed. \item If $E$ is stable under generalization, then $E$ is open. \end{enumerate}

\begin{lemma} \label{lemma-same-image} Let $k$ be a field, and let $R$, $S$ be $k$-algebras. Let $S' \subset S$ be a sub $k$-algebra, and let $f \in S' \otimes_k R$. In the commutative diagram $$ \xymatrix{ \Spec((S \otimes_k R)_f) \ar[rd] \ar[rr] & & \Spec((S' \otimes_k R)_f) \ar[ld] \\ & \Spec(R) & } $$ the images of the diagonal arrows are the same.

\begin{lemma} \label{lemma-map-into-tensor-algebra-open} Let $k$ be a field. Let $R$ and $S$ be $k$-algebras. The map $\Spec(S \otimes_k R) \to \Spec(R)$ is open.

\begin{lemma} \label{lemma-unique-prime-over-localize-below} Let $R \to S$ be a ring map. Let $\mathfrak p \subset R$ be a prime. Assume that \begin{enumerate} \item there exists a unique prime $\mathfrak q \subset S$ lying over $\mathfrak p$, and \item either \begin{enumerate} \item going up holds for $R \to S$, or \item going down holds for $R \to S$ and there is at most one prime of $S$ above every prime of $R$. \end{enumerate} \end{enumerate} Then $S_{\mathfrak p} = S_{\mathfrak q}$.

\begin{lemma} \label{lemma-going-down-flat-module} Let $R \to S$ be a ring map. Let $N$ be a finite $S$-module flat over $R$. Endow $\text{Supp}(N) \subset \Spec(S)$ with the induced topology. Then generalizations lift along $\text{Supp}(N) \to \Spec(R)$.

\begin{definition} \label{definition-separable-field-extension} Let $k \subset K$ be a field extension. \begin{enumerate} \item We say $K$ is {\it separably generated over $k$} if there exists a transcendence basis $\{x_i; i \in I\}$ of $K/k$ such that the extension $k(x_i; i\in I) \subset K$ is a separable algebraic extension. \item We say $K$ is {\it separable over $k$} if for every subextension $k \subset K' \subset K$ with $K'$ finitely generated over $k$, the extension $k \subset K'$ is separably generated. \end{enumerate}

\begin{lemma} \label{lemma-subextensions-are-separable} Let $k \subset K$ be a separable field extension. For any subextension $k \subset K' \subset K$ the field extension $k \subset K'$ is separable.

\begin{lemma} \label{lemma-generating-finitely-generated-separable-field-extensions} Let $k \subset K$ be a separably generated, and finitely generated field extension. Set $r = \text{trdeg}_k(K)$. Then there exist elements $x_1, \ldots, x_{r + 1}$ of $K$ such that \begin{enumerate} \item $x_1, \ldots, x_r$ is a transcendence basis of $K$ over $k$, \item $K = k(x_1, \ldots, x_{r + 1})$, and \item $x_{r + 1}$ is separable over $k(x_1, \ldots, x_r)$. \end{enumerate}

\begin{lemma} \label{lemma-make-separably-generated} Let $k \subset K$ be a finitely generated field extension. There exists a diagram $$ \xymatrix{ K \ar[r] & K' \\ k \ar[u] \ar[r] & k' \ar[u] } $$ where $k \subset k'$, $K \subset K'$ are finite purely inseparable field extensions such that $k' \subset K'$ is a separably generated field extension.

\begin{definition} \label{definition-geometrically-reduced} Let $k$ be a field. Let $S$ be a $k$-algebra. We say $S$ is {\it geometrically reduced over $k$} if for every field extension $k \subset K$ the $K$-algebra $K \otimes_k S$ is reduced.

\begin{lemma} \label{lemma-subalgebra-separable} Elementary properties of geometrically reduced algebras. Let $k$ be a field. Let $S$ be a $k$-algebra. \begin{enumerate} \item If $S$ is geometrically reduced over $k$ so is every $k$-subalgebra. \item If all finitely generated $k$-subalgebras of $S$ are geometrically reduced, then $S$ is geometrically reduced. \item A directed colimit of geometrically reduced $k$-algebras is geometrically reduced. \item If $S$ is geometrically reduced over $k$, then any localization of $S$ is geometrically reduced over $k$. \end{enumerate}

\begin{lemma} \label{lemma-geometrically-reduced-permanence} Let $k$ be a field. If $R$ is geometrically reduced over $k$, and $S \subset R$ is a multiplicative subset, then the localization $S^{-1}R$ is geometrically reduced over $k$. If $R$ is geometrically reduced over $k$, then $R[x]$ is geometrically reduced over $k$.

\begin{lemma} \label{lemma-limit-argument} Let $k$ be a field. Let $R$, $S$ be $k$-algebras. \begin{enumerate} \item If $R \otimes_k S$ is nonreduced, then there exist finitely generated subalgebras $R' \subset R$, $S' \subset S$ such that $R' \otimes_k S'$ is not reduced. \item If $R \otimes_k S$ contains a nonzero zerodivisor, then there exist finitely generated subalgebras $R' \subset R$, $S' \subset S$ such that $R' \otimes_k S'$ contains a nonzero zerodivisor. \item If $R \otimes_k S$ contains a nontrivial idempotent, then there exist finitely generated subalgebras $R' \subset R$, $S' \subset S$ such that $R' \otimes_k S'$ contains a nontrivial idempotent. \end{enumerate}

\begin{lemma} \label{lemma-geometrically-reduced-any-reduced-base-change} Let $k$ be a field. Let $S$ be a geometrically reduced $k$-algebra. Let $R$ be any reduced $k$-algebra. Then $R \otimes_k S$ is reduced.

\begin{lemma} \label{lemma-separable-extension-preserves-reducedness} Let $k$ be a field. Let $S$ be a reduced $k$-algebra. Let $k \subset K$ be either a separable field extension, or a separably generated field extension. Then $K \otimes_k S$ is reduced.

\begin{lemma} \label{lemma-generic-points-geometrically-reduced} Let $k$ be a field and let $S$ be a $k$-algebra. Assume that $S$ is reduced and that $S_{\mathfrak p}$ is geometrically reduced for every minimal prime $\mathfrak p$ of $S$. Then $S$ is geometrically reduced.

\begin{lemma} \label{lemma-separable-algebraic-diagonal} Let $k'/k$ be a separable algebraic extension. Then there exists a multiplicative subset $S \subset k' \otimes_k k'$ such that the multiplication map $k' \otimes_k k' \to k'$ is identified with $k' \otimes_k k' \to S^{-1}(k' \otimes_k k')$.

\begin{lemma} \label{lemma-geometrically-reduced-over-separable-algebraic} Let $k \subset k'$ be a separable algebraic field extension. Let $A$ be an algebra over $k'$. Then $A$ is geometrically reduced over $k$ if and only if it is geometrically reduced over $k'$.

\begin{lemma} \label{lemma-characterize-separable-field-extensions} Let $k$ be a field of characteristic $p > 0$. Let $k \subset K$ be a field extension. The following are equivalent: \begin{enumerate} \item $K$ is separable over $k$, \item the ring $K \otimes_k k^{1/p}$ is reduced, and \item $K$ is geometrically reduced over $k$. \end{enumerate}

\begin{lemma} \label{lemma-separably-generated-separable} A separably generated field extension is separable.

\begin{lemma} \label{lemma-geometrically-reduced-finite-purely-inseparable-extension} Let $k$ be a field. Let $S$ be a $k$-algebra. The following are equivalent: \begin{enumerate} \item $k' \otimes_k S$ is reduced for every finite purely inseparable extension $k'$ of $k$, \item $k^{1/p} \otimes_k S$ is reduced, \item $k^{perf} \otimes_k S$ is reduced, where $k^{perf}$ is the perfect closure of $k$, \item $\overline{k} \otimes_k S$ is reduced, where $\overline{k}$ is the algebraic closure of $k$, and \item $S$ is geometrically reduced over $k$. \end{enumerate}

\begin{definition} \label{definition-perfect} Let $k$ be a field. We say $k$ is {\it perfect} if every field extension of $k$ is separable over $k$.

\begin{lemma} \label{lemma-perfect} A field $k$ is perfect if and only if it is a field of characteristic $0$ or a field of characteristic $p > 0$ such that every element has a $p$th root.

\begin{lemma} \label{lemma-make-separable} Let $k \subset K$ be a finitely generated field extension. There exists a diagram $$ \xymatrix{ K \ar[r] & K' \\ k \ar[u] \ar[r] & k' \ar[u] } $$ where $k \subset k'$, $K \subset K'$ are finite purely inseparable field extensions such that $k' \subset K'$ is a separable field extension. In this situation we can assume that $K' = k'K$ is the compositum, and also that $K' = (k' \otimes_k K)_{red}$.

\begin{lemma} \label{lemma-perfection} \begin{slogan} Every field has a unique perfect closure. \end{slogan} For every field $k$ there exists a purely inseparable extension $k \subset k'$ such that $k'$ is perfect. The field extension $k \subset k'$ is unique up to unique isomorphism.

\begin{definition} \label{definition-perfection} Let $k$ be a field. The field extension $k \subset k'$ of Lemma \ref{lemma-perfection} is called the {\it perfect closure} of $k$. Notation $k \subset k^{perf}$.

\begin{lemma} \label{lemma-perfect-reduced} Let $k$ be a perfect field. Any reduced $k$ algebra is geometrically reduced over $k$. Let $R$, $S$ be $k$-algebras. Assume both $R$ and $S$ are reduced. Then the $k$-algebra $R \otimes_k S$ is reduced.

\begin{lemma} \label{lemma-surjective-locally-nilpotent-kernel} Let $\varphi : R \to S$ be a surjective map with locally nilpotent kernel. Then $\varphi$ induces a homeomorphism of spectra and isomorphisms on residue fields. For any ring map $R \to R'$ the ring map $R' \to R' \otimes_R S$ is surjective with locally nilpotent kernel.

\begin{lemma} \label{lemma-powers-field} \begin{reference} \cite[Lemma 3.1.6]{Alper-adequate} \end{reference} Let $k \subset k'$ be a field extension. The following are equivalent \begin{enumerate} \item for each $x \in k'$ there exists an $n > 0$ such that $x^n \in k$, and \item $k' = k$, or $k'/k$ is a purely inseparable extension of fields, or $k$ and $k'$ have characteristic $p > 0$ and are algebraic extensions of $\mathbf{F}_p$. \end{enumerate}

\begin{lemma} \label{lemma-powers} Let $\varphi : R \to S$ be a ring map. If \begin{enumerate} \item for any $x \in S$ there exists $n > 0$ such that $x^n$ is in the image of $\varphi$, and \item $\Ker(\varphi)$ is locally nilpotent, \end{enumerate} then $\varphi$ induces a homeomorphism on spectra and induces residue field extensions satisfying the equivalent conditions of Lemma \ref{lemma-powers-field}.

\begin{lemma} \label{lemma-help-with-powers} Let $p$ be a prime number. Let $n, m > 0$ be two integers. There exists an integer $a$ such that $(x + y)^{p^a}, p^a(x + y) \in \mathbf{Z}[x^{p^n}, p^nx, y^{p^m}, p^my]$.

\begin{lemma} \label{lemma-p-ring-map-field} Let $k \subset k'$ be a field extension. Let $p$ be a prime number. The following are equivalent \begin{enumerate} \item $k'$ is generated as a field extension of $k$ by elements $x$ such that there exists an $n > 0$ with $x^{p^n} \in k$ and $p^nx \in k$, and \item $k = k'$ or the characteristic of $k$ and $k'$ is $p$ and $k'/k$ is purely inseparable. \end{enumerate}

\begin{lemma} \label{lemma-p-ring-map} Let $\varphi : R \to S$ be a ring map. Let $p$ be a prime number. Assume \begin{enumerate} \item[(a)] $S$ is generated as an $R$-algebra by elements $x$ such that there exists an $n > 0$ with $x^{p^n} \in \varphi(R)$ and $p^nx \in \varphi(R)$, and \item[(b)] $\Ker(\varphi)$ is locally nilpotent, \end{enumerate} Then $\varphi$ induces a homeomorphism of spectra and induces residue field extensions satisfying the equivalent conditions of Lemma \ref{lemma-p-ring-map-field}. For any ring map $R \to R'$ the ring map $R' \to R' \otimes_R S$ also satisfies (a) and (b).

\begin{lemma} \label{lemma-radicial} Let $\varphi : R \to S$ be a ring map. Assume \begin{enumerate} \item $\varphi$ induces an injective map of spectra, \item $\varphi$ induces purely inseparable residue field extensions. \end{enumerate} Then for any ring map $R \to R'$ properties (1) and (2) are true for $R' \to R' \otimes_R S$.

\begin{lemma} \label{lemma-radicial-integral} Let $\varphi : R \to S$ be a ring map. Assume \begin{enumerate} \item $\varphi$ is integral, \item $\varphi$ induces an injective map of spectra, \item $\varphi$ induces purely inseparable residue field extensions. \end{enumerate} Then $\varphi$ induces a homeomorphism from $\Spec(S)$ onto a closed subset of $\Spec(R)$ and for any ring map $R \to R'$ properties (1), (2), (3) are true for $R' \to R' \otimes_R S$.

\begin{lemma} \label{lemma-radicial-integral-bijective} Let $\varphi : R \to S$ be a ring map. Assume \begin{enumerate} \item $\varphi$ is integral, \item $\varphi$ induces an bijective map of spectra, \item $\varphi$ induces purely inseparable residue field extensions. \end{enumerate} Then $\varphi$ induces a homeomorphism on spectra and for any ring map $R \to R'$ properties (1), (2), (3) are true for $R' \to R' \otimes_R S$.

\begin{lemma} \label{lemma-universally-bijective} Let $\varphi : R \to S$ be a ring map such that \begin{enumerate} \item the kernel of $\varphi$ is locally nilpotent, and \item $S$ is generated as an $R$-algebra by elements $x$ such that there exist $n > 0$ and a polynomial $P(T) \in R[T]$ whose image in $S[T]$ is $(T - s)^n$. \end{enumerate} Then $\Spec(S) \to \Spec(R)$ is a homeomorphism and $R \to S$ induces purely inseparable extensions of residue fields. Moreover, conditions (1) and (2) remain true on arbitrary base change.

\begin{lemma} \label{lemma-flat-fibres-irreducible} Let $R \to S$ be a ring map. Assume \begin{enumerate} \item[(a)] $\Spec(R)$ is irreducible, \item[(b)] $R \to S$ is flat, \item[(c)] $R \to S$ is of finite presentation, \item[(d)] the fibre rings $S \otimes_R \kappa(\mathfrak p)$ have irreducible spectra for a dense collection of primes $\mathfrak p$ of $R$. \end{enumerate} Then $\Spec(S)$ is irreducible. This is true more generally with (b) $+$ (c) replaced by ``the map $\Spec(S) \to \Spec(R)$ is open''.

\begin{lemma} \label{lemma-separably-closed-irreducible} Let $k$ be a separably algebraically closed field. Let $R$, $S$ be $k$-algebras. If $R$, $S$ have a unique minimal prime, so does $R \otimes_k S$.

\begin{lemma} \label{lemma-geometrically-irreducible} Let $k$ be a field. Let $R$ be a $k$-algebra. The following are equivalent \begin{enumerate} \item for every field extension $k \subset k'$ the spectrum of $R \otimes_k k'$ is irreducible, and \item for every finite separable field extension $k \subset k'$ the spectrum of $R \otimes_k k'$ is irreducible. \end{enumerate}

\begin{definition} \label{definition-geometrically-irreducible} Let $k$ be a field. Let $S$ be a $k$-algebra. We say $S$ is {\it geometrically irreducible over $k$} if for every field extension $k \subset k'$ the spectrum of $S \otimes_k k'$ is irreducible\footnote{An irreducible space is nonempty.}.

\begin{lemma} \label{lemma-separably-closed-irreducible-implies-geometric} Let $k$ be a field. Let $R$ be a $k$-algebra. If $k$ is separably algebraically closed then $R$ is geometrically irreducible over $k$ if and only if the spectrum of $R$ is irreducible.

\begin{lemma} \label{lemma-subalgebra-geometrically-irreducible} Let $k$ be a field. Let $S$ be a $k$-algebra. \begin{enumerate} \item If $S$ is geometrically irreducible over $k$ so is every $k$-subalgebra. \item If all finitely generated $k$-subalgebras of $S$ are geometrically irreducible, then $S$ is geometrically irreducible. \item A directed colimit of geometrically irreducible $k$-algebras is geometrically irreducible. \end{enumerate}

\begin{lemma} \label{lemma-geometrically-irreducible-any-base-change} Let $k$ be a field. Let $S$ be a geometrically irreducible $k$-algebra. Let $R$ be any $k$-algebra. The map $$ \Spec(R \otimes_k S) \longrightarrow \Spec(R) $$ induces a bijection on irreducible components.

\begin{lemma} \label{lemma-field-extension-geometrically-irreducible} Let $k \subset K$ be a field extension. If $k$ is algebraically closed in $K$, then $K$ is geometrically irreducible over $k$.

\begin{lemma} \label{lemma-make-geometrically-irreducible} Let $k \subset K$ be a field extension. Consider the subextension $k \subset k' \subset K$ such that $k \subset k'$ is separable algebraic and $k' \subset K$ maximal with this property. Then $K$ is geometrically irreducible over $k'$. If $K/k$ is a finitely generated field extension, then $[k' : k] < \infty$.

\begin{lemma} \label{lemma-Galois-orbit} Let $k \subset K$ be an extension of fields. Let $k \subset \overline{k}$ be a separable algebraic closure. Then $\text{Gal}(\overline{k}/k)$ acts transitively on the primes of $\overline{k} \otimes_k K$.

\begin{lemma} \label{lemma-separably-closed-connected} Let $k$ be a separably algebraically closed field. Let $R$, $S$ be $k$-algebras. If $\Spec(R)$, and $\Spec(S)$ are connected, then so is $\Spec(R \otimes_k S)$.

\begin{lemma} \label{lemma-geometrically-connected} Let $k$ be a field. Let $R$ be a $k$-algebra. The following are equivalent \begin{enumerate} \item for every field extension $k \subset k'$ the spectrum of $R \otimes_k k'$ is connected, and \item for every finite separable field extension $k \subset k'$ the spectrum of $R \otimes_k k'$ is connected. \end{enumerate}

\begin{definition} \label{definition-geometrically-connected} Let $k$ be a field. Let $S$ be a $k$-algebra. We say $S$ is {\it geometrically connected over $k$} if for every field extension $k \subset k'$ the spectrum of $S \otimes_k k'$ is connected.

\begin{lemma} \label{lemma-separably-closed-connected-implies-geometric} Let $k$ be a field. Let $R$ be a $k$-algebra. If $k$ is separably algebraically closed then $R$ is geometrically connected over $k$ if and only if the spectrum of $R$ is connected.

\begin{lemma} \label{lemma-subalgebra-geometrically-connected} Let $k$ be a field. Let $S$ be a $k$-algebra. \begin{enumerate} \item If $S$ is geometrically connected over $k$ so is every $k$-subalgebra. \item If all finitely generated $k$-subalgebras of $S$ are geometrically connected, then $S$ is geometrically connected. \item A directed colimit of geometrically connected $k$-algebras is geometrically connected. \end{enumerate}

\begin{lemma} \label{lemma-geometrically-connected-any-base-change} Let $k$ be a field. Let $S$ be a geometrically connected $k$-algebra. Let $R$ be any $k$-algebra. The map $$ R \longrightarrow R \otimes_k S $$ induces a bijection on idempotents, and the map $$ \Spec(R \otimes_k S) \longrightarrow \Spec(R) $$ induces a bijection on connected components.

\begin{definition} \label{definition-geometrically-integral} Let $k$ be a field. Let $S$ be a $k$-algebra. We say $S$ is {\it geometrically integral over $k$} if for every field extension $k \subset k'$ the ring of $S \otimes_k k'$ is a domain.

\begin{lemma} \label{lemma-geometrically-integral} Let $k$ be a field. Let $S$ be a $k$-algebra. In this case $S$ is geometrically integral over $k$ if and only if $S$ is geometrically irreducible as well as geometrically reduced over $k$.

\begin{lemma} \label{lemma-geometrically-integral-any-integral-base-change} Let $k$ be a field. Let $S$ be a geometrically integral $k$-algebra. Let $R$ be a $k$-algebra and an integral domain. Then $R \otimes_k S$ is an integral domain.

\begin{definition} \label{definition-valuation-ring} Valuation rings. \begin{enumerate} \item Let $K$ be a field. Let $A$, $B$ be local rings contained in $K$. We say that $B$ {\it dominates} $A$ if $A \subset B$ and $\mathfrak m_A = A \cap \mathfrak m_B$. \item Let $A$ be a ring. We say $A$ is a {\it valuation ring} if $A$ is a local domain and if $A$ is maximal for the relation of domination among local rings contained in the fraction field of $A$. \item Let $A$ be a valuation ring with fraction field $K$. If $R \subset K$ is a subring of $K$, then we say $A$ is {\it centered} on $R$ if $R \subset A$. \end{enumerate}

\begin{lemma} \label{lemma-dominate} Let $K$ be a field. Let $A \subset K$ be a local subring. Then there exists a valuation ring with fraction field $K$ dominating $A$.

\begin{lemma} \label{lemma-valuation-ring-x-or-x-inverse} Let $A$ be a valuation ring with maximal ideal $\mathfrak m$ and fraction field $K$. Let $x \in K$. Then either $x \in A$ or $x^{-1} \in A$ or both.

\begin{lemma} \label{lemma-x-or-x-inverse-valuation-ring} Let $A \subset K$ be a subring of a field $K$ such that for all $x \in K$ either $x \in A$ or $x^{-1} \in A$ or both. Then $A$ is a valuation ring with fraction field $K$.

\begin{lemma} \label{lemma-colimit-valuation-rings} Let $I$ be a directed set. Let $(A_i, \varphi_{ij})$ be a system of valuation rings over $I$ whose transition maps $\varphi_{ij}$ are local. Then $A = \colim A_i$ is a valuation ring.

\begin{lemma} \label{lemma-valuation-ring-cap-field} Let $K \subset L$ be an extension of fields. If $B \subset L$ is a valuation ring, then $A = K \cap B$ is a valuation ring.

\begin{lemma} \label{lemma-valuation-ring-cap-field-finite} Let $K \subset L$ be an algebraic extension of fields. If $B \subset L$ is a valuation ring with fraction field $L$ and not a field, then $A = K \cap B$ is a valuation ring and not a field.

\begin{lemma} \label{lemma-make-valuation-rings} Let $A$ be a valuation ring. For any prime ideal $\mathfrak p \subset A$ the quotient $A/\mathfrak p$ is a valuation ring. The same is true for the localization $A_\mathfrak p$ and in fact any localization of $A$.

\begin{lemma} \label{lemma-stack-valuation-rings} Let $A'$ be a valuation ring with residue field $K$. Let $A$ be a valuation ring with fraction field $K$. Then $C = \{\lambda \in A' \mid \lambda \bmod \mathfrak m_{A'} \in A\}$ is a valuation ring.

\begin{lemma} \label{lemma-valuation-ring-normal} Let $A$ be a valuation ring. Then $A$ is a normal domain.

\begin{lemma} \label{lemma-find-valuation-rings} Let $A$ be a normal domain with fraction field $K$. For every $x \in K$, $x \not \in A$ there exists a valuation ring $A \subset V \subset K$ with fraction field $K$ such that $x \not \in V$. In other words, $A$ is the intersection of all valuation rings in $K$ containing $A$.

\begin{lemma} \label{lemma-valuation-group} Let $A$ be a valuation ring with field of fractions $K$. Set $\Gamma = K^*/A^*$ (with group law written additively). For $\gamma, \gamma' \in \Gamma$ define $\gamma \geq \gamma'$ if and only if $\gamma - \gamma'$ is in the image of $A - \{0\} \to \Gamma$. Then $(\Gamma, \geq)$ is a totally ordered abelian group.

\begin{definition} \label{definition-value-group} Let $A$ be a valuation ring. \begin{enumerate} \item The totally ordered abelian group $(\Gamma, \geq)$ of Lemma \ref{lemma-valuation-group} is called the {\it value group} of the valuation ring $A$. \item The map $v : A - \{0\} \to \Gamma$ and also $v : K^* \to \Gamma$ is called the {\it valuation} associated to $A$. \item The valuation ring $A$ is called a {\it discrete valuation ring} if $\Gamma \cong \mathbf{Z}$. \end{enumerate}

\begin{lemma} \label{lemma-properties-valuation} Let $A$ be a valuation ring. The valuation $v : A -\{0\} \to \Gamma_{\geq 0}$ has the following properties: \begin{enumerate} \item $v(a) = 0 \Leftrightarrow a \in A^*$, \item $v(ab) = v(a) + v(b)$, \item $v(a + b) \geq \text{min}(v(a), v(b))$. \end{enumerate}

\begin{lemma} \label{lemma-characterize-valuation-ring} Let $A$ be a ring. The following are equivalent \begin{enumerate} \item $A$ is a valuation ring, \item $A$ is a local domain and every finitely generated ideal of $A$ is principal. \end{enumerate}

\begin{lemma} \label{lemma-valuation-valuation-ring} Let $(\Gamma, \geq)$ be a totally ordered abelian group. Let $K$ be a field. Let $v : K^* \to \Gamma$ be a homomorphism of abelian groups such that $v(a + b) \geq \min(v(a), v(b))$ for $a, b \in K$ with $a, b, a + b$ not zero. Then $$ A = \{ x \in K \mid x = 0 \text{ or } v(x) \geq 0 \} $$ is a valuation ring with value group $\Im(v) \subset \Gamma$, with maximal ideal $$ \mathfrak m = \{ x \in K \mid x = 0 \text{ or } v(x) > 0 \} $$ and with group of units $$ A^* = \{ x \in K^* \mid v(x) = 0 \}. $$

\begin{lemma} \label{lemma-ideals-valuation-ring} Let $A$ be a valuation ring. Ideals in $A$ correspond $1 - 1$ with ideals of $\Gamma$. This bijection is inclusion preserving, and maps prime ideals to prime ideals.

\begin{lemma} \label{lemma-valuation-ring-Noetherian-discrete} A valuation ring is Noetherian if and only if it is a discrete valuation ring or a field.

\begin{lemma} \label{lemma-Noetherian-basic} Let $R$ be a Noetherian ring. Any finite $R$-module is of finite presentation. Any submodule of a finite $R$-module is finite. The ascending chain condition holds for $R$-submodules of a finite $R$-module.



\begin{lemma} \label{lemma-map-AR} Suppose that $0 \to K \to M \xrightarrow{f} N$ is an exact sequence of finitely generated modules over a Noetherian ring $R$. Let $I \subset R$ be an ideal. Then there exists a $c$ such that $$ f^{-1}(I^nN) = K + I^{n-c}f^{-1}(I^cN) \quad\text{and}\quad f(M) \cap I^nN \subset f(I^{n - c}M) $$ for all $n \geq c$.



\begin{lemma} \label{lemma-intersection-powers-ideal-module} Let $R$ be a Noetherian ring. Let $I \subset R$ be an ideal. Let $M$ be a finite $R$-module. Let $N = \bigcap_n I^n M$. \begin{enumerate} \item For every prime $\mathfrak p$, $I \subset \mathfrak p$ there exists a $f \in R$, $f \not \in \mathfrak p$ such that $N_f = 0$. \item If $I \subset \text{rad}(R)$ is contained in the Jacobson radical of $R$, then $N = 0$. \end{enumerate}



\begin{definition} \label{definition-length} Let $R$ be a ring. For any $R$-module $M$ we define the {\it length} of $M$ over $R$ by the formula $$ \text{length}_R(M) = \sup \{ n \mid \exists\ 0 = M_0 \subset M_1 \subset \ldots \subset M_n = M, \text{ }M_i \not = M_{i + 1} \}. $$

\begin{lemma} \label{lemma-finite-length-finite} \begin{slogan} Modules of finite length are finite. \end{slogan} Let $R$ be a ring. Let $M$ be an $R$-module. If $\text{length}_R(M) < \infty$ then $M$ is a finite $R$-module.

\begin{lemma} \label{lemma-length-additive} If $0 \to M' \to M \to M'' \to 0$ is a short exact sequence of modules over $R$ then the length of $M$ is the sum of the lengths of $M'$ and $M''$.

\begin{lemma} \label{lemma-length-infinite} Let $R$ be a local ring with maximal ideal $\mathfrak m$. Let $M$ be an $R$-module. \begin{enumerate} \item If $M$ is a finite module and $\mathfrak m^n M \not = 0$ for all $n\geq 0$, then $\text{length}_R(M) = \infty$. \item If $M$ has finite length then $\mathfrak m^nM = 0$ for some $n$. \end{enumerate}

\begin{lemma} \label{lemma-length-independent} Let $R \to S$ be a ring map. Let $M$ be an $S$-module. We always have $\text{length}_R(M) \geq \text{length}_S(M)$. If $R \to S$ is surjective then equality holds.

\begin{lemma} \label{lemma-dimension-is-length} Let $R$ be a ring with maximal ideal $\mathfrak m$. Suppose that $M$ is an $R$-module with $\mathfrak m M  =  0$. Then the length of $M$ as an $R$-module agrees with the dimension of $M$ as a $R/\mathfrak m$ vector space. The length is finite if and only if $M$ is a finite $R$-module.

\begin{lemma} \label{lemma-length-localize} Let $R$ be a ring. Let $M$ be an $R$-module. Let $S \subset R$ be a multiplicative subset. Then $\text{length}_R(M) \geq \text{length}_{S^{-1}R}(S^{-1}M)$.

\begin{lemma} \label{lemma-length-finite} Let $R$ be a ring with finitely generated maximal ideal $\mathfrak m$. (For example $R$ Noetherian.) Suppose that $M$ is a finite $R$-module with $\mathfrak m^n M  =  0$ for some $n$. Then $\text{length}_R(M) < \infty$.

\begin{definition} \label{definition-simple-module} Let $R$ be a ring. Let $M$ be an $R$-module. We say $M$ is {\it simple} if $M \not = 0$ and every submodule of $M$ is either equal to $M$ or to $0$.

\begin{lemma} \label{lemma-characterize-length-1} Let $R$ be a ring. Let $M$ be an $R$-module. The following are equivalent: \begin{enumerate} \item $M$ is simple, \item $\text{length}_R(M) = 1$, and \item $M \cong R/\mathfrak m$ for some maximal ideal $\mathfrak m \subset R$. \end{enumerate}

\begin{lemma} \label{lemma-simple-pieces} Let $R$ be a ring. Let $M$ be a finite length $R$-module. Let $\ell = \text{length}_R(M)$. Choose any maximal chain of submodules $$ 0 = M_0 \subset M_1 \subset M_2 \subset \ldots \subset M_n = M $$ with $M_i \not = M_{i-1}$, $i = 1, \ldots, n$. Then \begin{enumerate} \item $n = \ell$, \item each $M_i/M_{i-1}$ is simple, \item each $M_i/M_{i-1}$ is of the form $R/\mathfrak m_i$ for some maximal ideal $\mathfrak m_i$, \item given a maximal ideal $\mathfrak m \subset R$ we have $$ \# \{i \mid \mathfrak m_i = \mathfrak m\} = \text{length}_{R_{\mathfrak m}} (M_{\mathfrak m}). $$ \end{enumerate}

\begin{lemma} \label{lemma-pushdown-module} Let $A$ be a local ring with maximal ideal $\mathfrak m$. Let $B$ be a semi-local ring with maximal ideals $\mathfrak m_i$, $i = 1, \ldots, n$. Suppose that $A \to B$ is a homomorphism such that each $\mathfrak m_i$ lies over $\mathfrak m$ and such that $$ [\kappa(\mathfrak m_i) : \kappa(\mathfrak m)] < \infty. $$ Let $M$ be a $B$-module of finite length. Then $$ \text{length}_A(M) = \sum\nolimits_{i = 1, \ldots, n} [\kappa(\mathfrak m_i) : \kappa(\mathfrak m)] \text{length}_{B_{\mathfrak m_i}}(M_{\mathfrak m_i}), $$ in particular $\text{length}_A(M) < \infty$.

\begin{lemma} \label{lemma-pullback-module} Let $A \to B$ be a flat local homomorphism of local rings. Then for any $A$-module $M$ we have $$ \text{length}_A(M) \text{length}_B(B/\mathfrak m_AB) = \text{length}_B(M \otimes_A B). $$ In particular, if $\text{length}_B(B/\mathfrak m_AB) < \infty$ then $M$ has finite length if and only if $M \otimes_A B$ has finite length.

\begin{lemma} \label{lemma-pullback-transitive} Let $A \to B \to C$ be flat local homomorphisms of local rings. Then $$ \text{length}_B(B/\mathfrak m_A B) \text{length}_C(C/\mathfrak m_B C) = \text{length}_C(C/\mathfrak m_A C) $$

\begin{definition} \label{definition-artinian} A ring $R$ is {\it Artinian} if it satisfies the descending chain condition for ideals.

\begin{lemma} \label{lemma-finite-dimensional-algebra} Suppose $R$ is a finite dimensional algebra over a field. Then $R$ is Artinian.

\begin{lemma} \label{lemma-artinian-finite-nr-max} If $R$ is Artinian then $R$ has only finitely many maximal ideals.

\begin{lemma} \label{lemma-artinian-radical-nilpotent} Let $R$ be Artinian. The radical $\text{rad}(R)$ of $R$ is a nilpotent ideal.

\begin{lemma} \label{lemma-product-local} Any ring with finitely many maximal ideals and locally nilpotent radical is the product of its localizations at its maximal ideals. Also, all primes are maximal.

\begin{lemma} \label{lemma-artinian-finite-length} A ring $R$ is Artinian if and only if it has finite length as a module over itself. Any such ring $R$ is both Artinian and Noetherian, any prime ideal of $R$ is a maximal ideal, and $R$ is equal to the (finite) product of its localizations at its maximal ideals.

\begin{definition} \label{definition-essentially-finite-p-t} Let $R \to S$ be a ring map. \begin{enumerate} \item We say that $R \to S$ is {\it essentially of finite type} if $S$ is the localization of an $R$-algebra of finite type. \item We say that $R \to S$ is {\it essentially of finite presentation} if $S$ is the localization of an $R$-algebra of finite presentation. \end{enumerate}

\begin{lemma} \label{lemma-composition-essentially-of-finite-type} The class of ring maps which are essentially of finite type is preserved under composition. Similarly for essentially of finite presentation.

\begin{lemma} \label{lemma-base-change-essentially-of-finite-type} The class of ring maps which are essentially of finite type is preserved by base change. Similarly for essentially of finite presentation.

\begin{lemma} \label{lemma-essentially-of-finite-type-into-artinian-local} Let $R \to S$ be a ring map. Assume $S$ is an Artinian local ring with maximal ideal $\mathfrak m$. Then \begin{enumerate} \item $R \to S$ is finite if and only if $R \to S/\mathfrak m$ is finite, \item $R \to S$ is of finite type if and only if $R \to S/\mathfrak m$ is of finite type. \item $R \to S$ is essentially of finite type if and only if the composition $R \to S/\mathfrak m$ is essentially of finite type. \end{enumerate}

\begin{lemma} \label{lemma-localization-at-closed-point-special-fibre} Let $\varphi : R \to S$ be essentially of finite type with $R$ and $S$ local (but not necessarily $\varphi$ local). Then there exists an $n$ and a maximal ideal $\mathfrak m \subset R[x_1, \ldots, x_n]$ lying over $\mathfrak m_R$ such that $S$ is a localization of a quotient of $R[x_1, \ldots, x_n]_\mathfrak m$.

\begin{lemma} \label{lemma-length-K0} If $R$ is an Artinian local ring then the length function defines a natural abelian group homomorphism $\text{length}_R : K_0'(R) \to \mathbf{Z}$.

\begin{lemma} \label{lemma-K0-product} Let $R = R_1 \times R_2$. Then $K_0(R) = K_0(R_1) \times K_0(R_2)$ and $K_0'(R) = K_0'(R_1) \times K_0'(R_2)$

\begin{lemma} \label{lemma-K0prime-Artinian} Let $R$ be an Artinian local ring. The map $\text{length}_R : K_0'(R) \to \mathbf{Z}$ of Lemma \ref{lemma-length-K0} is an isomorphism.

\begin{lemma} \label{lemma-K0-local} Let $R$ be a local ring. Every finite projective $R$-module is finite free. The map $\text{rank}_R : K_0(R) \to \mathbf{Z}$ defined by $[M] \to \text{rank}_R(M)$ is well defined and an isomorphism.

\begin{lemma} \label{lemma-K0-and-K0prime-Artinian-local} Let $R$ be a local Artinian ring. There is a commutative diagram $$ \xymatrix{ K_0(R) \ar[rr] \ar[d]_{\text{rank}_R} & & K_0'(R) \ar[d]^{\text{length}_R} \\ \mathbf{Z} \ar[rr]^{\text{length}_R(R)} & & \mathbf{Z} } $$ where the vertical maps are isomorphisms by Lemmas \ref{lemma-K0prime-Artinian} and \ref{lemma-K0-local}.

\begin{lemma} \label{lemma-integral-closure-graded} Let $R \to S$ be a homomorphism of graded rings. Let $S' \subset S$ be the integral closure of $R$ in $S$. Then $$ S' = \bigoplus\nolimits_{d \geq 0} S' \cap S_d, $$ i.e., $S'$ is a graded $R$-subalgebra of $S$.

\begin{definition} \label{definition-proj} Let $S$ be a graded ring. We define $\text{Proj}(S)$ to be the set of homogeneous, prime ideals $\mathfrak p$ of $S$ such that $S_{+} \not \subset \mathfrak p$. As $\text{Proj}(S)$ is a subset of $\Spec(S)$ and we endow it with the induced topology. The topological space $\text{Proj}(S)$ is called the {\it homogeneous spectrum} of the graded ring $S$.

\begin{lemma} \label{lemma-Z-graded} Let $S$ be a $\mathbf{Z}$-graded ring containing a homogeneous invertible element of positive degree. Then the set $G \subset \Spec(S)$ of $\mathbf{Z}$-graded primes of $S$ (with induced topology) maps homeomorphically to $\Spec(S_0)$.



\begin{lemma} \label{lemma-proj-prime} Let $S$ be a graded ring. Let $M$ be a graded $S$-module. Let $\mathfrak p$ be an element of $\text{Proj}(S)$. Let $f \in S$ be a homogeneous element of positive degree such that $f \not \in \mathfrak p$, i.e., $\mathfrak p \in D_{+}(f)$. Let $\mathfrak p' \subset S_{(f)}$ be the element of $\Spec(S_{(f)})$ corresponding to $\mathfrak p$ as in Lemma \ref{lemma-topology-proj}. Then $S_{(\mathfrak p)} = (S_{(f)})_{\mathfrak p'}$ and compatibly $M_{(\mathfrak p)} = (M_{(f)})_{\mathfrak p'}$.

\begin{lemma} \label{lemma-graded-silly} Suppose $S$ is a graded ring, $\mathfrak p_i$, $i = 1, \ldots, r$ homogeneous prime ideals and $I \subset S_{+}$ a graded ideal. Assume $I \not\subset \mathfrak p_i$ for all $i$. Then there exists a homogeneous element $x\in I$ of positive degree such that $x\not\in \mathfrak p_i$ for all $i$.

\begin{lemma} \label{lemma-smear-out} Let $S$ be a graded ring. Let $\mathfrak p \subset S$ be a prime. Let $\mathfrak q$ be the homogeneous ideal of $S$ generated by the homogeneous elements of $\mathfrak p$. Then $\mathfrak q$ is a prime ideal of $S$.

\begin{lemma} \label{lemma-graded-ring-minimal-prime} Let $S$ be a graded ring. \begin{enumerate} \item Any minimal prime of $S$ is a homogeneous ideal of $S$. \item Given a homogeneous ideal $I \subset S$ any minimal prime over $I$ is homogeneous. \end{enumerate}

\begin{lemma} \label{lemma-dehomogenize-finite-type} Let $R$ be a ring. Let $S$ be a graded $R$-algebra. Assume that $S$ is of finite type over $R$. Then for every homogeneous $f \in S_{+}$ the ring $S_{(f)}$ is of finite type over $R$.

\begin{lemma} \label{lemma-homogenize} Let $R$ be a ring. Let $R'$ be a finite type $R$-algebra, and let $M$ be a finite $R'$-module. There exists a graded $R$-algebra $S$, a graded $S$-module $N$ and an element $f \in S$ homogeneous of degree $1$ such that \begin{enumerate} \item $R' \cong S_{(f)}$ and $M \cong N_{(f)}$ (as modules), \item $S_0 = R$ and $S$ is generated by finitely many elements of degree $1$ over $R$, and \item $N$ is a finite $S$-module. \end{enumerate}

\begin{lemma} \label{lemma-S-plus-generated} Let $S$ be a graded ring. A set of homogeneous elements $f_i \in S_{+}$ generates $S$ as an algebra over $S_0$ if and only if they generate $S_{+}$ as an ideal of $S$.

\begin{lemma} \label{lemma-graded-Noetherian} A graded ring $S$ is Noetherian if and only if $S_0$ is Noetherian and $S_{+}$ is finitely generated as an ideal of $S$.

\begin{definition} \label{definition-numerical-polynomial} Let $A$ be an abelian group. We say that a function $f : n \mapsto f(n) \in A$ defined for all sufficient large integers $n$ is a {\it numerical polynomial} if there exists $r \geq 0$, elements $a_0, \ldots, a_r\in A$ such that $$ f(n) = \sum\nolimits_{i = 0}^r \binom{n}{i} a_i $$ for all $n \gg 0$.

\begin{lemma} \label{lemma-numerical-polynomial-functorial} If $A \to A'$ is a homomorphism of abelian groups and if $f : n \mapsto f(n) \in A$ is a numerical polynomial, then so is the composition.

\begin{lemma} \label{lemma-numerical-polynomial} Suppose that $f: n \mapsto f(n) \in A$ is defined for all $n$ sufficiently large and suppose that $n \mapsto f(n) - f(n-1)$ is a numerical polynomial. Then $f$ is a numerical polynomial.

\begin{lemma} \label{lemma-graded-module-fg} If $M$ is a finitely generated graded $S$-module, and if $S$ is finitely generated over $S_0$, then each $M_n$ is a finite $S_0$-module.

\begin{lemma} \label{lemma-quotient-smaller-d} Let $k$ be a field. Suppose that $I \subset k[X_1, \ldots, X_d]$ is a nonzero graded ideal. Let $M = k[X_1, \ldots, X_d]/I$. Then the numerical polynomial $n \mapsto \dim_k(M_n)$ (see Example \ref{example-hilbert-function}) has degree $ < d - 1$ (or is zero if $d = 1$).

\begin{definition} \label{definition-ideal-definition} Let $(R, \mathfrak m)$ be a local Noetherian ring. An ideal $I \subset R$ such that $\sqrt{I} = \mathfrak m$ is called {\it an ideal of definition of $R$}.

\begin{lemma} \label{lemma-differ-finite} Suppose that $M' \subset M$ are finite $R$-modules with finite length quotient. Then there exists a constants $c_1, c_2$ such that for all $n \geq c_2$ we have $$ c_1 + \chi_{I, M'}(n - c_2) \leq \chi_{I, M}(n) \leq c_1 + \chi_{I, M'}(n) $$

\begin{lemma} \label{lemma-hilbert-ses} Suppose that $0 \to M' \to M \to M'' \to 0$ is a short exact sequence of finite $R$-modules. Then there exists a submodule $N \subset M'$ with finite colength $l$ and $c \geq 0$ such that $$ \chi_{I, M}(n) = \chi_{I, M''}(n) + \chi_{I, N}(n - c) + l $$ and $$ \varphi_{I, M}(n) = \varphi_{I, M''}(n) + \varphi_{I, N}(n - c) $$ for all $n \geq c$.

\begin{lemma} \label{lemma-hilbert-change-I} Suppose that $I$, $I'$ are two ideals of definition for the Noetherian local ring $R$. Let $M$ be a finite $R$-module. There exists a constant $a$ such that $\chi_{I, M}(n) \leq \chi_{I', M}(an)$ for $n \geq 1$.

\begin{definition} \label{definition-hilbert-polynomial} Let $R$ be a Noetherian local ring. Let $M$ be a finite $R$-module. The {\it Hilbert polynomial} of $M$ over $R$ is the element $P(t) \in \mathbf{Q}[t]$ such that $P(n) = \varphi_M(n)$ for $n \gg 0$.

\begin{lemma} \label{lemma-d-independent} Let $R$ be a Noetherian local ring. Let $M$ be a finite $R$-module. \begin{enumerate} \item The degree of the numerical polynomial $\varphi_{I, M}$ is independent of the ideal of definition $I$. \item The degree of the numerical polynomial $\chi_{I, M}$ is independent of the ideal of definition $I$. \end{enumerate}

\begin{definition} \label{definition-d} Let $R$ be a local Noetherian ring and $M$ a finite $R$-module. We denote {\it $d(M)$} the element of $\{-\infty, 0, 1, 2, \ldots \}$ defined as follows: \begin{enumerate} \item If $M = 0$ we set $d(M) = -\infty$, \item if $M \not = 0$ then $d(M)$ is the degree of the numerical polynomial $\chi_M$. \end{enumerate}

\begin{lemma} \label{lemma-differ-finite-chi} Let $R$ be a Noetherian local ring. Let $I \subset R$ be an ideal of definition. Let $M$ be a finite $R$-module which does not have finite length. If $M' \subset M$ is a submodule with finite colength, then $\chi_{I, M} - \chi_{I, M'}$ is a polynomial of degree $<$ degree of either polynomial.

\begin{lemma} \label{lemma-hilbert-ses-chi} Let $R$ be a Noetherian local ring. Let $I \subset R$ be an ideal of definition. Let $0 \to M' \to M \to M'' \to 0$ be a short exact sequence of finite $R$-modules. Then \begin{enumerate} \item if $M'$ does not have finite length, then $\chi_{I, M} - \chi_{I, M''} - \chi_{I, M'}$ is a numerical polynomial of degree $<$ the degree of $\chi_{I, M'}$, \item $\max\{ \deg(\chi_{I, M'}), \deg(\chi_{I, M''}) \} = \deg(\chi_{I, M})$, and \item $\max\{d(M'), d(M'')\} = d(M)$, \end{enumerate}

\begin{definition} \label{definition-Krull} The {\it Krull dimension} of the ring $R$ is the Krull dimension of the topological space $\Spec(R)$, see Topology, Definition \ref{topology-definition-Krull}. In other words it is the supremum of the integers $n\geq 0$ such that there exists a chain of prime ideals of length $n$: $$ \mathfrak p_0 \subset \mathfrak p_1 \subset \ldots \subset \mathfrak p_n, \quad \mathfrak p_i \not = \mathfrak p_{i + 1}. $$

\begin{definition} \label{definition-height} The {\it height} of a prime ideal $\mathfrak p$ of a ring $R$ is the dimension of the local ring $R_{\mathfrak p}$.

\begin{lemma} \label{lemma-dimension-height} The Krull dimension of $R$ is the supremum of the heights of its (maximal) primes.

\begin{lemma} \label{lemma-Noetherian-dimension-0} A Noetherian ring of dimension $0$ is Artinian. Conversely, any Artinian ring is Noetherian of dimension zero.

\begin{lemma} \label{lemma-dimension-0-d-0} Let $R$ be a Noetherian local ring. Then $\dim(R) = 0 \Leftrightarrow d(R) = 0$.

\begin{lemma} \label{lemma-height-1} Let $R$ be a local Noetherian ring. The following are equivalent: \begin{enumerate} \item \label{item-dim-1} $\dim(R) = 1$, \item \label{item-d-1} $d(R) = 1$, \item \label{item-Vx} there exists an $x \in \mathfrak m$, $x$ not nilpotent such that $V(x) = \{\mathfrak m\}$, \item \label{item-x} there exists an $x \in \mathfrak m$, $x$ not nilpotent such that $\mathfrak m = \sqrt{(x)}$, and \item \label{item-ideal-1} there exists an ideal of definition generated by $1$ element, and no ideal of definition is generated by $0$ elements. \end{enumerate}

\begin{definition} \label{definition-regular-local} Let $(R, \mathfrak m)$ be a Noetherian local ring of dimension $d$. \begin{enumerate} \item A {\it system of parameters of $R$} is a sequence of elements $x_1, \ldots, x_d \in \mathfrak m$ which generates an ideal of definition of $R$, \item if there exist $x_1, \ldots, x_d \in \mathfrak m$ such that $\mathfrak m = (x_1, \ldots, x_d)$ then we call $R$ a {\it regular local ring} and $x_1, \ldots, x_d$ a {\it regular system of parameters}. \end{enumerate}

\begin{lemma} \label{lemma-minimal-over-1} Let $R$ be a Noetherian ring. Let $x \in R$. \begin{enumerate} \item If $\mathfrak p$ is minimal over $(x)$ then the height of $\mathfrak p$ is $0$ or $1$. \item If $\mathfrak p, \mathfrak q \in \Spec(R)$ and $\mathfrak q$ is minimal over $(\mathfrak p, x)$, then there is no prime strictly between $\mathfrak p$ and $\mathfrak q$. \end{enumerate}

\begin{lemma} \label{lemma-minimal-over-r} Let $R$ be a Noetherian ring. Let $f_1, \ldots, f_r \in R$. \begin{enumerate} \item If $\mathfrak p$ is minimal over $(f_1, \ldots, f_r)$ then the height of $\mathfrak p$ is $\leq r$. \item If $\mathfrak p, \mathfrak q \in \Spec(R)$ and $\mathfrak q$ is minimal over $(\mathfrak p, f_1, \ldots, f_r)$, then every chain of primes between $\mathfrak p$ and $\mathfrak q$ has length at most $r$. \end{enumerate}

\begin{lemma} \label{lemma-one-equation} Suppose that $R$ is a Noetherian local ring and $x\in \mathfrak m$ an element of its maximal ideal. Then $\dim R \leq \dim R/xR + 1$. If $x$ is not contained in any of the minimal primes of $R$ then equality holds. (For example if $x$ is a nonzerodivisor.)

\begin{lemma} \label{lemma-elements-generate-ideal-definition} Let $(R, \mathfrak m)$ be a Noetherian local ring. Suppose $x_1, \ldots, x_d \in \mathfrak m$ generate an ideal of definition and $d = \dim(R)$. Then $\dim(R/(x_1, \ldots, x_i)) = d - i$ for all $i = 1, \ldots, d$.

\begin{lemma} \label{lemma-Noetherian-local-domain-dim-2-infinite-opens} Let $R$ be a Noetherian local domain of dimension $\geq 2$. A nonempty open subset $U \subset \Spec(R)$ is infinite.

\begin{lemma} \label{lemma-Noetherian-finite-nr-primes} A Noetherian ring with finitely many primes has dimension $\leq 1$.

\begin{lemma} \label{lemma-finite-type-algebra-finite-nr-primes} Let $S$ be a nonzero finite type algebra over a field $k$. Then $\dim(S) = 0$ if and only if $S$ has finitely many primes.

\begin{lemma} \label{lemma-noetherian-dim-1-Jacobson} Noetherian Jacobson rings. \begin{enumerate} \item Any Noetherian domain $R$ of dimension $1$ with infinitely many primes is Jacobson. \item Any Noetherian ring such that every prime $\mathfrak p$ is either maximal or contained in infinitely many prime ideals is Jacobson. \end{enumerate}

\begin{lemma} \label{lemma-filter-Noetherian-module} Let $R$ be a Noetherian ring, and let $M$ be a finite $R$-module. There exists a filtration by $R$-submodules $$ 0 = M_0 \subset M_1 \subset \ldots \subset M_n = M $$ such that each quotient $M_i/M_{i-1}$ is isomorphic to $R/\mathfrak p_i$ for some prime ideal $\mathfrak p_i$ of $R$.

\begin{lemma} \label{lemma-filter-primes-in-support} Let $R$, $M$, $M_i$, $\mathfrak p_i$ as in Lemma \ref{lemma-filter-Noetherian-module}. Then $\text{Supp}(M) = \bigcup V(\mathfrak p_i)$ and in particular $\mathfrak p_i \in \text{Supp}(M)$.

\begin{lemma} \label{lemma-support-point} Suppose that $R$ is a Noetherian local ring with maximal ideal $\mathfrak m$. Let $M$ be a nonzero finite $R$-module. Then $\text{Supp}(M) = \{ \mathfrak m\}$ if and only if $M$ has finite length over $R$.

\begin{lemma} \label{lemma-Noetherian-power-ideal-kills-module} Let $R$ be a Noetherian ring. Let $I \subset R$ be an ideal. Let $M$ be a finite $R$-module. Then $I^nM = 0$ for some $n \geq 0$ if and only if $\text{Supp}(M) \subset V(I)$.

\begin{lemma} \label{lemma-filter-minimal-primes-in-support} Let $R$, $M$, $M_i$, $\mathfrak p_i$ as in Lemma \ref{lemma-filter-Noetherian-module}. The minimal elements of the set $\{\mathfrak p_i\}$ are the minimal elements of $\text{Supp}(M)$. The number of times a minimal prime $\mathfrak p$ occurs is $$ \#\{i \mid \mathfrak p_i = \mathfrak p\} = \text{length}_{R_\mathfrak p} M_{\mathfrak p}. $$

\begin{lemma} \label{lemma-support-dimension-d} Let $R$ be a Noetherian local ring. Let $M$ be a finite $R$-module. Then $d(M) = \dim(\text{Supp}(M))$.

\begin{lemma} \label{lemma-ses-dimension} Let $R$ be a Noetherian ring. Let $0 \to M' \to M \to M'' \to 0$ be a short exact sequence of finite $R$-modules. Then $\max\{\dim(\text{Supp}(M')), \dim(\text{Supp}(M''))\} = \dim(\text{Supp}(M))$.

\begin{definition} \label{definition-associated} Let $R$ be a ring. Let $M$ be an $R$-module. A prime $\mathfrak p$ of $R$ is {\it associated} to $M$ if there exists an element $m \in M$ whose annihilator is $\mathfrak p$. The set of all such primes is denoted $\text{Ass}_R(M)$ or $\text{Ass}(M)$.

\begin{lemma} \label{lemma-ass-support} Let $R$ be a ring. Let $M$ be an $R$-module. Then $\text{Ass}(M) \subset \text{Supp}(M)$.

\begin{lemma} \label{lemma-ass} Let $R$ be a ring. Let $0 \to M' \to M \to M'' \to 0$ be a short exact sequence of $R$-modules. Then $\text{Ass}(M') \subset \text{Ass}(M)$ and $\text{Ass}(M) \subset \text{Ass}(M') \cup \text{Ass}(M'')$.

\begin{lemma} \label{lemma-ass-filter} Let $R$ be a ring, and $M$ an $R$-module. Suppose there exists a filtration by $R$-submodules $$ 0 = M_0 \subset M_1 \subset \ldots \subset M_n = M $$ such that each quotient $M_i/M_{i-1}$ is isomorphic to $R/\mathfrak p_i$ for some prime ideal $\mathfrak p_i$ of $R$. Then $\text{Ass}(M) \subset \{\mathfrak p_1, \ldots, \mathfrak p_n\}$.

\begin{lemma} \label{lemma-finite-ass} Let $R$ be a Noetherian ring. Let $M$ be a finite $R$-module. Then $\text{Ass}(M)$ is finite.

\begin{lemma} \label{lemma-ass-zero} \begin{slogan} Over a Noetherian ring each nonzero module has an associated prime. \end{slogan} Let $R$ be a Noetherian ring. Let $M$ be an $R$-module. Then $$ M = (0) \Leftrightarrow \text{Ass}(M) = \emptyset. $$

\begin{lemma} \label{lemma-ass-minimal-prime-support} Let $R$ be a Noetherian ring. Let $M$ be an $R$-module. Any $\mathfrak p \in \text{Supp}(M)$ which is minimal among the elements of $\text{Supp}(M)$ is an element of $\text{Ass}(M)$.

\begin{lemma} \label{lemma-ass-zero-divisors} Let $R$ be a Noetherian ring. Let $M$ be an $R$-module. The union $\bigcup_{\mathfrak q \in \text{Ass}(M)} \mathfrak q$ is the set of elements of $R$ which are zerodivisors on $M$.

\begin{lemma} \label{lemma-one-equation-module} Let $R$ is a Noetherian local ring, $M$ a finite $R$-module, and $f \in \mathfrak m$ an element of the maximal ideal of $R$. Then $$ \dim(\text{Supp}(M/fM)) \leq \dim(\text{Supp}(M)) \leq \dim(\text{Supp}(M/fM)) + 1 $$ If $f$ is not in any of the minimal primes of the support of $M$ (for example if $f$ is a nonzerodivisor on $M$), then equality holds for the right inequality.

\begin{lemma} \label{lemma-ass-functorial} Let $\varphi : R \to S$ be a ring map. Let $M$ be an $S$-module. Then $\Spec(\varphi)(\text{Ass}_S(M)) \subset \text{Ass}_R(M)$.

\begin{lemma} \label{lemma-ass-functorial-Noetherian} Let $\varphi : R \to S$ be a ring map. Let $M$ be an $S$-module. If $S$ is Noetherian, then $\Spec(\varphi)(\text{Ass}_S(M)) = \text{Ass}_R(M)$.

\begin{lemma} \label{lemma-ass-quotient-ring} Let $R$ be a ring. Let $I$ be an ideal. Let $M$ be an $R/I$-module. Via the canonical injection $\Spec(R/I) \to \Spec(R)$ we have $\text{Ass}_{R/I}(M) = \text{Ass}_R(M)$.

\begin{lemma} \label{lemma-associated-primes-localize} Let $R$ be a ring. Let $M$ be an $R$-module. Let $\mathfrak p \subset R$ be a prime. \begin{enumerate} \item If $\mathfrak p \in \text{Ass}(M)$ then $\mathfrak pR_{\mathfrak p} \in \text{Ass}(M_{\mathfrak p})$. \item If $\mathfrak p$ is finitely generated then the converse holds as well. \end{enumerate}

\begin{lemma} \label{lemma-localize-ass} Let $R$ be a ring. Let $M$ be an $R$-module. Let $S \subset R$ be a multiplicative subset. Via the canonical injection $\Spec(S^{-1}R) \to \Spec(R)$ we have \begin{enumerate} \item $\text{Ass}_R(S^{-1}M) = \text{Ass}_{S^{-1}R}(S^{-1}M)$, \item $\text{Ass}_R(M) \cap \Spec(S^{-1}R) \subset \text{Ass}_R(S^{-1}M)$, and \item if $R$ is Noetherian this inclusion is an equality. \end{enumerate}

\begin{lemma} \label{lemma-localize-ass-nonzero-divisors} Let $R$ be a ring. Let $M$ be an $R$-module. Let $S \subset R$ be a multiplicative subset. Assume that every $s \in S$ is a nonzerodivisor on $M$. Then $$ \text{Ass}_R(M) = \text{Ass}_R(S^{-1}M). $$

\begin{lemma} \label{lemma-ideal-nonzerodivisor} Let $R$ be a Noetherian local ring with maximal ideal $\mathfrak m$. Let $I \subset \mathfrak m$ be an ideal. Let $M$ be a finite $R$-module. The following are equivalent: \begin{enumerate} \item There exists an $x \in I$ which is not a zerodivisor on $M$. \item We have $I \not \subset \mathfrak q$ for all $\mathfrak q \in \text{Ass}(M)$. \end{enumerate}

\begin{lemma} \label{lemma-zero-at-ass-zero} Let $R$ be a ring. Let $M$ be an $R$-module. If $R$ is Noetherian the map $$ M \longrightarrow \prod\nolimits_{\mathfrak p \in \text{Ass}(M)} M_{\mathfrak p} $$ is injective.

\begin{definition} \label{definition-symbolic-power} Let $R$ be a ring. Let $\mathfrak p$ be a prime ideal. For $n \geq 0$ the $n$th {\it symbolic power} of $\mathfrak p$ is the ideal $\mathfrak p^{(n)} = \Ker(R \to R_\mathfrak p/\mathfrak p^nR_\mathfrak p)$.

\begin{lemma} \label{lemma-symbolic-power-associated} Let $R$ be a Noetherian ring. Let $\mathfrak p$ be a prime ideal. Let $n > 0$. Then $\text{Ass}(R/\mathfrak p^{(n)}) = \{\mathfrak p\}$.

\begin{lemma} \label{lemma-symbolic-power-flat-extension} Let $R \to S$ be flat ring map. Let $\mathfrak p \subset R$ be a prime such that $\mathfrak q = \mathfrak p S$ is a prime of $S$. Then $\mathfrak p^{(n)} S = \mathfrak q^{(n)}$.

\begin{lemma} \label{lemma-compare-relative-assassins} Let $R \to S$ be a ring map. Let $N$ be an $S$-module. Let $A$, $A'$, $A_{fin}$, $B$, and $B_{fin}$ be the subsets of $\Spec(S)$ introduced above. \begin{enumerate} \item We always have $A = A'$. \item We always have $A_{fin} \subset A$, $B_{fin} \subset B$, $A_{fin} \subset A'_{fin} \subset B_{fin}$ and $A \subset B$. \item If $S$ is Noetherian, then $A = A_{fin}$ and $B = B_{fin}$. \item If $N$ is flat over $R$, then $A = A_{fin} = A'_{fin}$ and $B = B_{fin}$. \item If $R$ is Noetherian and $N$ is flat over $R$, then all of the sets are equal, i.e., $A = A' = A_{fin} = A'_{fin} = B = B_{fin}$. \end{enumerate}

\begin{definition} \label{definition-relative-assassin} Let $R \to S$ be a ring map. Let $N$ be an $S$-module. The {\it relative assassin of $N$ over $S/R$} is the set $$ \text{Ass}_{S/R}(N) = \{ \mathfrak q \subset S \mid \mathfrak q \in \text{Ass}_S(N \otimes_R \kappa(\mathfrak p)) \text{ with }\mathfrak p = R \cap \mathfrak q\}. $$ This is the set named $A$ in Lemma \ref{lemma-compare-relative-assassins}.

\begin{lemma} \label{lemma-bourbaki} Let $R \to S$ be a ring map. Let $M$ be an $R$-module, and let $N$ be an $S$-module. If $N$ is flat as $R$-module, then $$ \text{Ass}_S(M \otimes_R N) \supset \bigcup\nolimits_{\mathfrak p \in \text{Ass}_R(M)} \text{Ass}_S(N/\mathfrak pN) $$ and if $R$ is Noetherian then we have equality.

\begin{lemma} \label{lemma-post-bourbaki} Let $R \to S$ be a ring map. Let $N$ be an $S$-module. Assume $N$ is flat as an $R$-module and $R$ is a domain with fraction field $K$. Then $$ \text{Ass}_S(N) = \text{Ass}_S(N \otimes_R K) = \text{Ass}_{S \otimes_R K}(N \otimes_R K) $$ via the canonical inclusion $\Spec(S \otimes_R K) \subset \Spec(S)$.

\begin{lemma} \label{lemma-bourbaki-fibres} Let $R \to S$ be a ring map. Let $M$ be an $R$-module, and let $N$ be an $S$-module. Assume $N$ is flat as $R$-module. Then $$ \text{Ass}_S(M \otimes_R N) \supset \bigcup\nolimits_{\mathfrak p \in \text{Ass}_R(M)} \text{Ass}_{S \otimes_R \kappa(\mathfrak p)}(N \otimes_R \kappa(\mathfrak p)) $$ where we use Remark \ref{remark-fundamental-diagram} to think of the spectra of fibre rings as subsets of $\Spec(S)$. If $R$ is Noetherian then this inclusion is an equality.

\begin{definition} \label{definition-weakly-associated} Let $R$ be a ring. Let $M$ be an $R$-module. A prime $\mathfrak p$ of $R$ is {\it weakly associated} to $M$ if there exists an element $m \in M$ such that $\mathfrak p$ is minimal among the prime ideals containing the annihilator $\text{Ann}(m) = \{f \in R \mid fm = 0\}$. The set of all such primes is denoted $\text{WeakAss}_R(M)$ or $\text{WeakAss}(M)$.

\begin{lemma} \label{lemma-weakly-ass-local} Let $R$ be a ring. Let $M$ be an $R$-module. Let $\mathfrak p$ be a prime of $R$. The following are equivalent: \begin{enumerate} \item $\mathfrak p$ is weakly associated to $M$, \item $\mathfrak pR_{\mathfrak p}$ is weakly associated to $M_{\mathfrak p}$, and \item $M_{\mathfrak p}$ contains an element whose annihilator has radical equal to $\mathfrak pR_{\mathfrak p}$. \end{enumerate}

\begin{lemma} \label{lemma-weakly-ass} Let $R$ be a ring. Let $0 \to M' \to M \to M'' \to 0$ be a short exact sequence of $R$-modules. Then $\text{WeakAss}(M') \subset \text{WeakAss}(M)$ and $\text{WeakAss}(M) \subset \text{WeakAss}(M') \cup \text{WeakAss}(M'')$.

\begin{lemma} \label{lemma-weakly-ass-zero} \begin{slogan} Every nonzero module has a weakly associated prime. \end{slogan} Let $R$ be a ring. Let $M$ be an $R$-module. Then $$ M = (0) \Leftrightarrow \text{WeakAss}(M) = \emptyset $$

\begin{lemma} \label{lemma-weakly-ass-support} Let $R$ be a ring. Let $M$ be an $R$-module. Then $$ \text{Ass}(M) \subset \text{WeakAss}(M) \subset \text{Supp}(M). $$

\begin{lemma} \label{lemma-weakly-ass-zero-divisors} Let $R$ be a ring. Let $M$ be an $R$-module. The union $\bigcup_{\mathfrak q \in \text{WeakAss}(M)} \mathfrak q$ is the set elements of $R$ which are zerodivisors on $M$.

\begin{lemma} \label{lemma-weakly-ass-minimal-prime-support} Let $R$ be a ring. Let $M$ be an $R$-module. Any $\mathfrak p \in \text{Supp}(M)$ which is minimal among the elements of $\text{Supp}(M)$ is an element of $\text{WeakAss}(M)$.

\begin{lemma} \label{lemma-ass-weakly-ass} Let $R$ be a ring. Let $M$ be an $R$-module. Let $\mathfrak p$ be a prime ideal of $R$ which is finitely generated. Then $$ \mathfrak p \in \text{Ass}(M) \Leftrightarrow \mathfrak p \in \text{WeakAss}(M). $$ In particular, if $R$ is Noetherian, then $\text{Ass}(M) = \text{WeakAss}(M)$.

\begin{lemma} \label{lemma-weakly-ass-reverse-functorial} Let $\varphi : R \to S$ be a ring map. Let $M$ be an $S$-module. Then we have $\Spec(\varphi)(\text{WeakAss}_S(M)) \supset \text{WeakAss}_R(M)$.

\begin{lemma} \label{lemma-weakly-ass-finite-ring-map} Let $\varphi : R \to S$ be a ring map. Let $M$ be an $S$-module. Denote $f : \Spec(S) \to \Spec(R)$ the associated map on spectra. If $\varphi$ is a finite ring map, then $$ \text{WeakAss}_R(M) = f(\text{WeakAss}_S(M)). $$

\begin{lemma} \label{lemma-weakly-ass-quotient-ring} Let $R$ be a ring. Let $I$ be an ideal. Let $M$ be an $R/I$-module. Via the canonical injection $\Spec(R/I) \to \Spec(R)$ we have $\text{WeakAss}_{R/I}(M) = \text{WeakAss}_R(M)$.

\begin{lemma} \label{lemma-localize-weakly-ass} Let $R$ be a ring. Let $M$ be an $R$-module. Let $S \subset R$ be a multiplicative subset. Via the canonical injection $\Spec(S^{-1}R) \to \Spec(R)$ we have $\text{WeakAss}_R(S^{-1}M) = \text{WeakAss}_{S^{-1}R}(S^{-1}M)$ and $$ \text{WeakAss}(M) \cap \Spec(S^{-1}R) = \text{WeakAss}(S^{-1}M). $$

\begin{lemma} \label{lemma-localize-weakly-ass-nonzero-divisors} Let $R$ be a ring. Let $M$ be an $R$-module. Let $S \subset R$ be a multiplicative subset. Assume that every $s \in S$ is a nonzerodivisor on $M$. Then $$ \text{WeakAss}(M) = \text{WeakAss}(S^{-1}M). $$

\begin{lemma} \label{lemma-zero-at-weakly-ass-zero} Let $R$ be a ring. Let $M$ be an $R$-module. The map $$ M \longrightarrow \prod\nolimits_{\mathfrak p \in \text{WeakAss}(M)} M_{\mathfrak p} $$ is injective.

\begin{lemma} \label{lemma-weak-post-bourbaki} Let $R \to S$ be a ring map. Let $N$ be an $S$-module. Assume $N$ is flat as an $R$-module and $R$ is a domain with fraction field $K$. Then $$ \text{WeakAss}_S(N) = \text{WeakAss}_{S \otimes_R K}(N \otimes_R K) $$ via the canonical inclusion $\Spec(S \otimes_R K) \subset \Spec(S)$.

\begin{definition} \label{definition-embedded-primes} Let $R$ be a ring. Let $M$ be an $R$-module. \begin{enumerate} \item  The associated primes of $M$ which are not minimal among the associated primes of $M$ are called the {\it embedded associated primes} of $M$. \item The {\it embedded primes of $R$} are the embedded associated primes of $R$ as an $R$-module. \end{enumerate}

\begin{lemma} \label{lemma-remove-embedded-primes} Let $R$ be a Noetherian ring. Let $M$ be a finite $R$-module. Consider the set of $R$-submodules $$ \{ K \subset M \mid \text{Supp}(K) \text{ nowhere dense in } \text{Supp}(M) \}. $$ This set has a maximal element $K$ and the quotient $M' = M/K$ has the following properties \begin{enumerate} \item $\text{Supp}(M) = \text{Supp}(M')$, \item $M'$ has no embedded associated primes, \item for any $f \in R$ which is contained in all embedded associated primes of $M$ we have $M_f \cong M'_f$. \end{enumerate}

\begin{lemma} \label{lemma-remove-embedded-primes-localize} Let $R$ be a Noetherian ring. Let $M$ be a finite $R$-module. For any $f \in R$ we have $(M')_f = (M_f)'$ where $M \to M'$ and $M_f \to (M_f)'$ are the quotients constructed in Lemma \ref{lemma-remove-embedded-primes}.

\begin{lemma} \label{lemma-no-embedded-primes-endos} Let $R$ be a Noetherian ring. Let $M$ be a finite $R$-module without embedded associated primes. Let $I = \{x \in R \mid xM = 0\}$. Then the ring $R/I$ has no embedded primes.

\begin{definition} \label{definition-regular-sequence} Let $R$ be a ring. Let $M$ be an $R$-module. A sequence of elements $f_1, \ldots, f_r$ of $R$ is called an {\it $M$-regular sequence} if the following conditions hold: \begin{enumerate} \item $f_i$ is a nonzerodivisor on $M/(f_1, \ldots, f_{i - 1})M$ for each $i = 1, \ldots, r$, and \item the module $M/(f_1, \ldots, f_r)M$ is not zero. \end{enumerate} If $I$ is an ideal of $R$ and $f_1, \ldots, f_r \in I$ then we call $f_1, \ldots, f_r$ a {\it $M$-regular sequence in $I$}. If $M = R$, we call $f_1, \ldots, f_r$ simply a {\it regular sequence} (in $I$).

\begin{lemma} \label{lemma-permute-xi} Let $R$ be a local Noetherian ring. Let $M$ be a finite $R$-module. Let $x_1, \ldots, x_c$ be an $M$-regular sequence. Then any permutation of the $x_i$ is a regular sequence as well.

\begin{lemma} \label{lemma-flat-increases-depth} Let $R, S$ be local rings. Let $R \to S$ be a flat local ring homomorphism. Let $x_1, \ldots, x_r$ be a sequence in $R$. Let $M$ be an $R$-module. The following are equivalent \begin{enumerate} \item $x_1, \ldots, x_r$ is an $M$-regular sequence in $R$, and \item the images of $x_1, \ldots, x_r$ in $S$ form a $M \otimes_R S$-regular sequence. \end{enumerate}

\begin{lemma} \label{lemma-regular-sequence-in-neighbourhood} Let $R$ be a Noetherian ring. Let $M$ be a finite $R$-module. Let $\mathfrak p$ be a prime. Let $x_1, \ldots, x_r$ be a sequence in $R$ whose image in $R_{\mathfrak p}$ forms an $M_{\mathfrak p}$-regular sequence. Then there exists a $g \in R$, $g \not \in \mathfrak p$ such that the image of $x_1, \ldots, x_r$ in $R_g$ forms an $M_g$-regular sequence.

\begin{lemma} \label{lemma-join-regular-sequences} Let $A$ be a ring. Let $I$ be an ideal generated by a regular sequence $f_1, \ldots, f_n$ in $A$. Let $g_1, \ldots, g_m \in A$ be elements whose images $\overline{g}_1, \ldots, \overline{g}_m$ form a regular sequence in $A/I$. Then $f_1, \ldots, f_n, g_1, \ldots, g_m$ is a regular sequence in $A$.

\begin{lemma} \label{lemma-regular-sequence-powers} Let $R$ be a ring. Let $M$ be an $R$-module. Let $f_1, \ldots, f_r \in R$ be an $M$-regular sequence. Then for $e_1, \ldots, e_r > 0$ the sequence $f_1^{e_1}, \ldots, f_r^{e_r}$ is $M$-regular too.

\begin{lemma} \label{lemma-regular-sequence-in-polynomial-ring} Let $R$ be a ring. Let $f_1, \ldots, f_r \in R$ which do not generate the unit ideal. The following are equivalent: \begin{enumerate} \item any permutation of $f_1, \ldots, f_r$ is a regular sequence, \item any subsequence of $f_1, \ldots, f_r$ (in the given order) is a regular sequence, and \item $f_1x_1, \ldots, f_rx_r$ is a regular sequence in the polynomial ring $R[x_1, \ldots, x_r]$. \end{enumerate}

\begin{definition} \label{definition-quasi-regular-sequence} Let $R$ be a ring. Let $M$ be an $R$-module. A sequence of elements $f_1, \ldots, f_c$ of $R$ is called {\it $M$-quasi-regular} if (\ref{equation-quasi-regular}) is an isomorphism. If $M = R$, we call $f_1, \ldots, f_c$ simply a {\it quasi-regular sequence}.

\begin{lemma} \label{lemma-regular-quasi-regular} Let $R$ be a ring. \begin{enumerate} \item A regular sequence $f_1, \ldots, f_c$ of $R$ is a quasi-regular sequence. \item Suppose that $M$ is an $R$-module and that $f_1, \ldots, f_c$ is an $M$-regular sequence. Then $f_1, \ldots, f_c$ is an $M$-quasi-regular sequence. \end{enumerate}

\begin{lemma} \label{lemma-flat-base-change-quasi-regular} Let $R \to R'$ be a flat ring map. Let $M$ be an $R$-module. Suppose that $f_1, \ldots, f_r \in R$ form an $M$-quasi-regular sequence. Then the images of $f_1, \ldots, f_r$ in $R'$ form a $M \otimes_R R'$-quasi-regular sequence.

\begin{lemma} \label{lemma-quasi-regular-sequence-in-neighbourhood} Let $R$ be a Noetherian ring. Let $M$ be a finite $R$-module. Let $\mathfrak p$ be a prime. Let $x_1, \ldots, x_c$ be a sequence in $R$ whose image in $R_{\mathfrak p}$ forms an $M_{\mathfrak p}$-quasi-regular sequence. Then there exists a $g \in R$, $g \not \in \mathfrak p$ such that the image of $x_1, \ldots, x_c$ in $R_g$ forms an $M_g$-quasi-regular sequence.

\begin{lemma} \label{lemma-truncate-quasi-regular} Let $R$ be a ring. Let $M$ be an $R$-module. Let $f_1, \ldots, f_c \in R$ be an $M$-quasi-regular sequence. For any $i$ the sequence $\overline{f}_{i + 1}, \ldots, \overline{f}_c$ of $\overline{R} = R/(f_1, \ldots, f_i)$ is an $\overline{M} = M/(f_1, \ldots, f_i)M$-quasi-regular sequence.

\begin{lemma} \label{lemma-quasi-regular-regular} Let $(R, \mathfrak m)$ be a local Noetherian ring. Let $M$ be a nonzero finite $R$-module. Let $f_1, \ldots, f_c \in \mathfrak m$ be an $M$-quasi-regular sequence. Then $f_1, \ldots, f_c$ is an $M$-regular sequence.

\begin{lemma} \label{lemma-quasi-regular-on-quotient} Let $R$ be a ring. Let $J = (f_1, \ldots, f_r)$ be an ideal of $R$. Let $M$ be an $R$-module. Set $\overline{R} = R/\bigcap_{n \geq 0} J^n$, $\overline{M} = M/\bigcap_{n \geq 0} J^nM$, and denote $\overline{f}_i$ the image of $f_i$ in $\overline{R}$. Then $f_1, \ldots, f_r$ is $M$-quasi-regular if and only if $\overline{f}_1, \ldots, \overline{f}_r$ is $\overline{M}$-quasi-regular.

\begin{definition} \label{definition-blow-up} Let $R$ be a ring. Let $I \subset R$ be an ideal. \begin{enumerate} \item The {\it blowup algebra}, or the {\it Rees algebra}, associated to the pair $(R, I)$ is the graded $R$-algebra $$ \text{Bl}_I(R) = \bigoplus\nolimits_{n \geq 0} I^n = R \oplus I \oplus I^2 \oplus \ldots $$ where the summand $I^n$ is placed in degree $n$. \item Let $a \in I$ be an element. Denote $a^{(1)}$ the element $a$ seen as an element of degree $1$ in the Rees algebra. Then the {\it affine blowup algebra} $R[\frac{I}{a}]$ is the algebra $(\text{Bl}_I(R))_{(a^{(1)})}$ constructed in Section \ref{section-proj}. \end{enumerate}

\begin{lemma} \label{lemma-affine-blowup} Let $R$ be a ring, $I \subset R$ an ideal, and $a \in I$. The image of $a$ in the blowup algebra $R' = R[\frac{I}{a}]$ is a nonzerodivisor and $IR' = aR'$.

\begin{lemma} \label{lemma-blowup-base-change} Let $R \to S$ be a ring map. Let $I \subset R$ be an ideal and $a \in I$. Set $J = IS$ and let $b \in J$ be the image of $a$. Then $S[\frac{J}{b}]$ is the quotient of $S \otimes_R R[\frac{I}{a}]$ by the ideal of elements annihilated by some power of $b$.

\begin{lemma} \label{lemma-blowup-in-principal} Let $R$ be a ring, $I \subset R$ an ideal, and $a \in I$. Set $R' = R[\frac{I}{a}]$. If $f \in R$ is such that $V(f) = V(I)$, then $f$ maps to a nonzerodivisor in $R'$ and $R'_f = R'_a = R_f$.

\begin{lemma} \label{lemma-blowup-add-principal} Let $R$ be a ring, $I \subset R$ an ideal, $a \in I$, and $f \in R$. Set $R' = R[\frac{I}{a}]$ and $R'' = R[\frac{fI}{fa}]$. Then there is a surjective $R$-algebra map $R' \to R''$ whose kernel is the set of $f$-power torsion elements of $R'$.

\begin{lemma} \label{lemma-blowup-reduced} If $R$ is reduced then every (affine) blowup algebra of $R$ is reduced.

\begin{lemma} \label{lemma-blowup-domain} If $R$ is a domain then every (affine) blowup algebra of $R$ is a domain.

\begin{lemma} \label{lemma-blowup-dominant} Let $R$ be a ring. Let $I \subset R$ be an ideal. Let $a \in I$. If $a$ is not contained in any minimal prime of $R$, then $\Spec(R[\frac{I}{a}]) \to \Spec(R)$ has dense image.

\begin{lemma} \label{lemma-blowup-regular-sequence} Let $R$ be a Noetherian ring. Let $a, a_2, \ldots, a_r$ be a regular sequence in $R$. With $I = (a, a_2, \ldots, a_r)$ the blowup algebra $R' = R[\frac{I}{a}]$ is isomorphic to $R'' = R[y_2, \ldots, y_r]/(a y_i - a_i)$.

\begin{lemma} \label{lemma-valuation-ring-colimit-affine-blowups} Let $(R, \mathfrak m)$ be a local domain with fraction field $K$. Let $R \subset A \subset K$ be a valuation ring which dominates $R$. Then $$ A = \colim R[\textstyle{\frac{I}{a}}] $$ is a directed colimit of affine blowups $R \to R[\frac{I}{a}]$ with the following properties \begin{enumerate} \item $a \in I \subset \mathfrak m$, \item $I$ is finitely generated, and \item the fibre ring of $R \to R[\frac{I}{a}]$ at $\mathfrak m$ is not zero. \end{enumerate}

\begin{lemma} \label{lemma-resolution-by-finite-free} Let $R$ be a ring. Let $M$ be an $R$-module. \begin{enumerate} \item There exists an exact complex $$ \ldots \to F_2 \to F_1 \to F_0 \to M \to 0. $$ with $F_i$ free $R$-modules. \item If $R$ is Noetherian and $M$ finite over $R$, then we can choose the complex such that $F_i$ is finite free. In other words, we can find an exact complex $$ \ldots \to R^{\oplus n_2} \to R^{\oplus n_1} \to R^{\oplus n_0} \to M \to 0. $$ \end{enumerate}

\begin{definition} \label{definition-finite-free-resolution} Let $R$ be a ring. Let $M$ be an $R$-module. \begin{enumerate} \item A (left) {\it resolution} $F_\bullet \to M$ of $M$ is an exact complex $$ \ldots \to F_2 \to F_1 \to F_0 \to M \to 0 $$ of $R$-modules. \item A {\it resolution of $M$ by free $R$-modules} is a resolution $F_\bullet \to M$ where each $F_i$ is a free $R$-module. \item A {\it resolution of $M$ by finite free $R$-modules} is a resolution $F_\bullet \to M$ where each $F_i$ is a finite free $R$-module. \end{enumerate}

\begin{lemma} \label{lemma-homotopic-equal-homology} Any two homotopic maps of complexes induce the same maps on (co)homology groups.

\begin{lemma} \label{lemma-compare-resolutions} Let $R$ be a ring. Let $M \to N$ be a map of $R$-modules. Let $F_\bullet \to M$ be a resolution by free $R$-modules and let $N_\bullet \to N$ be an arbitrary resolution. Then \begin{enumerate} \item there exists a map of complexes $F_\bullet \to N_\bullet$ inducing the given map $$ M = \Coker(F_1 \to F_0) \to \Coker(N_1 \to N_0) = N $$ \item two maps $\alpha, \beta : F_\bullet \to N_\bullet$ inducing the same map $M \to N$ are homotopic. \end{enumerate}

\begin{lemma} \label{lemma-ext-welldefined} Let $R$ be a ring. Let $M_1, M_2, N$ be $R$-modules. Suppose that $F_{\bullet}$ is a free resolution of the module $M_1$, and $G_{\bullet}$ is a free resolution of the module $M_2$. Let $\varphi : M_1 \to M_2$ be a module map. Let $\alpha : F_{\bullet} \to G_{\bullet}$ be a map of complexes inducing $\varphi$ on $M_1 = \Coker(d_{F, 1}) \to M_2 = \Coker(d_{G, 1})$, see Lemma \ref{lemma-compare-resolutions}. Then the induced maps $$ H^i(\alpha) : H^i(\Hom_R(F_{\bullet}, N)) \longrightarrow H^i(\Hom_R(G_{\bullet}, N)) $$ are independent of the choice of $\alpha$. If $\varphi$ is an isomorphism, so are all the maps $H^i(\alpha)$. If $M_1 = M_2$, $F_\bullet = G_\bullet$, and $\varphi$ is the identity, so are all the maps $H_i(\alpha)$.

\begin{lemma} \label{lemma-long-exact-seq-ext} Let $R$ be a ring. Let $M$ be an $R$-module. Let $0 \to N' \to N \to N'' \to 0$ be a short exact sequence. Then we get a long exact sequence $$ \begin{matrix} 0 \to \Hom_R(M, N') \to \Hom_R(M, N) \to \Hom_R(M, N'') \\ \phantom{0\ } \to \text{Ext}^1_R(M, N') \to \text{Ext}^1_R(M, N) \to \text{Ext}^1_R(M, N'') \to \ldots \end{matrix} $$

\begin{lemma} \label{lemma-reverse-long-exact-seq-ext} Let $R$ be a ring. Let $N$ be an $R$-module. Let $0 \to M' \to M \to M'' \to 0$ be a short exact sequence. Then we get a long exact sequence $$ \begin{matrix} 0 \to \Hom_R(M'', N) \to \Hom_R(M, N) \to \Hom_R(M', N) \\ \phantom{0\ } \to \text{Ext}^1_R(M'', N) \to \text{Ext}^1_R(M, N) \to \text{Ext}^1_R(M', N) \to \ldots \end{matrix} $$

\begin{lemma} \label{lemma-annihilate-ext} Let $R$ be a ring. Let $M$, $N$ be $R$-modules. Any $x\in R$ such that either $xN = 0$, or $xM = 0$ annihilates each of the modules $\text{Ext}^i_R(M, N)$.

\begin{lemma} \label{lemma-ext-noetherian} Let $R$ be a Noetherian ring. Let $M$, $N$ be finite $R$-modules. Then $\text{Ext}^i_R(M, N)$ is a finite $R$-module for all $i$.

\begin{definition} \label{definition-depth} Let $R$ be a ring, and $I \subset R$ an ideal. Let $M$ be a finite $R$-module. The {\it $I$-depth} of $M$, denoted $\text{depth}_I(M)$, is defined as follows: \begin{enumerate} \item if $IM \not = M$, then $\text{depth}_I(M)$ is the supremum in $\{0, 1, 2, \ldots, \infty\}$ of the lengths of $M$-regular sequences in $I$, \item if $IM = M$ we set $\text{depth}_I(M) = \infty$. \end{enumerate} If $(R, \mathfrak m)$ is local we call $\text{depth}_{\mathfrak m}(M)$ simply the {\it depth} of $M$.

\begin{lemma} \label{lemma-depth-weak-sequence} Let $R$ be a ring, $I \subset R$ an ideal, and $M$ a finite $R$-module. Then $\text{depth}_I(M)$ is equal to the supremum of the lengths of sequences $f_1, \ldots, f_r \in I$ such that $f_i$ is a nonzerodivisor on $M/(f_1, \ldots, f_{i - 1})M$.

\begin{lemma} \label{lemma-bound-depth} Let $R$ be a Noetherian local ring. Let $M$ be a nonzero finite $R$-module. Then $\dim(\text{Supp}(M)) \geq \text{depth}(M)$.

\begin{lemma} \label{lemma-depth-finite-noetherian} Let $R$ be a Noetherian ring, $I \subset R$ an ideal, and $M$ a finite nonzero $R$-module such that $IM \not = M$. Then $\text{depth}_I(M) < \infty$.

\begin{lemma} \label{lemma-depth-ext} Let $R$ be a Noetherian local ring with maximal ideal $\mathfrak m$. Let $M$ be a nonzero finite $R$-module. Then $\text{depth}(M)$ is equal to the smallest integer $i$ such that $\text{Ext}^i_R(R/\mathfrak m, M)$ is nonzero.

\begin{lemma} \label{lemma-depth-in-ses} Let $R$ be a local Noetherian ring. Let $0 \to N' \to N \to N'' \to 0$ be a short exact sequence of finite $R$-modules. \begin{enumerate} \item $\text{depth}(N) \geq \min\{\text{depth}(N'), \text{depth}(N'')\}$ \item $\text{depth}(N'') \geq \min\{\text{depth}(N), \text{depth}(N') - 1\}$ \item $\text{depth}(N') \geq \min\{\text{depth}(N), \text{depth}(N'') + 1\}$ \end{enumerate}

\begin{lemma} \label{lemma-depth-drops-by-one} Let $R$ be a local Noetherian ring and $M$ a nonzero finite $R$-module. \begin{enumerate} \item If $x \in \mathfrak m$ is a nonzerodivisor on $M$, then $\text{depth}(M/xM) = \text{depth}(M) - 1$. \item Any $M$-regular sequence $x_1, \ldots, x_r$ can be extended to an $M$-regular sequence of length $\text{depth}(M)$. \end{enumerate}

\begin{lemma} \label{lemma-depth-dim-associated-primes} Let $(R, \mathfrak m)$ be a local Noetherian ring and $M$ a finite $R$-module. For $\mathfrak p \in \text{Ass}(M)$ we have $\dim(R/\mathfrak p) \geq \text{depth}(M)$.

\begin{lemma} \label{lemma-depth-goes-down-finite} Let $(R, \mathfrak m)$ be a Noetherian local ring. Let $R \to S$ be a finite ring map. Let $\mathfrak m_1, \ldots, \mathfrak m_n$ be the maximal ideals of $S$. Let $N$ be a finite $S$-module. Then $$ \min\nolimits_{i = 1, \ldots, n} \text{depth}(N_{\mathfrak m_i}) = \text{depth}(N) $$

\begin{lemma} \label{lemma-flat-base-change-ext} Given a flat ring map $R \to R'$, an $R$-module $M$, and an $R'$-module $N'$ the natural map $$ \text{Ext}^i_{R'}(M \otimes_R R', N') \to \text{Ext}^i_R(M, N') $$ is an isomorphism for $i \geq 0$.

\begin{lemma} \label{lemma-split-injection-after-completion} Let $R$ be a Noetherian ring. Let $I \subset R$ be an ideal contained in the Jacobson radical of $R$. Let $N \to M$ be a homomorphism of finite $R$-modules. Suppose that there exists arbitrarily large $n$ such that $N/I^nN \to M/I^nM$ is a split injection. Then $N \to M$ is a split injection.

\begin{lemma} \label{lemma-tor-welldefined} Let $R$ be a ring. Let $M_1, M_2, N$ be $R$-modules. Suppose that $F_\bullet$ is a free resolution of the module $M_1$ and that $G_\bullet$ is a free resolution of the module $M_2$. Let $\varphi : M_1 \to M_2$ be a module map. Let $\alpha : F_\bullet \to G_\bullet$ be a map of complexes inducing $\varphi$ on $M_1 = \Coker(d_{F, 1}) \to M_2 = \Coker(d_{G, 1})$, see Lemma \ref{lemma-compare-resolutions}. Then the induced maps $$ H_i(\alpha) : H_i(F_\bullet \otimes_R N) \longrightarrow H_i(G_\bullet \otimes_R N) $$ are independent of the choice of $\alpha$. If $\varphi$ is an isomorphism, so are all the maps $H_i(\alpha)$. If $M_1 = M_2$, $F_\bullet = G_\bullet$, and $\varphi$ is the identity, so are all the maps $H_i(\alpha)$.

\begin{lemma} \label{lemma-long-exact-sequence-tor} Let $R$ be a ring and let $M$ be an $R$-module. Suppose that $0 \to N' \to N \to N'' \to 0$ is a short exact sequence of $R$-modules. There exists a long exact sequence $$ \begin{matrix} M \otimes_R N' \to M \otimes_R N \to M \otimes_R N'' \to 0 \\ \text{Tor}_1^R(M, N') \to \text{Tor}_1^R(M, N) \to \text{Tor}_1^R(M, N'') \to \end{matrix} $$

\begin{lemma} \label{lemma-no-spectral-sequence} Let $(A_{\bullet, \bullet}, d, \delta)$ be a double complex such that \begin{enumerate} \item Each row $A_{\bullet, j}$ is a resolution of $R(A)_j$. \item Each column $A_{i, \bullet}$ is a resolution of $U(A)_i$. \end{enumerate} Then there are canonical isomorphisms $$ H_i(R(A)_\bullet) \cong H_i(U(A)_\bullet). $$ The isomorphisms are functorial with respect to morphisms of double complexes with the properties above.

\begin{lemma} \label{lemma-tor-left-right} Let $R$ be a ring. For any $i \geq 0$ the functors $\text{Mod}_R \times \text{Mod}_R \to \text{Mod}_R$, $(M, N) \mapsto \text{Tor}_i^R(M, N)$ and $(M, N) \mapsto \text{Tor}_i^R(N, M)$ are canonically isomorphic.

\begin{lemma} \label{lemma-tor-noetherian} Let $R$ be a Noetherian ring. Let $M$, $N$ be finite $R$-modules. Then $\text{Tor}_p^R(M, N)$ is a finite $R$-module for all $p$.

\begin{lemma} \label{lemma-characterize-flat} Let $R$ be a ring. Let $M$ be an $R$-module. The following are equivalent: \begin{enumerate} \item The module $M$ is flat over $R$. \item For all $i>0$ the functor $\text{Tor}_i^R(M, -)$ is zero. \item The functor $\text{Tor}_1^R(M, -)$ is zero. \item For all ideals $I \subset R$ we have $\text{Tor}_1^R(M, R/I) = 0$. \item For all finitely generated ideals $I \subset R$ we have $\text{Tor}_1^R(M, R/I) = 0$. \end{enumerate}

\begin{lemma} \label{lemma-flat-base-change-tor} Given a flat ring map $R \to R'$ and $R$-modules $M$, $N$ the natural $R$-module map $\text{Tor}_i^R(M, N)\otimes_R R' \to \text{Tor}_i^{R'}(M \otimes_R R', N \otimes_R R')$ is an isomorphism for all $i$.

\begin{lemma} \label{lemma-tor-commutes-filtered-colimits} Let $R$ be a ring. Let $M = \colim M_i$ be a filtered colimit of $R$-modules. Let $N$ be an $R$-module. Then $\text{Tor}_n^R(M, N) = \colim \text{Tor}_n^R(M_i, N)$ for all $n$.

\begin{definition} \label{definition-projective} Let $R$ be a ring. An $R$-module $P$ is {\it projective} if and only if the functor $\Hom_R(P, -) : \text{Mod}_R \to \text{Mod}_R$ is an exact functor.

\begin{lemma} \label{lemma-characterize-projective} Let $R$ be a ring. Let $P$ be an $R$-module. The following are equivalent \begin{enumerate} \item $P$ is projective, \item $P$ is a direct summand of a free $R$-module, and \item $\text{Ext}^1_R(P, M) = 0$ for every $R$-module $M$. \end{enumerate}

\begin{lemma} \label{lemma-direct-sum-projective} A direct sum of projective modules is projective.

\begin{lemma} \label{lemma-lift-projective-module} Let $R$ be a ring. Let $I \subset R$ be a nilpotent ideal. Let $\overline{P}$ be a projective $R/I$-module. Then there exists a projective $R$-module $P$ such that $P/IP \cong \overline{P}$.

\begin{lemma} \label{lemma-lift-projective} Let $R$ be a ring. Let $I \subset R$ be an ideal. Let $M$ be an $R$-module. Assume \begin{enumerate} \item $I$ is nilpotent, \item $M/IM$ is a projective $R/I$-module, \item $M$ is a flat $R$-module. \end{enumerate} Then $M$ is a projective $R$-module.

\begin{definition} \label{definition-locally-free} Let $R$ be a ring and $M$ an $R$-module. \begin{enumerate} \item We say that $M$ is {\it locally free} if we can cover $\Spec(R)$ by standard opens $D(f_i)$, $i \in I$ such that $M_{f_i}$ is a free $R_{f_i}$-module for all $i \in I$. \item We say that $M$ is {\it finite locally free} if we can choose the covering such that each $M_{f_i}$ is finite free. \item We say that $M$ is {\it finite locally free of rank $r$} if we can choose the covering such that each $M_{f_i}$ is isomorhic to $R_{f_i}^{\oplus r}$. \end{enumerate}

\begin{lemma} \label{lemma-finite-projective} Let $R$ be a ring and let $M$ be an $R$-module. The following are equivalent \begin{enumerate} \label{} \item $M$ is finitely presented and $R$-flat, \item $M$ is finite projective, \item $M$ is a direct summand of a finite free $R$-module, \item $M$ is finitely presented and for all $\mathfrak p \in \Spec(R)$ the localization $M_{\mathfrak p}$ is free, \item $M$ is finitely presented and for all maximal ideals $\mathfrak m \subset R$ the localization $M_{\mathfrak m}$ is free, \item $M$ is finite and locally free, \item $M$ is finite locally free, and \item $M$ is finite, for every prime $\mathfrak p$ the module $M_{\mathfrak p}$ is free, and the function $$ \rho_M : \Spec(R) \to \mathbf{Z}, \quad \mathfrak p \longmapsto \dim_{\kappa(\mathfrak p)} M \otimes_R \kappa(\mathfrak p) $$ is locally constant in the Zariski topology. \end{enumerate}

\begin{lemma} \label{lemma-finite-flat-local} (Warning: see Remark \ref{remark-warning}.) Suppose $R$ is a local ring, and $M$ is a finite flat $R$-module. Then $M$ is finite free.

\begin{lemma} \label{lemma-finite-projective-descends} Let $R \to S$ be a flat local homomorphism of local rings. Let $M$ be a finite $R$-module. Then $M$ is finite projective over $R$ if and only if $M \otimes_R S$ is finite projective over $S$.

\begin{lemma} \label{lemma-locally-free-semi-local-free} Let $R$ be a semi-local ring. Let $M$ be a finite locally free module. If $M$ has constant rank, then $M$ is free. In particular, if $R$ has connected spectrum, then $M$ is free.

\begin{lemma} \label{lemma-semi-local-module-basis-in-submodule} Let $R$ be a local ring with maximal ideal $\mathfrak m$ and infinite residue field. Let $R \to S$ be a ring map. Let $M$ be an $S$-module and let $N \subset M$ be an $R$-submodule. Assume \begin{enumerate} \item $S$ is semi-local and $\mathfrak mS$ is contained in the radical of $S$, \item $M$ is a finite free $S$-module, and \item $N$ generates $M$ as an $S$-module. \end{enumerate} Then $N$ contains an $S$-basis of $M$.

\begin{lemma} \label{lemma-map-between-finite} Let $R$ be a ring. Let $\varphi : M \to N$ be a map of $R$-modules with $N$ a finite $R$-module. Then we have the equality \begin{align*} U & = \{\mathfrak p \subset R \mid \varphi_{\mathfrak p} : M_{\mathfrak p} \to N_{\mathfrak p} \text{ is surjective}\} \\ & = \{\mathfrak p \subset R \mid \varphi \otimes \kappa(\mathfrak p) : M \otimes \kappa(\mathfrak p) \to N \otimes \kappa(\mathfrak p) \text{ is surjective}\} \end{align*} and $U$ is an open subset of $\Spec(R)$. Moreover, for any $f \in R$ such that $D(f) \subset U$ the map $M_f \to N_f$ is surjective.

\begin{lemma} \label{lemma-map-between-finitely-presented} Let $R$ be a ring. Let $\varphi : M \to N$ be a map of finitely presented $R$-modules. Then $$ U = \{\mathfrak p \subset R \mid \varphi_{\mathfrak p} : M_{\mathfrak p} \to N_{\mathfrak p} \text{ is an isomorphism}\} $$ is an open subset of $\Spec(R)$.

\begin{lemma} \label{lemma-cokernel-flat} Let $R$ be a ring. Let $\varphi : P_1 \to P_2$ be a map of finite projective modules. Then \begin{enumerate} \item The set $U$ of primes $\mathfrak p \in \Spec(R)$ such that $\varphi \otimes \kappa(\mathfrak p)$ is injective is open and for any $f\in R$ such that $D(f) \subset U$ we have \begin{enumerate} \item $P_{1, f} \to P_{2, f}$ is injective, and \item the module $\Coker(\varphi)_f$ is finite projective over $R_f$. \end{enumerate} \item The set $W$ of primes $\mathfrak p \in \Spec(R)$ such that $\varphi \otimes \kappa(\mathfrak p)$ is surjective is open and for any $f\in R$ such that $D(f) \subset W$ we have \begin{enumerate} \item $P_{1, f} \to P_{2, f}$ is surjective, and \item the module $\Ker(\varphi)_f$ is finite projective over $R_f$. \end{enumerate} \item The set $V$ of primes $\mathfrak p \in \Spec(R)$ such that $\varphi \otimes \kappa(\mathfrak p)$ is an isomorphism is open and for any $f\in R$ such that $D(f) \subset V$ the map $\varphi : P_{1, f} \to P_{2, f}$ is an isomorphism of modules over $R_f$. \end{enumerate}

\begin{lemma} \label{lemma-flat-factors-free} Let $M$ be an $R$-module.  The following are equivalent: \begin{enumerate} \item $M$ is flat. \item If $f: R^n \to M$ is a module map and $x \in \Ker(f)$, then there are module maps $h: R^n \to R^m$ and $g: R^m \to M$ such that $f = g \circ h$ and $x \in \Ker(h)$. \item Suppose $f: R^n \to M$ is a module map, $N \subset \Ker(f)$ any submodule, and $h: R^n \to R^{m}$ a map such that $N \subset \Ker(h)$ and $f$ factors through $h$.  Then given any $x \in \Ker(f)$ we can find a map $h': R^n \to R^{m'}$ such that $N + Rx \subset \Ker(h')$ and $f$ factors through $h'$. \item If $f: R^n \to M$ is a module map and $N \subset \Ker(f)$ is a finitely generated submodule, then there are module maps $h: R^n \to R^m$ and $g: R^m \to M$ such that $f = g \circ h$ and $N \subset \Ker(h)$. \end{enumerate}

\begin{lemma} \label{lemma-flat-factors-fp} Let $M$ be an $R$-module.  Then $M$ is flat if and only if the following condition holds: if $P$ is a finitely presented $R$-module and $f: P \to M$ a module map, then there is a free finite $R$-module $F$ and module maps $h: P \to F$ and $g: F \to M$ such that $f = g \circ h$.

\begin{lemma} \label{lemma-flat-surjective-hom} Let $M$ be an $R$-module.  Then $M$ is flat if and only if the following condition holds: for every finitely presented $R$-module $P$, if $N \to M$ is a surjective $R$-module map, then the induced map $\Hom_R(P, N) \to \Hom_R(P, M)$ is surjective.

\begin{definition} \label{definition-universally-injective} Let $f: M \to N$ be a map of $R$-modules.  Then $f$ is called {\it universally injective} if for every $R$-module $Q$, the map $f \otimes_R \text{id}_Q: M \otimes_R Q \to N \otimes_R Q$ is injective.  A sequence $0 \to M_1 \to M_2 \to M_3 \to 0$ of $R$-modules is called {\it universally exact} if it is exact and $M_1 \to M_2$ is universally injective.

\begin{lemma} \label{lemma-universally-exact-split} Let $$ 0 \to M_1 \to M_2 \to M_3 \to 0 $$ be an exact sequence of $R$-modules.  Suppose $M_3$ is of finite presentation. Then $$ 0 \to M_1 \to M_2 \to M_3 \to 0 $$ is universally exact if and only if it is split.

\begin{lemma} \label{lemma-flat-universally-injective} Let $M$ be an $R$-module.  Then $M$ is flat if and only if any exact sequence of $R$-modules $$ 0 \to M_1 \to M_2 \to M \to 0 $$ is universally exact.

\begin{lemma} \label{lemma-ui-flat-domain} Let $0 \to M_1 \to M_2 \to M_3 \to 0$ be a universally exact sequence of $R$-modules, and suppose $M_2$ is flat. Then $M_1$ and $M_3$ are flat.

\begin{lemma} \label{lemma-universally-injective-tensor} Let $R$ be a ring. Let $M \to M'$ be a universally injective $R$-module map. Then for any $R$-module $N$ the map $M \otimes_R N \to M' \otimes_R N$ is universally injective.

\begin{lemma} \label{lemma-composition-universally-injective} Let $R$ be a ring. A composition of universally injective $R$-module maps is universally injective.

\begin{lemma} \label{lemma-universally-injective-permanence} Let $R$ be a ring. Let $M \to M'$ and $M' \to M''$ be $R$-module maps. If their composition $M \to M''$ is universally injective, then $M \to M'$ is universally injective.

\begin{lemma} \label{lemma-faithfully-flat-universally-injective} Let $R \to S$ be a faithfully flat ring map. Then $R \to S$ is universally injective as a map of $R$-modules. In particular $R \cap IS = I$ for any ideal $I \subset R$.

\begin{lemma} \label{lemma-universally-injective-check-stalks} Let $R \to S$ be a ring map. Let $M \to M'$ be a map of $S$-modules. The following are equivalent \begin{enumerate} \item $M \to M'$ is universally injective as a map of $R$-modules, \item for each prime $\mathfrak q$ of $S$ the map $M_{\mathfrak q} \to M'_{\mathfrak q}$ is universally injective as a map of $R$-modules, \item for each maximal ideal $\mathfrak m$ of $S$ the map $M_{\mathfrak m} \to M'_{\mathfrak m}$ is universally injective as a map of $R$-modules, \item for each prime $\mathfrak q$ of $S$ the map $M_{\mathfrak q} \to M'_{\mathfrak q}$ is universally injective as a map of $R_{\mathfrak p}$-modules, where $\mathfrak p$ is the inverse image of $\mathfrak q$ in $R$, and \item for each maximal ideal $\mathfrak m$ of $S$ the map $M_{\mathfrak m} \to M'_{\mathfrak m}$ is universally injective as a map of $R_{\mathfrak p}$-modules, where $\mathfrak p$ is the inverse image of $\mathfrak m$ in $R$. \end{enumerate}

\begin{lemma} \label{lemma-universally-injective-localize} Let $\varphi : A \to B$ be a ring map. Let $S \subset A$ and $S' \subset B$ be multiplicative subsets such that $\varphi(S) \subset S'$. Let $M \to M'$ be a map of $B$-modules. \begin{enumerate} \item If $M \to M'$ is universally injective as a map of $A$-modules, then $(S')^{-1}M \to (S')^{-1}M'$ is universally injective as a map of $A$-modules and as a map of $S^{-1}A$-modules. \item If $M$ and $M'$ are $(S')^{-1}B$-modules, then $M \to M'$ is universally injective as a map of $A$-modules if and only if it is universally injective as a map of $S^{-1}A$-modules. \end{enumerate}

\begin{lemma} \label{lemma-check-universally-injective-into-flat} Let $R$ be a ring and let $M \to M'$ be a map of $R$-modules. If $M'$ is flat, then $M \to M'$ is universally injective if and only if $M/IM \to M'/IM'$ is injective for every finitely generated ideal $I$ of $R$.

\begin{lemma} \label{lemma-finite-projective-again} Let $M$ be an $R$-module.  Then $M$ is finite projective if and only if $M$ is finitely presented and flat.

\begin{lemma} \label{lemma-descend-properties-modules} Let $R \to S$ be a faithfully flat ring map. Let $M$ be an $R$-module. Then \begin{enumerate} \item if the $S$-module $M \otimes_R S$ is of finite type, then $M$ is of finite type, \item if the $S$-module $M \otimes_R S$ is of finite presentation, then $M$ is of finite presentation, \item if the $S$-module $M \otimes_R S$ is flat, then $M$ is flat, and \item add more here as needed. \end{enumerate}

\begin{definition} \label{definition-devissage} Let $M$ be an $R$-module.  A {\it direct sum d\'evissage} of $M$ is a family of submodules $(M_{\alpha})_{\alpha \in S}$, indexed by an ordinal $S$ and increasing (with respect to inclusion), such that: \begin{enumerate} \item[(0)] $M_0 = 0$; \item[(1)] $M = \bigcup_{\alpha} M_{\alpha}$; \item[(2)] if $\alpha \in S$ is a limit ordinal, then $M_{\alpha} = \bigcup_{\beta < \alpha} M_{\beta}$; \item[(3)] if $\alpha + 1 \in S$, then $M_{\alpha}$ is a direct summand of $M_{\alpha + 1}$. \end{enumerate} If moreover \begin{enumerate} \item[(4)] $M_{\alpha + 1}/M_{\alpha}$ is countably generated for $\alpha + 1 \in S$, \end{enumerate} then $(M_{\alpha})_{\alpha \in S}$ is called a {\it Kaplansky d\'evissage} of $M$.

\begin{lemma} \label{lemma-direct-sum-devissage} Let $M$ be an $R$-module.  If $(M_{\alpha})_{\alpha \in S}$ is a direct sum d\'evissage of $M$, then $M \cong \bigoplus_{\alpha + 1 \in S} M_{\alpha + 1}/M_{\alpha}$.

\begin{lemma} \label{lemma-Kaplansky-devissage} Let $M$ be an $R$-module.  Then $M$ is a direct sum of countably generated $R$-modules if and only if it admits a Kaplansky d\'evissage.

\begin{lemma} \label{lemma-projective-free} Let $R$ be a ring.  Then every projective $R$-module is free if and only if every countably generated projective $R$-module is free.

\begin{lemma} \label{lemma-freeness-criteria} Let $M$ be a countably generated $R$-module.  Suppose any direct summand $N$ of $M$ satisfies: any element of $N$ is contained in a free direct summand of $N$.  Then $M$ is free.

\begin{lemma} \label{lemma-projective-freeness-criteria} Let $P$ be a projective module over a local ring $R$.  Then any element of $P$ is contained in a free direct summand of $P$.

\begin{definition} \label{definition-ML-system} Let $(A_i, \varphi_{ji})$ be a directed inverse system of sets over $I$.  Then we say  $(A_i, \varphi_{ji})$ is {\it Mittag-Leffler inverse system} if for each $i \in I$, the decreasing family $\varphi_{ji}(A_j) \subset A_i$ for $j \geq i$ stabilizes.  Explicitly, this means that for each $i \in I$, there exists $j \geq i$ such that for $k \geq j$ we have $\varphi_{ki}(A_k) = \varphi_{ji}( A_j)$.  If $(A_i, \varphi_{ji})$ is a directed inverse system of modules over a ring $R$, we say that it is Mittag-Leffler if the underlying inverse system of sets is Mittag-Leffler.

\begin{lemma} \label{lemma-ML-limit-nonempty} Let $(A_i, \varphi_{ji})$ be a directed inverse system over $I$.  Suppose $I$ is countable.  If $(A_i, \varphi_{ji})$ is Mittag-Leffler and the $A_i$ are nonempty, then $\lim A_i$ is nonempty.

\begin{lemma} \label{lemma-ML-exact-sequence} Let $$ 0 \to A_i \xrightarrow{f_i} B_i \xrightarrow{g_i} C_i \to 0 $$ be an exact sequence of directed inverse systems of abelian groups over $I$. Suppose $I$ is countable.  If $(A_i)$ is Mittag-Leffler, then $$ 0 \to \lim A_i \to \lim B_i \to \lim C_i\to 0 $$ is exact.

\begin{lemma} \label{lemma-Mittag-Leffler} Let $R$ be a ring. Let $0 \to K_i \to L_i \to M_i \to 0$ be short exact sequences of $R$-modules, $i \geq 1$ which fit into maps of short exact sequences $$ \xymatrix{ 0 \ar[r] & K_i \ar[r] & L_i \ar[r] & M_i \ar[r] & 0 \\ 0 \ar[r] & K_{i + 1} \ar[r] \ar[u] & L_{i + 1} \ar[r] \ar[u] & M_{i + 1} \ar[r] \ar[u] & 0} $$ If for every $i$ there exists a $c = c(i) \geq i$ such that $\Im(K_c \to K_i) = \Im(K_j \to K_i)$ for all $j \geq c$, then the sequence $$ 0 \to \lim K_i \to \lim L_i \to \lim M_i \to 0 $$ is exact.

\begin{definition} \label{definition-ML-inductive-system} Let $(M_i, f_{ij})$ be a directed system of $R$-modules.  We say that $(M_i, f_{ij})$ is a {\it Mittag-Leffler directed system of modules} if each $M_i$ is an $R$-module of finite presentation and if for every $R$-module $N$, the inverse system $$ (\Hom_R(M_i, N), \Hom_R(f_{ij}, N)) $$ is Mittag-Leffler.

\begin{definition} \label{definition-domination} Let $f: M \to N$ and $g: M \to M'$ be maps of $R$-modules. Then we say $g$ {\it dominates} $f$ if for any $R$-module $Q$, we have $\Ker(f \otimes_R \text{id}_Q) \subset \Ker(g \otimes_R \text{id}_Q)$.

\begin{lemma} \label{lemma-domination-fp} Let $f: M \to N$ and $g: M \to M'$ be maps of $R$-modules. Then $g$ dominates $f$ if and only if for any finitely presented $R$-module $Q$, we have $\Ker(f \otimes_R \text{id}_Q) \subset \Ker(g \otimes_R \text{id}_Q)$.

\begin{lemma} \label{lemma-domination-universally-injective} Let $f : M \to N$ and $g : M \to M'$ be maps of $R$-modules. Consider the pushout of $f$ and $g$, $$ \xymatrix{ M  \ar[r]_f \ar[d]_g & N \ar[d]^{g'} \\ M' \ar[r]^{f'} & N' } $$ Then $g$ dominates $f$ if and only if $f'$ is universally injective.

\begin{lemma} \label{lemma-domination} Let $f: M \to N$ and $g: M \to M'$ be maps of $R$-modules. Suppose $\Coker(f)$ is of finite presentation.  Then $g$ dominates $f$ if and only if $g$ factors through $f$, i.e.\ there exists a module map $h: N \to M'$ such that $g = h \circ f$.

\begin{definition} \label{definition-mittag-leffler-module} Let $M$ be an $R$-module.  We say that $M$ is {\it Mittag-Leffler} if the equivalent conditions of Proposition \ref{proposition-ML-characterization} hold.

\begin{lemma} \label{lemma-tensor-ML-modules} If $R$ is a ring and $M$, $N$ are Mittag-Leffler modules over $R$, then $M \otimes_R N$ is a Mittag-Leffler module.

\begin{lemma} \label{lemma-ML-also} Let $R$ be a ring and $M$ an $R$-module. Then $M$ is Mittag-Leffler if and only if for every finite free $R$-module $F$ and module map $f: F \to M$, there exists a finitely presented $R$-module $Q$ and a module map $g : F \to Q$ such that $g$ and $f$ dominate each other, i.e., $\Ker(f \otimes_R \text{id}_N) = \Ker(g \otimes_R \text{id}_N)$ for every $R$-module $N$.

\begin{lemma} \label{lemma-restrict-ML-modules} Let $R \to S$ be a finite and finitely presented ring map. Let $M$ be an $S$-module. If $M$ is a Mittag-Leffler module over $S$ then $M$ is a Mittag-Leffler module over $R$.

\begin{lemma} \label{lemma-mod-ideal-ML-modules} Let $R$ be a ring. Let $S = R/I$ for some finitely generated ideal $I$. Let $M$ be an $S$-module. Then $M$ is a Mittag-Leffler module over $R$ if and only if $M$ is a Mittag-Leffler module over $S$.

\begin{lemma} \label{lemma-kernel-tensored-fp} Let $M$ be an $R$-module, $P$ a finitely presented $R$-module, and $f: P \to M$ a map.  Let $Q$ be an $R$-module and suppose $x \in \Ker(P \otimes Q \to M \otimes Q)$.  Then there exists a finitely presented $R$-module $P'$ and a map $f': P \to P'$ such that $f$ factors through $f'$ and $x \in \Ker(P \otimes Q \to P' \otimes Q)$.

\begin{lemma} \label{lemma-minimal-contains} Let $M$ be a flat Mittag-Leffler module over $R$. Let $F$ be an $R$-module and let $x \in F \otimes_R M$. Then there exists a smallest submodule $F' \subset F$ such that $x \in F' \otimes_R M$.

\begin{lemma} \label{lemma-pure-submodule-ML} Let $0 \to M_1 \to M_2 \to M_3 \to 0$ be a universally exact sequence of $R$-modules.  Then: \begin{enumerate} \item If $M_2$ is Mittag-Leffler, then $M_1$ is Mittag-Leffler. \item If $M_1$ and $M_3$ are Mittag-Leffler, then $M_2$ is Mittag-Leffler. \end{enumerate}

\begin{lemma} \label{lemma-colimit-universally-injective-ML} If $M = \colim M_i$ is the colimit of a directed system of Mittag-Leffler $R$-modules $M_i$ with universally injective transition maps, then $M$ is Mittag-Leffler.

\begin{lemma} \label{lemma-direct-sum-ML} If $M = \bigoplus_{i \in I} M_i$ is a direct sum of $R$-modules, then $M$ is Mittag-Leffler if and only if each $M_i$ is Mittag-Leffler.

\begin{lemma} \label{lemma-flat-ML-over-ML-ring} Let $R \to S$ be a ring map. Let $M$ be an $S$-module. If $S$ is Mittag-Leffler as an $R$-module, and $M$ is flat and Mittag-Leffler as an $S$-module, then $M$ is Mittag-Leffler as an $R$-module.

\begin{definition} \label{definition-coherent} Let $R$ be a ring. Let $M$ be an $R$-module. \begin{enumerate} \item We say $M$ is a {\it coherent module} if it is finitely generated and every finitely generated submodule of $M$ is finitely presented over $R$. \item We say $R$ is a {\it coherent ring} if it is coherent as a module over itself. \end{enumerate}

\begin{lemma} \label{lemma-coherent} Let $R$ be a ring. \begin{enumerate} \item A finite submodule of a coherent module is coherent. \item Let $\varphi : N \to M$ be a homomorphism from a finite module to a coherent module. Then $\Ker(\varphi)$ is finite. \item Let $\varphi : N \to M$ be a homomorphism of coherent modules. Then $\Ker(\varphi)$ and $\Coker(\varphi)$ are coherent modules. \item Given a short exact sequence of $R$-modules $0 \to M_1 \to M_2 \to M_3 \to 0$ if two out of three are coherent so is the third. \end{enumerate}

\begin{lemma} \label{lemma-coherent-ring} Let $R$ be a ring. If $R$ is coherent, then a module is coherent if and only if it is finitely presented.

\begin{lemma} \label{lemma-Noetherian-coherent} A Noetherian ring is a coherent ring.

\begin{lemma} \label{lemma-flat-ML-criterion} Let $M$ be a flat $R$-module. The following are equivalent \begin{enumerate} \item $M$ is Mittag-Leffler, and \item if $F$ is a finite free $R$-module and $x \in F \otimes_R M$, then there exists a smallest submodule $F'$ of $F$ such that $x \in F' \otimes_R M$. \end{enumerate}

\begin{lemma} \label{lemma-product-over-Noetherian-ring} Let $R$ be a Noetherian ring and $A$ a set. Then $M = R^A$ is a flat and Mittag-Leffler $R$-module.

\begin{lemma} \label{lemma-power-series-ML} Let $R$ be a Noetherian ring and $n$ a positive integer.  Then the $R$-module $M = R[[t_1, \ldots, t_n]]$ is flat and Mittag-Leffler.

\begin{lemma} \label{lemma-ML-countable-colimit} Let $M$ be an $R$-module.  Write $M = \colim_{i \in I} M_i$ where $(M_i, f_{ij})$ is a directed system of finitely presented $R$-modules.  If $M$ is Mittag-Leffler and countably generated, then there is a directed countable subset $I' \subset I$ such that $M \cong \colim_{i \in I'} M_i$.

\begin{lemma} \label{lemma-ML-countable} Let $R$ be a ring. Let $M$ be an $R$-module. Assume $M$ is Mittag-Leffler and countably generated. For any $R$-module map $f : P \to M$ with $P$ finitely generated there exists an endomorphism $\alpha : M \to M$ such that \begin{enumerate} \item $\alpha : M \to M$ factors through a finitely presented $R$-module, and \item $\alpha \circ f = f$. \end{enumerate}

\begin{lemma} \label{lemma-countgen-projective} Let $M$ be an $R$-module.  If $M$ is flat, Mittag-Leffler, and countably generated, then $M$ is projective.

\begin{lemma} \label{lemma-ML-ui-descent} Let $f: M \to N$ be universally injective map of $R$-modules.  Suppose $M$ is a direct sum of countably generated $R$-modules, and suppose $N$ is flat and Mittag-Leffler.  Then $M$ is projective.

\begin{lemma} \label{lemma-universally-injective-submodule-powerseries} Let $R$ be a Noetherian ring and let $M$ be a $R$-module.  Suppose $M$ is a direct sum of countably generated $R$-modules, and suppose there is a universally injective map $M \to R[[t_1, \ldots, t_n]]$ for some $n$. Then $M$ is projective.

\begin{lemma} \label{lemma-ascend-properties-modules} Let $R \to S$ be a ring map.  Let $M$ be an $R$-module.  Then: \begin{enumerate} \item If $M$ is flat, then the $S$-module $M \otimes_R S$ is flat. \item If $M$ is Mittag-Leffler, then the $S$-module $M \otimes_R S$ is Mittag-Leffler. \item If $M$ is a direct sum of countably generated $R$-modules, then the $S$-module $M \otimes_R S$ is a direct sum of countably generated $S$-modules. \item If $M$ is projective, then the $S$-module $M \otimes_R S$ is projective. \end{enumerate}

\begin{lemma} \label{lemma-ffdescent-ML} \begin{reference} Email from Juan Pablo Acosta Lopez dated 12/20/14. \end{reference} Let $R \to S$ be a faithfully flat ring map. Let $M$ be an $R$-module. If the $S$-module $M \otimes_R S$ is Mittag-Leffler, then $M$ is Mittag-Leffler.

\begin{lemma} \label{lemma-ffdescent-countable-projectivity} Let $R \to S$ be a faithfully flat ring map.  Let $M$ be an $R$-module.  If the $S$-module $M \otimes_R S$ is countably generated and projective, then $M$ is countably generated and projective.

\begin{lemma} \label{lemma-lift-countably-generated-submodule} Let $R \to S$ be a ring map, let $M$ be an $R$-module, and let $Q$ be a countably generated $S$-submodule of $M \otimes_R S$.  Then there exists a countably generated $R$-submodule $P$ of $M$ such that $\Im(P \otimes_R S \to M \otimes_R S)$ contains $Q$.

\begin{lemma} \label{lemma-adapted-submodule} Let $R \to S$ be a ring map, and let $M$ be an $R$-module.  Suppose $M \otimes_R S = \bigoplus_{i \in I} Q_i$ is a direct sum of countably generated $S$-modules $Q_i$.  If $N$ is a countably generated submodule of $M$, then there is a countably generated submodule $N'$ of $M$ such that $N' \supset N$ and $\Im(N' \otimes_R S \to M \otimes_R S) = \bigoplus_{i \in I'} Q_i$ for some subset $I' \subset I$.

\begin{lemma} \label{lemma-completion-generalities} Let $R$ be a ring. Let $I \subset R$ be an ideal. Let $\varphi : M \to N$ be a map of $R$-modules. \begin{enumerate} \item If $M/IM \to N/IN$ is surjective, then $M^\wedge \to N^\wedge$ is surjective. \item If $M \to N$ is surjective, then $M^\wedge \to N^\wedge$ is surjective. \item If $0 \to K \to M \to N \to 0$ is a short exact sequence of $R$-modules and $N$ is flat, then $0 \to K^\wedge \to M^\wedge \to N^\wedge \to 0$ is a short exact sequence. \item The map $M \otimes_R R^\wedge \to M^\wedge$ is surjective for any finite $R$-module $M$. \end{enumerate}

\begin{lemma} \label{lemma-completion-differ-by-torsion} Let $R$ be a ring. Let $I \subset R$ be an ideal. Let $0 \to M \to N \to Q \to 0$ be an exact sequence of $R$-modules such that $Q$ is annihilated by a power of $I$. Then completion produces an exact sequence $0 \to M^\wedge \to N^\wedge \to Q \to 0$. In particular, $(I^nM)^\wedge = \Ker(M^\wedge \to M/I^nM)$ for all $n$.

\begin{definition} \label{definition-complete} Let $R$ be a ring. Let $I \subset R$ be an ideal. Let $M$ be an $R$-module. We say $M$ is {\it $I$-adically complete} if the map $$ M \longrightarrow M^\wedge = \lim_n M/I^nM $$ is an isomorphism\footnote{This includes the condition that $\bigcap I^nM = (0)$.}. We say $R$ is {\it $I$-adically complete} if $R$ is $I$-adically complete as an $R$-module.

\begin{lemma} \label{lemma-hathat} Let $R$ be a ring. Let $I \subset R$ be an ideal. Let $M$ be an $R$-module. Denote $K_n = \Ker(M^\wedge \to M/I^nM)$. Then $M^\wedge$ is $I$-adically complete if and only if $K_n$ is equal to $I^nM^\wedge$ for all $n \geq 1$.

\begin{lemma} \label{lemma-hathat-finitely-generated} \begin{reference} \cite[Theorem 15]{Matlis} \end{reference} Let $R$ be a ring. Let $I$ be a finitely generated ideal of $R$. Let $M$ be an $R$-module. Then \begin{enumerate} \item the completion $M^\wedge$ is $I$-adically complete, and \item $I^nM^\wedge = \Ker(M^\wedge \to M/I^nM) = (I^nM)^\wedge$ for all $n \geq 1$. \end{enumerate} In particular $R^\wedge$ is $I$-adically complete, $I^nR^\wedge = (I^n)^\wedge$, and $R^\wedge/I^nR^\wedge = R/I^n$.

\begin{lemma} \label{lemma-radical-completion} Let $R$ be a ring, let $I \subset R$ be an ideal, and let $R^\wedge = \lim R/I^n$. \begin{enumerate} \item any element of $R^\wedge$ which maps to a unit of $R/I$ is a unit, \item any element of $1 + I$ maps to an invertible element of $R^\wedge$, \item any element of $1 + IR^\wedge$ is invertible in $R^\wedge$, and \item the ideals $IR^\wedge$ and $\Ker(R^\wedge \to R/I)$ are contained in the radical of $R^\wedge$. \end{enumerate}

\begin{lemma} \label{lemma-when-surjective-to-completion} Let $A$ be a ring. Let $I = (f_1, \ldots, f_r)$ be a finitely generated ideal. If $M \to \lim M/f_i^nM$ is surjective for each $i$, then $M \to \lim M/I^nM$ is surjective.

\begin{lemma} \label{lemma-complete-by-sub} Let $A$ be a ring. Let $I \subset J \subset A$ be ideals. If $M$ is $J$-adically complete and $I$ is finitely generated, then $M$ is $I$-adically complete.

\begin{lemma} \label{lemma-change-ideal-completion} Let $R$ be a ring. Let $I$, $J$ be ideals of $R$. Assume there exist integers $c, d > 0$ such that $I^c \subset J$ and $J^d \subset I$. Then completion with respect to $I$ agrees with completion with respect to $J$ for any $R$-module. In particular an $R$-module $M$ is $I$-adically complete if and only if it is $J$-adically complete.

\begin{lemma} \label{lemma-quotient-complete} Let $R$ be a ring. Let $I$ be an ideal of $R$. Let $M$ be an $I$-adically complete $R$-module, and let $K \subset M$ be an $R$-submodule. The following are equivalent \begin{enumerate} \item $K = \bigcap (K + I^nM)$ and \item $M/K$ is $I$-adically complete. \end{enumerate}

\begin{lemma} \label{lemma-when-finite-module-complete-over-complete-ring} Let $R$ be a ring. Let $I$ be an ideal of $R$. Let $M$ be an $R$-module. If (a) $R$ is $I$-adically complete, (b) $M$ is a finite $R$-module, and (c) $\bigcap I^nM = (0)$, then $M$ is $I$-adically complete.

\begin{lemma} \label{lemma-finite-over-complete-ring} Let $R$ be a ring. Let $I \subset R$ be an ideal. Let $M$ be an $R$-module. Assume \begin{enumerate} \item $R$ is $I$-adically complete, \item $\bigcap_{n \geq 1} I^nM = (0)$, and \item $M/IM$ is a finite $R/I$-module. \end{enumerate} Then $M$ is a finite $R$-module.

\begin{lemma} \label{lemma-completion-tensor} Suppose $R$ is Noetherian. \begin{enumerate} \item If $N \to M$ is an injective map of finite $R$-modules, then the map on completions $N^\wedge \to M^\wedge$ is injective. \item If $M$ is a finite $R$-module, then $M^\wedge = M \otimes_R R^\wedge$. \end{enumerate}

\begin{lemma} \label{lemma-completion-flat} Let $R$ be a Noetherian ring. Let $I \subset R$ be an ideal. \begin{enumerate} \item The ring map $R \to R^\wedge$ is flat. \item The functor $M \mapsto M^\wedge$ is exact on the category of finitely generated $R$-modules. \end{enumerate}

\begin{lemma} \label{lemma-completion-faithfully-flat} Let $R$ be a Noetherian local ring. Let $\mathfrak m \subset R$ be the maximal ideal. Let $I \subset \mathfrak m$ be an ideal. The ring map $R \to R^\wedge$ is faithfully flat. In particular the completion with respect to $\mathfrak m$, namely $\lim_n R/\mathfrak m^n$ is faithfully flat.

\begin{lemma} \label{lemma-completion-complete} Let $R$ be a Noetherian ring. Let $I$ be an ideal of $R$. Let $M$ be an $R$-module. Then the completion $M^\wedge$ of $M$ with respect to $I$ is $I$-adically complete, $I^n M^\wedge = (I^nM)^\wedge$, and $M^\wedge/I^nM^\wedge = M/I^nM$.

\begin{lemma} \label{lemma-completion-Noetherian} Let $R$ be a ring. Let $I \subset R$ be an ideal. Assume \begin{enumerate} \item $R/I$ is a Noetherian ring, \item $I$ is finitely generated. \end{enumerate} Then $R^\wedge$ is a Noetherian ring complete with respect to $IR^\wedge$.

\begin{lemma} \label{lemma-completion-Noetherian-Noetherian} Let $R$ be a Noetherian ring. Let $I$ be an ideal of $R$. The completion $R^\wedge$ of $R$ with respect to $I$ is Noetherian.

\begin{lemma} \label{lemma-finite-after-completion} Let $R \to S$ be a local homomorphism of local rings $(R, \mathfrak m)$ and $(S, \mathfrak n)$. Let $R^\wedge$, resp.\ $S^\wedge$ be the completion of $R$, resp.\ $S$ with respect to $\mathfrak m$, resp.\ $\mathfrak n$. If $\mathfrak m$ and $\mathfrak n$ are finitely generated and $\dim_{\kappa(\mathfrak m)} S/\mathfrak mS < \infty$, then \begin{enumerate} \item $S^\wedge$ is equal to the $\mathfrak m$-adic completion of $S$, and \item $S^\wedge$ is a finite $R^\wedge$-module. \end{enumerate}

\begin{lemma} \label{lemma-completion-finite-extension} Let $R$ be a Noetherian ring. Let $R \to S$ be a finite ring map. Let $\mathfrak p \subset R$ be a prime and let $\mathfrak q_1, \ldots, \mathfrak q_m$ be the primes of $S$ lying over $\mathfrak p$ (Lemma \ref{lemma-finite-finite-fibres}). Then $$ R_\mathfrak p^\wedge \otimes_R S = (S_\mathfrak p)^\wedge = S_{\mathfrak q_1}^\wedge \times \ldots \times S_{\mathfrak q_m}^\wedge $$ where the $(S_\mathfrak p)^\wedge$ is the completion with respect to $\mathfrak p$ and the local rings $R_\mathfrak p$ and $S_{\mathfrak q_i}$ are completed with respect to their maximal ideals.

\begin{lemma} \label{lemma-split-completed-sequence} Let $R$ be a ring. Let $I \subset R$ be an ideal. Let $0 \to K \to P \to M \to 0$ be a short exact sequence of $R$-modules. If $M$ is flat over $R$ and $M/IM$ is a projective $R/I$-module, then the sequence of $I$-adic completions $$ 0 \to K^\wedge \to P^\wedge \to M^\wedge \to 0 $$ is a split exact sequence.

\begin{lemma} \label{lemma-limit-complete} Let $A$ be a ring. Let $I \subset A$ be an ideal. Let $(M_n)$ be an inverse system of $A$-modules. Set $M = \lim M_n$. If $M_n = M_{n + 1}/I^nM_{n + 1}$ and $I$ is finitely generated then $M/I^nM = M_n$ and $M$ is $I$-adically complete.

\begin{lemma} \label{lemma-mod-injective} Suppose that $R \to S$ is a local homomorphism of Noetherian local rings. Denote $\mathfrak m$ the maximal ideal of $R$. Let $M$ be a flat $R$-module and $N$ a finite $S$-module. Let $u : N \to M$ be a map of $R$-modules. If $\overline{u} : N/\mathfrak m N \to M/\mathfrak m M$ is injective then $u$ is injective. In this case $M/u(N)$ is flat over $R$.

\begin{lemma} \label{lemma-grothendieck} Suppose that $R \to S$ is a flat and local ring homomorphism of Noetherian local rings. Denote $\mathfrak m$ the maximal ideal of $R$. Suppose $f \in S$ is a nonzerodivisor in $S/{\mathfrak m}S$. Then $S/fS$ is flat over $R$, and $f$ is a nonzerodivisor in $S$.

\begin{lemma} \label{lemma-grothendieck-regular-sequence} Suppose that $R \to S$ is a flat and local ring homomorphism of Noetherian local rings. Denote $\mathfrak m$ the maximal ideal of $R$. Suppose $f_1, \ldots, f_c$ is a sequence of elements of $S$ such that the images $\overline{f}_1, \ldots, \overline{f}_c$ form a regular sequence in $S/{\mathfrak m}S$. Then $f_1, \ldots, f_c$ is a regular sequence in $S$ and each of the quotients $S/(f_1, \ldots, f_i)$ is flat over $R$.

\begin{lemma} \label{lemma-free-fibre-flat-free} Let $R \to S$ be a local homomorphism of Noetherian local rings. Let $\mathfrak m$ be the maximal ideal of $R$. Let $M$ be a finite $S$-modules. Suppose that (a) $M/\mathfrak mM$ is a free $S/\mathfrak mS$-module, and (b) $M$ is flat over $R$. Then $M$ is free and $S$ is flat over $R$.

\begin{lemma} \label{lemma-complex-exact-mod} Let $R \to S$ be a local homomorphism of local Noetherian rings. Let $\mathfrak m$ be the maximal ideal of $R$. Let $0 \to F_e \to F_{e-1} \to \ldots \to F_0$ be a finite complex of finite $S$-modules. Assume that each $F_i$ is $R$-flat, and that the complex $0 \to F_e/\mathfrak m F_e \to F_{e-1}/\mathfrak m F_{e-1} \to \ldots \to F_0 / \mathfrak m F_0$ is exact. Then $0 \to F_e \to F_{e-1} \to \ldots \to F_0$ is exact, and moreover the module $\Coker(F_1 \to F_0)$ is $R$-flat.

\begin{lemma} \label{lemma-prepare-local-criterion-flatness} Let $R$ be a local ring with maximal ideal $\mathfrak m$ and residue field $\kappa = R/\mathfrak m$. Let $M$ be an $R$-module. If $\text{Tor}_1^R(\kappa, M) = 0$, then for every finite length $R$-module $N$ we have $\text{Tor}_1^R(N, M) = 0$.



\begin{lemma} \label{lemma-what-does-it-mean} Let $R$ be a ring. Let $I \subset R$ be an ideal. Let $M$ be an $R$-module. If $M/IM$ is flat over $R/I$ and $\text{Tor}_1^R(R/I, M) = 0$ then \begin{enumerate} \item $M/I^nM$ is flat over $R/I^n$ for all $n \geq 1$, and \item for any module $N$ which is annihilated by $I^m$ for some $m \geq 0$ we have $\text{Tor}_1^R(N, M) = 0$. \end{enumerate} In particular, if $I$ is nilpotent, then $M$ is flat over $R$.

\begin{lemma} \label{lemma-what-does-it-mean-again} Let $R$ be a ring. Let $I \subset R$ be an ideal. Let $M$ be an $R$-module. \begin{enumerate} \item If $M/IM$ is flat over $R/I$ and $M \otimes_R I/I^2 \to IM/I^2M$ is injective, then $M/I^2M$ is flat over $R/I^2$. \item If $M/IM$ is flat over $R/I$ and $M \otimes_R I^n/I^{n + 1} \to I^nM/I^{n + 1}M$ is injective for $n = 1, \ldots, k$, then $M/I^{k + 1}M$ is flat over $R/I^{k + 1}$. \end{enumerate}



\begin{lemma} \label{lemma-flat-module-powers} Let $R \to S$ be a ring map. Let $I \subset R$ be an ideal. Let $M$ be an $S$-module. Assume \begin{enumerate} \item $R$ is a Noetherian ring, \item $S$ is a Noetherian ring, \item $M$ is a finite $S$-module, and \item for each $n \geq 1$ the module $M/I^n M$ is flat over $R/I^n$. \end{enumerate} Then for every $\mathfrak q \in V(IS)$ the localization $M_{\mathfrak q}$ is flat over $R$. In particular, if $S$ is local and $IS$ is contained in its maximal ideal, then $M$ is flat over $R$.

\begin{lemma} \label{lemma-surjective-on-tor-one} Let $R \to R' \to R''$ be ring maps. Let $M$ be an $R$-module. Suppose that $M \otimes_R R'$ is flat over $R'$. Then the natural map $\text{Tor}_1^R(M, R') \otimes_{R'} R'' \to \text{Tor}_1^R(M, R'')$ is onto.

\begin{lemma} \label{lemma-surjective-on-tor-one-trivial} Let $R \to R'$ be a ring map. Let $I \subset R$ be an ideal and $I' = IR'$. Let $M$ be an $R$-module and set $M' = M \otimes_R R'$. The natural map $\text{Tor}_1^R(R'/I', M) \to \text{Tor}_1^{R'}(R'/I', M')$ is surjective.

\begin{lemma} \label{lemma-another-variant-local-criterion-flatness} Let $$ \xymatrix{ S \ar[r] & S' \\ R \ar[r] \ar[u] & R' \ar[u] } $$ be a commutative diagram of local homomorphisms of local Noetherian rings. Let $I \subset R$ be a proper ideal. Let $M$ be a finite $S$-module. Denote $I' = IR'$ and $M' = M \otimes_S S'$. Assume that \begin{enumerate} \item $S'$ is a localization of the tensor product $S \otimes_R R'$, \item $M/IM$ is flat over $R/I$, \item $\text{Tor}_1^R(M, R/I) \to \text{Tor}_1^{R'}(M', R'/I')$ is zero. \end{enumerate} Then $M'$ is flat over $R'$.



\begin{lemma} \label{lemma-base-change-flat-up-down} Let $$ \xymatrix{ S \ar[r] & S' \\ R \ar[r] \ar[u] & R' \ar[u] } $$ be a commutative diagram of local homomorphisms of local rings. Assume that $S'$ is a localization of the tensor product $S \otimes_R R'$. Let $M$ be an $S$-module and set $M' = S' \otimes_S M$. \begin{enumerate} \item If $M$ is flat over $R$ then $M'$ is flat over $R'$. \item If $M'$ is flat over $R'$ and $R \to R'$ is flat then $M$ is flat over $R$. \end{enumerate} In particular we have \begin{enumerate} \item[(3)] If $S$ is flat over $R$ then $S'$ is flat over $R'$. \item[(4)] If $R' \to S'$ and $R \to R'$ are flat then $S$ is flat over $R$. \end{enumerate}

\begin{lemma} \label{lemma-local-artinian-basis-when-flat} Let $(R, \mathfrak m)$ be a local ring with nilpotent maximal ideal $\mathfrak m$. Let $M$ be a flat $R$-module. If $A$ is a set and $x_\alpha \in M$, $\alpha \in A$ is a collection of elements of $M$, then the following are equivalent: \begin{enumerate} \item $\{\overline{x}_\alpha\}_{\alpha \in A}$ forms a basis for the vector space $M/\mathfrak mM$ over $R/\mathfrak m$, and \item $\{x_\alpha\}_{\alpha \in A}$ forms a basis for $M$ over $R$. \end{enumerate}

\begin{lemma} \label{lemma-local-artinian-characterize-flat} Let $R$ be a local ring with nilpotent maximal ideal. Let $M$ be an $R$-module. The following are equivalent \begin{enumerate} \item $M$ is flat over $R$, \item $M$ is a free $R$-module, and \item $M$ is a projective $R$-module. \end{enumerate}

\begin{lemma} \label{lemma-lift-basis} Let $R$ be a ring. Let $I \subset R$ be an ideal. Let $M$ be an $R$-module. Let $A$ be a set and let $x_\alpha \in M$, $\alpha \in A$ be a collection of elements of $M$. Assume \begin{enumerate} \item $I$ is nilpotent, \item $\{\overline{x}_\alpha\}_{\alpha \in A}$ forms a basis for $M/IM$ over $R/I$, and \item $\text{Tor}_1^R(R/I, M) = 0$. \end{enumerate} Then $M$ is free on $\{x_\alpha\}_{\alpha \in A}$ over $R$.

\begin{lemma} \label{lemma-prepare-lift-flatness} Let $\varphi : R \to R'$ be a ring map. Let $I \subset R$ be an ideal. Let $M$ be an $R$-module. Assume \begin{enumerate} \item $M/IM$ is flat over $R/I$, and \item $R' \otimes_R M$ is flat over $R'$. \end{enumerate} Set $I_2 = \varphi^{-1}(\varphi(I^2)R')$. Then $M/I_2M$ is flat over $R/I_2$.

\begin{lemma} \label{lemma-lift-flatness} Let $\varphi : R \to R'$ be a ring map. Let $I \subset R$ be an ideal. Let $M$ be an $R$-module. Assume \begin{enumerate} \item $I$ is nilpotent, \item $R \to R'$ is injective, \item $M/IM$ is flat over $R/I$, and \item $R' \otimes_R M$ is flat over $R'$. \end{enumerate} Then $M$ is flat over $R$.

\begin{lemma} \label{lemma-artinian-variant-local-criterion-flatness} Let $R$ be an Artinian local ring. Let $M$ be an $R$-module. Let $I \subset R$ be a proper ideal. The following are equivalent \begin{enumerate} \item $M$ is flat over $R$, and \item $M/IM$ is flat over $R/I$ and $\text{Tor}_1^R(R/I, M) = 0$. \end{enumerate}

\begin{lemma} \label{lemma-descent-flatness-injective-map-artinian-rings} Let $R \to S$ be a ring map. Let $M$ be an $R$-module. Assume \begin{enumerate} \item $R$ is Artinian \item $R \to S$ is injective, and \item $M \otimes_R S$ is a flat $S$-module. \end{enumerate} Then $M$ is a flat $R$-module.



\begin{lemma} \label{lemma-add-trivial-complex} In Situation \ref{situation-complex}. Suppose $R$ is a local ring with maximal ideal $\mathfrak m$. Suppose that for some $i$, $e \leq i \leq 1$ some matrix coefficient of the map $\varphi_i$ is invertible. Then the complex $0 \to R^{n_e} \to R^{n_{e-1}} \to \ldots \to R^{n_0}$ is isomorphic to the direct sum of a complex $0 \to R^{n_e} \to \ldots \to R^{n_i - 1} \to R^{n_{i-1} - 1} \to \ldots \to R^{n_0}$ and the complex $0 \to 0 \to \ldots \to R \to R \to 0 \to \ldots \to 0$ where the map $R \to R$ is the identity map.

\begin{lemma} \label{lemma-exact-artinian-local} In Situation \ref{situation-complex}. Let $R$ be a Artinian local ring. Suppose that $0 \to R^{n_e} \to R^{n_{e-1}} \to \ldots \to R^{n_0}$ is an exact complex. Then the complex is isomorphic to a direct sum of trivial complexes.

\begin{definition} \label{definition-rank} Let $R$ be a ring. Suppose that $\varphi : R^m \to R^n$ is a map of finite free modules. \begin{enumerate} \item The {\it rank} of $\varphi$ is the maximal $r$ such that $\wedge^r \varphi : \wedge^r R^m \to \wedge^r R^n$ is nonzero. \item We let $I(\varphi) \subset R$ be the ideal generated by the $r \times r$ minors of the matrix of $\varphi$, where $r$ is the rank as defined above. \end{enumerate}

\begin{lemma} \label{lemma-trivial-case-exact} In Situation \ref{situation-complex}, suppose the complex is isomorphic to a direct sum of trivial complexes. Then we have \begin{enumerate} \item the maps $\varphi_i$ have rank $r_i = n_i - n_{i + 1} + \ldots + (-1)^{e-i-1} n_{e-1} + (-1)^{e-i} n_e$, \item for all $i$, $1 \leq i \leq e$ we have $\text{rank}(\varphi_{i + 1}) + \text{rank}(\varphi_i) = n_i$, \item each $I(\varphi_i) = R$. \end{enumerate}

\begin{lemma} \label{lemma-exact-length-1} Let $R$ be a local Noetherian ring. Suppose that $\varphi : R^m \to R^n$ is a map of finite free modules. The following are equivalent \begin{enumerate} \item $\varphi$ is injective. \item the rank of $\varphi$ is $m$ and either $I(\varphi) = R$ or it contains a nonzerodivisor. \end{enumerate}

\begin{lemma} \label{lemma-exact-depth-zero-local} In Situation \ref{situation-complex}. Suppose $R$ is a local Noetherian ring with maximal ideal $\mathfrak m$. Assume $\mathfrak m \in \text{Ass}(R)$, in other words $R$ has depth $0$. Suppose that the complex is exact. In this case the complex is isomorphic to a direct sum of trivial complexes.

\begin{lemma} \label{lemma-div-x-exact-one-less} In Situation \ref{situation-complex}, suppose $R$ is a local Noetherian ring, and suppose that the complex is exact. Let $x$ be an element of the maximal ideal which is a nonzerodivisor. The complex $0 \to (R/xR)^{n_e} \to \ldots \to (R/xR)^{n_1}$ is still exact.



\begin{definition} \label{definition-CM} Let $R$ be a Noetherian local ring. Let $M$ be a finite $R$-module. We say $M$ is {\it Cohen-Macaulay} if $\dim(\text{Supp}(M)) = \text{depth}(M)$.

\begin{lemma} \label{lemma-good-element} Notation and assumptions as above. If $g$ is good with respect to $(M, f_1, \ldots, f_d)$, then (a) $g$ is a nonzerodivisor on $M$, and (b) $M/gM$ is Cohen-Macaulay with maximal regular sequence $f_1, \ldots, f_{d-1}$.

\begin{lemma} \label{lemma-CM-one-g} Let $R$ be a Noetherian local ring. Let $M$ be a Cohen-Macaulay module over $R$. Suppose $g \in \mathfrak m$ is such that $\dim(\text{Supp}(M) \cap V(g)) = \dim(\text{Supp}(M)) - 1$. Then (a) $g$ is a nonzerodivisor on $M$, and (b) $M/gM$ is Cohen-Macaulay of depth one less.

\begin{lemma} \label{lemma-nonzerodivisor-on-CM} Let $R$ be a Noetherian local ring with maximal ideal $\mathfrak m$. Let $M$ be a finite $R$-module. Let $x \in \mathfrak m$ be a nonzerodivisor on $M$. Then $M$ is Cohen-Macaulay if and only if $M/xM$ is Cohen-Macaulay.

\begin{lemma} \label{lemma-CM-over-quotient} Let $R \to S$ be a surjective homomorphism of Noetherian local rings. Let $N$ be a finite $S$-module. Then $N$ is Cohen-Macaulay as an $S$-module if and only if $N$ is Cohen-Macaulay as an $R$-module.

\begin{lemma} \label{lemma-CM-ass-minimal-support} Let $R$ be a Noetherian local ring. Let $M$ be a finite Cohen-Macaulay $R$-module. If $\mathfrak p \in \text{Ass}(M)$, then $\dim(R/\mathfrak p) = \dim(\text{Supp}(M))$ and $\mathfrak p$ is a minimal prime in the support of $M$. In particular, $M$ has no embedded associated primes.

\begin{definition} \label{definition-maximal-CM} Let $R$ be a Noetherian local ring. A finite module $M$ over $R$ is called a {\it maximal Cohen-Macaulay} module if $\text{depth}(M) = \dim(R)$.

\begin{lemma} \label{lemma-maximal-chain-maximal-CM} Let $R$ be a Noetherian local ring. Assume there exists a Cohen-Macaulay module $M$ with $\Spec(R) = \text{Supp}(M)$. Then any maximal chain of ideals $\mathfrak p_0 \subset \mathfrak p_1 \subset \ldots \subset \mathfrak p_n$ has length $n = \dim(R)$.

\begin{lemma} \label{lemma-dim-formula-maximal-CM} Suppose $R$ is a Noetherian local ring. Assume there exists a Cohen-Macaulay module $M$ with $\Spec(R) = \text{Supp}(M)$. Then for a prime $\mathfrak p \subset R$ we have $$ \dim(R) = \dim(R_{\mathfrak p}) + \dim(R/\mathfrak p). $$

\begin{lemma} \label{lemma-localize-CM-module} Suppose $R$ is a Noetherian local ring. Let $M$ be a Cohen-Macaulay module over $R$. For any prime $\mathfrak p \subset R$ the module $M_{\mathfrak p}$ is Cohen-Macaulay over $R_\mathfrak p$.

\begin{definition} \label{definition-module-CM} Let $R$ be a Noetherian ring. Let $M$ be a finite $R$-module. We say $M$ is {\it Cohen-Macaulay} if $M_\mathfrak p$ is a Cohen-Macaulay module over $R_\mathfrak p$ for all primes $\mathfrak p$ of $R$.

\begin{lemma} \label{lemma-maximal-CM-polynomial-algebra} Let $R$ be a Noetherian ring. Let $M$ be a Cohen-Macaulay module over $R$. Then $M \otimes_R R[x_1, \ldots, x_n]$ is a Cohen-Macaulay module over $R[x_1, \ldots, x_n]$.

\begin{definition} \label{definition-local-ring-CM} A Noetherian local ring $R$ is called {\it Cohen-Macaulay} if it is Cohen-Macaulay as a module over itself.

\begin{lemma} \label{lemma-reformulate-CM} \begin{slogan} Regular sequences in Cohen-Macaulay local rings are characterized by cutting out something of the correct dimension. \end{slogan} Let $R$ be a Noetherian local Cohen-Macaulay ring with maximal ideal $\mathfrak m $. Let $x_1, \ldots, x_c \in \mathfrak m$ be elements. Then $$ x_1, \ldots, x_c \text{ is a regular sequence } \Leftrightarrow \dim(R/(x_1, \ldots, x_c)) = \dim(R) - c $$ If so $x_1, \ldots, x_c$ can be extended to a regular sequence of length $\dim(R)$ and each quotient $R/(x_1, \ldots, x_i)$ is a Cohen-Macaulay ring of dimension $\dim(R) - i$.

\begin{lemma} \label{lemma-maximal-chain-CM} Let $R$ be Noetherian local. Suppose $R$ is Cohen-Macaulay of dimension $d$. Any maximal chain of ideals $\mathfrak p_0 \subset \mathfrak p_1 \subset \ldots \subset \mathfrak p_n$ has length $n = d$.

\begin{lemma} \label{lemma-CM-dim-formula} Suppose $R$ is a Noetherian local Cohen-Macaulay ring of dimension $d$. For any prime $\mathfrak p \subset R$ we have $$ \dim(R) = \dim(R_{\mathfrak p}) + \dim(R/\mathfrak p). $$

\begin{lemma} \label{lemma-localize-CM} Suppose $R$ is a Cohen-Macaulay local ring. For any prime $\mathfrak p \subset R$ the ring $R_{\mathfrak p}$ is Cohen-Macaulay as well.

\begin{definition} \label{definition-ring-CM} A Noetherian ring $R$ is called {\it Cohen-Macaulay} if all its local rings are Cohen-Macaulay.

\begin{lemma} \label{lemma-CM-polynomial-algebra} Suppose $R$ is a Cohen-Macaulay ring. Any polynomial algebra over $R$ is Cohen-Macaulay.

\begin{lemma} \label{lemma-dimension-shift} Let $R$ be a Noetherian local Cohen-Macaulay ring of dimension $d$. Let $0 \to K \to R^{\oplus n} \to M \to 0$ be an exact sequence of $R$-modules. Then either $\text{depth}(K) > \text{depth}(M)$ or $\text{depth}(K) = \text{depth}(M) = d$.

\begin{lemma} \label{lemma-mcm-resolution} Let $R$ be a local Noetherian Cohen-Macaulay ring of dimension $d$. Let $M$ be a finite $R$ module of depth $e$. There exists an exact complex $$ 0 \to K \to F_{d-e-1} \to \ldots \to F_0 \to M \to 0 $$ with each $F_i$ finite free and $K$ maximal Cohen-Macaulay.

\begin{lemma} \label{lemma-find-sequence-image-regular} Let $\varphi : A \to B$ be a map of local rings. Assume that $B$ is Noetherian and Cohen-Macaulay and that $\mathfrak m_B = \sqrt{\varphi(\mathfrak m_A) B}$. Then there exists a sequence of elements $f_1, \ldots, f_{\dim(B)}$ in $A$ such that $\varphi(f_1), \ldots, \varphi(f_{\dim(B)})$ is a regular sequence in $B$.

\begin{definition} \label{definition-catenary} A ring $R$ is said to be {\it catenary} if for any pair of prime ideals $\mathfrak p \subset \mathfrak q$, all maximal chains of primes $\mathfrak p = \mathfrak p_0 \subset \mathfrak p_1 \subset \ldots \subset \mathfrak p_e = \mathfrak q$ have the same (finite) length.

\begin{lemma} \label{lemma-catenary} A ring $R$ is catenary if and only if the topological space $\Spec(R)$ is catenary (see Topology, Definition \ref{topology-definition-catenary}).

\begin{definition} \label{definition-universally-catenary} A ring $R$ is said to be {\it universally catenary} if $R$ is Noetherian and every $R$ algebra of finite type is catenary.

\begin{lemma} \label{lemma-localization-catenary} Any localization of a (universally) catenary ring is (universally) catenary.

\begin{lemma} \label{lemma-catenary-check-local} Let $R$ be a ring. The following are equivalent \begin{enumerate} \item $R$ is catenary, \item $R_\mathfrak p$ is catenary for all prime ideals $\mathfrak p$, \item $R_\mathfrak m$ is catenary for all maximal ideals $\mathfrak m$. \end{enumerate} Assume $R$ is Noetherian. The following are equivalent \begin{enumerate} \item $R$ is universally catenary, \item $R_\mathfrak p$ is universally catenary for all prime ideals $\mathfrak p$, \item $R_\mathfrak m$ is universally catenary for all maximal ideals $\mathfrak m$. \end{enumerate}

\begin{lemma} \label{lemma-quotient-catenary} Any quotient of a (universally) catenary ring is (universally) catenary.

\begin{lemma} \label{lemma-catenary-check-irreducible} Let $R$ be a Noetherian ring. \begin{enumerate} \item $R$ is catenary if and only if $R/\mathfrak p$ is catenary for every minimal prime $\mathfrak p$. \item $R$ is universally catenary if and only if $R/\mathfrak p$ is universally catenary for every minimal prime $\mathfrak p$. \end{enumerate}

\begin{lemma} \label{lemma-CM-ring-catenary} A Cohen-Macaulay ring is universally catenary. More generally, if $R$ is a Noetherian ring and $M$ is a Cohen-Macaulay $R$-module with $\text{Supp}(M) = \Spec(R)$, then $R$ is universally catenary.

\begin{lemma} \label{lemma-regular-graded} Let $R$ be a regular local ring with maximal ideal $\mathfrak m$. The graded ring $\bigoplus \mathfrak m^n / \mathfrak m^{n + 1}$ is isomorphic to the graded polynomial algebra $\kappa(\mathfrak m)[X_1, \ldots, X_d]$.

\begin{lemma} \label{lemma-regular-domain} Any regular local ring is a domain.

\begin{lemma} \label{lemma-regular-ring-CM} Let $R$ be a regular local ring and let $x_1, \ldots, x_d$ be a minimal set of generators for the maximal ideal $\mathfrak m$. Then $x_1, \ldots, x_d$ is a regular sequence, and each $R/(x_1, \ldots, x_c)$ is a regular local ring of dimension $d - c$. In particular $R$ is Cohen-Macaulay.

\begin{lemma} \label{lemma-regular-quotient-regular} Let $R$ be a regular local ring. Let $I \subset R$ be an ideal such that $R/I$ is a regular local ring as well. Then there exists a minimal set of generators $x_1, \ldots, x_d$ for the maximal ideal $\mathfrak m$ of $R$ such that $I = (x_1, \ldots, x_c)$ for some $0 \leq c \leq d$.

\begin{lemma} \label{lemma-free-mod-x} Let $R$ be a Noetherian local ring. Let $x \in \mathfrak m$. Let $M$ be a finite $R$-module such that $x$ is a nonzerodivisor on $M$ and $M/xM$ is free over $R/xR$. Then $M$ is free over $R$.

\begin{lemma} \label{lemma-regular-mcm-free} Let $R$ be a regular local ring. Any maximal Cohen-Macaulay module over $R$ is free.

\begin{lemma} \label{lemma-regular-mod-x} Suppose $R$ is a Noetherian local ring. Let $x \in \mathfrak m$ be a nonzerodivisor such that $R/xR$ is a regular local ring. Then $R$ is a regular local ring. More generally, if $x_1, \ldots, x_r$ is a regular sequence in $R$ such that $R/(x_1, \ldots, x_r)$ is a regular local ring, then $R$ is a regular local ring.

\begin{lemma} \label{lemma-colimit-regular} Let $(R_i, \varphi_{ii'})$ be a directed system of local rings whose transition maps are local ring maps. If each $R_i$ is a regular local ring and $R = \colim R_i$ is Noetherian, then $R$ is a regular local ring.

\begin{lemma} \label{lemma-epimorphism} Let $R \to S$ be a ring map. The following are equivalent \begin{enumerate} \item $R \to S$ is an epimorphism, \item the two ring maps $S \to S \otimes_R S$ are equal, \item either of the ring maps $S \to S \otimes_R S$ is an isomorphism, and \item the ring map $S \otimes_R S \to S$ is an isomorphism. \end{enumerate}

\begin{lemma} \label{lemma-composition-epimorphism} The composition of two epimorphisms of rings is an epimorphism.

\begin{lemma} \label{lemma-base-change-epimorphism} If $R \to S$ is an epimorphism of rings and $R \to R'$ is any ring map, then $R' \to R' \otimes_R S$ is an epimorphism.

\begin{lemma} \label{lemma-permanence-epimorphism} If $A \to B \to C$ are ring maps and $A \to C$ is an epimorphism, so is $B \to C$.

\begin{lemma} \label{lemma-epimorphism-local} Let $R \to S$ be a ring map. The following are equivalent: \begin{enumerate} \item $R \to S$ is an epimorphism, and \item $R_{\mathfrak p} \to S_{\mathfrak p}$ is an epimorphism for each prime $\mathfrak p$ of $R$. \end{enumerate}

\begin{lemma} \label{lemma-finite-epimorphism-surjective} \begin{slogan} A ring map is surjective if and only if it is a finite epimorphism. \end{slogan} Let $R \to S$ be a ring map. The following are equivalent \begin{enumerate} \item $R \to S$ is an epimorphism and finite, and \item $R \to S$ is surjective. \end{enumerate}

\begin{lemma} \label{lemma-faithfully-flat-epimorphism} A faithfully flat epimorphism is an isomorphism.

\begin{lemma} \label{lemma-epimorphism-over-field} If $k \to S$ is an epimorphism and $k$ is a field, then $S = k$ or $S = 0$.

\begin{lemma} \label{lemma-epimorphism-injective-spec} Let $R \to S$ be an epimorphism of rings. Then \begin{enumerate} \item $\Spec(S) \to \Spec(R)$ is injective, and \item for $\mathfrak q \subset S$ lying over $\mathfrak p \subset R$ we have $\kappa(\mathfrak p) = \kappa(\mathfrak q)$. \end{enumerate}

\begin{lemma} \label{lemma-relations} Let $R$ be a ring. Let $M$, $N$ be $R$-modules. Let $\{x_i\}_{i \in I}$ be a set of generators of $M$. Let $\{y_j\}_{j \in J}$ be a set of generators of $N$. Let $\{m_j\}_{j \in J}$ be a family of elements of $M$ with $m_j = 0$ for all but finitely many $j$. Then $$ \sum\nolimits_{j \in J} m_j \otimes y_j = 0 \text{ in } M \otimes_R N $$ is equivalent to the following: There exist $a_{i, j} \in R$ with $a_{i, j} = 0$ for all but finitely many pairs $(i, j)$ such that \begin{align*} m_j & = \sum\nolimits_{i \in I} a_{i, j} x_i \quad\text{for all } j \in J, \\ 0 & = \sum\nolimits_{j \in J} a_{i, j} y_j \quad\text{for all } i \in I. \end{align*}

\begin{lemma} \label{lemma-kernel-difference-projections} Let $\varphi : R \to S$ be a ring map. Let $g \in S$. The following are equivalent: \begin{enumerate} \item $g \otimes 1 = 1 \otimes g$ in $S \otimes_R S$, and \item there exist $n \geq 0$ and elements $y_i, z_j \in S$ and $x_{i, j} \in R$ for $1 \leq i, j \leq n$ such that \begin{enumerate} \item $g = \sum_{i, j \leq n} x_{i, j} y_i z_j$, \item for each $j$ we have $\sum x_{i, j}y_i \in \varphi(R)$, and \item for each $i$ we have $\sum x_{i, j}z_j \in \varphi(R)$. \end{enumerate} \end{enumerate}

\begin{lemma} \label{lemma-epimorphism-cardinality} Let $R \to S$ be an epimorphism of rings. Then the cardinality of $S$ is at most the cardinality of $R$. In a formula: $|S| \leq |R|$.

\begin{lemma} \label{lemma-epimorphism-modules} Let $R \to S$ be an epimorphism of rings. Let $N_1, N_2$ be $S$-modules. Then $\Hom_S(N_1, N_2) = \Hom_R(N_1, N_2)$. In other words, the restriction functor $\text{Mod}_S \to \text{Mod}_R$ is fully faithful.

\begin{definition} \label{definition-pure-ideal} Let $R$ be a ring. We say that $I \subset R$ is {\it pure} if the quotient ring $R/I$ is flat over $R$.

\begin{lemma} \label{lemma-pure} Let $R$ be a ring. Let $I \subset R$ be an ideal. The following are equivalent: \begin{enumerate} \item $I$ is pure, \item for every ideal $J \subset R$ we have $J \cap I = IJ$, \item for every finitely generated ideal $J \subset R$ we have $J \cap I = JI$, \item for every $x \in R$ we have $(x) \cap I = xI$, \item for every $x \in I$ we have $x = yx$ for some $y \in I$, \item for every $x_1, \ldots, x_n \in I$ there exists a $y \in I$ such that $x_i = yx_i$ for all $i = 1, \ldots, n$, \item for every prime $\mathfrak p$ of $R$ we have $IR_{\mathfrak p} = 0$ or $IR_{\mathfrak p} = R_{\mathfrak p}$, \item $\text{Supp}(I) = \Spec(R) \setminus V(I)$, \item $I$ is the kernel of the map $R \to (1 + I)^{-1}R$, \item $R/I \cong S^{-1}R$ as $R$-algebras for some multiplicative subset $S$ of $R$, and \item $R/I \cong (1 + I)^{-1}R$ as $R$-algebras. \end{enumerate}

\begin{lemma} \label{lemma-pure-ideal-determined-by-zero-set} \begin{slogan} Pure ideals are determined by their vanishing locus. \end{slogan} Let $R$ be a ring. If $I, J \subset R$ are pure ideals, then $V(I) = V(J)$ implies $I = J$.

\begin{lemma} \label{lemma-pure-open-closed-specializations} Let $R$ be a ring. The rule $I \mapsto V(I)$ determines a bijection $$ \{I \subset R \text{ pure}\} \leftrightarrow \{Z \subset \Spec(R)\text{ closed and closed under generalizations}\} $$

\begin{lemma} \label{lemma-finitely-generated-pure-ideal} Let $R$ be a ring. Let $I \subset R$ be an ideal. The following are equivalent \begin{enumerate} \item $I$ is pure and finitely generated, \item $I$ is generated by an idempotent, \item $I$ is pure and $V(I)$ is open, and \item $R/I$ is a projective $R$-module. \end{enumerate}

\begin{lemma} \label{lemma-finite-flat-module-finitely-presented} Let $R$ be a ring. The following are equivalent: \begin{enumerate} \item every $Z \subset \Spec(R)$ which is closed and closed under generalizations is also open, and \item any finite flat $R$-module is finite locally free. \end{enumerate}



\begin{definition} \label{definition-finite-proj-dim} Let $R$ be a ring. Let $M$ be an $R$-module. We say $M$ has {\it finite projective dimension} if it has a finite length resolution by projective $R$-modules. The minimal length of such a resolution is called the {\it projective dimension} of $M$.

\begin{lemma} \label{lemma-independent-resolution} Let $R$ be a ring. Suppose that $M$ is an $R$-module of projective dimension $d$. Suppose that $F_e \to F_{e-1} \to \ldots \to F_0 \to M \to 0$ is exact with $F_i$ projective and $e \geq d - 1$. Then the kernel of $F_e \to F_{e-1}$ is projective (or the kernel of $F_0 \to M$ is projective in case $e = 0$).

\begin{lemma} \label{lemma-projective-dimension-ext} Let $R$ be a ring. Let $M$ be an $R$-module. Let $n \geq 0$. The following are equivalent \begin{enumerate} \item $M$ has projective dimension $\leq n$, \item $\text{Ext}^i_R(M, N) = 0$ for all $R$-modules $N$ and all $i \geq n + 1$, and \item $\text{Ext}^{n + 1}_R(M, N) = 0$ for all $R$-modules $N$. \end{enumerate}

\begin{lemma} \label{lemma-exact-sequence-projective-dimension} Let $R$ be a ring. Let $0 \to M' \to M \to M'' \to 0$ be a short exact sequence of $R$-modules. \begin{enumerate} \item If $M$ has projective dimension $\leq n$ and $M''$ has projective dimension $\leq n + 1$, then $M'$ has projective dimension $\leq n$. \item If $M'$ and $M''$ have projective dimension $\leq n$ then $M$ has projective dimension $\leq n$. \item If $M'$ has projective dimension $\leq n$ and $M$ has projective dimension $\leq n + 1$ then $M''$ has projective dimension $\leq n + 1$. \end{enumerate}

\begin{definition} \label{definition-finite-gl-dim} Let $R$ be a ring. The ring $R$ is said to have {\it finite global dimension} if there exists an integer $n$ such that every $R$-module has a resolution by projective $R$-modules of length at most $n$. The minimal such $n$ is then called the {\it global dimension} of $R$.

\begin{lemma} \label{lemma-finite-gl-dim} Let $R$ be a ring. The following are equivalent \begin{enumerate} \item $R$ has finite global dimension $\leq n$, \item every finite $R$-module has projective dimension $\leq n$, and \item every cyclic $R$-module $R/I$ has projective dimension $\leq n$. \end{enumerate}

\begin{lemma} \label{lemma-localize-finite-gl-dim} Let $R$ be a ring. Let $M$ be an $R$-module. Let $S \subset R$ be a multiplicative subset. \begin{enumerate} \item If $M$ has projective dimension $\leq n$, then $S^{-1}M$ has projective dimension $\leq n$ over $S^{-1}R$. \item If $R$ has finite global dimension $\leq n$, then $S^{-1}R$ has finite global dimension $\leq n$. \end{enumerate}

\begin{lemma} \label{lemma-finite-gl-dim-primes} Let $R$ be a Noetherian ring. Then $R$ has finite global dimension if and only if there exists an integer $n$ such that for all maximal ideals $\mathfrak m$ of $R$ the ring $R_{\mathfrak m}$ has global dimension $\leq n$.

\begin{lemma} \label{lemma-length-resolution-residue-field} Suppose that $R$ is a Noetherian local ring with maximal ideal $\mathfrak m$ and residue field $\kappa$. In this case the projective dimension of $\kappa$ is $\geq \dim_\kappa \mathfrak m / \mathfrak m^2$.

\begin{lemma} \label{lemma-dim-gl-dim} Let $R$ be a Noetherian local ring. Suppose that the residue field $\kappa$ has finite projective dimension $n$ over $R$. In this case $\dim(R) \geq n$.

\begin{lemma} \label{lemma-localization-of-regular-local-is-regular} A Noetherian local ring $R$ is a regular local ring if and only if it has finite global dimension. In this case $R_{\mathfrak p}$ is a regular local ring for all primes $\mathfrak p$.

\begin{definition} \label{definition-regular} A Noetherian ring $R$ is said to be {\it regular} if all the localizations $R_{\mathfrak p}$ at primes are regular local rings.

\begin{lemma} \label{lemma-finite-gl-dim-finite-dim-regular} Let $R$ be a Noetherian ring. The following are equivalent: \begin{enumerate} \item $R$ has finite global dimension $n$, \item there exists an integer $n$ such that all the localizations $R_{\mathfrak m}$ at maximal ideals are regular of dimension $\leq n$ with equality for at least one $\mathfrak m$, and \item there exists an integer $n$ such that all the localizations $R_{\mathfrak p}$ at prime ideals are regular of dimension $\leq n$ with equality for at least one $\mathfrak p$. \end{enumerate}

\begin{lemma} \label{lemma-flat-under-regular} Let $R \to S$ be a local homomorphism of local Noetherian rings. Assume that $R \to S$ is flat and that $S$ is regular. Then $R$ is regular.

\begin{lemma} \label{lemma-dimension-going-up} Suppose $R \to S$ is a ring map satisfying either going up, see Definition \ref{definition-going-up-down}, or going down see Definition \ref{definition-going-up-down}. Assume in addition that $\Spec(S) \to \Spec(R)$ is surjective. Then $\dim(R) \leq \dim(S)$.

\begin{lemma} \label{lemma-going-up-maximal-on-top} Suppose that $R \to S$ is a ring map with the going up property, see Definition \ref{definition-going-up-down}. If $\mathfrak q \subset S$ is a maximal ideal. Then the inverse image of $\mathfrak q$ in $R$ is a maximal ideal too.

\begin{lemma} \label{lemma-integral-dim-up} Suppose that $R \to S$ is a ring map such that $S$ is integral over $R$. Then $\dim (R) \geq \dim(S)$, and every closed point of $\Spec(S)$ maps to a closed point of $\Spec(R)$.

\begin{lemma} \label{lemma-integral-sub-dim-equal} Suppose $R \subset S$ and $S$ integral over $R$. Then $\dim(R) = \dim(S)$.

\begin{definition} \label{definition-fibre} Suppose that $R \to S$ is a ring map. Let $\mathfrak q \subset S$ be a prime lying over the prime $\mathfrak p$ of $R$. The {\it local ring of the fibre at $\mathfrak q$} is the local ring $$ S_{\mathfrak q}/\mathfrak pS_{\mathfrak q} = (S/\mathfrak pS)_{\mathfrak q} = (S \otimes_R \kappa(\mathfrak p))_{\mathfrak q} $$

\begin{lemma} \label{lemma-dimension-base-fibre-total} Let $R \to S$ be a homomorphism of Noetherian rings. Let $\mathfrak q \subset S$ be a prime lying over the prime $\mathfrak p$. Then $$ \dim(S_{\mathfrak q}) \leq \dim(R_{\mathfrak p}) + \dim(S_{\mathfrak q}/\mathfrak pS_{\mathfrak q}). $$

\begin{lemma} \label{lemma-dimension-base-fibre-equals-total} Let $R \to S$ be a homomorphism of Noetherian rings. Let $\mathfrak q \subset S$ be a prime lying over the prime $\mathfrak p$. Assume the going down property holds for $R \to S$ (for example if $R \to S$ is flat, see Lemma \ref{lemma-flat-going-down}). Then $$ \dim(S_{\mathfrak q}) = \dim(R_{\mathfrak p}) + \dim(S_{\mathfrak q}/\mathfrak pS_{\mathfrak q}). $$

\begin{lemma} \label{lemma-flat-over-regular-with-regular-fibre} Let $R \to S$ be a local homomorphism of local Noetherian rings. Assume \begin{enumerate} \item $R$ is regular, \item $S/\mathfrak m_RS$ is regular, and \item $R \to S$ is flat. \end{enumerate} Then $S$ is regular.

\begin{lemma} \label{lemma-finite-flat-over-regular-CM} Let $R \to S$ be a local homomorphism of Noetherian local rings. Assume $R$ Cohen-Macaulay. If $S$ is finite flat over $R$, or if $S$ is flat over $R$ and $\dim(S) \leq \dim(R)$, then $S$ is Cohen-Macaulay and $\dim(R) = \dim(S)$.

\begin{lemma} \label{lemma-dimension-formula} Let $R \to S$ be a ring map. Let $\mathfrak q$ be a prime of $S$ lying over the prime $\mathfrak p$ of $R$. Assume that \begin{enumerate} \item $R$ is Noetherian, \item $R \to S$ is of finite type, \item $R$, $S$ are domains, and \item $R \subset S$. \end{enumerate} Then we have $$ \text{height}(\mathfrak q) \leq \text{height}(\mathfrak p) + \text{trdeg}_R(S) - \text{trdeg}_{\kappa(\mathfrak p)} \kappa(\mathfrak q) $$ with equality if $R$ is universally catenary.

\begin{lemma} \label{lemma-finite-in-codim-1} Let $A \to B$ be a ring map. Assume \begin{enumerate} \item $A \subset B$ is an extension of domains. \item $A$ is Noetherian, \item $A \to B$ is of finite type, and \item the extension $f.f.(A) \subset f.f.(B)$ is finite. \end{enumerate} Let $\mathfrak p \subset A$ be a prime of height $1$. Then there are at most finitely many primes of $B$ lying over $\mathfrak p$ and they all have height $1$.

\begin{lemma} \label{lemma-dim-affine-space} Let $\mathfrak m$ be a maximal ideal in $k[x_1, \ldots, x_n]$. The ideal $\mathfrak m$ is generated by $n$ elements. The dimension of $k[x_1, \ldots, x_n]_{\mathfrak m}$ is $n$. Hence $k[x_1, \ldots, x_n]_{\mathfrak m}$ is a regular local ring of dimension $n$.

\begin{lemma} \label{lemma-dimension-height-polynomial-ring} Let $k$ be a field. Let $\mathfrak p \subset \mathfrak q \subset k[x_1, \ldots, x_n]$ be a pair of primes. Any maximal chain of primes between $\mathfrak p$ and $\mathfrak q$ has length $\text{height}(\mathfrak q) - \text{height}(\mathfrak p)$.

\begin{lemma} \label{lemma-dimension-spell-it-out} Let $k$ be a field. Let $S$ be a finite type $k$-algebra which is an integral domain. Then $\dim(S) = \dim(S_{\mathfrak m})$ for any maximal ideal $\mathfrak m$ of $S$. In words: every maximal chain of primes has length equal to the dimension of $S$.

\begin{lemma} \label{lemma-dimension-at-a-point-finite-type-over-field} Let $k$ be a field. Let $S$ be a finite type $k$-algebra. Let $X = \Spec(S)$. Let $\mathfrak p \subset S$ be a prime ideal and let $x \in X$ be the corresponding point. The following numbers are equal \begin{enumerate} \item $\dim_x(X)$, \item $\max \dim(Z)$ where the maximum is over those irreducible components $Z$ of $X$ passing through $x$, and \item $\min \dim(S_{\mathfrak m})$ where the minimum is over maximal ideals $\mathfrak m$ with $\mathfrak p \subset \mathfrak m$. \end{enumerate}

\begin{lemma} \label{lemma-dimension-closed-point-finite-type-field} Let $k$ be a field. Let $S$ be a finite type $k$-algebra. Let $X = \Spec(S)$. Let $\mathfrak m \subset S$ be a maximal ideal and let $x \in X$ be the associated closed point. Then $\dim_x(X) = \dim(S_{\mathfrak m})$.

\begin{lemma} \label{lemma-disjoint-decomposition-CM-algebra} Let $k$ be a field. Let $S$ be a finite type $k$ algebra. Assume that $S$ is Cohen-Macaulay. Then $\Spec(S) = \coprod T_d$ is a finite disjoint union of open and closed subsets $T_d$ with $T_d$ equidimensional (see Topology, Definition \ref{topology-definition-equidimensional}) of dimension $d$. Equivalently, $S$ is a product of rings $S_d$, $d = 0, \ldots, \dim(S)$ such that every maximal ideal $\mathfrak m$ of $S_d$ has height $d$.

\begin{lemma} \label{lemma-helper} Let $n \in \mathbf{N}$. Let $N$ be a finite nonempty set of multi-indices $\nu = (\nu_1, \ldots, \nu_n)$. Given $e = (e_1, \ldots, e_n)$ we set $e \cdot \nu = \sum e_i\nu_i$. Then for $e_1 \gg e_2 \gg \ldots \gg e_{n-1} \gg e_n$ we have: If $\nu, \nu' \in N$ then $$ (e \cdot \nu = e \cdot \nu') \Leftrightarrow (\nu = \nu') $$

\begin{lemma} \label{lemma-helper-polynomial} Let $R$ be a ring. Let $g \in R[x_1, \ldots, x_n]$ be an element which is nonconstant, i.e., $g \not \in R$. For $e_1 \gg e_2 \gg \ldots \gg e_{n-1} \gg e_n = 1$ the polynomial $$ g(x_1 + x_n^{e_1}, x_2 + x_n^{e_2}, \ldots, x_{n - 1} + x_n^{e_{n - 1}}, x_n) = ax_n^d + \text{lower order terms in }x_n $$ where $d > 0$ and $a \in R$ is one of the nonzero coefficients of $g$.

\begin{lemma} \label{lemma-one-relation} Let $k$ be a field. Let $S = k[x_1, \ldots, x_n]/I$ for some ideal $I$. If $I \not = 0$, then there exist $y_1, \ldots, y_{n-1} \in k[x_1, \ldots, x_n]$ such that $S$ is finite over $k[y_1, \ldots, y_{n-1}]$. Moreover we may choose $y_i$ to be in the $\mathbf{Z}$-subalgebra of $k[x_1, \ldots, x_n]$ generated by $x_1, \ldots, x_n$.

\begin{lemma} \label{lemma-Noether-normalization} Let $k$ be a field. Let $S = k[x_1, \ldots, x_n]/I$ for some ideal $I$. There exist $r\geq 0$, and $y_1, \ldots, y_r \in k[x_1, \ldots, x_n]$ such that (a) the map $k[y_1, \ldots, y_r] \to S$ is injective, and (b) the map $k[y_1, \ldots, y_r] \to S$ is finite. In this case the integer $r$ is the dimension of $S$. Moreover we may choose $y_i$ to be in the $\mathbf{Z}$-subalgebra of $k[x_1, \ldots, x_n]$ generated by $x_1, \ldots, x_n$.

\begin{lemma} \label{lemma-Noether-normalization-at-point} Let $k$ be a field. Let $S$ be a finite type $k$ algebra and denote $X = \Spec(S)$. Let $\mathfrak q$ be a prime of $S$, and let $x \in X$ be the corresponding point. There exists a $g \in S$, $g \not \in \mathfrak q$ such that $\dim(S_g) = \dim_x(X) =: d$ and such that there exists a finite injective map $k[y_1, \ldots, y_d] \to S_g$.

\begin{lemma} \label{lemma-refined-Noether-normalization} Let $k$ be a field. Let $\mathfrak q \subset k[x_1, \ldots, x_n]$ be a prime ideal. Set $r = \text{trdeg}_k\ \kappa(\mathfrak q)$. Then there exists a finite ring map $\varphi : k[y_1, \ldots, y_n] \to k[x_1, \ldots, x_n]$ such that $\varphi^{-1}(\mathfrak q) = (y_{r + 1}, \ldots, y_n)$.

\begin{lemma} \label{lemma-Noether-normalization-over-a-domain} Let $R \to S$ be an injective finite type map of domains. Then there exists an integer $d$ and factorization $$ R \to R[y_1, \ldots, y_d] \to S' \to S $$ by injective maps such that $S'$ is finite over $R[y_1, \ldots, y_d]$ and such that $S'_f \cong S_f$ for some nonzero $f \in R$.

\begin{lemma} \label{lemma-dimension-prime-polynomial-ring} Let $k$ be a field. Let $S$ be a finite type $k$ algebra which is an integral domain. Let $K = f.f.(S)$ be the field of fractions of $S$. Let $r = \text{trdeg}(K/k)$ be the transcendence degree of $K$ over $k$. Then $\dim(S) = r$. Moreover, the local ring of $S$ at every maximal ideal has dimension $r$.

\begin{lemma} \label{lemma-tr-deg-specialization} Let $k$ be a field. Let $S$ be a finite type $k$-algebra. Let $\mathfrak q \subset \mathfrak q' \subset S$ be distinct prime ideals. Then $\text{trdeg}_k\ \kappa(\mathfrak q') < \text{trdeg}_k\ \kappa(\mathfrak q)$.

\begin{lemma} \label{lemma-dimension-at-a-point-finite-type-field} Let $k$ be a field. Let $S$ be a finite type $k$ algebra. Let $X = \Spec(S)$. Let $\mathfrak p \subset S$ be a prime ideal, and let $x \in X$ be the corresponding point. Then we have $$ \dim_x(X) = \dim(S_{\mathfrak p}) + \text{trdeg}_k\ \kappa(\mathfrak p). $$

\begin{lemma} \label{lemma-codimension} Let $k$ be a field. Let $S' \to S$ be a surjection of finite type $k$ algebras. Let $\mathfrak p \subset S$ be a prime ideal, and let $\mathfrak p'$ be the corresponding prime ideal of $S'$. Let $X = \Spec(S)$, resp.\ $X' = \Spec(S')$, and let $x \in X$, resp. $x'\in X'$ be the point corresponding to $\mathfrak p$, resp.\ $\mathfrak p'$. Then $$ \dim_{x'} X' - \dim_x X = \text{height}(\mathfrak p') - \text{height}(\mathfrak p). $$

\begin{lemma} \label{lemma-dimension-preserved-field-extension} Let $k$ be a field. Let $S$ be a finite type $k$-algebra. Let $k \subset K$ be a field extension. Then $\dim(S) = \dim(K \otimes_k S)$.

\begin{lemma} \label{lemma-dimension-at-a-point-preserved-field-extension} Let $k$ be a field. Let $S$ be a finite type $k$-algebra. Set $X = \Spec(S)$. Let $k \subset K$ be a field extension. Set $S_K = K \otimes_k S$, and $X_K = \Spec(S_K)$. Let $\mathfrak q \subset S$ be a prime corresponding to $x \in X$ and let $\mathfrak q_K \subset S_K$ be a prime corresponding to $x_K \in X_K$ lying over $\mathfrak q$. Then $\dim_x X = \dim_{x_K} X_K$.

\begin{lemma} \label{lemma-dimension-graded} Let $k$ be a field. Let $S$ be a finitely generated graded algebra over $k$. Assume $S_0 = k$. Let $P(T) \in \mathbf{Q}[T]$ be the polynomial such that $\dim(S_d) = P(d)$ for all $d \gg 0$. See Proposition \ref{proposition-graded-hilbert-polynomial}. Then \begin{enumerate} \item The irrelevant ideal $S_{+}$ is a maximal ideal $\mathfrak m$. \item Any minimal prime of $S$ is a homogeneous ideal and is contained in $S_{+} = \mathfrak m$. \item We have $\dim(S) = \deg(P) + 1 = \dim_x\Spec(S)$ (with the convention that $\deg(0) = -1$) where $x$ is the point corresponding to the maximal ideal $S_{+} = \mathfrak m$. \item The Hilbert function of the local ring $R = S_{\mathfrak m}$ is equal to the Hilbert function of $S$. \end{enumerate}

\begin{lemma} \label{lemma-generic-flatness-Noetherian} Let $R \to S$ be a ring map. Let $M$ be an $S$-module. Assume \begin{enumerate} \item $R$ is Noetherian, \item $R$ is a domain, \item $R \to S$ is of finite type, and \item $M$ is a finite type $S$-module. \end{enumerate} Then there exists a nonzero $f \in R$ such that $M_f$ is a free $R_f$-module.

\begin{lemma} \label{lemma-generic-flatness-finitely-presented} \begin{slogan} Generic freeness. \end{slogan} Let $R \to S$ be a ring map. Let $M$ be an $S$-module. Assume \begin{enumerate} \item $R$ is a domain, \item $R \to S$ is of finite presentation, and \item $M$ is an $S$-module of finite presentation. \end{enumerate} Then there exists a nonzero $f \in R$ such that $M_f$ is a free $R_f$-module.

\begin{lemma} \label{lemma-generic-flatness} Let $R \to S$ be a ring map. Let $M$ be an $S$-module. Assume \begin{enumerate} \item $R$ is a domain, \item $R \to S$ is of finite type, and \item $M$ is a finite type $S$-module. \end{enumerate} Then there exists a nonzero $f \in R$ such that \begin{enumerate} \item[(a)] $M_f$ and $S_f$ are free as $R_f$-modules, and \item[(b)] $S_f$ is a finitely presented $R_f$-algebra and $M_f$ is a finitely presented $S_f$-module. \end{enumerate}

\begin{lemma} \label{lemma-generic-flatness-locus-extension} Let $R \to S$ be a ring map. Let $0 \to M_1 \to M_2 \to M_3 \to 0$ be a short exact sequence of $S$-modules. Then $$ U(R \to S, M_1) \cap U(R \to S, M_3) \subset U(R \to S, M_2). $$

\begin{lemma} \label{lemma-generic-flatness-locus-localize} Let $R \to S$ be a ring map. Let $M$ be an $S$-module. Let $f \in R$. Using the identification $\Spec(R_f) = D(f)$ we have $U(R_f \to S_f, M_f) = D(f) \cap U(R \to S, M)$.

\begin{lemma} \label{lemma-generic-flatness-locus-reduce} Let $R \to S$ be a ring map. Let $M$ be an $S$-module. Let $U \subset \Spec(R)$ be a dense open. Assume there is a covering $U = \bigcup_{i \in I} D(f_i)$ of opens such that $U(R_{f_i} \to S_{f_i}, M_{f_i})$ is dense in $D(f_i)$ for each $i \in I$. Then $U(R \to S, M)$ is dense in $\Spec(R)$.

\begin{lemma} \label{lemma-generic-flatness-reduced} Let $R \to S$ be a ring map. Let $M$ be an $S$-module. Assume \begin{enumerate} \item $R \to S$ is of finite type, \item $M$ is a finite $S$-module, and \item $R$ is reduced. \end{enumerate} Then there exists a subset $U \subset \Spec(R)$ such that \begin{enumerate} \item $U$ is open and dense in $\Spec(R)$, \item for every $u \in U$ there exists an $f \in R$ such that $u \in D(f) \subset U$ and such that we have \begin{enumerate} \item $M_f$ and $S_f$ are free over $R_f$, \item $S_f$ is a finitely presented $R_f$-algebra, and \item $M_f$ is a finitely presented $S_f$-module. \end{enumerate} \end{enumerate}

\begin{lemma} \label{lemma-dominate-by-dimension-1} Let $R$ be a local Noetherian domain with fraction field $K$. Assume $R$ is not a field. Then there exist $R \subset R' \subset K$ with \begin{enumerate} \item $R'$ local Noetherian of dimension $1$, \item $R \to R'$ a local ring map, i.e., $R'$ dominates $R$, and \item $R \to R'$ essentially of finite type. \end{enumerate}



\begin{lemma} \label{lemma-nonregular-dimension-one} Let $R$ be a local ring with maximal ideal $\mathfrak m$. Assume $R$ is Noetherian, has dimension $1$, and that $\dim(\mathfrak m/\mathfrak m^2) > 1$. Then there exists a ring map $R \to R'$ such that \begin{enumerate} \item $R \to R'$ is finite, \item $R \to R'$ is not an isomorphism, \item the kernel and cokernel of $R \to R'$ are annihilated by a power of $\mathfrak m$, and \item $\mathfrak m$ is not an associated prime of $R'$. \end{enumerate}

\begin{lemma} \label{lemma-characterize-dvr} Let $A$ be a ring. The following are equivalent. \begin{enumerate} \item The ring $A$ is a discrete valuation ring. \item The ring $A$ is a valuation ring and Noetherian. \item The ring $A$ is a regular local ring of dimension $1$. \item The ring $A$ is a Noetherian local domain with maximal ideal $\mathfrak m$ generated by a single nonzero element. \item The ring $A$ is a Noetherian local normal domain of dimension $1$. \end{enumerate} In this case if $\pi$ is a generator of the maximal ideal of $A$, then every element of $A$ can be uniquely written as $u\pi^n$, where $u \in A$ is a unit.

\begin{definition} \label{definition-uniformizer} Let $A$ be a discrete valuation ring. A {\it uniformizer} is an element $\pi \in A$ which generates the maximal ideal of $A$.

\begin{lemma} \label{lemma-finite-length} Let $R$ be a domain with fraction field $K$. Let $M$ be an $R$-submodule of $K^{\oplus r}$. Assume $R$ is local Noetherian of dimension $1$. For any nonzero $x \in R$ we have $\text{length}_R(R/xR) < \infty$ and $$ \text{length}_R(M/xM) \leq r \cdot \text{length}_R(R/xR). $$

\begin{lemma} \label{lemma-finite-extension-residue-fields-dimension-1} Let $R \to S$ be a homomorphism of domains inducing an injection of fraction fields $K \subset L$. If $R$ is Noetherian local of dimension $1$ and $[L : K] < \infty$ then \begin{enumerate} \item each prime ideal $\mathfrak n_i$ of $S$ lying over the maximal ideal $\mathfrak m$ of $R$ is maximal, \item there are finitely many of these, and \item $[\kappa(\mathfrak n_i) : \kappa(\mathfrak m)] < \infty$ for each $i$. \end{enumerate}

\begin{lemma} \label{lemma-finite-length-global} Let $R$ be a domain with fraction field $K$. Let $M$ be an $R$-submodule of $K^{\oplus r}$. Assume $R$ is Noetherian of dimension $1$. For any nonzero $x \in R$ we have $\text{length}_R(M/xM) < \infty$.



\begin{lemma} \label{lemma-exists-dvr} Let $R$ be a Noetherian local domain with fraction field $K$. Assume that $R$ is not a field. Let $K \subset L$ be a finitely generated field extension. Then there exists discrete valuation ring $A$ with fraction field $L$ which dominates $R$.

\begin{definition} \label{definition-irreducible-prime-element} Let $R$ be a domain. \begin{enumerate} \item Elements $x, y \in R$ are called {\it associates} if there exists a unit $u \in R^*$ such that $x = uy$. \item An element $x \in R$ is called {\it irreducible} if it is nonzero, not a unit and whenever $x = yz$, $y, z \in R$, then $y$ is either a unit or an associate of $x$. \item An element $x \in R$ is called {\it prime} if the ideal generated by $x$ is a prime ideal. \end{enumerate}

\begin{lemma} \label{lemma-easy-divisibility} Let $R$ be a domain. Let $x, y \in R$. Then $x$, $y$ are associates if and only if $(x) = (y)$.

\begin{lemma} \label{lemma-factorization-exists} Let $R$ be a domain. Consider the following conditions: \begin{enumerate} \item The ring $R$ satisfies the ascending chain condition for principal ideals. \item Every nonzero, nonunit element $a \in R$ has a factorization $a = b_1 \ldots b_k$ with each $b_i$ an irreducible element of $R$. \end{enumerate} Then (1) implies (2).

\begin{definition} \label{definition-UFD} A {\it unique factorization domain}, abbreviated {\it UFD}, is a domain $R$ such that if $x \in R$ is a nonzero, nonunit, then $x$ has a factorization into irreducibles, and if $$ x = a_1 \ldots a_m = b_1 \ldots b_n $$ are factorizations into irreducibles then $n = m$ and there exists a permutation $\sigma : \{1, \ldots, n\} \to \{1, \ldots, n\}$ such that $a_i$ and $b_{\sigma(i)}$ are associates.

\begin{lemma} \label{lemma-characterize-UFD} Let $R$ be a domain. Assume every nonzero, nonunit factors into irreducibles. Then $R$ is a UFD if and only if every irreducible element is prime.

\begin{lemma} \label{lemma-characterize-UFD-height-1} Let $R$ be a Noetherian domain. Then $R$ is a UFD if and only if every height $1$ prime ideal is principal.



\begin{lemma} \label{lemma-UFD-ascending-chain-condition-principal-ideals} A UFD satisfies the ascending chain condition for principal ideals.

\begin{lemma} \label{lemma-factoring-in-polynomial} Let $R$ be a domain. Assume $R$ has the ascending chain condition for principal ideals. Then the same property holds for a polynomial ring over $R$.

\begin{lemma} \label{lemma-polynomial-ring-UFD} A polynomial ring over a UFD is a UFD. In particular, if $k$ is a field, then $k[x_1, \ldots, x_n]$ is a UFD.

\begin{lemma} \label{lemma-UFD-normal} A unique factorization domain is normal.

\begin{definition} \label{definition-PID} A {\it principal ideal domain}, abbreviated {\it PID}, is a domain $R$ such that every ideal is a principal ideal.

\begin{lemma} \label{lemma-PID-UFD} A principal ideal domain is a unique factorization domain.

\begin{definition} \label{definition-dedekind-domain} A {\it Dedekind domain} is a domain $R$ such that every nonzero ideal $I \subset R$ can be written as a product $$ I = \mathfrak p_1 \ldots \mathfrak p_r $$ of nonzero prime ideals uniquely up to permutation of the $\mathfrak p_i$.

\begin{lemma} \label{lemma-PID-dedekind} A PID is a Dedekind domain.

\begin{lemma} \label{lemma-product-ideals-principal} Let $A$ be a ring. Let $I$ and $J$ be nonzero ideals of $A$ such that $IJ = (f)$ for some nonzerodivisor $f \in A$. Then $I$ and $J$ are finitely generated ideals and finitely locally free of rank $1$ as $A$-modules.

\begin{lemma} \label{lemma-characterize-Dedekind} Let $R$ be a ring. The following are equivalent \begin{enumerate} \item $R$ is a Dedekind domain, \item $R$ is a Noetherian domain, and for every maximal ideal $\mathfrak m$ the local ring $R_{\mathfrak m}$ is a discrete valuation ring, and \item $R$ is a Noetherian, normal domain, and $\dim(R) \leq 1$. \end{enumerate}

\begin{lemma} \label{lemma-integral-closure-Dedekind} Let $A$ be a Noetherian domain of dimension $1$ with fraction field $K$. Let $K \subset L$ be a finite extension. Let $B$ be the integral closure of $A$ in $L$. Then $B$ is a Dedekind domain and $\Spec(B) \to \Spec(A)$ is surjective, has finite fibres, and induces finite residue field extensions.

\begin{lemma} \label{lemma-ord-additive} Let $R$ be a semi-local Noetherian ring of dimension $1$. If $a, b \in R$ are nonzerodivisors then $$ \text{length}_R(R/(ab)) = \text{length}_R(R/(a)) + \text{length}_R(R/(b)) $$ and these lengths are finite.

\begin{definition} \label{definition-ord} Suppose that $K$ is a field, and $R \subset K$ is a local\footnote{We could also define this when $R$ is only semi-local but this is probably never really what you want!} Noetherian subring of dimension $1$ with fraction field $K$. In this case we define the {\it order of vanishing along $R$} $$ \text{ord}_R : K^* \longrightarrow \mathbf{Z} $$ by the rule $$ \text{ord}_R(x) = \text{length}_R(R/(x)) $$ if $x \in R$ and we set $\text{ord}_R(x/y) = \text{ord}_R(x) - \text{ord}_R(y)$ for $x, y \in R$ both nonzero.

\begin{definition} \label{definition-lattice} Let $R$ be a Noetherian local domain of dimension $1$ with fraction field $K$. Let $V$ be a finite dimensional $K$-vector space. A {\it lattice in $V$} is a finite $R$-submodule $M \subset V$ such that $V = K \otimes_R M$.

\begin{lemma} \label{lemma-compare-lattices} Let $R$ be a Noetherian local domain of dimension $1$ with fraction field $K$. Let $V$ be a finite dimensional $K$-vector space. \begin{enumerate} \item If $M$ is a lattice in $V$ and $M \subset M' \subset V$ is an $R$-submodule of $V$ containing $M$ then the following are equivalent \begin{enumerate} \item $M'$ is a lattice, \item $\text{length}_R(M'/M)$ is finite, and \item $M'$ is finitely generated. \end{enumerate} \item If $M$ is a lattice in $V$ and $M' \subset M$ is an $R$-submodule of $M$ then $M'$ is a lattice if and only if $\text{length}_R(M/M')$ is finite. \item If $M$, $M'$ are lattices in $V$, then so are $M \cap M'$ and $M + M'$. \item If $M \subset M' \subset M'' \subset V$ are lattices in $V$ then $$ \text{length}_R(M''/M) = \text{length}_R(M'/M) + \text{length}_R(M''/M'). $$ \item If $M$, $M'$, $N$, $N'$ are lattices in $V$ and $N \subset M \cap M'$, $M + M' \subset N'$, then we have \begin{eqnarray*} & & \text{length}_R(M/M \cap M') - \text{length}_R(M'/M \cap M')\\ & = & \text{length}_R(M/N) - \text{length}_R(M'/N) \\ & = & \text{length}_R(M + M' / M') - \text{length}_R(M + M'/M) \\ & = & \text{length}_R(N' / M') - \text{length}_R(N'/M) \end{eqnarray*} \end{enumerate}

\begin{definition} \label{definition-distance} Let $R$ be a Noetherian local domain of dimension $1$ with fraction field $K$. Let $V$ be a finite dimensional $K$-vector space. Let $M$, $M'$ be two lattices in $V$. The {\it distance between $M$ and $M'$} is the integer $$ d(M, M') = \text{length}_R(M/M \cap M') - \text{length}_R(M'/M \cap M') $$ of Lemma \ref{lemma-compare-lattices} part (5).

\begin{lemma} \label{lemma-properties-distance-function} Let $R$ be a Noetherian local domain of dimension $1$ with fraction field $K$. Let $V$ be a finite dimensional $K$-vector space. This distance function has the property that $$ d(M, M'') = d(M, M') + d(M', M'') $$ whenever given three lattices $M$, $M'$, $M''$ of $V$. In particular we have $d(M, M') = - d(M', M)$.

\begin{lemma} \label{lemma-order-vanishing-determinant} Let $R$ be a Noetherian local domain of dimension $1$ with fraction field $K$. Let $V$ be a finite dimensional $K$-vector space. Let $\varphi : V \to V$ be a $K$-linear isomorphism. For any lattice $M \subset V$ we have $$ d(M, \varphi(M)) = \text{ord}_R(\det(\varphi)) $$

\begin{lemma} \label{lemma-finite-extension-dim-1} Let $A \to B$ be a ring map. Assume \begin{enumerate} \item $A$ is a Noetherian local domain of dimension $1$, \item $A \subset B$ is a finite extension of domains. \end{enumerate} Let $K = f.f.(A)$ and $L = f.f.(B)$ so that $L$ is a finite field extension of $K$. Let $y \in L^*$ and $x = \text{Nm}_{L/K}(y)$. In this situation $B$ is semi-local. Let $\mathfrak m_i$, $i = 1, \ldots, n$ be the maximal ideals of $B$. Then $$ \text{ord}_A(x) = \sum\nolimits_i [\kappa(\mathfrak m_i) : \kappa(\mathfrak m_A)] \text{ord}_{B_{\mathfrak m_i}}(y) $$ where $\text{ord}$ is defined as in Definition \ref{definition-ord}.

\begin{lemma} \label{lemma-not-domain} Let $(R, \mathfrak m)$ be a reduced Noetherian local ring of dimension $1$ and let $x \in \mathfrak m$ be a nonzerodivisor. Let $\mathfrak q_1, \ldots, \mathfrak q_r$ be the minimal primes of $R$. Then $$ \text{length}_R(R/(x)) = \sum\nolimits_i \text{ord}_{R/\mathfrak q_i}(x) $$

\begin{lemma} \label{lemma-length-multiplication} Let $R$ be a Noetherian local ring with maximal ideal $\mathfrak m$. Let $M$ be a finite $R$-module. Let $x \in R$. Assume that \begin{enumerate} \item $\dim(\text{Supp}(M)) \leq 1$, and \item $\dim(\text{Supp}(M/xM)) \leq 0$. \end{enumerate} Write $\text{Supp}(M) = \{\mathfrak m, \mathfrak q_1, \ldots, \mathfrak q_t\}$. Then $$ \text{length}_R(M_x) - \text{length}_R({}_xM) = \sum\nolimits_{i = 1, \ldots, t} \text{ord}_{R/\mathfrak q_i}(x) \text{length}_{R_{\mathfrak q_i}}(M_{\mathfrak q_i}). $$ where $M_x = M/xM$ and ${}_xM = \Ker(x : M \to M)$.

\begin{lemma} \label{lemma-additivity-divisors-restricted} Let $R$ be a Noetherian local ring with maximal ideal $\mathfrak m$. Let $I \subset R$ be an ideal and let $x \in R$. Assume $x$ is a nonzerodivisor on $R/I$ and that $\dim(R/I) = 1$. Then $$ \text{length}_R(R/(x, I)) = \sum\nolimits_i \text{length}_R(R/(x, \mathfrak q_i)) \text{length}_{R_{\mathfrak q_i}}((R/I)_{\mathfrak q_i}) $$ where $\mathfrak q_1, \ldots, \mathfrak q_n$ are the minimal primes over $I$. More generally if $M$ is any finite Cohen-Macaulay module of dimension $1$ over $R$ and $\dim(\text{Supp}(M/xM)) = 0$, then $$ \text{length}_R(M/xM) = \sum\nolimits_i \text{length}_R(R/(x, \mathfrak q_i)) \text{length}_{R_{\mathfrak q_i}}(M_{\mathfrak q_i}). $$ where $\mathfrak q_1, \ldots, \mathfrak q_t$ are the minimal primes of the support of $M$.

\begin{lemma} \label{lemma-isolated-point} Let $k$ be a field. Let $S$ be a finite type $k$ algebra. Let $\mathfrak q$ be a prime of $S$. The following are equivalent: \begin{enumerate} \item $\mathfrak q$ is an isolated point of $\Spec(S)$, \item $S_{\mathfrak q}$ is finite over $k$, \item there exists a $g \in S$, $g \not\in \mathfrak q$ such that $D(g) = \{ \mathfrak q \}$, \item $\dim_{\mathfrak q} \Spec(S) = 0$, \item $\mathfrak q$ is a closed point of $\Spec(S)$ and $\dim(S_{\mathfrak q}) = 0$, and \item the field extension $k \subset \kappa(\mathfrak q)$ is finite and $\dim(S_{\mathfrak q}) = 0$. \end{enumerate} In this case $S = S_{\mathfrak q} \times S'$ for some finite type $k$-algebra $S'$. Also, the element $g$ as in (3) has the property $S_{\mathfrak q} = S_g$.

\begin{lemma} \label{lemma-isolated-point-fibre} \begin{slogan} Equivalent conditions for isolated points in fibres \end{slogan} Let $R \to S$ be a ring map of finite type. Let $\mathfrak q \subset S$ be a prime lying over $\mathfrak p \subset R$. Let $F = \Spec(S \otimes_R \kappa(\mathfrak p))$ be the fibre of $\Spec(S) \to \Spec(R)$, see Remark \ref{remark-fundamental-diagram}. Denote $\overline{\mathfrak q} \in F$ the point corresponding to $\mathfrak q$. The following are equivalent \begin{enumerate} \item $\overline{\mathfrak q}$ is an isolated point of $F$, \item $S_{\mathfrak q}/\mathfrak pS_{\mathfrak q}$ is finite over $\kappa(\mathfrak p)$, \item there exists a $g \in S$, $g \not \in \mathfrak q$ such that the only prime of $D(g)$ mapping to $\mathfrak p$ is $\mathfrak q$, \item $\dim_{\overline{\mathfrak q}}(F) = 0$, \item $\overline{\mathfrak q}$ is a closed point of $F$ and $\dim(S_{\mathfrak q}/\mathfrak pS_{\mathfrak q}) = 0$, and \item the field extension $\kappa(\mathfrak p) \subset \kappa(\mathfrak q)$ is finite and $\dim(S_{\mathfrak q}/\mathfrak pS_{\mathfrak q}) = 0$. \end{enumerate}

\begin{definition} \label{definition-quasi-finite} Let $R \to S$ be a finite type ring map. Let $\mathfrak q \subset S$ be a prime. \begin{enumerate} \item If the equivalent conditions of Lemma \ref{lemma-isolated-point-fibre} are satisfied then we say $R \to S$ is {\it quasi-finite at $\mathfrak q$}. \item We say a ring map $A \to B$ is {\it quasi-finite} if it is of finite type and quasi-finite at all primes of $B$. \end{enumerate}

\begin{lemma} \label{lemma-quasi-finite} Let $R \to S$ be a finite type ring map. Then $R \to S$ is quasi-finite if and only if for all primes $\mathfrak p \subset R$ the fibre $S \otimes_R \kappa(\mathfrak p)$ is finite over $\kappa(\mathfrak p)$.

\begin{lemma} \label{lemma-quasi-finite-local} Let $R \to S$ be a finite type ring map. Let $\mathfrak q \subset S$ be a prime lying over $\mathfrak p \subset R$. Let $f \in R$, $f \not \in \mathfrak p$ and $g \in S$, $g \not \in \mathfrak q$. Then $R \to S$ is quasi-finite at $\mathfrak q$ if and only if $R_f \to S_{fg}$ is quasi-finite at $\mathfrak qS_{fg}$.

\begin{lemma} \label{lemma-four-rings} Let $$ \xymatrix{ S \ar[r] & S' & & \mathfrak q \ar@{-}[r] & \mathfrak q' \\ R \ar[u] \ar[r] &  R' \ar[u] & & \mathfrak p \ar@{-}[r] \ar@{-}[u] & \mathfrak p' \ar@{-}[u] } $$ be a commutative diagram of rings with primes as indicated. Assume $R \to S$ of finite type, and $S \otimes_R R' \to S'$ surjective. If $R \to S$ is quasi-finite at $\mathfrak q$, then $R' \to S'$ is quasi-finite at $\mathfrak q'$.

\begin{lemma} \label{lemma-quasi-finite-composition} A composition of quasi-finite ring maps is quasi-finite.

\begin{lemma} \label{lemma-quasi-finite-base-change} Let $R \to S$ be a ring map of finite type. Let $R \to R'$ be any ring map. Set $S' = R' \otimes_R S$. \begin{enumerate} \item The set $\{\mathfrak q' \mid R' \to S' \text{ quasi-finite at }\mathfrak q'\}$ is the inverse image of the corresponding set of $\Spec(S)$ under the canonical map $\Spec(S') \to \Spec(S)$. \item If $\Spec(R') \to \Spec(R)$ is surjective, then $R \to S$ is quasi-finite if and only if $R' \to S'$ is quasi-finite. \item Any base change of a quasi-finite ring map is quasi-finite. \end{enumerate}

\begin{lemma} \label{lemma-quasi-finite-permanence} Let $A \to B$ and $B \to C$ be finite type ring homomorphisms. Let $\mathfrak r$ be a prime of $C$ lying over $\mathfrak q \subset B$ and $\mathfrak p \subset A$. If $A \to C$ is quasi-finite at $\mathfrak r$, then $B \to C$ is quasi-finite at $\mathfrak r$.

\begin{lemma} \label{lemma-generically-finite} Let $R \to S$ be a ring map of finite type. Let $\mathfrak p \subset R$ be a minimal prime. Assume that there are at most finitely many primes of $S$ lying over $\mathfrak p$. Then there exists a $g \in R$, $g \not \in \mathfrak p$ such that the ring map $R_g \to S_g$ is finite.

\begin{lemma} \label{lemma-make-integral-trivial} Let $\varphi : R \to S$ be a ring map. Suppose $t \in S$ satisfies the relation $\varphi(a_0) + \varphi(a_1)t + \ldots + \varphi(a_n) t^n = 0$. Then $\varphi(a_n)t$ is integral over $R$.

\begin{lemma} \label{lemma-make-integral-trick} Let $R$ be a ring. Let $\varphi : R[x] \to S$ be a ring map. Let $t \in S$. Assume that (a) $t$ is integral over $R[x]$, and (b) there exists a monic $p \in R[x]$ such that $t \varphi(p) \in \Im(\varphi)$. Then there exists a $q \in R[x]$ such that $t - \varphi(q)$ is integral over $R$.

\begin{lemma} \label{lemma-change-equation-multiply} Let $R$ be a ring and let $\varphi : R[x] \to S$ be a ring map. Let $t \in S$. If $t$ is integral over $R[x]$, then there exists an $\ell \geq 0$ such that for every $a \in R$ the element $\varphi(a)^\ell t$ is integral over $\varphi_a : R[y] \to S$, defined by $y \mapsto \varphi(ax)$ and $r \mapsto \varphi(r)$ for $r\in R$.

\begin{lemma} \label{lemma-combine-lemmas} Let $R$ be a ring. Let $\varphi : R[x] \to S$ be a ring map. Let $t \in S$. Assume $t$ is integral over $R[x]$. Let $p \in R[x]$, $p = a_0 + a_1x + \ldots + a_k x^k$ such that $t \varphi(p) \in \Im(\varphi)$. Then there exists a $q \in R[x]$ and $n \geq 0$ such that $\varphi(a_k)^n t - \varphi(q) $ is integral over $R$.

\begin{lemma} \label{lemma-leading-coefficient-in-J} In Situation \ref{situation-one-transcendental-element}. Suppose $u \in S$, $a_0, \ldots, a_k \in R$, $u \varphi(a_0 + a_1x + \ldots + a_k x^k) \in J$. Then there exists an $m \geq 0$ such that $u \varphi(a_k)^m \in J$.

\begin{lemma} \label{lemma-all-coefficients-in-J} In Situation \ref{situation-one-transcendental-element}. Suppose $u \in S$, $a_0, \ldots, a_k \in R$, $u \varphi(a_0 + a_1x + \ldots + a_k x^k) \in \sqrt{J}$. Then $u \varphi(a_i) \in \sqrt{J}$ for all $i$.

\begin{definition} \label{definition-strongly-transcendental} Given an inclusion of rings $R \subset S$ and an element $x \in S$ we say that $x$ is {\it strongly transcendental over $R$} if whenever $u(a_0 + a_1 x + \ldots + a_k x^k) = 0$ with $u \in S$ and $a_i \in R$, then we have $ua_i = 0$ for all $i$.

\begin{lemma} \label{lemma-reduced-strongly-transcendental-minimal-prime} Suppose $R \subset S$ is an inclusion of reduced rings and suppose that $x \in S$ is strongly transcendental over $R$. Let $\mathfrak q \subset S$ be a minimal prime and let $\mathfrak p = R \cap \mathfrak q$. Then the image of $x$ in $S/\mathfrak q$ is strongly transcendental over the subring $R/\mathfrak p$.

\begin{lemma} \label{lemma-domains-transcendental-not-quasi-finite} Suppose $R\subset S$ is an inclusion of domains and let $x \in S$. Assume $x$ is (strongly) transcendental over $R$ and that $S$ is finite over $R[x]$. Then $R \to S$ is not quasi-finite at any prime of $S$.

\begin{lemma} \label{lemma-reduced-strongly-transcendental-not-quasi-finite} Suppose $R \subset S$ is an inclusion of reduced rings. Assume $x \in S$ be strongly transcendental over $R$, and $S$ finite over $R[x]$. Then $R \to S$ is not quasi-finite at any prime of $S$.

\begin{lemma} \label{lemma-quasi-finite-monogenic} Let $R$ be a ring. Let $S = R[x]/I$. Let $\mathfrak q \subset S$ be a prime. Assume $R \to S$ is quasi-finite at $\mathfrak q$. Let $S' \subset S$ be the integral closure of $R$ in $S$. Then there exists an element $g \in S'$, $g \not\in \mathfrak q$ such that $S'_g \cong S_g$.

\begin{lemma} \label{lemma-quasi-finite-open} Let $R \to S$ be a finite type ring map. The set of points $\mathfrak q$ of $\Spec(S)$ at which $S/R$ is quasi-finite is open in $\Spec(S)$.

\begin{lemma} \label{lemma-quasi-finite-open-integral-closure} Let $R \to S$ be a finite type ring map. Suppose that $S$ is quasi-finite over $R$. Let $S' \subset S$ be the integral closure of $R$ in $S$. Then \begin{enumerate} \item $\Spec(S) \to \Spec(S')$ is a homeomorphism onto an open subset, \item if $g \in S'$ and $D(g)$ is contained in the image of the map, then $S'_g \cong S_g$, and \item there exists a finite $R$-algebra $S'' \subset S'$ such that (1) and (2) hold for the ring map $S'' \to S$. \end{enumerate}

\begin{lemma} \label{lemma-quasi-finite-extension-dim-1} Let $A \subset B$ be an extension of domains. Assume \begin{enumerate} \item $A$ is a local Noetherian ring of dimension $1$, \item $A \to B$ is of finite type, and \item the extension $K = f.f.(A) \subset L = f.f.(B)$ is a finite field extension. \end{enumerate} Then $B$ is semi-local. Let $x \in \mathfrak m_A$, $x \not = 0$. Let $\mathfrak m_i$, $i = 1, \ldots, n$ be the maximal ideals of $B$. Then $$ [L : K]\text{ord}_A(x) \geq \sum\nolimits_i [\kappa(\mathfrak m_i) : \kappa(\mathfrak m_A)] \text{ord}_{B_{\mathfrak m_i}}(x) $$ where $\text{ord}$ is defined as in Definition \ref{definition-ord}. We have equality if and only if $A \to B$ is finite.

\begin{lemma} \label{lemma-essentially-finite-type-fibre-dim-zero} Let $(R, \mathfrak m_R) \to (S, \mathfrak m_S)$ be a local homomorphism of local rings. Assume \begin{enumerate} \item $R \to S$ is essentially of finite type, \item $\kappa(\mathfrak m_R) \subset \kappa(\mathfrak m_S)$ is finite, and \item $\dim(S/\mathfrak m_RS) = 0$. \end{enumerate} Then $S$ is the localization of a finite $R$-algebra.

\begin{lemma} \label{lemma-completion-at-quasi-finite-prime} Let $R \to S$ be a ring map, $\mathfrak q$ a prime of $S$ lying over $\mathfrak p$ in $R$. If \begin{enumerate} \item $R$ is Noetherian, \item $R \to S$ is of finite type, and \item $R \to S$ is quasi-finite at $\mathfrak q$, \end{enumerate} then $R_\mathfrak p^\wedge \otimes_R S = S_\mathfrak q^\wedge \times B$ for some $R_\mathfrak p^\wedge$-algebra $B$.

\begin{definition} \label{definition-relative-dimension} Suppose that $R \to S$ is of finite type, and let $\mathfrak q \subset S$ be a prime lying over a prime $\mathfrak p$ of $R$. We define the {\it relative dimension of $S/R$ at $\mathfrak q$}, denoted $\dim_{\mathfrak q}(S/R)$, to be the dimension of $\Spec(S \otimes_R \kappa(\mathfrak p))$ at the point corresponding to $\mathfrak q$. We let $\dim(S/R)$ be the supremum of $\dim_{\mathfrak q}(S/R)$ over all $\mathfrak q$. This is called the {\it relative dimension of} $S/R$.

\begin{lemma} \label{lemma-quasi-finite-over-polynomial-algebra} Let $R \to S$ be a finite type ring map. Let $\mathfrak q \subset S$ be a prime. Suppose that $\dim_{\mathfrak q}(S/R) = n$. There exists a $g \in S$, $g \not\in \mathfrak q$ such that $S_g$ is quasi-finite over a polynomial algebra $R[t_1, \ldots, t_n]$.

\begin{lemma} \label{lemma-refined-quasi-finite-over-polynomial-algebra} Let $R \to S$ be a ring map. Let $\mathfrak q \subset S$ be a prime lying over the prime $\mathfrak p$ of $R$. Assume \begin{enumerate} \item $R \to S$ is of finite type, \item $\dim_{\mathfrak q}(S/R) = n$, and \item $\text{trdeg}_{\kappa(\mathfrak p)}\kappa(\mathfrak q) = r$. \end{enumerate} Then there exist $f \in R$, $f \not \in \mathfrak p$, $g \in S$, $g \not\in \mathfrak q$ and a quasi-finite ring map $$ \varphi : R_f[x_1, \ldots, x_n] \longrightarrow S_g $$ such that $\varphi^{-1}(\mathfrak qS_g) = (\mathfrak p, x_{r + 1}, \ldots, x_n)R_f[x_{r + 1}, \ldots, x_n]$

\begin{lemma} \label{lemma-dimension-inequality-quasi-finite} Let $R \to S$ be a finite type ring map. Let $\mathfrak q \subset S$ be a prime lying over $\mathfrak p \subset R$. If $R \to S$ is quasi-finite at $\mathfrak q$, then $\dim(S_{\mathfrak q}) \leq \dim(R_{\mathfrak p})$.

\begin{lemma} \label{lemma-dimension-quasi-finite-over-polynomial-algebra} \begin{slogan} A quasi-finite cover of affine n-space has dimension at most n. \end{slogan} Let $k$ be a field. Let $S$ be a finite type $k$-algebra. Suppose there is a quasi-finite $k$-algebra map $k[t_1, \ldots, t_n] \subset S$. Then $\dim(S) \leq n$.

\begin{lemma} \label{lemma-dimension-fibres-bounded-open-upstairs} Let $R \to S$ be a finite type ring map. Let $\mathfrak q \subset S$ be a prime. Suppose that $\dim_{\mathfrak q}(S/R) = n$. There exists an open neighbourhood $V$ of $\mathfrak q$ in $\Spec(S)$ such that $\dim_{\mathfrak q'}(S/R) \leq n$ for all $\mathfrak q' \in V$.

\begin{lemma} \label{lemma-dimension-fibres-bounded-open-upstairs-base-change} Let $R \to S$ be a finite type ring map. Let $R \to R'$ be any ring map. Set $S' = R' \otimes_R S$ and denote $f : \Spec(S') \to \Spec(S)$ the associated map on spectra. Let $n \geq 0$. The inverse image $f^{-1}(\{\mathfrak q \in \Spec(S) \mid \dim_{\mathfrak q}(S/R) \leq n\})$ is equal to $\{\mathfrak q' \in \Spec(S') \mid \dim_{\mathfrak q'}(S'/R') \leq n\}$.

\begin{lemma} \label{lemma-dimension-fibres-bounded-quasi-compact-open-upstairs} Let $R \to S$ be a ring homomorphism of finite presentation. Let $n \geq 0$. The set $$ V_n = \{\mathfrak q \in \Spec(S) \mid \dim_{\mathfrak q}(S/R) \leq n\} $$ is a quasi-compact open subset of $\Spec(S)$.

\begin{lemma} \label{lemma-finite-type-domain-over-valuation-ring-dim-fibres} Let $R$ be a valuation ring with residue field $k$ and field of fractions $K$. Let $S$ be a domain containing $R$ such that $S$ is of finite type over $R$. If $S \otimes_R k$ is not the zero ring then $$ \dim(S \otimes_R k) = \dim(S \otimes_R K) $$ In fact, $\Spec(S \otimes_R k)$ is equidimensional.

\begin{lemma} \label{lemma-finite-type-descends} Let $R \to S$ be a ring map. Let $R \to R'$ be a faithfully flat ring map. Set $S' = R'\otimes_R S$. Then $R \to S$ is of finite type if and only if $R' \to S'$ is of finite type.

\begin{lemma} \label{lemma-finite-presentation-descends} Let $R \to S$ be a ring map. Let $R \to R'$ be a faithfully flat ring map. Set $S' = R'\otimes_R S$. Then $R \to S$ is of finite presentation if and only if $R' \to S'$ is of finite presentation.

\begin{lemma} \label{lemma-construct-fp-module} Let $R$ be a ring. Let $I \subset R$ be an ideal. Let $S \subset R$ be a multiplicative subset. Set $R' = S^{-1}(R/I) = S^{-1}R/S^{-1}I$. \begin{enumerate} \item For any finite $R'$-module $M'$ there exists a finite $R$-module $M$ such that $S^{-1}(M/IM) \cong M'$. \item For any finitely presented $R'$-module $M'$ there exists a finitely presented $R$-module $M$ such that $S^{-1}(M/IM) \cong M'$. \end{enumerate}

\begin{lemma} \label{lemma-construct-fp-module-from-localization} Let $R$ be a ring. Let $S \subset R$ be a multiplicative subset. Let $M$ be an $R$-module. \begin{enumerate} \item If $S^{-1}M$ is a finite $S^{-1}R$-module then there exists a finite $R$-module $M'$ and a map $M' \to M$ which induces an isomorphism $S^{-1}M' \to S^{-1}M$. \item If $S^{-1}M$ is a finitely presented $S^{-1}R$-module then there exists an $R$-module $M'$ of finite presentation and a map $M' \to M$ which induces an isomorphism $S^{-1}M' \to S^{-1}M$. \end{enumerate}

\begin{lemma} \label{lemma-construct-fp-module-from-stalk} Let $R$ be a ring. Let $\mathfrak p \subset R$ be a prime ideal. Let $M$ be an $R$-module. \begin{enumerate} \item If $M_{\mathfrak p}$ is a finite $R_{\mathfrak p}$-module then there exists a finite $R$-module $M'$ and a map $M' \to M$ which induces an isomorphism $M'_{\mathfrak p} \to M_{\mathfrak p}$. \item If $M_{\mathfrak p}$ is a finitely presented $R_{\mathfrak p}$-module then there exists an $R$-module $M'$ of finite presentation and a map $M' \to M$ which induces an isomorphism $M'_{\mathfrak p} \to M_{\mathfrak p}$. \end{enumerate}

\begin{lemma} \label{lemma-local-isomorphism} Let $\varphi : R \to S$ be a ring map. Let $\mathfrak q \subset S$ be a prime lying over $\mathfrak p \subset R$. Assume \begin{enumerate} \item $S$ is of finite presentation over $R$, \item $\varphi$ induces an isomorphism $R_\mathfrak p \cong S_\mathfrak q$. \end{enumerate} Then there exist $f \in R$, $f \not \in \mathfrak p$ and an $R_f$-algebra $C$ such that $S_f \cong R_f \times C$ as $R_f$-algebras.

\begin{lemma} \label{lemma-isomorphic-local-rings} Let $R$ be a ring. Let $S$, $S'$ be of finite presentation over $R$. Let $\mathfrak q \subset S$ and $\mathfrak q' \subset S'$ be primes. If $S_{\mathfrak q} \cong S_{\mathfrak q'}$ as $R$-algebras, then there exist $g \in S$, $g \not \in \mathfrak q$ and $g' \in S'$, $g' \not \in \mathfrak q'$ such that $S_g \cong S'_{g'}$ as $R$-algebras.

\begin{lemma} \label{lemma-surjective-mod-locally-nilpotent} Let $R$ be a ring. Let $I \subset R$ be a locally nilpotent ideal. Let $S \to S'$ be an $R$-algebra map such that $S \to S'/IS'$ is surjective and such that $S'$ is of finite type over $R$. Then $S \to S'$ is surjective.

\begin{lemma} \label{lemma-isomorphism-modulo-ideal} Let $R$ be a ring. Let $I \subset R$ be an ideal. Let $S \to S'$ be an $R$-algebra map. Let $IS \subset \mathfrak q \subset S$ be a prime ideal. Assume that \begin{enumerate} \item $S \to S'$ is surjective, \item $S_\mathfrak q/IS_\mathfrak q \to S'_\mathfrak q/IS'_\mathfrak q$ is an isomorphism, \item $S$ is of finite type over $R$, \item $S'$ of finite presentation over $R$, and \item $S'_\mathfrak q$ is flat over $R$. \end{enumerate} Then $S_g \to S'_g$ is an isomorphism for some $g \in S$, $g \not \in \mathfrak q$.

\begin{lemma} \label{lemma-isomorphism-modulo-locally-nilpotent} Let $R$ be a ring. Let $I \subset R$ be an ideal. Let $S \to S'$ be an $R$-algebra map. Assume that \begin{enumerate} \item $I$ is locally nilpotent, \item $S/IS \to S'/IS'$ is an isomorphism, \item $S$ is of finite type over $R$, \item $S'$ of finite presentation over $R$, and \item $S'$ is flat over $R$. \end{enumerate} Then $S \to S'$ is an isomorphism.

\begin{lemma} \label{lemma-ring-colimit-fp-category} Let $R \to A$ be a ring map. Consider the category $\mathcal{I}$ of all diagrams of $R$-algebra maps $A' \to A$ with $A'$ finitely presented over $R$. Then $\mathcal{I}$ is filtered, and the colimit of the $A'$ over $\mathcal{I}$ is isomorphic to $A$.

\begin{lemma} \label{lemma-ring-colimit-fp} Let $R \to A$ be a ring map. There exists a directed system $A_\lambda$ of $R$-algebras of finite presentation such that $A = \colim_\lambda A_\lambda$. If $A$ is of finite type over $R$ we may arrange it so that all the transition maps in the system of $A_\lambda$ are surjective.

\begin{lemma} \label{lemma-characterize-finite-presentation} Let $\varphi : R \to S$ be a ring map. The following are equivalent \begin{enumerate} \item $\varphi$ is of finite presentation, \item for every directed system $A_\lambda$ of $R$-algebras the map $$ \colim_\lambda \Hom_R(S, A_\lambda) \longrightarrow \Hom_R(S, \colim_\lambda A_\lambda) $$ is bijective, and \item for every directed system $A_\lambda$ of $R$-algebras the map $$ \colim_\lambda \Hom_R(S, A_\lambda) \longrightarrow \Hom_R(S, \colim_\lambda A_\lambda) $$ is surjective. \end{enumerate}

\begin{lemma} \label{lemma-when-colimit} Let $R \to \Lambda$ be a ring map. Let $\mathcal{E}$ be a set of $R$-algebras such that each $A \in \mathcal{E}$ is of finite presentation over $R$. Then the following two statements are equivalent \begin{enumerate} \item $\Lambda$ is a filtered colimit of elements of $\mathcal{E}$, and \item for any $R$ algebra map $A \to \Lambda$ with $A$ of finite presentation over $R$ we can find a factorization $A \to B \to \Lambda$ with $B \in \mathcal{E}$. \end{enumerate}

\begin{lemma} \label{lemma-module-map-property-in-colimit} Let $A$ be a ring and let $M, N$ be $A$-modules. Suppose that $R = \colim_{i \in I} R_i$ is a directed colimit of $A$-algebras. \begin{enumerate} \item If $M$ is a finite $A$-module, and $u, u' : M \to N$ are $A$-module maps such that $u \otimes 1 = u' \otimes 1 : M \otimes_A R \to N \otimes_A R$ then for some $i$ we have $u \otimes 1 = u' \otimes 1 : M \otimes_A R_i \to N \otimes_A R_i$. \item If $N$ is a finite $A$-module and $u : M \to N$ is an $A$-module map such that $u \otimes 1 : M \otimes_A R \to N \otimes_A R$ is surjective, then for some $i$ the map $u \otimes 1 : M \otimes_A R_i \to N \otimes_A R_i$ is surjective. \item If $N$ is a finitely presented $A$-module, and $v : N \otimes_A R \to M \otimes_A R$ is an $R$-module map, then there exists an $i$ and an $R_i$-module map $v_i : N \otimes_A R_i \to M \otimes_A R_i$ such that $v = v_i \otimes 1$. \item If $M$ is a finite $A$-module, $N$ is a finitely presented $A$-module, and $u : M \to N$ is an $R$-module map such that $u \otimes 1 : M \otimes_A R \to N \otimes_A R$ is an isomorphism, then for some $i$ the map $u \otimes 1 : M \otimes_A R_i \to N \otimes_A R_i$ is an isomorphism. \end{enumerate}

\begin{lemma} \label{lemma-colimit-category-fp-modules} Suppose that $R = \colim_{i \in I} R_i$ is a directed colimit of rings. Then the category of finitely presented $R$-modules is the colimit of the categories of finitely presented $R_\lambda$-modules. More precisely \begin{enumerate} \item Given a finitely presented $R$-module $M$ there exists a $\lambda \in \Lambda$ and a finitely presented $R_\lambda$-module $M_\lambda$ such that $M \cong M_\lambda \otimes_{R_\lambda} R$. \item Given a $\lambda \in \Lambda$, finitely presented $R_\lambda$-modules $M_\lambda, N_\lambda$, and an $R$-module map $\varphi : M_\lambda \otimes_{R_\lambda} R \to N_\lambda \otimes_{R_\lambda} R$, then there exists a $\mu \geq \lambda$ and an $R_\mu$-module map $\varphi_\mu : M_\lambda \otimes_{R_\lambda} R_\mu \to N_\lambda \otimes_{R_\lambda} R_\mu$ such that $\varphi = \varphi_\mu \otimes 1_R$. \item Given a $\lambda \in \Lambda$, finitely presented $R_\lambda$-modules $M_\lambda, N_\lambda$, and $R$-module maps $\varphi_\lambda, \psi_\lambda : M_\lambda \to N_\lambda$ such that $\varphi \otimes 1_R = \psi \otimes 1_R$, then $\varphi \otimes 1_{R_\mu} = \psi \otimes 1_{R_\mu}$ for some $\mu \geq \lambda$. \end{enumerate}

\begin{lemma} \label{lemma-algebra-map-property-in-colimit} Let $A$ be a ring and let $B, C$ be $A$-algebras. Suppose that $R = \colim_{i \in I} R_i$ is a directed colimit of $A$-algebras. \begin{enumerate} \item If $B$ is a finite type $A$-algebra, and $u, u' : B \to C$ are $A$-algebra maps such that $u \otimes 1 = u' \otimes 1 : B \otimes_A R \to C \otimes_A R$ then for some $i$ we have $u \otimes 1 = u' \otimes 1 : B \otimes_A R_i \to C \otimes_A R_i$. \item If $C$ is a finite type $A$-algebra and $u : B \to C$ is an $A$-algebra map such that $u \otimes 1 : B \otimes_A R \to C \otimes_A R$ is surjective, then for some $i$ the map $u \otimes 1 : B \otimes_A R_i \to C \otimes_A R_i$ is surjective. \item If $C$ is of finite presentation over $A$ and $v : C \otimes_A R \to B \otimes_A R$ is an $R$-algebra map, then there exists an $i$ and an $R_i$-algebra map $v_i : C \otimes_A R_i \to B \otimes_A R_i$ such that $v = v_i \otimes 1$. \item If $B$ is a finite type $A$-algebra, $C$ is a finitely presented $A$-algebra, and $u \otimes 1 : B \otimes_A R \to C \otimes_A R$ is an isomorphism, then for some $i$ the map $u \otimes 1 : B \otimes_A R_i \to C \otimes_A R_i$ is an isomorphism. \end{enumerate}

\begin{lemma} \label{lemma-colimit-category-fp-algebras} Suppose that $R = \colim_{i \in I} R_i$ is a directed colimit of rings. Then the category of finitely presented $R$-algebras is the colimit of the categories of finitely presented $R_\lambda$-algebras. More precisely \begin{enumerate} \item Given a finitely presented $R$-algebra $A$ there exists a $\lambda \in \Lambda$ and a finitely presented $R_\lambda$-algebra $A_\lambda$ such that $A \cong A_\lambda \otimes_{R_\lambda} R$. \item Given a $\lambda \in \Lambda$, finitely presented $R_\lambda$-algebras $A_\lambda, B_\lambda$, and an $R$-algebra map $\varphi : A_\lambda \otimes_{R_\lambda} R \to B_\lambda \otimes_{R_\lambda} R$, then there exists a $\mu \geq \lambda$ and an $R_\mu$-algebra map $\varphi_\mu : A_\lambda \otimes_{R_\lambda} R_\mu \to B_\lambda \otimes_{R_\lambda} R_\mu$ such that $\varphi = \varphi_\mu \otimes 1_R$. \item Given a $\lambda \in \Lambda$, finitely presented $R_\lambda$-algebras $A_\lambda, B_\lambda$, and $R$-algebra maps $\varphi_\lambda, \psi_\lambda : A_\lambda \to B_\lambda$ such that $\varphi \otimes 1_R = \psi \otimes 1_R$, then $\varphi \otimes 1_{R_\mu} = \psi \otimes 1_{R_\mu}$ for some $\mu \geq \lambda$. \end{enumerate}

\begin{lemma} \label{lemma-limit-no-condition-local} Suppose $R \to S$ is a local homomorphism of local rings. There exists a directed set $(\Lambda, \leq)$, and a system of local homomorphisms $R_\lambda \to S_\lambda$ of local rings such that \begin{enumerate} \item The colimit of the system $R_\lambda \to S_\lambda$ is equal to $R \to S$. \item Each $R_\lambda$ is essentially of finite type over $\mathbf{Z}$. \item Each $S_\lambda$ is essentially of finite type over $R_\lambda$. \end{enumerate}

\begin{lemma} \label{lemma-limit-essentially-finite-type} Suppose $R \to S$ is a local homomorphism of local rings. Assume that $S$ is essentially of finite type over $R$. Then there exists a directed set $(\Lambda, \leq)$, and a system of local homomorphisms $R_\lambda \to S_\lambda$ of local rings such that \begin{enumerate} \item The colimit of the system $R_\lambda \to S_\lambda$ is equal to $R \to S$. \item Each $R_\lambda$ is essentially of finite type over $\mathbf{Z}$. \item Each $S_\lambda$ is essentially of finite type over $R_\lambda$. \item For each $\lambda \leq \mu$ the map $S_\lambda \otimes_{R_\lambda} R_\mu \to S_\mu$ presents $S_\mu$ as the localization of a quotient of $S_\lambda \otimes_{R_\lambda} R_\mu$. \end{enumerate}

\begin{lemma} \label{lemma-limit-essentially-finite-presentation} Suppose $R \to S$ is a local homomorphism of local rings. Assume that $S$ is essentially of finite presentation over $R$. Then there exists a directed set $(\Lambda, \leq)$, and a system of local homomorphism $R_\lambda \to S_\lambda$ of local rings such that \begin{enumerate} \item The colimit of the system $R_\lambda \to S_\lambda$ is equal to $R \to S$. \item Each $R_\lambda$ is essentially of finite type over $\mathbf{Z}$. \item Each $S_\lambda$ is essentially of finite type over $R_\lambda$. \item For each $\lambda \leq \mu$ the map $S_\lambda \otimes_{R_\lambda} R_\mu \to S_\mu$ presents $S_\mu$ as the localization of $S_\lambda \otimes_{R_\lambda} R_\mu$ at a prime ideal. \end{enumerate}

\begin{lemma} \label{lemma-limit-module-essentially-finite-presentation} Suppose $R \to S$ is a local homomorphism of local rings. Assume that $S$ is essentially of finite presentation over $R$. Let $M$ be a finitely presented $S$-module. Then there exists a directed set $(\Lambda, \leq)$, and a system of local homomorphisms $R_\lambda \to S_\lambda$ of local rings together with $S_\lambda$-modules $M_\lambda$, such that \begin{enumerate} \item The colimit of the system $R_\lambda \to S_\lambda$ is equal to $R \to S$. The colimit of the system $M_\lambda$ is $M$. \item Each $R_\lambda$ is essentially of finite type over $\mathbf{Z}$. \item Each $S_\lambda$ is essentially of finite type over $R_\lambda$. \item Each $M_\lambda$ is finite over $S_\lambda$. \item For each $\lambda \leq \mu$ the map $S_\lambda \otimes_{R_\lambda} R_\mu \to S_\mu$ presents $S_\mu$ as the localization of $S_\lambda \otimes_{R_\lambda} R_\mu$ at a prime ideal. \item For each $\lambda \leq \mu$ the map $M_\lambda \otimes_{S_\lambda} S_\mu \to M_\mu$ is an isomorphism. \end{enumerate}

\begin{lemma} \label{lemma-limit-no-condition} Suppose $R \to S$ is a ring map. Then there exists a directed set $(\Lambda, \leq)$, and a system of ring maps $R_\lambda \to S_\lambda$ such that \begin{enumerate} \item The colimit of the system $R_\lambda \to S_\lambda$ is equal to $R \to S$. \item Each $R_\lambda$ is of finite type over $\mathbf{Z}$. \item Each $S_\lambda$ is of finite type over $R_\lambda$. \end{enumerate}

\begin{lemma} \label{lemma-limit-integral} Suppose $R \to S$ is a ring map. Assume that $S$ is integral over $R$. Then there exists a directed set $(\Lambda, \leq)$, and a system of ring maps $R_\lambda \to S_\lambda$ such that \begin{enumerate} \item The colimit of the system $R_\lambda \to S_\lambda$ is equal to $R \to S$. \item Each $R_\lambda$ is of finite type over $\mathbf{Z}$. \item Each $S_\lambda$ is of finite over $R_\lambda$. \end{enumerate}

\begin{lemma} \label{lemma-limit-finite-type} Suppose $R \to S$ is a ring map. Assume that $S$ is of finite type over $R$. Then there exists a directed set $(\Lambda, \leq)$, and a system of ring maps $R_\lambda \to S_\lambda$ such that \begin{enumerate} \item The colimit of the system $R_\lambda \to S_\lambda$ is equal to $R \to S$. \item Each $R_\lambda$ is of finite type over $\mathbf{Z}$. \item Each $S_\lambda$ is of finite type over $R_\lambda$. \item For each $\lambda \leq \mu$ the map $S_\lambda \otimes_{R_\lambda} R_\mu \to S_\mu$ presents $S_\mu$ as a quotient of $S_\lambda \otimes_{R_\lambda} R_\mu$. \end{enumerate}

\begin{lemma} \label{lemma-limit-finite-presentation} Suppose $R \to S$ is a ring map. Assume that $S$ is of finite presentation over $R$. Then there exists a directed set $(\Lambda, \leq)$, and a system of ring maps $R_\lambda \to S_\lambda$ such that \begin{enumerate} \item The colimit of the system $R_\lambda \to S_\lambda$ is equal to $R \to S$. \item Each $R_\lambda$ is of finite type over $\mathbf{Z}$. \item Each $S_\lambda$ is of finite type over $R_\lambda$. \item For each $\lambda \leq \mu$ the map $S_\lambda \otimes_{R_\lambda} R_\mu \to S_\mu$ is an isomorphism. \end{enumerate}

\begin{lemma} \label{lemma-limit-module-finite-presentation} Suppose $R \to S$ is a ring map. Assume that $S$ is of finite presentation over $R$. Let $M$ be a finitely presented $S$-module. Then there exists a directed set $(\Lambda, \leq)$, and a system of ring maps $R_\lambda \to S_\lambda$ together with $S_\lambda$-modules $M_\lambda$, such that \begin{enumerate} \item The colimit of the system $R_\lambda \to S_\lambda$ is equal to $R \to S$. The colimit of the system $M_\lambda$ is $M$. \item Each $R_\lambda$ is of finite type over $\mathbf{Z}$. \item Each $S_\lambda$ is of finite type over $R_\lambda$. \item Each $M_\lambda$ is finite over $S_\lambda$. \item For each $\lambda \leq \mu$ the map $S_\lambda \otimes_{R_\lambda} R_\mu \to S_\mu$ is an isomorphism. \item For each $\lambda \leq \mu$ the map $M_\lambda \otimes_{S_\lambda} S_\mu \to M_\mu$ is an isomorphism. \end{enumerate} In particular, for every $\lambda \in \Lambda$ we have $$ M = M_\lambda \otimes_{S_\lambda} S = M_\lambda \otimes_{R_\lambda} R. $$

\begin{lemma} \label{lemma-CM-over-regular-flat} Let $R \to S$ be a local homomorphism of Noetherian local rings. Assume \begin{enumerate} \item $R$ is regular, \item $S$ Cohen-Macaulay, \item $\dim(S) = \dim(R) + \dim(S/\mathfrak m_R S)$. \end{enumerate} Then $R \to S$ is flat.

\begin{lemma} \label{lemma-flat-over-regular} Let $R \to S$ be a homomorphism of Noetherian local rings. Assume that $R$ is a regular local ring and that a regular system of parameters maps to a regular sequence in $S$. Then $R \to S$ is flat.

\begin{lemma} \label{lemma-colimit-eventually-flat} Let $R \to S$, $M$, $\Lambda$, $R_\lambda \to S_\lambda$, $M_\lambda$ be as in Lemma \ref{lemma-limit-module-essentially-finite-presentation}. Assume that $M$ is flat over $R$. Then for some $\lambda \in \Lambda$ the module $M_\lambda$ is flat over $R_\lambda$.

\begin{lemma} \label{lemma-mod-injective-general} Suppose that $R \to S$ is a local homomorphism of local rings. Denote $\mathfrak m$ the maximal ideal of $R$. Let $u : M \to N$ be a map of $S$-modules. Assume \begin{enumerate} \item $S$ is essentially of finite presentation over $R$, \item $M$, $N$ are finitely presented over $S$, \item $N$ is flat over $R$, and \item $\overline{u} : M/\mathfrak mM \to N/\mathfrak mN$ is injective. \end{enumerate} Then $u$ is injective, and $N/u(M)$ is flat over $R$.

\begin{lemma} \label{lemma-grothendieck-general} Suppose that $R \to S$ is a local ring homomorphism of local rings. Denote $\mathfrak m$ the maximal ideal of $R$. Suppose \begin{enumerate} \item $S$ is essentially of finite presentation over $R$, \item $S$ is flat over $R$, and \item $f \in S$ is a nonzerodivisor in $S/{\mathfrak m}S$. \end{enumerate} Then $S/fS$ is flat over $R$, and $f$ is a nonzerodivisor in $S$.

\begin{lemma} \label{lemma-grothendieck-regular-sequence-general} Suppose that $R \to S$ is a local ring homomorphism of local rings. Denote $\mathfrak m$ the maximal ideal of $R$. Suppose \begin{enumerate} \item $R \to S$ is essentially of finite presentation, \item $R \to S$ is flat, and \item $f_1, \ldots, f_c$ is a sequence of elements of $S$ such that the images $\overline{f}_1, \ldots, \overline{f}_c$ form a regular sequence in $S/{\mathfrak m}S$. \end{enumerate} Then $f_1, \ldots, f_c$ is a regular sequence in $S$ and each of the quotients $S/(f_1, \ldots, f_i)$ is flat over $R$.

\begin{lemma} \label{lemma-variant-local-criterion-flatness-general} Let $R \to S$ be a local homomorphism of local rings. Let $I \not = R$ be an ideal in $R$. Let $M$ be an $S$-module. Assume \begin{enumerate} \item $S$ is essentially of finite presentation over $R$, \item $M$ is of finite presentation over $S$, \item $\text{Tor}_1^R(M, R/I) = 0$, and \item $M/IM$ is flat over $R/I$. \end{enumerate} Then $M$ is flat over $R$.



\begin{lemma} \label{lemma-criterion-flatness-fibre-fp-over-ft} Let $R$, $S$, $S'$ be local rings and let $R \to S \to S'$ be local ring homomorphisms. Let $M$ be an $S'$-module. Let $\mathfrak m \subset R$ be the maximal ideal. Assume \begin{enumerate} \item $R \to S'$ is essentially of finite presentation, \item $R \to S$ is essentially of finite type, \item $M$ is of finite presentation over $S'$, \item $M$ is not zero, \item $M/\mathfrak mM$ is a flat $S/\mathfrak mS$-module, and \item $M$ is a flat $R$-module. \end{enumerate} Then $S$ is essentially of finite presentation and flat over $R$ and $M$ is a flat $S$-module.



\begin{lemma} \label{lemma-CM-dim-finite-type} Let $k$ be a field. Let $S$ be a finite type $k$-algebra. Let $f_1, \ldots, f_i$ be elements of $S$. Assume that $S$ is Cohen-Macaulay and equidimensional of dimension $d$, and that $\dim V(f_1, \ldots, f_i) \leq d - i$. Then equality holds and $f_1, \ldots, f_i$ forms a regular sequence in $S_{\mathfrak q}$ for every prime $\mathfrak q$ of $V(f_1, \ldots, f_i)$.

\begin{lemma} \label{lemma-open-regular-sequence} Suppose that $R \to S$ is a ring map which is finite type, flat. Let $d$ be an integer such that all fibres $S \otimes_R \kappa(\mathfrak p)$ are Cohen-Macaulay and equidimensional of dimension $d$. Let $f_1, \ldots, f_i$ be elements of $S$. The set $$ \{ \mathfrak q \in V(f_1, \ldots, f_i) \mid f_1, \ldots, f_i \text{ are a regular sequence in } S_{\mathfrak q}/\mathfrak p S_{\mathfrak q} \text{ where }\mathfrak p = R \cap \mathfrak q \} $$ is open in $V(f_1, \ldots, f_i)$.

\begin{lemma} \label{lemma-exact-on-fibres-open} Let $R \to S$ is a ring map. Consider a finite homological complex of finite free $S$-modules: $$ F_{\bullet} : 0 \to S^{n_e} \xrightarrow{\varphi_e} S^{n_{e-1}} \xrightarrow{\varphi_{e-1}} \ldots \xrightarrow{\varphi_{i + 1}} S^{n_i} \xrightarrow{\varphi_i} S^{n_{i-1}} \xrightarrow{\varphi_{i-1}} \ldots \xrightarrow{\varphi_1} S^{n_0} $$ For every prime $\mathfrak q$ of $S$ consider the complex $\overline{F}_{\bullet, \mathfrak q} = F_{\bullet, \mathfrak q} \otimes_R \kappa(\mathfrak p)$ where $\mathfrak p$ is inverse image of $\mathfrak q$ in $R$. Assume there exists an integer $d$ such that $R \to S$ is finite type, flat with fibres $S \otimes_R \kappa(\mathfrak p)$ Cohen-Macaulay of dimension $d$. The set $$ \{\mathfrak q \in \Spec(S) \mid \overline{F}_{\bullet, \mathfrak q}\text{ is exact}\} $$ is open in $\Spec(S)$.

\begin{lemma} \label{lemma-where-CM} Let $S$ be a finite type algebra over a field $k$. Let $\varphi : k[y_1, \ldots, y_d] \to S$ be a quasi-finite ring map. As subsets of $\Spec(S)$ we have $$ \{ \mathfrak q \mid S_{\mathfrak q} \text{ flat over }k[y_1, \ldots, y_d]\} = \{ \mathfrak q \mid S_{\mathfrak q} \text{ CM and }\dim_{\mathfrak q}(S/k) = d\} $$ For notation see Definition \ref{definition-relative-dimension}.

\begin{lemma} \label{lemma-finite-type-over-field-CM-open} Let $S$ be a finite type algebra over a field $k$. The set of primes $\mathfrak q$ such that $S_{\mathfrak q}$ is Cohen-Macaulay is open in $S$.

\begin{lemma} \label{lemma-generic-CM} Let $k$ be a field. Let $S$ be a finite type $k$ algebra. The set of Cohen-Macaulay primes forms a dense open $U \subset \Spec(S)$.

\begin{lemma} \label{lemma-finite-presentation-flat-CM-locus-open} Let $R$ be a ring. Let $R \to S$ be of finite presentation and flat. For any $d \geq 0$ the set $$ \left\{ \begin{matrix} \mathfrak q \in \Spec(S) \text{ such that setting }\mathfrak p = R \cap \mathfrak q \text{ the fibre ring}\\ S_{\mathfrak q}/\mathfrak pS_{\mathfrak q} \text{ is Cohen-Macaulay} \text{ and } \dim_{\mathfrak q}(S/R) = d \end{matrix} \right\} $$ is open in $\Spec(S)$.

\begin{lemma} \label{lemma-generic-CM-flat-finite-presentation} Let $R$ be a ring. Let $R \to S$ be flat of finite presentation. The set of primes $\mathfrak q$ such that the fibre ring $S_{\mathfrak q} \otimes_R \kappa(\mathfrak p)$, with $\mathfrak p = R \cap \mathfrak q$ is Cohen-Macaulay is open and dense in every fibre of $\Spec(S) \to \Spec(R)$.

\begin{lemma} \label{lemma-extend-field-CM-locus} Let $k$ be a field. Let $S$ be a finite type $k$-algebra. Let $k \subset K$ be a field extension, and set $S_K = K \otimes_k S$. Let $\mathfrak q \subset S$ be a prime of $S$. Let $\mathfrak q_K \subset S_K$ be a prime of $S_K$ lying over $\mathfrak q$. Then $S_{\mathfrak q}$ is Cohen-Macaulay if and only if $(S_K)_{\mathfrak q_K}$ is Cohen-Macaulay.

\begin{lemma} \label{lemma-CM-locus-commutes-base-change} Let $R$ be a ring. Let $R \to S$ be of finite type. Let $R \to R'$ be any ring map. Set $S' = R' \otimes_R S$. Denote $f : \Spec(S') \to \Spec(S)$ the map associated to the ring map $S \to S'$. Set $W$ equal to the set of primes $\mathfrak q$ such that the fibre ring $S_{\mathfrak q} \otimes_R \kappa(\mathfrak p)$, $\mathfrak p = R \cap \mathfrak q$ is Cohen-Macaulay, and let $W'$ denote the analogue for $S'/R'$. Then $W' = f^{-1}(W)$.

\begin{lemma} \label{lemma-relative-dimension-CM} Let $R$ be a ring. Let $R \to S$ be a ring map which is (a) flat, (b) of finite presentation, (c) has Cohen-Macaulay fibres. Then we can write $S = S_0 \times \ldots \times S_n$ as a product of $R$-algebras $S_d$ such that each $S_d$ satisfies (a), (b), (c) and has all fibres equidimensional of dimension $d$.

\begin{definition} \label{definition-derivation} Let $\varphi : R \to S$ be a ring map and let $M$ be an $S$-module. A {\it derivation}, or more precisely an {\it $R$-derivation} into $M$ is a map $D : S \to M$ which is additive, annihilates elements of $\varphi(R)$, and satisfies the {\it Leibniz rule}: $D(ab) = aD(b) + bD(a)$.

\begin{definition} \label{definition-differentials} The pair $(\Omega_{S/R}, \text{d})$ is called the {\it module of K\"ahler differentials} or the {\it module of differentials} of $S$ over $R$.

\begin{lemma} \label{lemma-universal-omega} \begin{slogan} Maps out of the module of differentials are the same as derivations. \end{slogan} The module of differentials of $S$ over $R$ has the following universal property. The map $$ \Hom_S(\Omega_{S/R}, M) \longrightarrow \text{Der}_R(S, M), \quad \alpha \longmapsto \alpha \circ \text{d} $$ is an isomorphism of functors.

\begin{lemma} \label{lemma-colimit-differentials} Let $I$ be a directed set. Let $(R_i \to S_i, \varphi_{ii'})$ be a system of ring maps over $I$, see Categories, Section \ref{categories-section-posets-limits}. Then we have $$ \Omega_{S/R} = \colim_i \Omega_{S_i/R_i}. $$ where $R \to S = \colim (R_i \to S_i)$.

\begin{lemma} \label{lemma-trivial-differential-surjective} Suppose that $R \to S$ is surjective. Then $\Omega_{S/R} = 0$.

\begin{lemma} \label{lemma-differential-surjective} In diagram (\ref{equation-functorial-omega}), suppose that $S \to S'$ is surjective with kernel $I \subset S$. Then $\Omega_{S/R} \to \Omega_{S'/R'}$ is surjective with kernel generated as an $S$-module by the elements $\text{d}a$, where $a \in S$ is such that $\varphi(a) \in \beta(R')$. (This includes in particular the elements $\text{d}(i)$, $i \in I$.)

\begin{lemma} \label{lemma-exact-sequence-differentials} Let $A \to B \to C$ be ring maps. Then there is a canonical exact sequence $$ C \otimes_B \Omega_{B/A} \to \Omega_{C/A} \to \Omega_{C/B} \to 0 $$ of $C$-modules.

\begin{lemma} \label{lemma-differentials-localize} Let $\varphi : A \to B$ be a ring map. \begin{enumerate} \item If $S \subset A$ is a multiplicative subset mapping to invertible elements of $B$, then $\Omega_{B/A} = \Omega_{B/S^{-1}A}$. \item If $S \subset B$ is a multiplicative subset then $S^{-1}\Omega_{B/A} = \Omega_{S^{-1}B/A}$. \end{enumerate}

\begin{lemma} \label{lemma-differential-seq} In diagram (\ref{equation-functorial-omega}), suppose that $S \to S'$ is surjective with kernel $I \subset S$, and assume that $R' = R$. Then there is a canonical exact sequence of $S'$-modules $$ I/I^2 \longrightarrow \Omega_{S/R} \otimes_S S' \longrightarrow \Omega_{S'/R} \longrightarrow 0 $$ The leftmost map is characterized by the rule that $f \in I$ maps to $\text{d}f \otimes 1$.

\begin{lemma} \label{lemma-differential-seq-split} In diagram (\ref{equation-functorial-omega}), suppose that $S \to S'$ is surjective with kernel $I \subset S$, and assume that $R' = R$. Moreover, assume that there exists an $R$-algebra map $S' \to S$ which is a right inverse to $S \to S'$. Then the exact sequence of $S'$-modules of Lemma \ref{lemma-differential-seq} turns into a short exact sequence $$ 0 \longrightarrow I/I^2 \longrightarrow \Omega_{S/R} \otimes_S S' \longrightarrow \Omega_{S'/R} \longrightarrow 0 $$ which is even a split short exact sequence.

\begin{lemma} \label{lemma-differential-mod-power-ideal} Let $R \to S$ be a ring map. Let $I \subset S$ be an ideal. Let $n \geq 1$ be an integer. Set $S' = S/I^{n + 1}$. The map $\Omega_{S/R} \to \Omega_{S'/R}$ induces an isomorphism $$ \Omega_{S/R} \otimes_S S/I^n \longrightarrow \Omega_{S'/R} \otimes_{S'} S/I^n. $$

\begin{lemma} \label{lemma-differentials-base-change} Suppose that we have ring maps $R \to R'$ and $R \to S$. Set $S' = S \otimes_R R'$, so that we obtain a diagram (\ref{equation-functorial-omega}). Then the canonical map defined above induces an isomorphism $\Omega_{S/R} \otimes_R R' = \Omega_{S'/R'}$.

\begin{lemma} \label{lemma-differentials-diagonal} Let $R \to S$ be a ring map. Let $J = \Ker(S \otimes_R S \to S)$ be the kernel of the multiplication map. There is a canonical isomorphism of $S$-modules $\Omega_{S/R} \to J/J^2$, $a \text{d} b \mapsto a \otimes b - ab \otimes 1$.

\begin{lemma} \label{lemma-differentials-polynomial-ring} If $S = R[x_1, \ldots, x_n]$, then $\Omega_{S/R}$ is a finite free $S$-module with basis $\text{d}x_1, \ldots, \text{d}x_n$.

\begin{lemma} \label{lemma-differentials-finitely-presented} Suppose $R \to S$ is of finite presentation. Then $\Omega_{S/R}$ is a finitely presented $S$-module.

\begin{lemma} \label{lemma-differentials-finitely-generated} Suppose $R \to S$ is of finite type. Then $\Omega_{S/R}$ is finitely generated $S$-module.

\begin{definition} \label{definition-differential-operators} Let $R \to S$ be a ring map. Let $M$, $N$ be $S$-modules. Let $k \geq 0$ be an integer. We inductively define a {\it differential operator $D : M \to N$ of order $k$} to be an $R$-linear map such that for all $g \in S$ the map $m \mapsto D(gm) - gD(m)$ is a differential operator of order $k - 1$. For the base case $k = 0$ we define a differential operator of order $0$ to be an $S$-linear map.

\begin{lemma} \label{lemma-composition-differential-operators} Let $R \to S$ be a ring map. Let $L, M, N$ be $S$-modules. If $D : L \to M$ and $D' : M \to N$ are differential operators of order $k$ and $k'$, then $D' \circ D$ is a differential operator of order $k + k'$.

\begin{lemma} \label{lemma-module-principal-parts} Let $R \to S$ be a ring map. Let $M$ be an $S$-module. Let $k \geq 0$. There exists an $S$-module $P^k_{S/R}(M)$ and a canonical isomorphism $$ \text{Diff}^k_{S/R}(M, N) = \Hom_S(P^k_{S/R}(M), N) $$ functorial in the $S$-module $N$.

\begin{definition} \label{definition-module-principal-parts} Let $R \to S$ be a ring map. Let $M$ be an $S$-module. The module $P^k_{S/R}(M)$ constructed in Lemma \ref{lemma-module-principal-parts} is called the {\it module of principal parts of order $k$} of $M$.

\begin{lemma} \label{lemma-sequence-of-principal-parts} Let $R \to S$ be a ring map. Let $M$ be an $S$-module. There is a canonical short exact sequence $$ 0 \to \Omega_{S/R} \otimes_S M \to P^1_{S/R}(M) \to M \to 0 $$ functorial in $M$ called the {\it sequence of principal parts}.

\begin{definition} \label{definition-naive-cotangent-complex} Let $R \to S$ be a ring map. The {\it naive cotangent complex} $\NL_{S/R}$ is the chain complex (\ref{equation-naive-cotangent-complex}) $$ \NL_{S/R} = \left(I/I^2 \longrightarrow \Omega_{R[S]/R} \otimes_{R[S]} S\right) $$ with $I/I^2$ placed in (homological) degree $1$ and $\Omega_{R[S]/R} \otimes_{R[S]} S$ placed in degree $0$. We will denote $H_1(L_{S/R}) = H_1(\NL_{S/R})$\footnote{This module is sometimes denoted $\Gamma_{S/R}$ in the literature.} the homology in degree $1$.

\begin{lemma} \label{lemma-NL-homotopy} Suppose given a diagram (\ref{equation-functoriality-NL}). Let $\alpha : P \to S$ and $\alpha' : P' \to S'$ be presentations. \begin{enumerate} \item There exists a morphism of presentations from $\alpha$ to $\alpha'$. \item Any two morphisms of presentations induce homotopic morphisms of complexes $\NL(\alpha) \to \NL(\alpha')$. \item The construction is compatible with compositions of morphisms of presentations (see proof for exact statement). \item If $R \to R'$ and $S \to S'$ are isomorphisms, then for any map $\varphi$ of presentations from $\alpha$ to $\alpha'$ the induced map $\NL(\alpha) \to \NL(\alpha')$ is a homotopy equivalence and a quasi-isomorphism. \end{enumerate} In particular, comparing $\alpha$ to the canonical presentation (\ref{equation-canonical-presentation}) we conclude there is a quasi-isomorphism $\NL(\alpha) \to \NL_{S/R}$ well defined up to homotopy and compatible with all functorialities (up to homotopy).

\begin{lemma} \label{lemma-NL-polynomial-algebra} Let $A \to B$ be a polynomial algebra. Then $\NL_{B/A}$ is homotopy equivalent to the chain complex $(0 \to \Omega_{B/A})$ with $\Omega_{B/A}$ in degree $0$.



\begin{lemma} \label{lemma-NL-surjection} Let $A \to B$ be a surjective ring map with kernel $I$. Then $\NL_{B/A}$ is homotopy equivalent to the chain complex $(I/I^2 \to 0)$ with $I/I^2$ in degree $1$. In particular $H_1(L_{B/A}) = I/I^2$.

\begin{lemma} \label{lemma-application-NL} Let $A \to B \to C$ be ring maps. Assume $A \to C$ is surjective (so also $B \to C$ is). Denote $I = \Ker(A \to C)$ and $J = \Ker(B \to C)$. Then the sequence $$ I/I^2 \to J/J^2 \to \Omega_{B/A} \otimes_B B/J \to 0 $$ is exact.



\begin{lemma} \label{lemma-colimits-NL} Let $R_i \to S_i$ be a system of ring maps over the directed set $I$. Set $R = \colim R_i$ and $S = \colim S_i$. Then $\NL_{S/R} = \colim \NL_{S_i/R_i}$.

\begin{lemma} \label{lemma-NL-of-localization} If $S \subset A$ is a multiplicative subset of $A$, then $\NL_{S^{-1}A/A}$ is homotopy equivalent to the zero complex.

\begin{lemma} \label{lemma-NL-localize-bottom} Let $S \subset A$ is a multiplicative subset of $A$. Let $S^{-1}A \to B$ be a ring map. Then $\NL_{B/A} \to \NL_{B/S^{-1}A}$ is an homotopy equivalence.

\begin{lemma} \label{lemma-principal-localization-NL} \begin{slogan} The formation of the naive cotangent complex commutes with localization at an element. \end{slogan} Let $A \to B$ be a ring map. Let $g \in B$. Suppose $\alpha : P \to B$ is a presentation with kernel $I$. Then a presentation of $B_g$ over $A$ is the map $$ \beta : P[x] \longrightarrow B_g $$ extending $\alpha$ and sending $x$ to $1/g$. The kernel $J$ of $\beta$ is generated by $I$ and the element $f x - 1$ where $f \in P$ is an element mapped to $g \in B$ by $\alpha$. In this situation we have \begin{enumerate} \item $J/J^2 = (I/I^2)_g \oplus B_g (f x - 1)$, \item $\Omega_{P[x]/A} \otimes_{P[x]} B_g = \Omega_{P/A} \otimes_P B_g \oplus B_g \text{d}x$, \item $\NL(\beta) \cong \NL(\alpha) \otimes_B B_g \oplus (B_g \xrightarrow{g} B_g)$ \end{enumerate} Hence the canonical map $\NL_{B/A} \otimes_B B_g \to \NL_{B_g/A}$ is a homotopy equivalence.

\begin{lemma} \label{lemma-localize-NL} Let $A \to B$ be a ring map. Let $S \subset B$ be a multiplicative subset. The canonical map $\NL_{B/A} \otimes_B S^{-1}B \to \NL_{S^{-1}B/A}$ is a quasi-isomorphism.

\begin{lemma} \label{lemma-sum-two-terms} Let $R$ be a ring. Let $A_1 \to A_0$, and $B_1 \to B_0$ be two two term complexes. Suppose that there exist morphisms of complexes $\varphi : A_\bullet \to B_\bullet$ and $\psi : B_\bullet \to A_\bullet$ such that $\varphi \circ \psi$ and $\psi \circ \varphi$ are homotopic to the identity maps. Then $A_1 \oplus B_0 \cong B_1 \oplus A_0$ as $R$-modules.

\begin{lemma} \label{lemma-conormal-module} Let $R \to S$ be a ring map of finite type. For any presentations $\alpha : R[x_1, \ldots, x_n] \to S$, and $\beta : R[y_1, \ldots, y_m] \to S$ we have $$ I/I^2 \oplus S^{\oplus m} \cong J/J^2 \oplus S^{\oplus n} $$ as $S$-modules where $I = \Ker(\alpha)$ and $J = \Ker(\beta)$.

\begin{lemma} \label{lemma-conormal-module-localize} Let $R \to S$ be a ring map of finite type. Let $g \in S$. For any presentations $\alpha : R[x_1, \ldots, x_n] \to S$, and $\beta : R[y_1, \ldots, y_m] \to S_g$ we have $$ (I/I^2)_g \oplus S^{\oplus m}_g \cong J/J^2 \oplus S_g^{\oplus n} $$ as $S_g$-modules where $I = \Ker(\alpha)$ and $J = \Ker(\beta)$.

\begin{definition} \label{definition-lci-field} Let $k$ be a field. Let $S$ be a finite type $k$-algebra. \begin{enumerate} \item We say that $S$ is a {\it global complete intersection over $k$} if there exists a presentation $S = k[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$ such that $\dim(S) = n - c$. \item We say that $S$ is a {\it local complete intersection over $k$} if there exists a covering $\Spec(S) = \bigcup D(g_i)$ such that each of the rings $S_{g_i}$ is a global complete intersection over $k$. \end{enumerate} We will also use the convention that the zero ring is a global complete intersection over $k$.

\begin{lemma} \label{lemma-localize-lci} Let $k$ be a field. Let $S$ be a finite type $k$-algebra. Let $g \in S$. \begin{enumerate} \item If $S$ is a global complete intersection so is $S_g$. \item If $S$ is a local complete intersection so is $S_g$. \end{enumerate}

\begin{lemma} \label{lemma-lci-CM} Let $k$ be a field. Let $S$ be a finite type $k$-algebra. If $S$ is a local complete intersection, then $S$ is a Cohen-Macaulay ring.

\begin{lemma} \label{lemma-lci} Let $k$ be a field. Let $S$ be a finite type $k$-algebra. Let $\mathfrak q$ be a prime of $S$. Choose any presentation $S = k[x_1, \ldots, x_n]/I$. Let $\mathfrak q'$ be the prime of $k[x_1, \ldots, x_n]$ corresponding to $\mathfrak q$. Set $c = \text{height}(\mathfrak q') - \text{height}(\mathfrak q)$, in other words $\dim_{\mathfrak q}(S) = n - c$ (see Lemma \ref{lemma-codimension}). The following are equivalent \begin{enumerate} \item There exists a $g \in S$, $g \not \in \mathfrak q$ such that $S_g$ is a global complete intersection over $k$. \item The ideal $I_{\mathfrak q'} \subset k[x_1, \ldots, x_n]_{\mathfrak q'}$ can be generated by $c$ elements. \item The conormal module $(I/I^2)_{\mathfrak q}$ can be generated by $c$ elements over $S_{\mathfrak q}$. \item The conormal module $(I/I^2)_{\mathfrak q}$ is a free $S_{\mathfrak q}$-module of rank $c$. \item The ideal $I_{\mathfrak q'}$ can be generated by a regular sequence in the regular local ring $k[x_1, \ldots, x_n]_{\mathfrak q'}$. \end{enumerate} In this case any $c$ elements of $I_{\mathfrak q'}$ which generate $I_{\mathfrak q'}/\mathfrak q'I_{\mathfrak q'}$ form a regular sequence in the local ring $k[x_1, \ldots, x_n]_{\mathfrak q'}$.

\begin{definition} \label{definition-lci-local-ring} Let $k$ be a field. Let $S$ be a local $k$-algebra essentially of finite type over $k$. We say $S$ is a {\it complete intersection (over $k$)} if there exists a local $k$-algebra $R$ and elements $f_1, \ldots, f_c \in \mathfrak m_R$ such that \begin{enumerate} \item $R$ is essentially of finite type over $k$, \item $R$ is a regular local ring, \item $f_1, \ldots, f_c$ form a regular sequence in $R$, and \item $S \cong R/(f_1, \ldots, f_c)$ as $k$-algebras. \end{enumerate}

\begin{lemma} \label{lemma-ci-well-defined} Let $A \to B \to C$ be surjective local ring homomorphisms. Assume $A$ and $B$ are regular local rings. The following are equivalent \begin{enumerate} \item $\Ker(A \to C)$ is generated by a regular sequence, \item $\Ker(A \to C)$ is generated by $\dim(A) - \dim(C)$ elements, \item $\Ker(B \to C)$ is generated by a regular sequence, and \item $\Ker(B \to C)$ is generated by $\dim(B) - \dim(C)$ elements. \end{enumerate}

\begin{lemma} \label{lemma-lci-local} Let $k$ be a field. Let $S$ be a local $k$-algebra essentially of finite type over $k$. The following are equivalent: \begin{enumerate} \item $S$ is a complete intersection over $k$, \item for any surjection $R \to S$ with $R$ a regular local ring essentially of finite presentation over $k$ the ideal $\Ker(R \to S)$ can be generated by a regular sequence, \item for some surjection $R \to S$ with $R$ a regular local ring essentially of finite presentation over $k$ the ideal $\Ker(R \to S)$ can be generated by $\dim(R) - \dim(S)$ elements, \item there exists a global complete intersection $A$ over $k$ and a prime $\mathfrak a$ of $A$ such that $S \cong A_{\mathfrak a}$, and \item there exists a local complete intersection $A$ over $k$ and a prime $\mathfrak a$ of $A$ such that $S \cong A_{\mathfrak a}$. \end{enumerate}

\begin{lemma} \label{lemma-lci-at-prime} Let $k$ be a field. Let $S$ be a finite type $k$-algebra. Let $\mathfrak q$ be a prime of $S$. The following are equivalent: \begin{enumerate} \item The local ring $S_{\mathfrak q}$ is a complete intersection ring (Definition \ref{definition-lci-local-ring}). \item There exists a $g \in S$, $g \not \in \mathfrak q$ such that $S_g$ is a local complete intersection over $k$. \item There exists a $g \in S$, $g \not \in \mathfrak q$ such that $S_g$ is a global complete intersection over $k$. \item For any presentation $S = k[x_1, \ldots, x_n]/I$ with $\mathfrak q' \subset k[x_1, \ldots, x_n]$ corresponding to $\mathfrak q$ any of the equivalent conditions (1) -- (5) of Lemma \ref{lemma-lci} hold. \end{enumerate}

\begin{lemma} \label{lemma-lci-global} Let $k$ be a field. Let $S$ be a finite type $k$-algebra. The following are equivalent: \begin{enumerate} \item The ring $S$ is a local complete intersection over $k$. \item All local rings of $S$ are complete intersection rings over $k$. \item All localizations of $S$ at maximal ideals are complete intersection rings over $k$. \end{enumerate}

\begin{lemma} \label{lemma-lci-field-change-local} Let $k \subset K$ be a field extension. Let $S$ be a finite type algebra over $k$. Let $\mathfrak q_K$ be a prime of $S_K = K \otimes_k S$ and let $\mathfrak q$ be the corresponding prime of $S$. Then $S_{\mathfrak q}$ is a complete intersection over $k$ (Definition \ref{definition-lci-local-ring}) if and only if $(S_K)_{\mathfrak q_K}$ is a complete intersection over $K$.

\begin{lemma} \label{lemma-lci-field-change} Let $k \to K$ be a field extension. Let $S$ be a finite type $k$-algebra. Then $S$ is a local complete intersection over $k$ if and only if $S \otimes_k K$ is a local complete intersection over $K$.

\begin{lemma} \label{lemma-lci-permanence-initial} Let $$ \xymatrix{ B & S \ar[l] \\ A \ar[u] & R \ar[l] \ar[u] } $$ be a commutative square of local rings. Assume \begin{enumerate} \item $R$ and $\overline{S} = S/\mathfrak m_R S$ are regular local rings, \item $A = R/I$ and $B = S/J$ for some ideals $I$, $J$, \item $J \subset S$ and $\overline{J} = J/\mathfrak m_R \cap J \subset \overline{S}$ are generated by regular sequences, and \item $A \to B$ and $R \to S$ are flat. \end{enumerate} Then $I$ is generated by a regular sequence.

\begin{definition} \label{definition-lci} A ring map $R \to S$ is called {\it syntomic}, or we say $S$ is a {\it flat local complete intersection over $R$} if it is flat, of finite presentation, and if all of its fibre rings $S \otimes_R \kappa(\mathfrak p)$ are local complete intersections, see Definition \ref{definition-lci-field}.

\begin{lemma} \label{lemma-syntomic-descends} \begin{slogan} Being syntomic is fpqc local on the base. \end{slogan} Let $R \to S$ be a ring map. Let $R \to R'$ be a faithfully flat ring map. Set $S' = R'\otimes_R S$. Then $R \to S$ is syntomic if and only if $R' \to S'$ is syntomic.

\begin{lemma} \label{lemma-base-change-syntomic} Any base change of a syntomic map is syntomic.

\begin{lemma} \label{lemma-local-syntomic} Let $R \to S$ be a ring map. Suppose we have $g_1, \ldots g_m \in S$ which generate the unit ideal such that each $R \to S_{g_i}$ is syntomic. Then $R \to S$ is syntomic.

\begin{definition} \label{definition-relative-global-complete-intersection} Let $R \to S$ be a ring map. We say that $R \to S$ is a {\it relative global complete intersection} if we are given a presentation $S = R[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$ such that every nonempty fibre has dimension $n - c$.

\begin{lemma} \label{lemma-huber} Let $S$ be a finitely presented $R$-algebra which has a presentation $S = R[x_1, \ldots, x_n]/I$ such that $I/I^2$ is free over $S$. Then $S$ has a presentation $S = R[y_1, \ldots, y_m]/(f_1, \ldots, f_c)$ such that $(f_1, \ldots, f_c)/(f_1, \ldots, f_c)^2$ is free with basis given by the classes of $f_1, \ldots, f_c$.

\begin{lemma} \label{lemma-adjoin-roots} Suppose that $A$ is a ring, and $P(x) = x^n + b_1 x^{n-1} + \ldots + b_n \in A[x]$ is a monic polynomial over $A$. Then there exists a syntomic, finite locally free, faithfully flat ring extension $A \subset A'$ such that $P(x) = \prod_{i = 1, \ldots, n} (x - \beta_i)$ for certain $\beta_i \in A'$.

\begin{lemma} \label{lemma-base-change-relative-global-complete-intersection} Let $S = R[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$ be a relative global complete intersection over $R$. \begin{enumerate} \item For any $R \to R'$ the base change $R' \otimes_R S = R'[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$ is a relative global complete intersection. \item For any $g \in S$ which is the image of $h \in R[x_1, \ldots, x_n]$ the ring $S_g = R[x_1, \ldots, x_n, x_{n + 1}]/(f_1, \ldots, f_c, hx_{n + 1} - 1)$ is a relative global complete intersection. \item If $R \to S$ factors as $R \to R_f \to S$ for some $f \in R$. Then the ring $S = R_f[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$ is a relative global complete intersection over $R_f$. \end{enumerate}

\begin{lemma} \label{lemma-localize-relative-complete-intersection} Let $R$ be a ring. Let $S = R[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$. We will find $h \in R[x_1, \ldots, x_n]$ which maps to $g \in S$ such that $$ S_g = R[x_1, \ldots, x_n, x_{n + 1}]/(f_1, \ldots, f_c, hx_{n + 1} - 1) $$ is a relative global complete intersection over $R$ in each of the following cases: \begin{enumerate} \item Let $I \subset R$ be an ideal. If the fibres of $\Spec(S/IS) \to \Spec(R/I)$ have dimension $n - c$, then we can find $(h, g)$ as above such that $g$ maps to $1 \in S/IS$. \item Let $\mathfrak p \subset R$ be a prime. If $\dim(S \otimes_R \kappa(\mathfrak p)) = n - c$, then we can find $(h, g)$ as above such that $g$ maps to a unit of $S \otimes_R \kappa(\mathfrak p)$. \item Let $\mathfrak q \subset S$ be a prime lying over $\mathfrak p \subset R$. If $\dim_{\mathfrak q}(S/R) = n - c$, then we can find $(h, g)$ as above such that $g \not \in \mathfrak q$. \end{enumerate}

\begin{lemma} \label{lemma-relative-global-complete-intersection-Noetherian} Let $R$ be a ring. Let $S$ be a relative global complete intersection with presentation $S = R[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$. There exist a finite type $\mathbf{Z}$-subalgebra $R_0 \subset R$ such that $f_i \in R_0[x_1, \ldots, x_n]$ and such that $$ S_0 = R_0[x_1, \ldots, x_n]/(f_1, \ldots, f_c) $$ is a relative global intersection over $R_0$.

\begin{lemma} \label{lemma-relative-global-complete-intersection-conormal} Let $R$ be a ring. Let $S = R[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$ be a relative global complete intersection. For every prime $\mathfrak q$ of $S$, let $\mathfrak q'$ denote the corresponding prime of $R[x_1, \ldots, x_n]$. Then \begin{enumerate} \item $f_1, \ldots, f_c$ is a regular sequence in the local ring $R[x_1, \ldots, x_n]_{\mathfrak q'}$, \item each of the rings $R[x_1, \ldots, x_n]_{\mathfrak q'}/(f_1, \ldots, f_i)$ is flat over $R$, and \item the $S$-module $(f_1, \ldots, f_c)/(f_1, \ldots, f_c)^2$ is free with basis given by the elements $f_i \bmod (f_1, \ldots, f_c)^2$. \end{enumerate}

\begin{lemma} \label{lemma-relative-global-complete-intersection} A relative global complete intersection is syntomic, i.e., flat.

\begin{lemma} \label{lemma-syntomic} Let $R \to S$ be a ring map. Let $\mathfrak q \subset S$ be a prime lying over the prime $\mathfrak p$ of $R$. The following are equivalent: \begin{enumerate} \item There exists an element $g \in S$, $g \not \in \mathfrak q$ such that $R \to S_g$ is syntomic. \item There exists an element $g \in S$, $g \not \in \mathfrak q$ such that $S_g$ is a relative global complete intersection over $R$. \item There exists an element $g \in S$, $g \not \in \mathfrak q$, such that $R \to S_g$ is of finite presentation, the local ring map $R_{\mathfrak p} \to S_{\mathfrak q}$ is flat, and the local ring $S_{\mathfrak q}/\mathfrak pS_{\mathfrak q}$ is a complete intersection ring over $\kappa(\mathfrak p)$ (see Definition \ref{definition-lci-local-ring}). \end{enumerate}

\begin{lemma} \label{lemma-syntomic-presentation-ideal-mod-squares} Let $R$ be a ring. Let $S = R[x_1, \ldots, x_n]/I$ for some finitely generated ideal $I$. If $g \in S$ is such that $S_g$ is syntomic over $R$, then $(I/I^2)_g$ is a finite projective $S_g$-module.

\begin{lemma} \label{lemma-composition-syntomic} Let $R \to S$, $S \to S'$ be ring maps. \begin{enumerate} \item If $R \to S$ and $S \to S'$ are syntomic, then $R \to S'$ is syntomic. \item If $R \to S$ and $S \to S'$ are relative global complete intersections, then $R \to S'$ is a relative global complete intersection. \end{enumerate}

\begin{lemma} \label{lemma-lift-syntomic} Let $R$ be a ring and let $I \subset R$ be an ideal. Let $R/I \to \overline{S}$ be a syntomic map. Then there exists elements $\overline{g}_i \in \overline{S}$ which generate the unit ideal of $\overline{S}$ such that each $\overline{S}_{g_i} \cong S_i/IS_i$ for some relative global complete intersection $S_i$ over $R$.

\begin{definition} \label{definition-smooth} A ring map $R \to S$ is {\it smooth} if it is of finite presentation and the naive cotangent complex $\NL_{S/R}$ is quasi-isomorphic to a finite projective $S$-module placed in degree $0$.

\begin{lemma} \label{lemma-smooth-independent-presentation} Let $R \to S$ be a ring map of finite presentation. If for some presentation $\alpha$ of $S$ over $R$ the naive cotangent complex $\NL(\alpha)$ is quasi-isomorphic to a finite projective $S$-module placed in degree $0$, then this holds for any presentation.

\begin{lemma} \label{lemma-localize-smooth} Let $R \to S$ be a smooth ring map. Any localization $S_g$ is smooth over $R$. If $f \in R$ maps to an invertible element of $S$, then $R_f \to S$ is smooth.

\begin{lemma} \label{lemma-base-change-smooth} Let $R \to S$ be a smooth ring map. Let $R \to R'$ be any ring map. Then the base change $R' \to S' = R' \otimes_R S$ is smooth.

\begin{lemma} \label{lemma-smooth-over-field} Let $k$ be a field. Let $S$ be a smooth $k$-algebra. Then $S$ is a local complete intersection.

\begin{definition} \label{definition-standard-smooth} Let $R$ be a ring. Given integers $n \geq c \geq 0$ and $f_1, \ldots, f_c \in R[x_1, \ldots, x_n]$ we say $$ S = R[x_1, \ldots, x_n]/(f_1, \ldots, f_c) $$ is a {\it standard smooth algebra over $R$} if the polynomial $$ g = \det \left( \begin{matrix} \partial f_1/\partial x_1 & \partial f_2/\partial x_1 & \ldots & \partial f_c/\partial x_1 \\ \partial f_1/\partial x_2 & \partial f_2/\partial x_2 & \ldots & \partial f_c/\partial x_2 \\ \ldots & \ldots & \ldots & \ldots \\ \partial f_1/\partial x_c & \partial f_2/\partial x_c & \ldots & \partial f_c/\partial x_c \end{matrix} \right) $$ maps to an invertible element in $S$.

\begin{lemma} \label{lemma-standard-smooth} Let $S = R[x_1, \ldots, x_n]/(f_1, \ldots, f_c) = R[x_1, \ldots, x_n]/I$ be a standard smooth algebra. Then \begin{enumerate} \item the ring map $R \to S$ is smooth, \item the $S$-module $\Omega_{S/R}$ is free on $\text{d}x_{c + 1}, \ldots, \text{d}x_n$, \item the $S$-module $I/I^2$ is free on the classes of $f_1, \ldots, f_c$, \item for any $g \in S$ the ring map $R \to S_g$ is standard smooth, \item for any ring map $R \to R'$ the base change $R' \to R'\otimes_R S$ is standard smooth, \item if $f \in R$ maps to an invertible element in $S$, then $R_f \to S$ is standard smooth, and \item the ring $S$ is a relative global complete intersection over $R$. \end{enumerate}

\begin{lemma} \label{lemma-compose-standard-smooth} A composition of standard smooth ring maps is standard smooth.

\begin{lemma} \label{lemma-smooth-syntomic} Let $R \to S$ be a smooth ring map. There exists an open covering of $\Spec(S)$ by standard opens $D(g)$ such that each $S_g$ is standard smooth over $R$. In particular $R \to S$ is syntomic.

\begin{definition} \label{definition-smooth-at-prime} Let $R \to S$ be a ring map. Let $\mathfrak q$ be a prime of $S$. We say $R \to S$ is {\it smooth at $\mathfrak q$} if there exists a $g \in S$, $g \not \in \mathfrak q$ such that $R \to S_g$ is smooth.

\begin{lemma} \label{lemma-smooth-at-point} Let $R \to S$ be of finite presentation. Let $\mathfrak q$ be a prime of $S$. The following are equivalent \begin{enumerate} \item $R \to S$ is smooth at $\mathfrak q$, \item $H_1(L_{S/R})_\mathfrak q = 0$ and $\Omega_{S/R, \mathfrak q}$ is a projective $S_\mathfrak q$-module, and \item $H_1(L_{S/R})_\mathfrak q = 0$ and $\Omega_{S/R, \mathfrak q}$ is a flat $S_\mathfrak q$-module. \end{enumerate}

\begin{lemma} \label{lemma-locally-smooth} Let $R \to S$ be a ring map. Then $R \to S$ is smooth if and only if $R \to S$ is smooth at every prime $\mathfrak q$ of $S$.

\begin{lemma} \label{lemma-compose-smooth} A composition of smooth ring maps is smooth.

\begin{lemma} \label{lemma-relative-global-complete-intersection-smooth} Let $R$ be a ring. Let $S = R[x_1, \ldots, x_n]/(f_1, \ldots, f_c)$ be a relative global complete intersection. Let $\mathfrak q \subset S$ be a prime. Then $R \to S$ is smooth at $\mathfrak q$ if and only if there exists a subset $I \subset \{1, \ldots, n\}$ of cardinality $c$ such that the polynomial $$ g_I = \det (\partial f_j/\partial x_i)_{j = 1, \ldots, c, \ i \in I}. $$ does not map to an element of $\mathfrak q$.

\begin{lemma} \label{lemma-flat-fibre-smooth} Let $R \to S$ be a ring map. Let $\mathfrak q \subset S$ be a prime lying over the prime $\mathfrak p$ of $R$. Assume \begin{enumerate} \item there exists a $g \in S$, $g \not\in \mathfrak q$ such that $R \to S_g$ is of finite presentation, \item the local ring homomorphism $R_{\mathfrak p} \to S_{\mathfrak q}$ is flat, \item the fibre $S \otimes_R \kappa(\mathfrak p)$ is smooth over $\kappa(\mathfrak p)$ at the prime corresponding to $\mathfrak q$. \end{enumerate} Then $R \to S$ is smooth at $\mathfrak q$.

\begin{lemma} \label{lemma-flat-base-change-locus-smooth} Let $R \to S$ be a ring map of finite presentation. Let $R \to R'$ be a flat ring map. Denote $S' = R' \otimes_R S$ the base change. Let $U \subset \Spec(S)$ be the set of primes at which $R \to S$ is smooth. Let $V \subset \Spec(S')$ the set of primes at which $R' \to S'$ is smooth. Then $V$ is the inverse image of $U$ under the map $f : \Spec(S') \to \Spec(S)$.

\begin{lemma} \label{lemma-smooth-field-change-local} Let $k \subset K$ be a field extension. Let $S$ be a finite type algebra over $k$. Let $\mathfrak q_K$ be a prime of $S_K = K \otimes_k S$ and let $\mathfrak q$ be the corresponding prime of $S$. Then $S$ is smooth over $k$ at $\mathfrak q$ if and only if $S_K$ is smooth at $\mathfrak q_K$ over $K$.

\begin{lemma} \label{lemma-lift-smooth} Let $R$ be a ring and let $I \subset R$ be an ideal. Let $R/I \to \overline{S}$ be a smooth ring map. Then there exists elements $\overline{g}_i \in \overline{S}$ which generate the unit ideal of $\overline{S}$ such that each $\overline{S}_{g_i} \cong S_i/IS_i$ for some (standard) smooth ring $S_i$ over $R$.

\begin{definition} \label{definition-formally-smooth} Let $R \to S$ be a ring map. We say $S$ is {\it formally smooth over $R$} if for every commutative solid diagram $$ \xymatrix{ S \ar[r] \ar@{-->}[rd] & A/I \\ R \ar[r] \ar[u] & A \ar[u] } $$ where $I \subset A$ is an ideal of square zero, a dotted arrow exists which makes the diagram commute.

\begin{lemma} \label{lemma-base-change-fs} Let $R \to S$ be a formally smooth ring map. Let $R \to R'$ be any ring map. Then the base change $S' = R' \otimes_R S$ is formally smooth over $R'$.

\begin{lemma} \label{lemma-compose-formally-smooth} A composition of formally smooth ring maps is formally smooth.

\begin{lemma} \label{lemma-polynomial-ring-formally-smooth} A polynomial ring over $R$ is formally smooth over $R$.

\begin{lemma} \label{lemma-characterize-formally-smooth} Let $R \to S$ be a ring map. Let $P \to S$ be a surjective $R$-algebra map from a polynomial ring $P$ onto $S$. Denote $J \subset P$ the kernel. Then $R \to S$ is formally smooth if and only if there exists an $R$-algebra map $\sigma : S \to P/J^2$ which is a right inverse to the surjection $P/J^2 \to S$.

\begin{lemma} \label{lemma-characterize-formally-smooth-again} Let $R \to S$ be a ring map. Let $P \to S$ be a surjective $R$-algebra map from a polynomial ring $P$ onto $S$. Denote $J \subset P$ the kernel. Then $R \to S$ is formally smooth if and only if the sequence $$ 0 \to J/J^2 \to \Omega_{P/R} \otimes_P S \to \Omega_{S/R} \to 0 $$ of Lemma \ref{lemma-differential-seq} is a split exact sequence.

\begin{lemma} \label{lemma-ses-formally-smooth} Let $A \to B \to C$ be ring maps. Assume $B \to C$ is formally smooth. Then the sequence $$ 0 \to \Omega_{B/A} \otimes_B C \to \Omega_{C/A} \to \Omega_{C/B} \to 0 $$ of Lemma \ref{lemma-exact-sequence-differentials} is a split short exact sequence.

\begin{lemma} \label{lemma-differential-seq-formally-smooth} Let $A \to B \to C$ be ring maps with $A \to C$ formally smooth and $B \to C$ surjective with kernel $J \subset B$. Then the exact sequence $$ 0 \to J/J^2 \to \Omega_{B/A} \otimes_B C \to \Omega_{C/A} \to 0 $$ of Lemma \ref{lemma-differential-seq} is split exact.

\begin{lemma} \label{lemma-application-NL-formally-smooth} Let $A \to B \to C$ be ring maps. Assume $A \to C$ is surjective (so also $B \to C$ is) and $A \to B$ formally smooth. Denote $I = \Ker(A \to C)$ and $J = \Ker(B \to C)$. Then the sequence $$ 0 \to I/I^2 \to J/J^2 \to \Omega_{B/A} \otimes_B B/J \to 0 $$ of Lemma \ref{lemma-application-NL} is split exact.

\begin{lemma} \label{lemma-lift-formal-smoothness} Let $R \to S$ be a ring map. Let $I \subset R$ be an ideal. Assume \begin{enumerate} \item $I^2 = 0$, \item $R \to S$ is flat, and \item $R/I \to S/IS$ is formally smooth. \end{enumerate} Then $R \to S$ is formally smooth.

\begin{lemma} \label{lemma-finite-presentation-fs-Noetherian} Let $R \to S$ be a smooth ring map. Then there exists a subring $R_0 \subset R$ of finite type over $\mathbf{Z}$ and a smooth ring map $R_0 \to S_0$ such that $S \cong R \otimes_{R_0} S_0$.

\begin{lemma} \label{lemma-smooth-descends-through-colimit} Let $A = \colim A_i$ be a filtered colimit of rings. Let $A \to B$ be a smooth ring map. There exists an $i$ and a smooth ring map $A_i \to B_i$ such that $B = B_i \otimes_{A_i} A$.

\begin{lemma} \label{lemma-descent-formally-smooth} Let $R \to S$ be a ring map. Let $R \to R'$ be a faithfully flat ring map. Set $S' = S \otimes_R R'$. Then $R \to S$ is formally smooth if and only if $R' \to S'$ is formally smooth.

\begin{lemma} \label{lemma-smooth-strong-lift} Let $R \to S$ be a smooth ring map. Given a commutative solid diagram $$ \xymatrix{ S \ar[r] \ar@{-->}[rd] & A/I \\ R \ar[r] \ar[u] & A \ar[u] } $$ where $I \subset A$ is a locally nilpotent ideal, a dotted arrow exists which makes the diagram commute.

\begin{lemma} \label{lemma-triangle-differentials-smooth} Given ring maps $A \to B \to C$ with $B \to C$ smooth, then the sequence $$ 0 \to C \otimes_B \Omega_{B/A} \to \Omega_{C/A} \to \Omega_{C/B} \to 0 $$ of Lemma \ref{lemma-exact-sequence-differentials} is exact.

\begin{lemma} \label{lemma-differential-seq-smooth} Let $A \to B \to C$ be ring maps with $A \to C$ smooth and $B \to C$ surjective with kernel $J \subset B$. Then the exact sequence $$ 0 \to J/J^2 \to \Omega_{B/A} \otimes_B C \to \Omega_{C/A} \to 0 $$ of Lemma \ref{lemma-differential-seq} is split exact.

\begin{lemma} \label{lemma-application-NL-smooth} Let $A \to B \to C$ be ring maps. Assume $A \to C$ is surjective (so also $B \to C$ is) and $A \to B$ smooth. Denote $I = \Ker(A \to C)$ and $J = \Ker(B \to C)$. Then the sequence $$ 0 \to I/I^2 \to J/J^2 \to \Omega_{B/A} \otimes_B B/J \to 0 $$ of Lemma \ref{lemma-application-NL} is exact.

\begin{lemma} \label{lemma-section-smooth} \begin{slogan} If $R$ is a summand of $S$ and $S$ is smooth over $R$, then the $I$-adic completion of $S$ is often a power series over $R$ where $I$ is the kernel of the projection map from $S$ to $R$. \end{slogan} Let $\varphi : R \to S$ be a smooth ring map. Let $\sigma : S \to R$ be a left inverse to $\varphi$. Set $I = \Ker(\sigma)$. Then \begin{enumerate} \item $I/I^2$ is a finite locally free $R$-module, and \item if $I/I^2$ is free, then $S^\wedge \cong R[[t_1, \ldots, t_d]]$ as $R$-algebras, where $S^\wedge$ is the $I$-adic completion of $S$. \end{enumerate}

\begin{lemma} \label{lemma-rank-omega} Let $k$ be an algebraically closed field. Let $S$ be a finite type $k$-algebra. Let $\mathfrak m \subset S$ be a maximal ideal. Then $$ \dim_{\kappa(\mathfrak m)} \Omega_{S/k} \otimes_S \kappa(\mathfrak m) = \dim_{\kappa(\mathfrak m)} \mathfrak m/\mathfrak m^2. $$

\begin{lemma} \label{lemma-characterize-smooth-kbar} Let $k$ be an algebraically closed field. Let $S$ be a finite type $k$-algebra. Let $\mathfrak m \subset S$ be a maximal ideal. The following are equivalent: \begin{enumerate} \item The ring $S_{\mathfrak m}$ is a regular local ring. \item We have $\dim_{\kappa(\mathfrak m)} \Omega_{S/k} \otimes_S \kappa(\mathfrak m) \leq \dim(S_{\mathfrak m})$. \item We have $\dim_{\kappa(\mathfrak m)} \Omega_{S/k} \otimes_S \kappa(\mathfrak m) = \dim(S_{\mathfrak m})$. \item There exists a $g \in S$, $g \not \in \mathfrak m$ such that $S_g$ is smooth over $k$. In other words $S/k$ is smooth at $\mathfrak m$. \end{enumerate}

\begin{lemma} \label{lemma-characterize-smooth-over-field} Let $k$ be any field. Let $S$ be a finite type $k$-algebra. Let $X = \Spec(S)$. Let $\mathfrak q \subset S$ be a prime corresponding to $x \in X$. The following are equivalent: \begin{enumerate} \item The $k$-algebra $S$ is smooth at $\mathfrak q$ over $k$. \item We have $\dim_{\kappa(\mathfrak q)} \Omega_{S/k} \otimes_S \kappa(\mathfrak q) \leq \dim_x X$. \item We have $\dim_{\kappa(\mathfrak q)} \Omega_{S/k} \otimes_S \kappa(\mathfrak q) = \dim_x X$. \end{enumerate} Moreover, in this case the local ring $S_{\mathfrak q}$ is regular.

\begin{lemma} \label{lemma-computation-differential} Let $k$ be a field. Let $R$ be a Noetherian local ring containing $k$. Assume that the residue field $\kappa = R/\mathfrak m$ is a finitely generated separable extension of $k$. Then the map $$ \text{d} : \mathfrak m/\mathfrak m^2 \longrightarrow \Omega_{R/k} \otimes_R \kappa(\mathfrak m) $$ is injective.

\begin{lemma} \label{lemma-separable-smooth} Let $k$ be a field. Let $S$ be a finite type $k$-algebra. Let $\mathfrak q \subset S$ be a prime. Assume $\kappa(\mathfrak q)$ is separable over $k$. The following are equivalent: \begin{enumerate} \item The algebra $S$ is smooth at $\mathfrak q$ over $k$. \item The ring $S_{\mathfrak q}$ is regular. \end{enumerate}

\begin{lemma} \label{lemma-characteristic-zero} Let $R \to S$ be a $\mathbf{Q}$-algebra map. Let $f \in S$ be such that $\Omega_{S/R} = S \text{d}f \oplus C$ for some $S$-submodule $C$. Then \begin{enumerate} \item $f$ is not nilpotent, and \item if $S$ is a Noetherian local ring, then $f$ is a nonzerodivisor in $S$. \end{enumerate}

\begin{lemma} \label{lemma-characteristic-zero-local-smooth} Let $k$ be a field of characteristic $0$. Let $S$ be a finite type $k$-algebra. Let $\mathfrak q \subset S$ be a prime. The following are equivalent: \begin{enumerate} \item The algebra $S$ is smooth at $\mathfrak q$ over $k$. \item The $S_{\mathfrak q}$-module $\Omega_{S/k, \mathfrak q}$ is (finite) free. \item The ring $S_{\mathfrak q}$ is regular. \end{enumerate}

\begin{lemma} \label{lemma-smooth-at-generic-point} Let $R \to S$ be an injective finite type ring map with $R$ and $S$ domains. Then $R \to S$ is smooth at $\mathfrak q = (0)$ if and only if $f.f.(R) \subset f.f.(S)$ is a separable extension of fields.

\begin{definition} \label{definition-small-extension} Let $\varphi : B' \to B$ be a ring map. We say $\varphi$ is a {\it small extension} if $B'$ and $B$ are local Artinian rings, $\varphi$ is surjective and $I = \Ker(\varphi)$ has length $1$ as a $B'$-module.

\begin{lemma} \label{lemma-smooth-test-artinian} Let $R \to S$ be a ring map. Let $\mathfrak q$ be a prime ideal of $S$ lying over $\mathfrak p \subset R$. Assume $R$ is Noetherian and $R \to S$ of finite type. The following are equivalent: \begin{enumerate} \item $R \to S$ is smooth at $\mathfrak q$, \item for every surjection of local $R$-algebras $(B', \mathfrak m') \to (B, \mathfrak m)$ with $\Ker(B' \to B)$ having square zero and every solid commutative diagram $$ \xymatrix{ S \ar[r] \ar@{-->}[rd] & B \\ R \ar[r] \ar[u] & B' \ar[u] } $$ such that $\mathfrak q = S \cap \mathfrak m$ there exists a dotted arrow making the diagram commute, \item same as in (2) but with $B' \to B$ ranging over small extensions, and \item same as in (2) but with $B' \to B$ ranging over small extensions such that in addition $S \to B$ induces an isomorphism $\kappa(\mathfrak q) \cong \kappa(\mathfrak m)$. \end{enumerate}

\begin{definition} \label{definition-etale} Let $R \to S$ be a ring map. We say $R \to S$ is {\it \'etale} if it is of finite presentation and the naive cotangent complex $\NL_{S/R}$ is quasi-isomorphic to zero. Given a prime $\mathfrak q$ of $S$ we say that $R \to S$ is {\it \'etale at $\mathfrak q$} if there exists a $g \in S$, $g \not \in \mathfrak q$ such that $R \to S_g$ is \'etale.

\begin{lemma} \label{lemma-etale-standard-smooth} Any \'etale ring map is standard smooth. More precisely, if $R \to S$ is \'etale, then there exists a presentation $S = R[x_1, \ldots, x_n]/(f_1, \ldots, f_n)$ such that the image of $\det(\partial f_j/\partial x_i)$ is invertible in $S$.

\begin{lemma} \label{lemma-etale} Results on \'etale ring maps. \begin{enumerate} \item The ring map $R \to R_f$ is \'etale for any ring $R$ and any $f \in R$. \item Compositions of \'etale ring maps are \'etale. \item A base change of an \'etale ring map is \'etale. \item The property of being \'etale is local: Given a ring map $R \to S$ and elements $g_1, \ldots, g_m \in S$ which generate the unit ideal such that $R \to S_{g_j}$ is \'etale for $j = 1, \ldots, m$ then $R \to S$ is \'etale. \item Given $R \to S$ of finite presentation, and a flat ring map $R \to R'$, set $S' = R' \otimes_R S$. The set of primes where $R' \to S'$ is \'etale is the inverse image via $\Spec(S') \to \Spec(S)$ of the set of primes where $R \to S$ is \'etale. \item An \'etale ring map is syntomic, in particular flat. \item If $S$ is finite type over a field $k$, then $S$ is \'etale over $k$ if and only if $\Omega_{S/k} = 0$. \item Any \'etale ring map $R \to S$ is the base change of an \'etale ring map $R_0 \to S_0$ with $R_0$ of finite type over $\mathbf{Z}$. \item Let $A = \colim A_i$ be a filtered colimit of rings. Let $A \to B$ be an \'etale ring map. Then there exists an \'etale ring map $A_i \to B_i$ for some $i$ such that $B \cong A \otimes_{A_i} B_i$. \item Let $A$ be a ring. Let $S$ be a multiplicative subset of $A$. Let $S^{-1}A \to B'$ be \'etale. Then there exists an \'etale ring map $A \to B$ such that $B' \cong S^{-1}B$. \end{enumerate}

\begin{lemma} \label{lemma-etale-over-field} Let $k$ be a field. A ring map $k \to S$ is \'etale if and only if $S$ is isomorphic as a $k$-algebra to a finite product of finite separable extensions of $k$.

\begin{lemma} \label{lemma-etale-at-prime} Let $R \to S$ be a ring map. Let $\mathfrak q \subset S$ be a prime lying over $\mathfrak p$ in $R$. If $S/R$ is \'etale at $\mathfrak q$ then \begin{enumerate} \item we have $\mathfrak p S_{\mathfrak q} = \mathfrak qS_{\mathfrak q}$ is the maximal ideal of the local ring $S_{\mathfrak q}$, and \item the field extension $\kappa(\mathfrak p) \subset \kappa(\mathfrak q)$ is finite separable. \end{enumerate}

\begin{lemma} \label{lemma-etale-quasi-finite} An \'etale ring map is quasi-finite.

\begin{lemma} \label{lemma-characterize-etale} Let $R \to S$ be a ring map. Let $\mathfrak q$ be a prime of $S$ lying over a prime $\mathfrak p$ of $R$. If \begin{enumerate} \item $R \to S$ is of finite presentation, \item $R_{\mathfrak p} \to S_{\mathfrak q}$ is flat \item $\mathfrak p S_{\mathfrak q}$ is the maximal ideal of the local ring $S_{\mathfrak q}$, and \item the field extension $\kappa(\mathfrak p) \subset \kappa(\mathfrak q)$ is finite separable, \end{enumerate} then $R \to S$ is \'etale at $\mathfrak q$.

\begin{lemma} \label{lemma-map-between-etale} Let $R \to S$ and $R \to S'$ be \'etale. Then any $R$-algebra map $S' \to S$ is \'etale.

\begin{lemma} \label{lemma-surjective-flat-finitely-presented} Let $\varphi :R \to S$ be a ring map. If $R \to S$ is surjective, flat and finitely presented then there exist an idempotent $e \in R$ such that $S = R_e$.

\begin{lemma} \label{lemma-lift-etale} Let $R$ be a ring and let $I \subset R$ be an ideal. Let $R/I \to \overline{S}$ be an \'etale ring map. Then there exists an \'etale ring map $R \to S$ such that $\overline{S} \cong S/IS$ as $R/I$-algebras.

\begin{lemma} \label{lemma-lift-etale-infinitesimal} Consider a commutative diagram $$ \xymatrix{ 0 \ar[r] & J \ar[r] & B' \ar[r] & B \ar[r] & 0 \\ 0 \ar[r] & I \ar[r] \ar[u] & A' \ar[r] \ar[u] & A \ar[r] \ar[u] & 0 } $$ with exact rows where $B' \to B$ and $A' \to A$ are surjective ring maps whose kernels are ideals of square zero. If $A \to B$ is \'etale, and $J = I \otimes_A B$, then $A' \to B'$ is \'etale.

\begin{definition} \label{definition-standard-etale} Let $R$ be a ring. Let $g , f  \in R[x]$. Assume that $f$ is monic and the derivative $f'$ is invertible in the localization $R[x]_g/(f)$. In this case the ring map $R \to R[x]_g/(f)$ is said to be {\it standard \'etale}.

\begin{lemma} \label{lemma-standard-etale} Let $R \to R[x]_g/(f)$ be standard \'etale. \begin{enumerate} \item The ring map $R \to R[x]_g/(f)$ is \'etale. \item For any ring map $R \to R'$ the base change $R' \to R'[x]_g/(f)$ of the standard \'etale ring map $R \to R[x]_g/(f)$ is standard \'etale. \item Any principal localization of $R[x]_g/(f)$ is standard \'etale over $R$. \item A composition of standard \'etale maps is {\bf not} standard \'etale in general. \end{enumerate}

\begin{lemma} \label{lemma-make-etale-map-prescribed-residue-field} Let $R$ be a ring. Let $\mathfrak p$ be a prime of $R$. Let $\kappa(\mathfrak p) \subset L$ be a finite separable field extension. There exists an \'etale ring map $R \to R'$ together with a prime $\mathfrak p'$ lying over $\mathfrak p$ such that the field extension $\kappa(\mathfrak p) \subset \kappa(\mathfrak p')$ is isomorphic to $\kappa(\mathfrak p) \subset L$.

\begin{lemma} \label{lemma-standard-etale-finite-flat-Zariski} Let $R \to S$ be a standard \'etale morphism. There exists a ring map $R \to S'$ with the following properties \begin{enumerate} \item $R \to S'$ is finite, finitely presented, and flat (in other words $S'$ is finite projective as an $R$-module), \item $\Spec(S') \to \Spec(R)$ is surjective, \item for every prime $\mathfrak q \subset S$, lying over $\mathfrak p \subset R$ and every prime $\mathfrak q' \subset S'$ lying over $\mathfrak p$ there exists a $g' \in S'$, $g' \not \in \mathfrak q'$ such that the ring map $R \to S'_{g'}$ factors through a map $\varphi : S \to S'_{g'}$ with $\varphi^{-1}(\mathfrak q'S'_{g'}) = \mathfrak q$. \end{enumerate}

\begin{lemma} \label{lemma-etale-finite-flat-zariski} Let $R \to S$ be a ring map. Assume that \begin{enumerate} \item $R \to S$ is \'etale, and \item $\Spec(S) \to \Spec(R)$ is surjective. \end{enumerate} Then there exists a ring map $R \to S'$ such that \begin{enumerate} \item $R \to S'$ is finite, finitely presented, and flat (in other words it is finite projective as an $R$-module), \item $\Spec(S') \to \Spec(R)$ is surjective, \item for every prime $\mathfrak q' \subset S'$ there exists a $g' \in S'$, $g' \not \in \mathfrak q'$ such that the ring map $R \to S'_{g'}$ factors as $R \to S \to S'_{g'}$. \end{enumerate}

\begin{lemma} \label{lemma-factor-mod-lift-etale} Let $R$ be a ring. Let $f \in R[x]$ be a monic polynomial. Let $\mathfrak p$ be a prime of $R$. Let $f \bmod \mathfrak p = \overline{g} \overline{h}$ be a factorization of the image of $f$ in $\kappa(\mathfrak p)[x]$. If $\gcd(\overline{g}, \overline{h}) = 1$, then there exist \begin{enumerate} \item an \'etale ring map $R \to R'$, \item a prime $\mathfrak p' \subset R'$ lying over $\mathfrak p$, and \item a factorization $f = g h$ in $R'[x]$ \end{enumerate} such that \begin{enumerate} \item $\kappa(\mathfrak p) = \kappa(\mathfrak p')$, \item $\overline{g} = g \bmod \mathfrak p'$, $\overline{h} = h \bmod \mathfrak p'$, and \item the polynomials $g, h$ generate the unit ideal in $R'[x]$. \end{enumerate}

\begin{lemma} \label{lemma-produce-finite} Let $R \to S' \to S$ be ring maps. Let $\mathfrak p \subset R$ be a prime. Let $g \in S'$ be an element. Assume \begin{enumerate} \item $R \to S'$ is integral, \item $R \to S$ is finite type, \item $S'_g \cong S_g$, and \item $g$ invertible in $S' \otimes_R \kappa(\mathfrak p)$. \end{enumerate} Then there exists a $f \in R$, $f \not \in \mathfrak p$ such that $R_f \to S_f$ is finite.

\begin{lemma} \label{lemma-etale-makes-quasi-finite-finite-one-prime} Let $R \to S$ be a ring map. Let $\mathfrak q \subset S$ be a prime lying over the prime $\mathfrak p \subset R$. Assume $R \to S$ finite type and quasi-finite at $\mathfrak q$. Then there exists \begin{enumerate} \item an \'etale ring map $R \to R'$, \item a prime $\mathfrak p' \subset R'$ lying over $\mathfrak p$, \item a product decomposition $$ R' \otimes_R S = A \times B $$ \end{enumerate} with the following properties \begin{enumerate} \item $\kappa(\mathfrak p) = \kappa(\mathfrak p')$, \item $R' \to A$ is finite, \item $A$ has exactly one prime $\mathfrak r$ lying over $\mathfrak p'$, and \item $\mathfrak r$ lies over $\mathfrak q$. \end{enumerate}

\begin{lemma} \label{lemma-etale-makes-quasi-finite-finite} Let $R \to S$ be a ring map. Let $\mathfrak p \subset R$ be a prime. Assume $R \to S$ finite type. Then there exists \begin{enumerate} \item an \'etale ring map $R \to R'$, \item a prime $\mathfrak p' \subset R'$ lying over $\mathfrak p$, \item a product decomposition $$ R' \otimes_R S = A_1 \times \ldots \times A_n \times B $$ \end{enumerate} with the following properties \begin{enumerate} \item we have $\kappa(\mathfrak p) = \kappa(\mathfrak p')$, \item each $A_i$ is finite over $R'$, \item each $A_i$ has exactly one prime $\mathfrak r_i$ lying over $\mathfrak p'$, and \item $R' \to B$ not quasi-finite at any prime lying over $\mathfrak p'$. \end{enumerate}

\begin{lemma} \label{lemma-etale-makes-quasi-finite-finite-variant} Let $R \to S$ be a ring map. Let $\mathfrak p \subset R$ be a prime. Assume $R \to S$ finite type. Then there exists \begin{enumerate} \item an \'etale ring map $R \to R'$, \item a prime $\mathfrak p' \subset R'$ lying over $\mathfrak p$, \item a product decomposition $$ R' \otimes_R S = A_1 \times \ldots \times A_n \times B $$ \end{enumerate} with the following properties \begin{enumerate} \item each $A_i$ is finite over $R'$, \item each $A_i$ has exactly one prime $\mathfrak r_i$ lying over $\mathfrak p'$, \item the finite field extensions $\kappa(\mathfrak p') \subset \kappa(\mathfrak r_i)$ are purely inseparable, and \item $R' \to B$ not quasi-finite at any prime lying over $\mathfrak p'$. \end{enumerate}

\begin{lemma} \label{lemma-etale-under-finite-flat} Let $(R, \mathfrak m_R) \to (S, \mathfrak m_S)$ be a local homomorphism of local rings. Assume $S$ is the localization of an \'etale ring extension of $R$. Then there exists a finite, finitely presented, faithfully flat ring map $R \to S'$ such that for every maximal ideal $\mathfrak m'$ of $S'$ there is a factorization $$ R \to S \to S'_{\mathfrak m'}. $$ of the ring map $R \to S'_{\mathfrak m'}$.

\begin{lemma} \label{lemma-trick} Let $R$ be a ring. Let $f \in R[x]$ be a monic polynomial. Let $R \to B$ be a ring map. If $h \in B[x]/(f)$ is integral over $R$, then the element $f' h$ can be written as $f'h = \sum_i b_i x^i$ with $b_i \in B$ integral over $R$.

\begin{lemma} \label{lemma-integral-closure-commutes-etale} Let $R \to S$ be an \'etale ring map. Let $R \to B$ be any ring map. Let $A \subset B$ be the integral closure of $R$ in $B$. Let $A' \subset S \otimes_R B$ be the integral closure of $S$ in $S \otimes_R B$. Then the canonical map $S \otimes_R A \to A'$ is an isomorphism.

\begin{lemma} \label{lemma-integral-closure-commutes-smooth} Let $R \to S$ be a smooth ring map. Let $R \to B$ be any ring map. Let $A \subset B$ be the integral closure of $R$ in $B$. Let $A' \subset S \otimes_R B$ be the integral closure of $S$ in $S \otimes_R B$. Then the canonical map $S \otimes_R A \to A'$ is an isomorphism.

\begin{lemma} \label{lemma-integral-closure-commutes-colim-smooth} Let $R \to S$ and $R \to B$ be ring maps. Let $A \subset B$ be the integral closure of $R$ in $B$. Let $A' \subset S \otimes_R B$ be the integral closure of $S$ in $S \otimes_R B$. If $S$ is a filtered colimit of smooth $R$-algebras, then the canonical map $S \otimes_R A \to A'$ is an isomorphism.

\begin{definition} \label{definition-formally-unramified} Let $R \to S$ be a ring map. We say $S$ is {\it formally unramified over $R$} if for every commutative solid diagram $$ \xymatrix{ S \ar[r] \ar@{-->}[rd] & A/I \\ R \ar[r] \ar[u] & A \ar[u] } $$ where $I \subset A$ is an ideal of square zero, there exists at most one dotted arrow making the diagram commute.

\begin{lemma} \label{lemma-characterize-formally-unramified} Let $R \to S$ be a ring map. The following are equivalent: \begin{enumerate} \item $R \to S$ is formally unramified, \item the module of differentials $\Omega_{S/R}$ is zero. \end{enumerate}

\begin{lemma} \label{lemma-formally-unramified-local} Let $R \to S$ be a ring map. The following are equivalent: \begin{enumerate} \item $R \to S$ is formally unramified, \item $R \to S_{\mathfrak q}$ is formally unramified for all primes $\mathfrak q$ of $S$, and \item $R_{\mathfrak p} \to S_{\mathfrak q}$ is formally unramified for all primes $\mathfrak q$ of $S$ with $\mathfrak p = R \cap \mathfrak q$. \end{enumerate}

\begin{lemma} \label{lemma-formally-unramified-localize} Let $A \to B$ be a formally unramified ring map. \begin{enumerate} \item For $S \subset A$ a multiplicative subset, $S^{-1}A \to S^{-1}B$ is formally unramified. \item For $S \subset B$ a multiplicative subset, $A \to S^{-1}B$ is formally unramified. \end{enumerate}

\begin{lemma} \label{lemma-colimit-formally-unramified} Let $R$ be a ring. Let $I$ be a directed set. Let $(S_i, \varphi_{ii'})$ be a system of $R$-algebras over $I$. If each $R \to S_i$ is formally unramified, then $S = \colim_{i \in I} S_i$ is formally unramified over $R$

\begin{lemma} \label{lemma-universal-thickening} Let $R \to S$ be a formally unramified ring map. There exists a surjection of $R$-algebras $S' \to S$ whose kernel is an ideal of square zero with the following universal property: Given any commutative diagram $$ \xymatrix{ S \ar[r]_a & A/I \\ R \ar[r]^b \ar[u] & A \ar[u] } $$ where $I \subset A$ is an ideal of square zero, there is a unique $R$-algebra map $a' : S' \to A$ such that $S' \to A \to A/I$ is equal to $S' \to S \to A/I$.

\begin{definition} \label{definition-universal-thickening} Let $R \to S$ be a formally unramified ring map. \begin{enumerate} \item The {\it universal first order thickening} of $S$ over $R$ is the surjection of $R$-algebras $S' \to S$ of Lemma \ref{lemma-universal-thickening}. \item The {\it conormal module} of $R \to S$ is the kernel $I$ of the universal first order thickening $S' \to S$, seen as a $S$-module. \end{enumerate} We often denote the conormal module {\it $C_{S/R}$} in this situation.

\begin{lemma} \label{lemma-universal-thickening-quotient} Let $I \subset R$ be an ideal of a ring. The universal first order thickening of $R/I$ over $R$ is the surjection $R/I^2 \to R/I$. The conormal module of $R/I$ over $R$ is $C_{(R/I)/R} = I/I^2$.

\begin{lemma} \label{lemma-universal-thickening-localize} Let $A \to B$ be a formally unramified ring map. Let $\varphi : B' \to B$ be the universal first order thickening of $B$ over $A$. \begin{enumerate} \item Let $S \subset A$ be a multiplicative subset. Then $S^{-1}B' \to S^{-1}B$ is the universal first order thickening of $S^{-1}B$ over $S^{-1}A$. In particular $S^{-1}C_{B/A} = C_{S^{-1}B/S^{-1}A}$. \item Let $S \subset B$ be a multiplicative subset. Then $S' = \varphi^{-1}(S)$ is a multiplicative subset in $B'$ and $(S')^{-1}B' \to S^{-1}B$ is the universal first order thickening of $S^{-1}B$ over $A$. In particular $S^{-1}C_{B/A} = C_{S^{-1}B/A}$. \end{enumerate} Note that the lemma makes sense by Lemma \ref{lemma-formally-unramified-localize}.

\begin{lemma} \label{lemma-differentials-universal-thickening} Let $R \to A  \to B$ be ring maps. Assume $A \to B$ formally unramified. Let $B' \to B$ be the universal first order thickening of $B$ over $A$. Then $B'$ is formally unramified over $A$, and the canonical map $\Omega_{A/R} \otimes_A B \to \Omega_{B'/R} \otimes_{B'} B$ is an isomorphism.

\begin{definition} \label{definition-formally-etale} Let $R \to S$ be a ring map. We say $S$ is {\it formally \'etale over $R$} if for every commutative solid diagram $$ \xymatrix{ S \ar[r] \ar@{-->}[rd] & A/I \\ R \ar[r] \ar[u] & A \ar[u] } $$ where $I \subset A$ is an ideal of square zero, there exists a unique dotted arrow making the diagram commute.

\begin{lemma} \label{lemma-formally-etale-etale} Let $R \to S$ be a ring map of finite presentation. The following are equivalent: \begin{enumerate} \item $R \to S$ is formally \'etale, \item $R \to S$ is \'etale. \end{enumerate}

\begin{lemma} \label{lemma-colimit-formally-etale} Let $R$ be a ring. Let $I$ be a directed set. Let $(S_i, \varphi_{ii'})$ be a system of $R$-algebras over $I$. If each $R \to S_i$ is formally \'etale, then $S = \colim_{i \in I} S_i$ is formally \'etale over $R$

\begin{lemma} \label{lemma-localization-formally-etale} Let $R$ be a ring. Let $S \subset R$ be any multiplicative subset. Then the ring map $R \to S^{-1}R$ is formally \'etale.

\begin{definition} \label{definition-unramified} Let $R \to S$ be a ring map. \begin{enumerate} \item We say $R \to S$ is {\it unramified} if $R \to S$ is of finite type and $\Omega_{S/R} = 0$. \item We say $R \to S$ is {\it G-unramified} if $R \to S$ is of finite presentation and $\Omega_{S/R} = 0$. \item Given a prime $\mathfrak q$ of $S$ we say that $S$ is {\it unramified at $\mathfrak q$} if there exists a $g \in S$, $g \not \in \mathfrak q$ such that $R \to S_g$ is unramified. \item Given a prime $\mathfrak q$ of $S$ we say that $S$ is {\it G-unramified at $\mathfrak q$} if there exists a $g \in S$, $g \not \in \mathfrak q$ such that $R \to S_g$ is G-unramified. \end{enumerate}

\begin{lemma} \label{lemma-formally-unramified-unramified} Let $R \to S$ be a ring map. The following are equivalent \begin{enumerate} \item $R \to S$ is formally unramified and of finite type, and \item $R \to S$ is unramified. \end{enumerate} Moreover, also the following are equivalent \begin{enumerate} \item $R \to S$ is formally unramified and of finite presentation, and \item $R \to S$ is G-unramified. \end{enumerate}

\begin{lemma} \label{lemma-unramified} Properties of unramified and G-unramified ring maps. \begin{enumerate} \item The base change of an unramified ring map is unramified. The base change of a G-unramified ring map is G-unramified. \item The composition of unramified ring maps is unramified. The composition of G-unramified ring maps is G-unramified. \item Any principal localization $R \to R_f$ is G-unramified and unramified. \item If $I \subset R$ is an ideal, then $R \to R/I$ is unramified. If $I \subset R$ is a finitely generated ideal, then $R \to R/I$ is G-unramified. \item An \'etale ring map is G-unramified and unramified. \item If $R \to S$ is of finite type (resp.\ finite presentation), $\mathfrak q \subset S$ is a prime and $(\Omega_{S/R})_{\mathfrak q} = 0$, then $R \to S$ is unramified (resp.\ G-unramified) at $\mathfrak q$. \item If $R \to S$ is of finite type (resp.\ finite presentation), $\mathfrak q \subset S$ is a prime and $\Omega_{S/R} \otimes_S \kappa(\mathfrak q) = 0$, then $R \to S$ is unramified (resp.\ G-unramified) at $\mathfrak q$. \item If $R \to S$ is of finite type (resp.\ finite presentation), $\mathfrak q \subset S$ is a prime lying over $\mathfrak p \subset R$ and $(\Omega_{S \otimes_R \kappa(\mathfrak p)/\kappa(\mathfrak p)})_{\mathfrak q} = 0$, then $R \to S$ is unramified (resp.\ G-unramified) at $\mathfrak q$. \item If $R \to S$ is of finite type (resp.\ presentation), $\mathfrak q \subset S$ is a prime lying over $\mathfrak p \subset R$ and $(\Omega_{S \otimes_R \kappa(\mathfrak p)/\kappa(\mathfrak p)}) \otimes_{S \otimes_R \kappa(\mathfrak p)} \kappa(\mathfrak q) = 0$, then $R \to S$ is unramified (resp.\ G-unramified) at $\mathfrak q$. \item If $R \to S$ is a ring map, $g_1, \ldots, g_m \in S$ generate the unit ideal and $R \to S_{g_j}$ is unramified (resp.\ G-unramified) for $j = 1, \ldots, m$, then $R \to S$ is unramified (resp.\ G-unramified). \item If $R \to S$ is a ring map which is unramified (resp.\ G-unramified) at every prime of $S$, then $R \to S$ is unramified (resp.\ G-unramified). \item If $R \to S$ is G-unramified, then there exists a finite type $\mathbf{Z}$-algebra $R_0$ and a G-unramified ring map $R_0 \to S_0$ and a ring map $R_0 \to R$ such that $S = R \otimes_{R_0} S_0$. \item If $R \to S$ is unramified, then there exists a finite type $\mathbf{Z}$-algebra $R_0$ and an unramified ring map $R_0 \to S_0$ and a ring map $R_0 \to R$ such that $S$ is a quotient of $R \otimes_{R_0} S_0$. \end{enumerate}

\begin{lemma} \label{lemma-diagonal-unramified} Let $R \to S$ be a ring map. If $R \to S$ is unramified, then there exists an idempotent $e \in S \otimes_R S$ such that $S \otimes_R S \to S$ is isomorphic to $S \otimes_R S \to (S \otimes_R S)_e$.

\begin{lemma} \label{lemma-unramified-at-prime} Let $R \to S$ be a ring map. Let $\mathfrak q \subset S$ be a prime lying over $\mathfrak p$ in $R$. If $S/R$ is unramified at $\mathfrak q$ then \begin{enumerate} \item we have $\mathfrak p S_{\mathfrak q} = \mathfrak qS_{\mathfrak q}$ is the maximal ideal of the local ring $S_{\mathfrak q}$, and \item the field extension $\kappa(\mathfrak p) \subset \kappa(\mathfrak q)$ is finite separable. \end{enumerate}

\begin{lemma} \label{lemma-unramified-quasi-finite} Let $R \to S$ be a finite type ring map. Let $\mathfrak q$ be a prime of $S$. If $R \to S$ is unramified at $\mathfrak q$ then $R \to S$ is quasi-finite at $\mathfrak q$. In particular, an unramified ring map is quasi-finite.

\begin{lemma} \label{lemma-characterize-unramified} Let $R \to S$ be a ring map. Let $\mathfrak q$ be a prime of $S$ lying over a prime $\mathfrak p$ of $R$. If \begin{enumerate} \item $R \to S$ is of finite type, \item $\mathfrak p S_{\mathfrak q}$ is the maximal ideal of the local ring $S_{\mathfrak q}$, and \item the field extension $\kappa(\mathfrak p) \subset \kappa(\mathfrak q)$ is finite separable, \end{enumerate} then $R \to S$ is unramified at $\mathfrak q$.

\begin{lemma} \label{lemma-etale-flat-unramified-finite-presentation} Let $R \to S$ be a ring map. The following are equivalent \begin{enumerate} \item $R \to S$ is \'etale, \item $R \to S$ is flat and G-unramified, and \item $R \to S$ is flat, unramified, and of finite presentation, \end{enumerate}

\begin{lemma} \label{lemma-etale-makes-unramified-closed-at-prime} Let $R \to S$ be a ring map. Let $\mathfrak q$ be a prime of $S$ lying over $\mathfrak p \subset R$. Assume that $R \to S$ is of finite type and unramified at $\mathfrak q$. Then there exist \begin{enumerate} \item an \'etale ring map $R \to R'$, \item a prime $\mathfrak p' \subset R'$ lying over $\mathfrak p$. \item a product decomposition $$ R' \otimes_R S = A \times B $$ \end{enumerate} with the following properties \begin{enumerate} \item $R' \to A$ is surjective, and \item $\mathfrak p'A$ is a prime of $A$ lying over $\mathfrak p'$ and over $\mathfrak q$. \end{enumerate}

\begin{lemma} \label{lemma-etale-makes-unramified-closed} \begin{slogan} In an unramified ring map, one can separate the points in a fiber by passing to an \'etale neighbourhood. \end{slogan} Let $R \to S$ be a ring map. Let $\mathfrak p$ be a prime of $R$. If $R \to S$ is unramified then there exist \begin{enumerate} \item an \'etale ring map $R \to R'$, \item a prime $\mathfrak p' \subset R'$ lying over $\mathfrak p$. \item a product decomposition $$ R' \otimes_R S = A_1 \times \ldots \times A_n \times B $$ \end{enumerate} with the following properties \begin{enumerate} \item $R' \to A_i$ is surjective, \item $\mathfrak p'A_i$ is a prime of $A_i$ lying over $\mathfrak p'$, and \item there is no prime of $B$ lying over $\mathfrak p'$. \end{enumerate}

\begin{definition} \label{definition-henselian} Let $(R, \mathfrak m, \kappa)$ be a local ring. \begin{enumerate} \item We say $R$ is {\it henselian} if for every monic $f \in R[T]$ and every root $a_0 \in \kappa$ of $\overline{f}$ such that $\overline{f'}(a_0) \not = 0$ there exists an $a \in R$ such that $f(a) = 0$ and $a_0 = \overline{a}$. \item We say $R$ is {\it strictly henselian} if $R$ is henselian and its residue field is separably algebraically closed. \end{enumerate}

\begin{lemma} \label{lemma-uniqueness} Let $(R, \mathfrak m, \kappa)$ be a local ring. Let $f \in R[T]$. Let $a, b \in R$ such that $f(a) = f(b) = 0$, $a = b \bmod \mathfrak m$, and $f'(a) \not \in \mathfrak m$. Then $a = b$.

\begin{lemma} \label{lemma-characterize-henselian} \begin{slogan} Characterizations of henselian local rings \end{slogan} Let $(R, \mathfrak m, \kappa)$ be a local ring. The following are equivalent \begin{enumerate} \item $R$ is henselian, \item for every $f \in R[T]$ and every root $a_0 \in \kappa$ of $\overline{f}$ such that $\overline{f'}(a_0) \not = 0$ there exists an $a \in R$ such that $f(a) = 0$ and $a_0 = \overline{a}$, \item for any monic $f \in R[T]$ and any factorization $\overline{f} = g_0 h_0$ with $\gcd(g_0, h_0) = 1$ there exists a factorization $f = gh$ in $R[T]$ such that $g_0 = \overline{g}$ and $h_0 = \overline{h}$, \item for any monic $f \in R[T]$ and any factorization $\overline{f} = g_0 h_0$ with $\gcd(g_0, h_0) = 1$ there exists a factorization $f = gh$ in $R[T]$ such that $g_0 = \overline{g}$ and $h_0 = \overline{h}$ and moreover $\deg_T(g) = \deg_T(g_0)$, \item for any $f \in R[T]$ and any factorization $\overline{f} = g_0 h_0$ with $\gcd(g_0, h_0) = 1$ there exists a factorization $f = gh$ in $R[T]$ such that $g_0 = \overline{g}$ and $h_0 = \overline{h}$, \item for any $f \in R[T]$ and any factorization $\overline{f} = g_0 h_0$ with $\gcd(g_0, h_0) = 1$ there exists a factorization $f = gh$ in $R[T]$ such that $g_0 = \overline{g}$ and $h_0 = \overline{h}$ and moreover $\deg_T(g) = \deg_T(g_0)$, \item for any \'etale ring map $R \to S$ and prime $\mathfrak q$ of $S$ lying over $\mathfrak m$ with $\kappa = \kappa(\mathfrak q)$ there exists a section $\tau : S \to R$ of $R \to S$, \item for any \'etale ring map $R \to S$ and prime $\mathfrak q$ of $S$ lying over $\mathfrak m$ with $\kappa = \kappa(\mathfrak q)$ there exists a section $\tau : S \to R$ of $R \to S$ with $\mathfrak q = \tau^{-1}(\mathfrak m)$, \item any finite $R$-algebra is a product of local rings, \item any finite $R$-algebra is a finite product of local rings, \item any finite type $R$-algebra $S$ can be written as $A \times B$ with $R \to A$ finite and $R \to B$ not quasi-finite at any prime lying over $\mathfrak m$, \item any finite type $R$-algebra $S$ can be written as $A \times B$ with $R \to A$ finite such that each irreducible component of $\Spec(B \otimes_R \kappa)$ has dimension $\geq 1$, and \item any quasi-finite $R$-algebra $S$ can be written as $S = A \times B$ with $R \to A$ finite such that $B \otimes_R \kappa = 0$. \end{enumerate}

\begin{lemma} \label{lemma-finite-over-henselian} Let $(R, \mathfrak m, \kappa)$ be a henselian local ring. \begin{enumerate} \item If $R \subset S$ is a finite ring extension then $S$ is a finite product of henselian local rings. \item If $R \subset S$ is a finite local homomorphism of local rings, then $S$ is a henselian local ring. \item If $R \to S$ is a finite type ring map, and $\mathfrak q$ is a prime of $S$ lying over $\mathfrak m$ at which $R \to S$ is quasi-finite, then $S_{\mathfrak q}$ is henselian. \item If $R \to S$ is quasi-finite then $S_{\mathfrak q}$ is henselian for every prime $\mathfrak q$ lying over $\mathfrak m$. \end{enumerate}

\begin{lemma} \label{lemma-mop-up} Let $(R, \mathfrak m, \kappa)$ be a henselian local ring. Any finite type $R$-algebra $S$ can be written as $S = A_1 \times \ldots \times A_n \times B$ with $A_i$ local and finite over $R$ and $R \to B$ not quasi-finite at any prime of $B$ lying over $\mathfrak m$.

\begin{lemma} \label{lemma-mop-up-strictly-henselian} Let $(R, \mathfrak m, \kappa)$ be a strictly henselian local ring. Any finite type $R$-algebra $S$ can be written as $S = A_1 \times \ldots \times A_n \times B$ with $A_i$ local and finite over $R$ and $\kappa \subset \kappa(\mathfrak m_{A_i})$ finite purely inseparable and $R \to B$ not quasi-finite at any prime of $B$ lying over $\mathfrak m$.

\begin{lemma} \label{lemma-henselian-cat-finite-etale} Let $(R, \mathfrak m, \kappa)$ be a henselian local ring. The category of finite \'etale ring extensions $R \to S$ is equivalent to the category of finite \'etale algebras $\kappa \to \overline{S}$ via the functor $S \mapsto S/\mathfrak mS$.

\begin{lemma} \label{lemma-unramified-over-strictly-henselian} Let $(R, \mathfrak m, \kappa)$ be a strictly henselian local ring. Let $R \to S$ be an unramified ring map. Then $$ S = A_1 \times \ldots \times A_n \times B $$ with each $R \to A_i$ surjective and no prime of $B$ lying over $\mathfrak m$.

\begin{lemma} \label{lemma-complete-henselian} Let $(R, \mathfrak m, \kappa)$ be a complete local ring, see Definition \ref{definition-complete-local-ring}. Then $R$ is henselian.

\begin{lemma} \label{lemma-local-dimension-zero-henselian} \begin{slogan} Local rings of dimension zero are henselian. \end{slogan} Let $(R, \mathfrak m)$ be a local ring of dimension $0$. Then $R$ is henselian.

\begin{lemma} \label{lemma-map-into-henselian} Let $R \to S$ be a ring map with $S$ henselian local. Given \begin{enumerate} \item an \'etale ring map $R \to A$, \item a prime $\mathfrak q$ of $A$ lying over $\mathfrak p = R \cap \mathfrak m_S$, \item a $\kappa(\mathfrak p)$-algebra map $\tau : \kappa(\mathfrak q) \to S/\mathfrak m_S$, \end{enumerate} then there exists a unique homomorphism of $R$-algebras $f : A \to S$ such that $\mathfrak q = f^{-1}(\mathfrak m_S)$ and $f \bmod \mathfrak q = \tau$.

\begin{lemma} \label{lemma-strictly-henselian-solutions} Let $\varphi : R \to S$ be a local homomorphism of strictly henselian local rings. Let $P_1, \ldots, P_n \in R[x_1, \ldots, x_n]$ be polynomials such that $R[x_1, \ldots, x_n]/(P_1, \ldots, P_n)$ is \'etale over $R$. Then the map $$ R^n \longrightarrow S^n, \quad (h_1, \ldots, h_n) \longmapsto (\varphi(h_1), \ldots, \varphi(h_n)) $$ induces a bijection between $$ \{ (r_1, \ldots, r_n) \in R^n \mid P_i(r_1, \ldots, r_n) = 0, \ i = 1, \ldots, n \} $$ and $$ \{ (s_1, \ldots, s_n) \in S^n \mid P'_i(s_1, \ldots, s_n) = 0, \ i = 1, \ldots, n \} $$ where $P'_i \in S[x_1, \ldots, x_n]$ are the images of the $P_i$ under $\varphi$.

\begin{lemma} \label{lemma-split-ML-henselian} Let $R$ be a henselian local ring. Any countably generated Mittag-Leffler module over $R$ is a direct sum of finitely presented $R$-modules.

\begin{lemma} \label{lemma-base-change-colimit-etale} Let $R \to A$ and $R \to R'$ be ring maps. If $A$ is a filtered colimit of \'etale ring maps, then so is $R' \to R' \otimes_R A$.

\begin{lemma} \label{lemma-composition-colimit-etale} Let $A \to B \to C$ be ring maps. If $A \to B$ is a filtered colimit of \'etale ring maps and $B \to C$ is a filtered colimit of \'etale ring maps, then $A \to C$ is a filtered colimit of \'etale ring maps.

\begin{lemma} \label{lemma-colimit-colimit-etale} Let $R$ be a ring. Let $A = \colim A_i$ be a filtered colimit of $R$-algebras such that each $A_i$ is a filtered colimit of \'etale $R$-algebras. Then $A$ is a filtered colimit of \'etale $R$-algebras.

\begin{lemma} \label{lemma-colimits-of-etale} Let $R$ be a ring. Let $A \to B$ be an $R$-algebra homomorphism. If $A$ and $B$ are filtered colimits of \'etale $R$-algebras, then $B$ is a filtered colimit of \'etale $A$-algebras.

\begin{lemma} \label{lemma-map-into-henselian-colimit} Let $R \to S$ be a ring map with $S$ henselian local. Given \begin{enumerate} \item an $R$-algebra $A$ which is a filtered colimit of \'etale $R$-algebras, \item a prime $\mathfrak q$ of $A$ lying over $\mathfrak p = R \cap \mathfrak m_S$, \item a $\kappa(\mathfrak p)$-algebra map $\tau : \kappa(\mathfrak q) \to S/\mathfrak m_S$, \end{enumerate} then there exists a unique homomorphism of $R$-algebras $f : A \to S$ such that $\mathfrak q = f^{-1}(\mathfrak m_S)$ and $f \bmod \mathfrak q = \tau$.

\begin{lemma} \label{lemma-uniqueness-henselian} Let $R$ be a ring. Given a commutative diagram of ring maps $$ \xymatrix{ S \ar[r] & K \\ R \ar[u] \ar[r] & S' \ar[u] } $$ where $S$, $S'$ are henselian local, $S$, $S'$ are filtered colimits of \'etale $R$-algebras, $K$ is a field and the arrows $S \to K$ and  $S' \to K$ identify $K$ with the residue field of both $S$ and $S'$. Then there exists an unique $R$-algebra isomorphism $S \to S'$ compatible with the maps to $K$.

\begin{lemma} \label{lemma-colimit-henselian} A filtered colimit of henselian local rings along local homomorphisms is henselian.

\begin{lemma} \label{lemma-henselization} Let $(R, \mathfrak m, \kappa)$ be a local ring. There exists a local ring map $R \to R^h$ with the following properties \begin{enumerate} \item $R^h$ is henselian, \item $R^h$ is a filtered colimit of \'etale $R$-algebras, \item $\mathfrak m R^h$ is the maximal ideal of $R^h$, and \item $\kappa = R^h/\mathfrak m R^h$. \end{enumerate}

\begin{lemma} \label{lemma-strict-henselization} Let $(R, \mathfrak m, \kappa)$ be a local ring. Let $\kappa \subset \kappa^{sep}$ be a separable algebraic closure. There exists a commutative diagram $$ \xymatrix{ \kappa \ar[r] & \kappa \ar[r] & \kappa^{sep} \\ R \ar[r] \ar[u] & R^h \ar[r] \ar[u] & R^{sh} \ar[u] } $$ with the following properties \begin{enumerate} \item the map $R^h \to R^{sh}$ is local \item $R^{sh}$ is strictly henselian, \item $R^{sh}$ is a filtered colimit of \'etale $R$-algebras, \item $\mathfrak m R^{sh}$ is the maximal ideal of $R^{sh}$, and \item $\kappa^{sep} = R^{sh}/\mathfrak m R^{sh}$. \end{enumerate}

\begin{definition} \label{definition-henselization} Let $(R, \mathfrak m, \kappa)$ be a local ring. \begin{enumerate} \item The local ring map $R \to R^h$ constructed in Lemma \ref{lemma-henselization} is called the {\it henselization} of $R$. \item Given a separable algebraic closure $\kappa \subset \kappa^{sep}$ the local ring map $R \to R^{sh}$ constructed in Lemma \ref{lemma-strict-henselization} is called the {\it strict henselization of $R$ with respect to $\kappa \subset \kappa^{sep}$}. \item A local ring map $R \to R^{sh}$ is called a {\it strict henselization} of $R$ if it is isomorphic to one of the local ring maps constructed in Lemma \ref{lemma-strict-henselization} \end{enumerate}

\begin{lemma} \label{lemma-henselian-functorial-prepare} Let $R \to S$ be a local map of local rings. Let $S \to S^h$ be the henselization. Let $R \to A$ be an \'etale ring map and let $\mathfrak q$ be a prime of $A$ lying over $\mathfrak m_R$ such that $R/\mathfrak m_R \cong \kappa(\mathfrak q)$. Then there exists a unique morphism of rings $f : A \to S^h$ fitting into the commutative diagram $$ \xymatrix{ A \ar[r]_f & S^h \\ R \ar[u] \ar[r] & S \ar[u] } $$ such that $f^{-1}(\mathfrak m_{S^h}) = \mathfrak q$.

\begin{lemma} \label{lemma-henselian-functorial} Let $R \to S$ be a local map of local rings. Let $R \to R^h$ and $S \to S^h$ be the henselizations. There exists a unique local ring map $R^h \to S^h$ fitting into the commutative diagram $$ \xymatrix{ R^h \ar[r]_f & S^h \\ R \ar[u] \ar[r] & S \ar[u] } $$

\begin{lemma} \label{lemma-henselization-different} Let $R$ be a ring. Let $\mathfrak p \subset R$ be a prime ideal. Consider the category of pairs $(S, \mathfrak q)$ where $R \to S$ is \'etale and $\mathfrak q$ is a prime lying over $\mathfrak p$ such that $\kappa(\mathfrak p) = \kappa(\mathfrak q)$. This category is filtered and $$ (R_{\mathfrak p})^h = \colim_{(S, \mathfrak q)} S = \colim_{(S, \mathfrak q)} S_{\mathfrak q} $$ canonically.

\begin{lemma} \label{lemma-henselian-functorial-improve} Let $R \to S$ be a ring map. Let $\mathfrak q \subset S$ be a prime lying over $\mathfrak p \subset R$. Let $R \to R^h$ and $S \to S^h$ be the henselizations of $R_\mathfrak p$ and $S_\mathfrak q$. The local ring map $R^h \to S^h$ of Lemma \ref{lemma-henselian-functorial} identifies $S^h$ with the henselization of $R^h \otimes_R S$ at the unique prime lying over $\mathfrak m^h$ and $\mathfrak q$.

\begin{lemma} \label{lemma-quasi-finite-henselization} Let $R \to S$ be a ring map. Let $\mathfrak q$ be a prime of $S$ lying over $\mathfrak p$ in $R$. Assume $R \to S$ is quasi-finite at $\mathfrak q$. The commutative diagram $$ \xymatrix{ R_{\mathfrak p}^h \ar[r] & S_{\mathfrak q}^h \\ R_{\mathfrak p} \ar[u] \ar[r] & S_{\mathfrak q} \ar[u] } $$ of Lemma \ref{lemma-henselian-functorial} identifies $S_{\mathfrak q}^h$ with the localization of $R_{\mathfrak p}^h \otimes_{R_{\mathfrak p}} S_{\mathfrak q}$ at the prime generated by $\mathfrak q$.

\begin{lemma} \label{lemma-quotient-henselization} Let $R$ be a local ring with henselization $R^h$. Let $I \subset \mathfrak m_R$. Then $R^h/IR^h$ is the henselization of $R/I$.

\begin{lemma} \label{lemma-strictly-henselian-functorial-prepare} Let $\varphi : R \to S$ be a local map of local rings. Let $S/\mathfrak m_S \subset \kappa^{sep}$ be a separable algebraic closure. Let $S \to S^{sh}$ be the strict henselization of $S$ with respect to $S/\mathfrak m_S \subset \kappa^{sep}$. Let $R \to A$ be an \'etale ring map and let $\mathfrak q$ be a prime of $A$ lying over $\mathfrak m_R$. Given any commutative diagram $$ \xymatrix{ \kappa(\mathfrak q) \ar[r]_{\phi} & \kappa^{sep} \\ R/\mathfrak m_R \ar[r]^{\varphi} \ar[u] & S/\mathfrak m_S \ar[u] } $$ there exists a unique morphism of rings $f : A \to S^{sh}$ fitting into the commutative diagram $$ \xymatrix{ A \ar[r]_f & S^{sh} \\ R \ar[u] \ar[r]^{\varphi} & S \ar[u] } $$ such that $f^{-1}(\mathfrak m_{S^h}) = \mathfrak q$ and the induced map $\kappa(\mathfrak q) \to \kappa^{sep}$ is the given one.

\begin{lemma} \label{lemma-strictly-henselian-functorial} Let $R \to S$ be a local map of local rings. Choose separable algebraic closures $R/\mathfrak m_R \subset \kappa_1^{sep}$ and $S/\mathfrak m_S \subset \kappa_2^{sep}$. Let $R \to R^{sh}$ and $S \to S^{sh}$ be the corresponding strict henselizations. Given any commutative diagram $$ \xymatrix{ \kappa_1^{sep} \ar[r]_{\phi} & \kappa_2^{sep} \\ R/\mathfrak m_R \ar[r]^{\varphi} \ar[u] & S/\mathfrak m_S \ar[u] } $$ There exists a unique local ring map $R^{sh} \to S^{sh}$ fitting into the commutative diagram $$ \xymatrix{ R^{sh} \ar[r]_f & S^{sh} \\ R \ar[u] \ar[r] & S \ar[u] } $$ and inducing $\phi$ on the residue fields of $R^{sh}$ and $S^{sh}$.

\begin{lemma} \label{lemma-strict-henselization-different} Let $R$ be a ring. Let $\mathfrak p \subset R$ be a prime ideal. Let $\kappa(\mathfrak p) \subset \kappa^{sep}$ be a separable algebraic closure. Consider the category of triples $(S, \mathfrak q, \phi)$ where $R \to S$ is \'etale, $\mathfrak q$ is a prime lying over $\mathfrak p$, and $\phi : \kappa(\mathfrak q) \to \kappa^{sep}$ is a $\kappa(\mathfrak p)$-algebra map. This category is filtered and $$ (R_{\mathfrak p})^{sh} = \colim_{(S, \mathfrak q, \phi)} S = \colim_{(S, \mathfrak q, \phi)} S_{\mathfrak q} $$ canonically.

\begin{lemma} \label{lemma-strictly-henselian-functorial-improve} Let $R \to S$ be a ring map. Let $\mathfrak q \subset S$ be a prime lying over $\mathfrak p \subset R$. Choose separable algebraic closures $\kappa(\mathfrak p) \subset \kappa_1^{sep}$ and $\kappa(\mathfrak q) \subset \kappa_2^{sep}$. Let $R^{sh}$ and $S^{sh}$ be the corresponding strict henselizations of $R_\mathfrak p$ and $S_\mathfrak q$. Given any commutative diagram $$ \xymatrix{ \kappa_1^{sep} \ar[r]_{\phi} & \kappa_2^{sep} \\ \kappa(\mathfrak p) \ar[r]^{\varphi} \ar[u] & \kappa(\mathfrak q) \ar[u] } $$ The local ring map $R^{sh} \to S^{sh}$ of Lemma \ref{lemma-strictly-henselian-functorial} identifies $S^{sh}$ with the strict henselization of $R^{sh} \otimes_R S$ at a prime lying over $\mathfrak m^{sh}$ and $\mathfrak q$.

\begin{lemma} \label{lemma-quasi-finite-strict-henselization} Let $R \to S$ be a ring map. Let $\mathfrak q$ be a prime of $S$ lying over $\mathfrak p$ in $R$. Let $\kappa(\mathfrak q) \subset \kappa^{sep}$ be a separable algebraic closure. Assume $R \to S$ is quasi-finite at $\mathfrak q$. The commutative diagram $$ \xymatrix{ R_{\mathfrak p}^{sh} \ar[r] & S_{\mathfrak q}^{sh} \\ R_{\mathfrak p} \ar[u] \ar[r] & S_{\mathfrak q} \ar[u] } $$ of Lemma \ref{lemma-strictly-henselian-functorial} identifies $S_{\mathfrak q}^{sh}$ with a localization of $R_{\mathfrak p}^{sh} \otimes_{R_{\mathfrak p}} S_{\mathfrak q}$.

\begin{lemma} \label{lemma-quotient-strict-henselization} Let $R$ be a local ring with strict henselization $R^{sh}$. Let $I \subset \mathfrak m_R$. Then $R^{sh}/IR^{sh}$ is a strict henselization of $R/I$.

\begin{lemma} \label{lemma-sh-from-h-map} Let $R \to S$ be a ring map. Let $\mathfrak q \subset S$ be a prime lying over $\mathfrak p \subset R$ such that $\kappa(\mathfrak p) \to \kappa(\mathfrak q)$ is an isomorphism. Choose a separable algebraic closure $\kappa^{sep}$ of $\kappa(\mathfrak p) = \kappa(\mathfrak q)$. Then $$ (S_\mathfrak q)^{sh} = (S_\mathfrak q)^h \otimes_{(R_\mathfrak p)^h} (R_\mathfrak p)^{sh} $$

\begin{definition} \label{definition-conditions} Let $R$ be a Noetherian ring. Let $k \geq 0$ be an integer. \begin{enumerate} \item We say $R$ has property {\it $(R_k)$} if for every prime $\mathfrak p$ of height $\leq k$ the local ring $R_{\mathfrak p}$ is regular. We also say that $R$ is {\it regular in codimension $\leq k$}. \item We say $R$ has property {\it $(S_k)$} if for every prime $\mathfrak p$ the local ring $R_{\mathfrak p}$ has depth at least $\min\{k, \dim(R_{\mathfrak p})\}$. \item Let $M$ be a finite $R$-module. We say $M$ has property $(S_k)$ if for every prime $\mathfrak p$ the module $M_{\mathfrak p}$ has depth at least $\min\{k, \dim(\text{Supp}(M_{\mathfrak p}))\}$. \end{enumerate}

\begin{lemma} \label{lemma-criterion-no-embedded-primes} Let $R$ be a Noetherian ring. Let $M$ be a finite $R$-module. The following are equivalent: \begin{enumerate} \item $M$ has no embedded associated prime, and \item $M$ has property $(S_1)$. \end{enumerate}

\begin{lemma} \label{lemma-criterion-reduced} \begin{slogan} Reduced equals R0 plus S1. \end{slogan} Let $R$ be a Noetherian ring. The following are equivalent: \begin{enumerate} \item $R$ is reduced, and \item $R$ has properties $(R_0)$ and $(S_1)$. \end{enumerate}



\begin{lemma} \label{lemma-regular-normal} A regular ring is normal.

\begin{lemma} \label{lemma-normal-domain-intersection-localizations-height-1} Let $R$ be a Noetherian normal domain with fraction field $K$. Then \begin{enumerate} \item for any nonzero $a \in R$ the quotient $R/aR$ has no embedded primes, and all its associated primes have height $1$ \item $$ R = \bigcap\nolimits_{\text{height}(\mathfrak p) = 1} R_{\mathfrak p} $$ \item For any nonzero $x \in K$ the quotient $R/(R \cap xR)$ has no embedded primes, and all its associates primes have height $1$. \end{enumerate}

\begin{lemma} \label{lemma-characterize-separable-algebraic-field-extensions} Let $k \subset K$ be a finitely generated field extension. The following are equivalent \begin{enumerate} \item $K$ is a finite separable field extension of $k$, \item $\Omega_{K/k} = 0$, \item $K$ is formally unramified over $k$, \item $K$ is unramified over $k$, \item $K$ is formally \'etale over $k$, \item $K$ is \'etale over $k$. \end{enumerate}

\begin{lemma} \label{lemma-derivative-zero-pth-power} Let $k$ be a perfect field of characteristic $p > 0$. Let $K/k$ be an extension. Let $a \in K$. Then $\text{d}a = 0$ in $\Omega_{K/k}$ if and only if $a$ is a $p$th power.

\begin{lemma} \label{lemma-size-extension-pth-roots} Let $k$ be a field of characteristic $p > 0$. Let $a_1, \ldots, a_n \in k$ be elements such that $\text{d}a_1, \ldots, \text{d}a_n$ are linearly independent in $\Omega_{k/\mathbf{F}_p}$. Then the field extension $k(a_1^{1/p}, \ldots, a_n^{1/p})$ has degree $p^n$ over $k$.

\begin{lemma} \label{lemma-separable-differentials} Let $k$ be a field of characteristic $p > 0$. The following are equivalent: \begin{enumerate} \item the field extension $K/k$ is separable (see Definition \ref{definition-separable-field-extension}), and \item the map $K \otimes_k \Omega_{k/\mathbf{F}_p} \to \Omega_{K/\mathbf{F}_p}$ is injective. \end{enumerate}

\begin{lemma} \label{lemma-formally-smooth-implies-separable} Let $k \subset K$ be an extension of fields. If $K$ is formally smooth over $k$, then $K$ is a separable extension of $k$.

\begin{lemma} \label{lemma-characterize-formally-smooth-field-extension} Let $k \subset K$ be an extension of fields. Then $K$ is formally smooth over $k$ if and only if $H_1(L_{K/k}) = 0$.

\begin{lemma} \label{lemma-formally-smooth-extensions-easy} Let $k \subset K$ be an extension of fields. \begin{enumerate} \item If $K$ is purely transcendental over $k$, then $K$ is formally smooth over $k$. \item If $K$ is separable algebraic over $k$, then $K$ is formally smooth over $k$. \item If $K$ is separable over $k$, then $K$ is formally smooth over $k$. \end{enumerate}

\begin{lemma} \label{lemma-fields-are-formally-smooth} \begin{slogan} Formally smooth equals separable for field extensions. \end{slogan} Let $k$ be a field. \begin{enumerate} \item If the characteristic of $k$ is zero, then any extension field of $k$ is formally smooth over $k$. \item If the characteristic of $k$ is $p > 0$, then $k \subset K$ is formally smooth if and only if it is a separable field extension. \end{enumerate}

\begin{lemma} \label{lemma-localization-smooth-separable} Let $k \subset K$ be a finitely generated field extension. Then $K$ is separable over $k$ if and only if $K$ is the localization of a smooth $k$-algebra.

\begin{lemma} \label{lemma-colimit-syntomic} Let $k \subset K$ be a field extension. Then $K$ is a filtered colimit of global complete intersection algebras over $k$. If $K/k$ is separable, then $K$ is a filtered colimit of smooth algebras over $k$.

\begin{lemma} \label{lemma-flat-local-given-residue-field} Let $(R, \mathfrak m, k)$ be a local ring. Let $k \subset K$ be a field extension. There exists a local ring $(R', \mathfrak m', k')$, a flat local ring map $R \to R'$ such that $\mathfrak m' = \mathfrak mR'$ and such that $k \subset k'$ is isomorphic to $k \subset K$.

\begin{lemma} \label{lemma-colimit-finite-etale-given-residue-field} Let $(R, \mathfrak m, k)$ be a local ring. If $k \subset K$ is a separable algebraic extension, then there exists a directed set $I$ and a system of finite \'etale extensions $R \subset R_i$, $i \in I$ of local rings such that $R' = \colim R_i$ has residue field $K$ (as extension of $k$).

\begin{lemma} \label{lemma-finite-free-given-residue-field-extension} Let $R$ be a ring. Let $\mathfrak p \subset R$ be a prime and let $\kappa(\mathfrak p) \subset L$ be a finite extension of fields. Then there exists a finite free ring map $R \to S$ such that $\mathfrak q = \mathfrak pS$ is prime and $\kappa(\mathfrak p) \subset \kappa(\mathfrak q)$ is isomorphic to the given extension $\kappa(\mathfrak p) \subset L$.

\begin{definition} \label{definition-complete-local-ring} Let $(R, \mathfrak m)$ be a local ring. We say $R$ is a {\it complete local ring} if the canonical map $$ R \longrightarrow \lim_n R/\mathfrak m^n $$ to the completion of $R$ with respect to $\mathfrak m$ is an isomorphism\footnote{This includes the condition that $\bigcap \mathfrak m^n = (0)$; in some texts this may be indicated by saying that $R$ is complete and separated. Warning: It can happen that the completion $\lim_n R/\mathfrak m^n$ of a local ring is non-complete, see Examples, Lemma \ref{examples-lemma-noncomplete-completion}. This does not happen when $\mathfrak m$ is finitely generated, see Lemma \ref{lemma-hathat-finitely-generated} in which case the completion is Noetherian, see Lemma \ref{lemma-completion-Noetherian}.}.

\begin{lemma} \label{lemma-quotient-complete-local} Let $R$ be a Noetherian complete local ring. Any quotient of $R$ is also a Noetherian complete local ring. Given a finite ring map $R \to S$, then $S$ is a product of Noetherian complete local rings.

\begin{lemma} \label{lemma-complete-local-ring-Noetherian} Let $(R, \mathfrak m)$ be a complete local ring. If $\mathfrak m$ is a finitely generated ideal then $R$ is Noetherian.

\begin{definition} \label{definition-coefficient-ring} Let $(R, \mathfrak m)$ be a complete local ring. A subring $\Lambda \subset R$ is called a {\it coefficient ring} if the following conditions hold: \begin{enumerate} \item $\Lambda$ is a complete local ring with maximal ideal $\Lambda \cap \mathfrak m$, \item the residue field of $\Lambda$ maps isomorphically to the residue field of $R$, and \item $\Lambda \cap \mathfrak m = p\Lambda$, where $p$ is the characteristic of the residue field of $R$. \end{enumerate}

\begin{definition} \label{definition-cohen-ring} A {\it Cohen ring} is a complete discrete valuation ring with uniformizer $p$ a prime number.

\begin{lemma} \label{lemma-cohen-rings-exist} Let $p$ be a prime number. Let $k$ be a field of characteristic $p$. There exists a Cohen ring $\Lambda$ with $\Lambda/p\Lambda \cong k$.

\begin{lemma} \label{lemma-cohen-ring-formally-smooth} Let $p > 0$ be a prime. Let $\Lambda$ be a Cohen ring with residue field of characteristic $p$. For every $n \geq 1$ the ring map $$ \mathbf{Z}/p^n\mathbf{Z} \to \Lambda/p^n\Lambda $$ is formally smooth.

\begin{lemma} \label{lemma-regular-complete-containing-coefficient-field} Let $(R, \mathfrak m)$ be a Noetherian complete local ring. Assume $R$ is regular. \begin{enumerate} \item If $R$ contains either $\mathbf{F}_p$ or $\mathbf{Q}$, then $R$ is isomorphic to a power series ring over its residue field. \item If $k$ is a field and $k \to R$ is a ring map inducing an isomorphism $k \to R/\mathfrak m$, then $R$ is isomorphic as a $k$-algebra to a power series ring over $k$. \end{enumerate}

\begin{lemma} \label{lemma-complete-local-Noetherian-domain-finite-over-regular} Let $(R, \mathfrak m)$ be a Noetherian complete local domain. Then there exists a $R_0 \subset R$ with the following properties \begin{enumerate} \item $R_0$ is a regular complete local ring, \item $R_0 \subset R$ is finite and induces an isomorphism on residue fields, \item $R_0$ is either isomorphic to $k[[X_1, \ldots, X_d]]$ where $k$ is a field or $\Lambda[[X_1, \ldots, X_d]]$ where $\Lambda$ is a Cohen ring. \end{enumerate}

\begin{definition} \label{definition-N} Let $R$ be a domain with field of fractions $K$. \begin{enumerate} \item We say $R$ is {\it N-1} if the integral closure of $R$ in $K$ is a finite $R$-module. \item We say $R$ is {\it N-2} or {\it Japanese} if for any finite extension $K \subset L$ of fields the integral closure of $R$ in $L$ is finite over $R$. \end{enumerate}

\begin{lemma} \label{lemma-localize-N} Let $R$ be a domain. If $R$ is N-1 then so is any localization of $R$. Same for N-2.

\begin{lemma} \label{lemma-Japanese-local} Let $R$ be a domain. Let $f_1, \ldots, f_n \in R$ generate the unit ideal. If each domain $R_{f_i}$ is N-1 then so is $R$. Same for N-2.

\begin{lemma} \label{lemma-quasi-finite-over-Noetherian-japanese} Let $R$ be a domain. Let $R \subset S$ be a quasi-finite extension of domains (for example finite). Assume $R$ is N-2 and Noetherian. Then $S$ is N-2.

\begin{lemma} \label{lemma-Laurent-ring-N-1} Let $R$ be a Noetherian domain. If $R[z, z^{-1}]$ is N-1, then so is $R$.

\begin{lemma} \label{lemma-finite-extension-N-2} Let $R$ be a Noetherian domain, and let $R \subset S$ be a finite extension of domains. If $S$ is N-1, then so is $R$. If $S$ is N-2, then so is $R$.

\begin{lemma} \label{lemma-Noetherian-normal-domain-finite-separable-extension} Let $R$ be a Noetherian normal domain with fraction field $K$. Let $K \subset L$ be a finite separable field extension. Then the integral closure of $R$ in $L$ is finite over $R$.

\begin{lemma} \label{lemma-Noetherian-normal-domain-insep-extension} Let $R$ be a Noetherian normal domain with fraction field $K$ of characteristic $p > 0$. Let $a \in K$ be an element such that there exists a derivation $D : R \to R$ with $D(a) \not = 0$. Then the integral closure of $R$ in $L = K[x]/(x^p - a)$ is finite over $R$.

\begin{lemma} \label{lemma-domain-char-zero-N-1-2} A Noetherian domain of characteristic zero is N-1 if and only if it is N-2 (i.e., Japanese).

\begin{lemma} \label{lemma-domain-char-p-N-1-2} Let $R$ be a Noetherian domain with fraction field $K$ of characteristic $p > 0$. Then $R$ is N-2 if and only if for every finite purely inseparable extension $K \subset L$ the integral closure of $R$ in $L$ is finite over $R$.

\begin{lemma} \label{lemma-polynomial-ring-N-2} Let $R$ be a Noetherian domain. If $R$ is N-1 then $R[x]$ is N-1. If $R$ is N-2 then $R[x]$ is N-2.

\begin{lemma} \label{lemma-openness-normal-locus} Let $R$ be a Noetherian domain. If there exists an $f \in R$ such that $R_f$ is normal then $$ U = \{\mathfrak p \in \Spec(R) \mid R_{\mathfrak p} \text{ is normal}\} $$ is open in $\Spec(R)$.

\begin{lemma} \label{lemma-characterize-N-1} Let $R$ be a Noetherian domain. Assume \begin{enumerate} \item there exists a nonzero $f \in R$ such that $R_f$ is normal, and \item for every maximal ideal $\mathfrak m \subset R$ the local ring $R_{\mathfrak m}$ is N-1. \end{enumerate} Then $R$ is N-1.



\begin{lemma} \label{lemma-power-series-over-N-2} Let $R$ be a ring. If $R$ is Noetherian, a domain, and N-2, then so is $R[[x]]$.

\begin{definition} \label{definition-nagata} Let $R$ be a ring. \begin{enumerate} \item We say $R$ is {\it universally Japanese} if for any finite type ring map $R \to S$ with $S$ a domain we have that $S$ is N-2 (i.e., Japanese). \item We say that $R$ is a {\it Nagata ring} if $R$ is Noetherian and for every prime ideal $\mathfrak p$ the ring $R/\mathfrak p$ is N-2. \end{enumerate}

\begin{lemma} \label{lemma-nagata-in-reduced-finite-type-finite-integral-closure} Let $R$ be a Nagata ring. Let $R \to S$ be essentially of finite type with $S$ reduced. Then the integral closure of $R$ in $S$ is finite over $R$.

\begin{lemma} \label{lemma-check-universally-japanese} Let $R$ be a ring. To check that $R$ is universally Japanese it suffices to show: If $R \to S$ is of finite type, and $S$ a domain then $S$ is N-1.

\begin{lemma} \label{lemma-universally-japanese} If $R$ is universally Japanese then any algebra essentially of finite type over $R$ is universally Japanese.

\begin{lemma} \label{lemma-quasi-finite-over-nagata} Let $R$ be a Nagata ring. If $R \to S$ is a quasi-finite ring map (for example finite) then $S$ is a Nagata ring also.

\begin{lemma} \label{lemma-nagata-localize} A localization of a Nagata ring is a Nagata ring.

\begin{lemma} \label{lemma-nagata-local} Let $R$ be a ring. Let $f_1, \ldots, f_n \in R$ generate the unit ideal. \begin{enumerate} \item  If each $R_{f_i}$ is universally Japanese then so is $R$. \item  If each $R_{f_i}$ is Nagata then so is $R$. \end{enumerate}

\begin{lemma} \label{lemma-Noetherian-complete-local-Nagata} A Noetherian complete local ring is a Nagata ring.

\begin{definition} \label{definition-analytically-unramified} Let $(R, \mathfrak m)$ be a Noetherian local ring. We say $R$ is {\it analytically unramified} if its completion $R^\wedge = \lim_n R/\mathfrak m^n$ is reduced. A prime ideal $\mathfrak p \subset R$ is said to be {\it analytically unramified} if $R/\mathfrak p$ is analytically unramified.

\begin{lemma} \label{lemma-analytically-unramified-easy} Let $(R, \mathfrak m)$ be a Noetherian local ring. \begin{enumerate} \item If $R$ is analytically unramified, then $R$ is reduced. \item If $R$ is analytically unramified, then each minimal prime of $R$ is analytically unramified. \item If $R$ is reduced with minimal primes $\mathfrak q_1, \ldots, \mathfrak q_t$, and each $\mathfrak q_i$ is analytically unramified, then $R$ is analytically unramified. \item If $R$ is analytically unramified, then the integral closure of $R$ in its total ring of fractions $Q(R)$ is finite over $R$. \item If $R$ is a domain and analytically unramified, then $R$ is N-1. \end{enumerate}

\begin{lemma} \label{lemma-codimension-1-analytically-unramified} Let $R$ be a Noetherian local ring. Let $\mathfrak p \subset R$ be a prime. Assume \begin{enumerate} \item $R_{\mathfrak p}$ is a discrete valuation ring, and \item $\mathfrak p$ is analytically unramified. \end{enumerate} Then for any associated prime $\mathfrak q$ of $R^\wedge/\mathfrak pR^\wedge$ the local ring $(R^\wedge)_{\mathfrak q}$ is a discrete valuation ring.

\begin{lemma} \label{lemma-criterion-analytically-unramified} Let $(R, \mathfrak m)$ be a Noetherian local domain. Let $x \in \mathfrak m$. Assume \begin{enumerate} \item $x \not = 0$, \item $R/xR$ has no embedded primes, and \item for each associated prime $\mathfrak p \subset R$ of $R/xR$ we have \begin{enumerate} \item the local ring $R_{\mathfrak p}$ is regular, and \item $\mathfrak p$ is analytically unramified. \end{enumerate} \end{enumerate} Then $R$ is analytically unramified.

\begin{lemma} \label{lemma-local-nagata-domain-analytically-unramified} Let $(R, \mathfrak m)$ be a local ring. If $R$ is Noetherian, a domain, and Nagata, then $R$ is analytically unramified.

\begin{lemma} \label{lemma-local-nagata-and-analytically-unramified} Let $(R, \mathfrak m)$ be a Noetherian local ring. The following are equivalent \begin{enumerate} \item $R$ is Nagata, \item for $R \to S$ finite with $S$ a domain and $\mathfrak m' \subset S$ maximal the local ring $S_{\mathfrak m'}$ is analytically unramified, \item for $(R, \mathfrak m) \to (S, \mathfrak m')$ finite local homomorphism with $S$ a domain, then $S$ is analytically unramified. \end{enumerate}

\begin{lemma} \label{lemma-nagata-pth-roots} Let $(A, \mathfrak m)$ be a Noetherian local domain which is Nagata and has fraction field of characteristic $p$. If $a \in A$ has a $p$th root in $A^\wedge$, then $a$ is has a $p$th root in $A$.

\begin{lemma} \label{lemma-apply-grothendieck-module} \begin{reference} \cite[IV, Proposition 6.3.1]{EGA} \end{reference} We have $$ \text{depth}(M \otimes_R N) = \text{depth}(M) + \text{depth}(N/\mathfrak m_RN) $$ where $R \to S$ is a local homomorphism of local Noetherian rings, $M$ is a finite $R$-module, and $N$ is a finite $S$-module flat over $R$.

\begin{lemma} \label{lemma-apply-grothendieck} Suppose that $R \to S$ is a flat and local ring homomorphism of Noetherian local rings. Then $$ \text{depth}(S) = \text{depth}(R) + \text{depth}(S/\mathfrak m_RS). $$

\begin{lemma} \label{lemma-CM-goes-up} Let $R \to S$ be a flat local homomorphism of local Noetherian rings. Then the following are equivalent \begin{enumerate} \item $S$ is Cohen-Macaulay, and \item $R$ and $S/\mathfrak m_RS$ are Cohen-Macaulay. \end{enumerate}

\begin{lemma} \label{lemma-Sk-goes-up} Let $\varphi : R \to S$ be a ring map. Assume \begin{enumerate} \item $R$ is Noetherian, \item $S$ is Noetherian, \item $\varphi$ is flat, \item the fibre rings $S \otimes_R \kappa(\mathfrak p)$ are $(S_k)$, and \item $R$ has property $(S_k)$. \end{enumerate} Then $S$ has property $(S_k)$.

\begin{lemma} \label{lemma-Rk-goes-up} Let $\varphi : R \to S$ be a ring map. Assume \begin{enumerate} \item $R$ is Noetherian, \item $S$ is Noetherian \item $\varphi$ is flat, \item the fibre rings $S \otimes_R \kappa(\mathfrak p)$ have property $(R_k)$, and \item $R$ has property $(R_k)$. \end{enumerate} Then $S$ has property $(R_k)$.

\begin{lemma} \label{lemma-reduced-goes-up-noetherian} Let $\varphi : R \to S$ be a ring map. Assume \begin{enumerate} \item $R$ is Noetherian, \item $S$ is Noetherian \item $\varphi$ is flat, \item the fibre rings $S \otimes_R \kappa(\mathfrak p)$ are reduced, \item $R$ is reduced. \end{enumerate} Then $S$ is reduced.

\begin{lemma} \label{lemma-reduced-goes-up} Let $\varphi : R \to S$ be a ring map. Assume \begin{enumerate} \item $\varphi$ is smooth, \item $R$ is reduced. \end{enumerate} Then $S$ is reduced.

\begin{lemma} \label{lemma-normal-goes-up-noetherian} Let $\varphi : R \to S$ be a ring map. Assume \begin{enumerate} \item $R$ is Noetherian, \item $S$ is Noetherian, \item $\varphi$ is flat, \item the fibre rings $S \otimes_R \kappa(\mathfrak p)$ are normal, and \item $R$ is normal. \end{enumerate} Then $S$ is normal.

\begin{lemma} \label{lemma-normal-goes-up} Let $\varphi : R \to S$ be a ring map. Assume \begin{enumerate} \item $\varphi$ is smooth, \item $R$ is normal. \end{enumerate} Then $S$ is normal.

\begin{lemma} \label{lemma-regular-goes-up} \begin{slogan} Regularity ascends along smooth maps of rings. \end{slogan} Let $\varphi : R \to S$ be a ring map. Assume \begin{enumerate} \item $\varphi$ is smooth, \item $R$ is a regular ring. \end{enumerate} Then $S$ is regular.

\begin{lemma} \label{lemma-descent-Noetherian} Let $R \to S$ be a ring map. Assume that \begin{enumerate} \item $R \to S$ is faithfully flat, and \item $S$ is Noetherian. \end{enumerate} Then $R$ is Noetherian.

\begin{lemma} \label{lemma-descent-reduced} Let $R \to S$ be a ring map. Assume that \begin{enumerate} \item $R \to S$ is faithfully flat, and \item $S$ is reduced. \end{enumerate} Then $R$ is reduced.

\begin{lemma} \label{lemma-descent-normal} Let $R \to S$ be a ring map. Assume that \begin{enumerate} \item $R \to S$ is faithfully flat, and \item $S$ is a normal ring. \end{enumerate} Then $R$ is a normal ring.

\begin{lemma} \label{lemma-descent-regular} Let $R \to S$ be a ring map. Assume that \begin{enumerate} \item $R \to S$ is faithfully flat, and \item $S$ is a regular ring. \end{enumerate} Then $R$ is a regular ring.

\begin{lemma} \label{lemma-descent-Sk} Let $R \to S$ be a ring map. Assume that \begin{enumerate} \item $R \to S$ is faithfully flat, and \item $S$ is Noetherian and has property $(S_k)$. \end{enumerate} Then $R$ is Noetherian and has property $(S_k)$.

\begin{lemma} \label{lemma-descent-Rk} Let $R \to S$ be a ring map. Assume that \begin{enumerate} \item $R \to S$ is faithfully flat, and \item $S$ is Noetherian and has property $(R_k)$. \end{enumerate} Then $R$ is Noetherian and has property $(R_k)$.

\begin{lemma} \label{lemma-descent-nagata} Let $R \to S$ be a ring map. Assume that \begin{enumerate} \item $R \to S$ is smooth and surjective on spectra, and \item $S$ is a Nagata ring. \end{enumerate} Then $R$ is a Nagata ring.

\begin{lemma} \label{lemma-geometrically-normal} Let $k$ be a field. Let $A$ be a $k$-algebra. The following properties of $A$ are equivalent: \begin{enumerate} \item $k' \otimes_k A$ is a normal ring for every field extension $k'/k$, \item $k' \otimes_k A$ is a normal ring for every finitely generated field extension $k'/k$, \item $k' \otimes_k A$ is a normal ring for every finite purely inseparable extension $k'/k$, \item $k^{perf} \otimes_k A$ is a normal ring. \end{enumerate} Here normal ring is defined in Definition \ref{definition-ring-normal}.

\begin{definition} \label{definition-geometrically-normal} Let $k$ be a field. A $k$-algebra $R$ is called {\it geometrically normal} over $k$ if the equivalent conditions of Lemma \ref{lemma-geometrically-normal} hold.

\begin{lemma} \label{lemma-localization-geometrically-normal-algebra} Let $k$ be a field. A localization of a geometrically normal $k$-algebra is geometrically normal.

\begin{lemma} \label{lemma-separable-field-extension-geometrically-normal} Let $k$ be a field. Let $K/k$ be a separable field extension. Then $K$ is geometrically normal over $k$.

\begin{lemma} \label{lemma-geometrically-normal-tensor-normal} Let $k$ be a field. Let $A, B$ be $k$-algebras. Assume $A$ is geometrically normal over $k$ and $B$ is a normal ring. Then $A \otimes_k B$ is a normal ring.

\begin{lemma} \label{lemma-geometrically-normal-over-separable-algebraic} Let $k \subset k'$ be a separable algebraic field extension. Let $A$ be an algebra over $k'$. Then $A$ is geometrically normal over $k$ if and only if it is geometrically normal over $k'$.

\begin{lemma} \label{lemma-geometrically-regular} Let $k$ be a field. Let $A$ be a $k$-algebra. Assume $A$ is Noetherian. The following properties of $A$ are equivalent: \begin{enumerate} \item $k' \otimes_k A$ is regular for every finitely generated field extension $k \subset k'$, and \item $k' \otimes_k A$ is regular for every finite purely inseparable extension $k \subset k'$. \end{enumerate} Here regular ring is as in Definition \ref{definition-regular}.

\begin{definition} \label{definition-geometrically-regular} Let $k$ be a field. Let $R$ be a Noetherian $k$-algebra. The $k$-algebra $R$ is called {\it geometrically regular} over $k$ if the equivalent conditions of Lemma \ref{lemma-geometrically-regular} hold.

\begin{lemma} \label{lemma-geometrically-regular-descent} \begin{slogan} Geometric regularity descends through faithfully flat maps of algebras \end{slogan} Let $k$ be a field. Let $A \to B$ be a faithfully flat $k$-algebra map. If $B$ is geometrically regular over $k$, so is $A$.

\begin{lemma} \label{lemma-geometrically-regular-goes-up} Let $k$ be a field. Let $A \to B$ be a smooth ring map of $k$-algebras. If $A$ is geometrically regular over $k$, then $B$ is geometrically regular over $k$.

\begin{lemma} \label{lemma-geometrically-regular-over-subfields} Let $k$ be a field. Let $A$ be an algebra over $k$. Let $k = \colim k_i$ be a directed colimit of subfields. If $A$ is geometrically regular over each $k_i$, then $A$ is geometrically regular over $k$.

\begin{lemma} \label{lemma-geometrically-regular-over-separable-algebraic} Let $k \subset k'$ be a separable algebraic field extension. Let $A$ be an algebra over $k'$. Then $A$ is geometrically regular over $k$ if and only if it is geometrically regular over $k'$.

\begin{lemma} \label{lemma-tensor-fields-CM} Let $k$ be a field and let $k \subset K$ and $k \subset L$ be two field extensions such that one of them is a field extension of finite type. Then $K \otimes_k L$ is a Noetherian Cohen-Macaulay ring.

\begin{lemma} \label{lemma-CM-geometrically-CM} Let $k$ be a field. Let $S$ be a Noetherian $k$-algebra. Let $k \subset K$ be a finitely generated field extension, and set $S_K = K \otimes_k S$. Let $\mathfrak q \subset S$ be a prime of $S$. Let $\mathfrak q_K \subset S_K$ be a prime of $S_K$ lying over $\mathfrak q$. Then $S_{\mathfrak q}$ is Cohen-Macaulay if and only if $(S_K)_{\mathfrak q_K}$ is Cohen-Macaulay.

\begin{lemma} \label{lemma-flat-finite-presentation-limit-flat} Let $R \to S$ be a ring map. Let $M$ be an $S$-module. Assume that \begin{enumerate} \item $R \to S$ is of finite presentation, \item $M$ is a finitely presented $S$-module, and \item $M$ is flat over $R$. \end{enumerate} In this case we have the following: \begin{enumerate} \item There exists a finite type $\mathbf{Z}$-algebra $R_0$ and a finite type ring map $R_0 \to S_0$ and a finite $S_0$-module $M_0$ such that $M_0$ is flat over $R_0$, together with a ring maps $R_0 \to R$ and $S_0 \to S$ and an $S_0$-module map $M_0 \to M$ such that $S \cong R \otimes_{R_0} S_0$ and $M = S \otimes_{S_0} M_0$. \item If $R = \colim_{\lambda \in \Lambda} R_\lambda$ is written as a directed colimit, then there exists a $\lambda$ and a ring map $R_\lambda \to S_\lambda$ of finite presentation, and an $S_\lambda$-module $M_\lambda$ of finite presentation such that $M_\lambda$ is flat over $R_\lambda$ and such that $S = R \otimes_{R_\lambda} S_\lambda$ and $M = S \otimes_{S_{\lambda}} M_\lambda$. \item If $$ (R \to S, M) = \colim_{\lambda \in \Lambda} (R_\lambda \to S_\lambda, M_\lambda) $$ is written as a directed colimit such that \begin{enumerate} \item $R_\mu \otimes_{R_\lambda} S_\lambda \to S_\mu$ and $S_\mu \otimes_{S_\lambda} M_\lambda \to M_\mu$ are isomorphisms for $\mu \geq \lambda$, \item $R_\lambda \to S_\lambda$ is of finite presentation, \item $M_\lambda$ is a finitely presented $S_\lambda$-module, \end{enumerate} then for all sufficiently large $\lambda$ the module $M_\lambda$ is flat over $R_\lambda$. \end{enumerate}

\begin{lemma} \label{lemma-descend-faithfully-flat-finite-presentation} Let $R \to A \to B$ be ring maps. Assume $A \to B$ faithfully flat of finite presentation. Then there exists a commutative diagram $$ \xymatrix{ R \ar[r] \ar@{=}[d] & A_0 \ar[d] \ar[r] & B_0 \ar[d] \\ R \ar[r] & A \ar[r] & B } $$ with $R \to A_0$ of finite presentation, $A_0 \to B_0$ faithfully flat of finite presentation and $B = A \otimes_{A_0} B_0$.

\begin{lemma} \label{lemma-colimit-finite} Let $A = \colim_{i \in I} A_i$ be a directed colimit of rings. Let $0 \in I$ and $\varphi_0 : B_0 \to C_0$ a map of $A_0$-algebras. Assume \begin{enumerate} \item $A \otimes_{A_0} B_0 \to A \otimes_{A_0} C_0$ is finite, \item $C_0$ is of finite type over $B_0$. \end{enumerate} Then there exists an $i \geq 0$ such that the map $A_i \otimes_{A_0} B_0 \to A_i \otimes_{A_0} C_0$ is finite.

\begin{lemma} \label{lemma-colimit-surjective} Let $A = \colim_{i \in I} A_i$ be a directed colimit of rings. Let $0 \in I$ and $\varphi_0 : B_0 \to C_0$ a map of $A_0$-algebras. Assume \begin{enumerate} \item $A \otimes_{A_0} B_0 \to A \otimes_{A_0} C_0$ is surjective, \item $C_0$ is of finite type over $B_0$. \end{enumerate} Then for some $i \geq 0$ the map $A_i \otimes_{A_0} B_0 \to A_i \otimes_{A_0} C_0$ is surjective.

\begin{lemma} \label{lemma-colimit-unramified} Let $A = \colim_{i \in I} A_i$ be a directed colimit of rings. Let $0 \in I$ and $\varphi_0 : B_0 \to C_0$ a map of $A_0$-algebras. Assume \begin{enumerate} \item $A \otimes_{A_0} B_0 \to A \otimes_{A_0} C_0$ is unramified, \item $C_0$ is of finite type over $B_0$. \end{enumerate} Then for some $i \geq 0$ the map $A_i \otimes_{A_0} B_0 \to A_i \otimes_{A_0} C_0$ is unramified.

\begin{lemma} \label{lemma-colimit-isomorphism} Let $A = \colim_{i \in I} A_i$ be a directed colimit of rings. Let $0 \in I$ and $\varphi_0 : B_0 \to C_0$ a map of $A_0$-algebras. Assume \begin{enumerate} \item $A \otimes_{A_0} B_0 \to A \otimes_{A_0} C_0$ is an isomorphism, \item $B_0 \to C_0$ is of finite presentation. \end{enumerate} Then for some $i \geq 0$ the map $A_i \otimes_{A_0} B_0 \to A_i \otimes_{A_0} C_0$ is an isomorphism.

\begin{lemma} \label{lemma-colimit-etale} Let $A = \colim_{i \in I} A_i$ be a directed colimit of rings. Let $0 \in I$ and $\varphi_0 : B_0 \to C_0$ a map of $A_0$-algebras. Assume \begin{enumerate} \item $A \otimes_{A_0} B_0 \to A \otimes_{A_0} C_0$ is \'etale, \item $B_0 \to C_0$ is of finite presentation. \end{enumerate} Then for some $i \geq 0$ the map $A_i \otimes_{A_0} B_0 \to A_i \otimes_{A_0} C_0$ is \'etale.

\begin{lemma} \label{lemma-colimit-smooth} Let $A = \colim_{i \in I} A_i$ be a directed colimit of rings. Let $0 \in I$ and $\varphi_0 : B_0 \to C_0$ a map of $A_0$-algebras. Assume \begin{enumerate} \item $A \otimes_{A_0} B_0 \to A \otimes_{A_0} C_0$ is smooth, \item $B_0 \to C_0$ is of finite presentation. \end{enumerate} Then for some $i \geq 0$ the map $A_i \otimes_{A_0} B_0 \to A_i \otimes_{A_0} C_0$ is smooth.

\begin{lemma} \label{lemma-colimit-lci} Let $A = \colim_{i \in I} A_i$ be a directed colimit of rings. Let $0 \in I$ and $\varphi_0 : B_0 \to C_0$ a map of $A_0$-algebras. Assume \begin{enumerate} \item $A \otimes_{A_0} B_0 \to A \otimes_{A_0} C_0$ is syntomic (resp.\ a relative global complete intersection), \item $C_0$ is of finite presentation over $B_0$. \end{enumerate} Then there exists an $i \geq 0$ such that the map $A_i \otimes_{A_0} B_0 \to A_i \otimes_{A_0} C_0$ is syntomic (resp.\ a relative global complete intersection).

\begin{lemma} \label{lemma-fppf-fpqf} Let $R \to S$ be a faithfully flat ring map of finite presentation. Then there exists a commutative diagram $$ \xymatrix{ S \ar[rr] & & S' \\ & R \ar[lu] \ar[ru] } $$ where $R \to S'$ is quasi-finite, faithfully flat and of finite presentation.

